<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="DoFinishInspect" Caption="检验完成" HasNavigationBar="false" Authenticate="false">
    <DataSource>
        <DataObject Key="DoFinishInspect" PrimaryTableKey="LRP_WMTx_L">
            <TableCollection>
                <Table Key="LRP_WMTx_L" Caption="快速检验单物料明细" TableMode="Detail" SourceType="Query">
                    <Column Key="SrcOID" Caption="原明细OID" DataType="Long"/>
                    <Column Key="SOID" Caption="表单标识" DataType="Long"/>
                    <Column Key="MaterialId" Caption="物料ID" DataType="Long"/>
                    <Column Key="MtlName" Caption="物料名称" DataType="Varchar" Length="200"/>
                    <Column Key="MtlCode" Caption="物料代码" DataType="Varchar" Length="100"/>
                    <Column Key="MaterialUnit" Caption="单位" DataType="Varchar" Length="10"/>
                    <Column Key="SrcBatchNo" Caption="批号" DataType="Varchar" Length="100"/>
                    <Column Key="Qty" Caption="数量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="SrcLocCode" Caption="源储位代码" DataType="Varchar"/>
                    <Column Key="SrcMaterialStatusCode" Caption="源物料状态代码" DataType="Varchar"/>
                    <Column Key="DestMaterialStatusCode" Caption="目标物料状态代码" DataType="Varchar"/>
                    <Column Key="Status" Caption="状态" DataType="Integer"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Formula="GetPara('OID');"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[SELECT l.OID as SrcOID,
  l.SOID,
  l.MaterialId,
  l.MaterialUnit,
  m.Name AS MtlName,
  m.Code AS MtlCode,
  l.SrcBatchNo,
  l.Qty,
  l.Status,
  srcloc.code as SrcLocCode,
  ms.code as SrcMaterialStatusCode ,
  ms2.code as DestMaterialStatusCode
FROM LRP_WMTx_L l
LEFT JOIN LRP_Material m
ON m.oid = l.MaterialId
LEFT JOIN LRP_Location srcloc
ON srcloc.oid = l.SrcLocationId
LEFT JOIN LRP_MaterialStatus ms
ON ms.oid = l.SrcMaterialStatusId 
LEFT JOIN LRP_MaterialStatus ms2
ON ms2.oid = l.DestMaterialStatusId
where  l.SOID = ?
ORDER BY srcloc.Code DESC]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Key="MaterialStatus">
            <Statement>
                <![CDATA[select l.code as N_KEY,l.name as N_NAME from  LRP_MaterialStatus l]]>
            </Statement>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#e6e6e6"/>
                <LinearLayoutPanel Caption="Title3" Key="Title" Orientation="Horizontal" X="0" Y="0" Padding="5px">
                    <Format BackColor="#f14c52"/>
                    <Button Key="Cancel" Caption="取消" Height="auto" Width="60px">
                        <Format HAlign="Left" ForeColor="#ffffff" BackColor="#f14c52">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									ShowConfirm('是否放弃本次检验完成？', 'YES_NO', 
										{
											YES: {
													Back();
												}, 
											NO: {} 
										}
												)
								]]>
                        </OnClick>
                    </Button>
                    <Label Key="OrderTitle3" Caption="检验完成" Height="auto" Weight="1.0">
                        <Format HAlign="Center" ForeColor="#ffffff">
                            <Font Size="20"/>
                        </Format>
                    </Label>
                    <Button Key="Comfirm" Caption="完成" Height="auto" Width="60px">
                        <Format HAlign="Right" ForeColor="#ffffff" BackColor="#f14c52">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									var count = GetRowCount('list',false);
									var b = true;
									var oid = GetPara('OID');
									if(count > 0){
										InvokeService("LRP_InspectCopyAndInsertRow", true, false,oid);
										ShowToast("检验完成");
										Parent.LoadData();
										Back();
									}
									
									]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <TableView Caption="扫描明细" Key="TableView2" X="0" Y="1" Padding="5px">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="row6" SelectColor="#cccccc" SeparatorColor="#e6e6e6" SeparatorStyle="none none solid none">
                            <GridLayoutPanel Key="EnterCode" Caption="扫描">
                                <Format BackColor="#FFFFFF">
                                    <Font Size="20"/>
                                </Format>
                                <TextEditor Key="TextMaterialCode" Caption="扫描物料条码" X="1" Y="1" Enable="True" PromptText="扫描物料条码">
                                    <Format HAlign="Left"/>
                                    <KeyEnter>
                                        <![CDATA[
										ScanMaterial();
										
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Image Key="GetMaterialCode" X="3" Y="1" Enable="true" Image="12.png" ImageScaleType="Fit_XY" SourceType="Resource" Stretch="true" Padding="10px">
                                    <OnClick>
                                        <![CDATA[ScanMaterial();]]>
                                    </OnClick>
                                </Image>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="5px"/>
                                    <RowDef Height="35px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="100%"/>
                                    <ColumnDef Width="5px"/>
                                    <ColumnDef Width="35px"/>
                                    <ColumnDef Width="20px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                        <TableRow Key="row2" SelectColor="#cccccc" SeparatorColor="#e6e6e6" SeparatorStyle="none none solid none">
                            <GridLayoutPanel Key="GridLayoutPanel3" Caption="GridLayoutPanel3">
                                <TextEditor Key="TextSrcLoc" Caption="扫描源储位" X="1" Y="1" Enable="true" PromptText="扫描源储位">
                                    <Format HAlign="Left"/>
                                    <KeyEnter>
                                        <![CDATA[
										ScanLoc();
										
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Image Key="GetSrcLoc" X="3" Y="1" Enable="true" Image="12.png" ImageScaleType="Fit_XY" SourceType="Resource" Stretch="true" Padding="10px">
                                    <OnClick>
                                        <![CDATA[ScanLoc();]]>
                                    </OnClick>
                                </Image>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="5px"/>
                                    <RowDef Height="35px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="100%"/>
                                    <ColumnDef Width="5px"/>
                                    <ColumnDef Width="35px"/>
                                    <ColumnDef Width="20px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <TableView Caption="物料明细" Key="TableView1" X="0" Y="2" Padding="5px">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="list" RowType="Detail" TableKey="LRP_WMTx_L" SelectColor="#dddddd" SeparatorStyle="none none solid none" SeparatorColor="#e6eaf2">
                            <GridLayoutPanel Key="GridLayoutPanel2" Height="pref" Caption="GridLayoutPanel2">
                                <Label Key="MtlCode" Caption="无物料代码" X="4" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MtlCode"/>
                                    <Format HAlign="Left"/>
                                </Label>
                                <Label Key="MtlName" Caption="无物料名称" X="6" Y="0">
                                    <DataBinding ColumnKey="MtlName"/>
                                    <Format HAlign="Left"/>
                                </Label>
                                <TextEditor Key="SrcBatchNo" Caption="批号" BuddyKey="Lab_SrcBatchNo" X="2" Y="1" Enable="false">
                                    <DataBinding ColumnKey="SrcBatchNo"/>
                                    <Format HAlign="Left" VAlign="Bottom"/>
                                </TextEditor>
                                <Label Key="Lab_SrcBatchNo" Caption="批号：" X="1" Y="1"/>
                                <NumberEditor Key="Qty" Caption="数量" BuddyKey="Lab_Qty" X="5" Y="1" Scale="0">
                                    <DataBinding ColumnKey="Qty"/>
                                    <Format HAlign="Left"/>
                                </NumberEditor>
                                <Label Key="Lab_Qty" Caption="数量：" X="4" Y="1"/>
                                <TextEditor Key="MaterialUnit" X="6" Y="1" Enable="false">
                                    <DataBinding ColumnKey="MaterialUnit"/>
                                    <Format HAlign="Left"/>
                                </TextEditor>
                                <Label Key="SrcLocCode" Caption="无储位代码" X="1" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="SrcLocCode"/>
                                    <Format HAlign="Left"/>
                                </Label>
                                <Label Key="SrcOID" Caption="SrcOID" X="3" Y="2" Visible="false">
                                    <DataBinding ColumnKey="SrcOID"/>
                                </Label>
                                <Button Key="Button1" Caption="拆分明细" X="8" Y="0" BorderColor="#cccccc" HasBorder="true" YSpan="3" Padding="5px">
                                    <Format HAlign="Center" ForeColor="#ffffff" BackColor="#f14c52">
                                        <Font Size="13"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[var srcLocCode = GetCellValue('list', -1, 'SrcLocCode');
var materialID = GetCellValue('list', -1, 'MaterialID');
var mtlCode = GetCellValue('list', -1, 'MtlCode');
var mtlName = GetCellValue('list', -1, 'MtlName');
var srcBatchNo = GetCellValue('list', -1, 'SrcBatchNo');
var srcMaterialStatusCode = GetCellValue('list', -1, 'SrcMaterialStatusCode');
var destMaterialStatusCode = GetCellValue('list', -1, 'DestMaterialStatusCode');
var materialUnit = GetCellValue('list', -1, 'MaterialUnit');
var srcOID = GetCellValue('list', -1, 'SrcOID');

var rowIndex= InsertRow('list',GetRowIndex('list')+1);

SetCellValue('list', rowIndex, 'MaterialID', materialID);
SetCellValue('list', rowIndex, 'SrcLocCode', srcLocCode);
SetCellValue('list', rowIndex, 'MtlCode', mtlCode);
SetCellValue('list', rowIndex, 'MtlName', mtlName);
SetCellValue('list', rowIndex, 'SrcBatchNo', srcBatchNo);
SetCellValue('list', rowIndex, 'SrcMaterialStatusCode', srcMaterialStatusCode);
SetCellValue('list', rowIndex, 'DestMaterialStatusCode', destMaterialStatusCode);
SetCellValue('list', rowIndex, 'MaterialUnit', materialUnit);
SetCellValue('list', rowIndex, 'Qty', 0);
SetCellValue('list', rowIndex, 'SrcOID', srcOID);

]]>
                                    </OnClick>
                                </Button>
                                <ComboBox Key="SrcMaterialStatusCode" Caption="源状态：" BuddyKey="Lab_SrcMaterialStatusCode" X="2" Y="2" Enable="false" SourceType="Formula">
                                    <DataBinding ColumnKey="SrcMaterialStatusCode" TableKey="LRP_WMTx_L"/>
                                    <Format HAlign="Left"/>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery("MaterialStatus");]]>
                                    </FormulaItems>
                                </ComboBox>
                                <Label Key="Lab_SrcMaterialStatusCode" Caption="源状态：" X="1" Y="2"/>
                                <ComboBox Key="DestMaterialStatusCode" Caption="目标状态：" BuddyKey="Lab_DestMaterialStatusCode" X="5" Y="2" SourceType="Formula" XSpan="2">
                                    <DataBinding ColumnKey="DestMaterialStatusCode" TableKey="LRP_WMTx_L"/>
                                    <Format HAlign="Left"/>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery("MaterialStatus");]]>
                                    </FormulaItems>
                                </ComboBox>
                                <Label Key="Lab_DestMaterialStatusCode" Caption="目标状态：" X="4" Y="2"/>
                                <Label Key="SOID" Caption="SOID" X="3" Y="1" Visible="false">
                                    <DataBinding ColumnKey="SOID"/>
                                </Label>
                                <Label Key="MaterialID" Caption="MaterialID" X="3" Y="0" Visible="false">
                                    <DataBinding ColumnKey="MaterialId"/>
                                </Label>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="35px"/>
                                    <RowDef Height="35px"/>
                                    <RowDef Height="35px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="45px"/>
                                    <ColumnDef Width="35%"/>
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="65px"/>
                                    <ColumnDef Width="15%"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="35px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <RowActionCollection>
                                <RowAction Key="delete" Caption="删除" BackColor="#ff5000" ForeColor="#ffffff">
                                    <![CDATA[
											ShowConfirm('确定删除该条明细吗?', 'YES_NO', 
												{
													YES: {
														DeleteRow('list', GetRowIndex('list'));
														ShowToast('已删除');
													}, 
													NO: {} 
												}
											)
									]]>
                                </RowAction>
                            </RowActionCollection>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef Height="50px"/>
                    <RowDef Height="120px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
			LoadData();
        ]]>
    </OnLoad>
    <MacroCollection>
        <Macro Key="ScanLoc">
            <![CDATA[
				if(TextSrcLoc <> ''){
					var flag = false;
					var count = GetRowCount('list',false);
					var i = 0;
					while(i < count){
						if(GetCellValue('list', i,'SrcLocCode') == TextSrcLoc ){
						
								SetFocusRow('list',i);
								SetRowIndex('list',i);
								ScrollTo('list',i);
								
								flag=true;
								break;
						}
						i=i+1;
					}
					if(flag==false){
						ShowToast("检验明细中找不到该代码的储位。");
					}
				}
				SetFocus('TextSrcLoc');
			]]>
        </Macro>
        <Macro Key="ScanMaterial">
            <![CDATA[				
				if(TextMaterialCode <> ''){
					var flag = false;
					var count = GetRowCount('list',false);
					var i = 0;
					while(i < count){
						if(GetCellValue('list', i,'MtlCode') == TextMaterialCode ){
						
								SetFocusRow('list',i);
								SetRowIndex('list',i);
								ScrollTo('list',i);
								
								flag=true;
								break;
						}
						i=i+1;
					}
					if(flag==false){
						ShowToast("检验明细中找不到该条码物料。");
					}
				}
				SetFocus('TextMaterialCode');
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara Formula="Para('OID')" Key="OID" Type="Formula"/>
    </FormParaCollection>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="Centertitle" Caption="检验完成" Location="Center">
            <Label Key="TitleCenter" Caption="检验完成" Width="auto">
                <Format HAlign="Center" ForeColor="#ffffff">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
