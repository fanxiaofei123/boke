<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Caption="二次分拣" Authenticate="false" HasNavigationBar="false" -->
<Form Key="TwiceWavePick" FormType="View">
    <DataSource>
        <DataObject Key="LRP_PickDetail" Caption="拣货明细" PrimaryTableKey="LRP_WMTx_L">
            <TableCollection>
                <Table Key="LRP_WMTx_L" Caption="拣货明细" TableMode="Detail" SourceType="Query">
                    <Column Caption="对象标识" DataType="Long" Key="OID"/>
                    <Column Caption="物料ID" DataType="Long" Key="MaterialId"/>
                    <Column Caption="单位" DataType="Varchar" Key="MaterialUnit" Length="10"/>
                    <Column Caption="批号" DataType="Varchar" Key="SrcBatchNo" Length="100"/>
                    <Column Caption="实拣量" DataType="Numeric" Key="PickQty" Precision="18" Scale="6"/>
                    <Column Caption="数量" DataType="Numeric" Key="Qty" Precision="18" Scale="6"/>
                    <Column Caption="储位" DataType="Long" Key="SrcLocationId"/>
                    <Column Caption="发货区储位" DataType="Long" Key="DestLocationId"/>
                    <Column Key="MaterilName" Caption="物料名称" DataType="Varchar" Length="200"/>
                    <Column Key="MaterilCode" Caption="物料代码" DataType="Varchar" Length="100"/>
                    <Column Key="SrcLocationName" Caption="储位名称" DataType="Varchar" Length="200"/>
                    <Column Key="SrcLocationCode" Caption="储位代码" DataType="Varchar" Length="200"/>
                    <Column Key="DestLocationName" Caption="发货区储位名称" DataType="Varchar" Length="200"/>
                    <Column Caption="序号" Key="RowIndex" DataType="Integer"/>
                    <Column Caption="订单号" DataType="Varchar" Key="NoticeNo" Length="100"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Formula="GetPara('OID');"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[ select 
    l.OID,
	l.SOID,
	l.MaterialId,
	l.MaterialUnit,
    l.SrcBatchNo,
	0.0 as PickQty,
    l.Qty,
    l.SrcLocationId,
    l.DestLocationId,
    m.Name as MaterilName,
    m.Code as MaterilCode,
	srcloc.Name as SrcLocationName,
	srcloc.Code as SrcLocationCode,
	destloc.Name as DestLocationName,
	wol.RowIndex, 
	oh.No as NoticeNo 
	from LRP_WMTx_L l left join LRP_Material m on m.oid = l.MaterialId 
	left join LRP_Location srcloc on srcloc.oid = l.SrcLocationId 
	left join LRP_Location destloc on destloc.oid = l.DestLocationId 
	join LRP_Wave_MaterialSum_L wl on wl.oid = l.SrcOID 
	join LRP_OutboundNotice_L ol on ol.oid = wl.RefLineOID 
	join LRP_OutboundNotice_H oh on oh.soid = ol.soid 
	join LRP_Wave_Notice_L wol on wol.NoticeLineSOID = oh.soid 
    where
        l.SOID = ? 
	Order by srcloc.Code
    ]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#e6e6e6"/>
                <!--
                <LinearLayoutPanel Caption="Title" Key="Title" Orientation="Horizontal" X="0" Y="0">
                    <Format BackColor="#f14c52"/>
                    <Label Key="OrderTitle" Caption="二次分拣" Height="auto" Weight="1.0">
                        <Format ForeColor="#ffffff" HAlign="Center">
                            <Font Size="20"/>
                        </Format>
                    </Label>
                </LinearLayoutPanel>-->
                <GridLayoutPanel Key="EnterCode" Caption="扫描" X="0" Y="1">
                    <Format BackColor="#FFFFFF">
                        <Font Size="13"/>
                    </Format>
                    <TextEditor Key="GetMaterialCode" Caption="扫描物料条码" Padding="2px" PromptText="扫描物料条码" BorderStyle="none" Enable="True" X="0" Y="0" XSpan="2">
                        <KeyEnter>
                            <![CDATA[
								PickMaterial();
							]]>
                        </KeyEnter>
                    </TextEditor>
                    <LinearLayoutPanel Key="opt_panel1" X="2" Y="0" Orientation="Horizontal" BorderStyle="solid none">
                        <Button Key="GetMatCode" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none" Height="auto">
                            <Format HAlign="Left"/>
                            <OnClick>
                                <![CDATA[
									PickMaterial();
								]]>
                            </OnClick>
                        </Button>
                    </LinearLayoutPanel>
                    <NumberEditor Key="AddQty" Precision="13" Scale="0" Padding="0px" BorderStyle="none" X="5" Y="0">
                        <DataBinding DefaultValue="1"/>
                        <Format BackColor="transparent">
                            <Font Size="13"/>
                        </Format>
                    </NumberEditor>
                    <Label Key="Lab_AddQty" Caption="增加量" X="4" Y="0">
                        <Format>
                            <Font Size="13"/>
                        </Format>
                    </Label>
                    <NumberEditor Key="TotlePickQty" Precision="13" Scale="0" Padding="0px" BorderStyle="none" X="1" Y="1">
                        <DataBinding DefaultValue="1"/>
                        <Format BackColor="transparent">
                            <Font Size="13"/>
                        </Format>
                    </NumberEditor>
                    <Label Key="Lab_TotlePickQty" Caption="已扫描量" X="0" Y="1">
                        <Format>
                            <Font Size="13"/>
                        </Format>
                    </Label>
                    <NumberEditor Key="LackQty" Precision="18" Scale="0" Enable="false" Padding="0px" BorderStyle="none" X="5" Y="1">
                        <Format BackColor="transparent">
                            <Font Size="13"/>
                        </Format>
                    </NumberEditor>
                    <Label Key="Lab_LackQty" Caption="待扫描量" X="4" Y="1">
                        <Format>
                            <Font Size="13"/>
                        </Format>
                    </Label>
                    <RowDefCollection RowGap="5">
                        <RowDef Height="35px"/>
                        <RowDef Height="35px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="70px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="40px"/>
                        <ColumnDef Width="5px"/>
                        <ColumnDef Width="70px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="40px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <TableView Key="MaterialDetail" X="0" Y="2">
                    <TableRowCollection>
                        <TableRow Key="list" TopMargin="5px" SeparatorStyle="none none solid none" RowType="Detail" SeparatorColor="#b8becc" TableKey="LRP_WMTx_L">
                            <GridLayoutPanel Key="GridLayoutPanel3" Padding="5px" Caption="MaterialDetai">
                                <Label Key="MaterialId" Caption="物料ID" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterialId"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SrcLocationId" Caption="储位ID" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="SrcLocationId"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterilCode" Caption="物料代码" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterilCode"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterilName" Caption="物料名称" Width="pref" Height="auto" X="2" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterilName"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SrcBatchNo" Caption="批号" Width="pref" Height="auto" X="4" Y="0">
                                    <DataBinding ColumnKey="SrcBatchNo"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SrcLocationCode" Caption="储位代码" Width="pref" Height="auto" X="5" Y="0">
                                    <DataBinding ColumnKey="SrcLocationCode"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="PickQty_label" Caption="实拣" Width="pref" X="0" Y="1" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="PickQty" Caption="实拣" Precision="18" Scale="0" Width="pref" Height="auto" Enable="true" X="1" Y="1">
                                    <DataBinding ColumnKey="PickQty">
                                        <ValueChanged>
                                            <![CDATA[
											if(GetValue('PickQty') < 0){
											   SetValue('PickQty',0,false);
											}
											if(GetValue('PickQty') > GetValue('Qty')){
											   SetValue('PickQty',GetValue('Qty'),false);
											}
											CalculatePick();
											]]>
                                        </ValueChanged>
                                    </DataBinding>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Qty_label" Caption="应拣" Width="pref" X="2" Y="1" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="Qty" Caption="应拣" Precision="18" Scale="0" Width="pref" Height="auto" Enable="false" X="3" Y="1">
                                    <DataBinding ColumnKey="Qty"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="MaterialUnit" Caption="单位" Width="pref" Height="auto" X="4" Y="1">
                                    <DataBinding ColumnKey="MaterialUnit"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="40px"/>
                                    <RowDef Height="40px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="3">
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="30%"/>
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="30%"/>
                                    <ColumnDef Width="20%"/>
                                    <ColumnDef Width="20%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef/>
                    <RowDef Height="80px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
			LoadData();		
			CalculatePick();
        ]]>
    </OnLoad>
    <MacroCollection>
        <Macro Key="CalculatePick" Description="计算并设置总未拣量">
            <![CDATA[
				var total = 0.0;
				var picked = 0.0; 
				
				var count = GetRowCount('list');
				var index = 0;
				while(index < count){
					total = total + GetCellValue('list',index,'Qty');
					picked = picked + GetCellValue('list',index,'PickQty');
					index = index + 1;							
				}
				SetValue('TotlePickQty',picked);
				SetValue('LackQty',total - picked);
			]]>
        </Macro>
        <Macro Key="PickMaterial" Description="根据扫入的物料码定位对应的物料并加上增加量">
            <![CDATA[				
				var count = GetRowCount('list');
				var index = 0;
				var Code = GetValue('GetMaterialCode');
				if(Code == "") {return true;}
				var b = false;
				while(index < count){
					var MatrialCode = GetCellValue('list',index,'MaterilCode');
					if(Code == MatrialCode){
						var CellQty = GetCellValue('list',index,'Qty');
						var CellPickQty = GetCellValue('list',index,'PickQty');
						if(CellQty > CellPickQty){
							var CellAdd = GetValue('AddQty');
							CellPickQty = CellPickQty + CellAdd;
							if(CellPickQty > CellQty){
								index = index + 1;
								ShowToast("第" & index & "条明细的实拣量不能超出应拣量");
							}
							else{								
								SetCellValue('list',index,'PickQty',CellPickQty,false);								
								CalculatePick();
							}
							b = true;
							break;
						}
					}
					index = index + 1;							
				}
				
				if(!b) {ShowToast("拣货明细中找不到该条码物料");}
				SetFocus('GetMaterialCode');
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara Formula="Para('OID')" Key="OID" Type="Formula"/>
    </FormParaCollection>
    <NavigationBar Style="Custom" BackColor="#f14c52" ForeColor="#ffffff">
        <BarItem Caption="BarItem1" Key="BarItem1" Location="Center">
            <Label Key="Label1" Caption="二次分拣" Width="150px">
                <Format ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
