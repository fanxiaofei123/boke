<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="TakeStockByLocation" FormType="View">
    <DataSource>
        <DataObject Caption="按储位盘点" Key="LRP_TakeStockByLocation" PrimaryTableKey="TakeStockByLocation">
            <TableCollection>
                <Table Caption="按储位盘点" Key="TakeStockByLocation" SourceType="Query" TableMode="Detail" Persist="false">
                    <Column Caption="物料代码" DataType="Varchar" Key="MaterialCode" Length="100" SortType="Desc"/>
                    <Column Caption="物料名称" DataType="Varchar" Key="MaterialName" Length="200"/>
                    <Column Caption="基本单位" DataType="Varchar" Key="BasicUnit" Length="10"/>
                    <Column Caption="账面量" DataType="Numeric" Key="Qty" Precision="18" Scale="6" DefaultValue="0"/>
                    <Column Caption="批号" Key="BatchNo" DataType="Varchar" Length="100" DefaultValue="*"/>
                    <Column Caption="储位代码" DataType="Varchar" Key="LocationCode" Length="100"/>
                    <Column Caption="仓储中心ID" DataType="Long" Key="WarehouseCenterId"/>
                    <ParameterCollection>
                        <Parameter Formula="GetUserOperator()" DataType="Long"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[
						 select * from (select a.MaterialId,mat.Name as MaterialName,mat.BasicUnit,mat.Code as MaterialCode, a.Qty,a.BatchNo,a.LocationCode,a.WarehouseCenterId from (select L.MaterialId, sum(L.Qty) as Qty, L.BatchNo,loc.Code as LocationCode,H.WarehouseCenterId from LRP_TakeStock_L L join LRP_TakeStock_H H on L.SOID=H.OID join LRP_WarehouseKeeper WK on H.WarehouseCenterId=WK.WarehouseCenterId join LRP_Location loc on L.LocationId=loc.oid where WK.OID=? group by L.MaterialId,L.BatchNo,loc.Code,H.WarehouseCenterId)a left join LRP_Material mat on MaterialId=mat.oid)k
						]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#f1f3f8"/>
                <TableView Key="locationquery_table" X="0" Y="0">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="r0" SeparatorStyle="solid solid solid solid" SeparatorColor="#dde0e7" TopMargin="20px">
                            <LinearLayoutPanel Key="service_panel" Height="50px" Orientation="Horizontal">
                                <TextEditor Key="Location_code" Caption="储位代码" PromptText="扫描储位代码" Weight="1.0" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Height="auto">
                                    <Condition ColumnKey="LocationCode" CondSign="=" TableKey="TakeStockByLocation"/>
                                    <KeyEnter>
                                        <![CDATA[
										if(Location_code<>''){
											DealCondition();LoadData();ShowData();
										}
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Button Key="Locationquery_btn" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none" Height="auto">
                                    <Format HAlign="Left"/>
                                    <OnClick>
                                        <![CDATA[
										if(Location_code<>''){
											DealCondition();LoadData();ShowData();
										}
									]]>
                                    </OnClick>
                                </Button>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r1" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="20px" BottomMargin="20px">
                            <LinearLayoutPanel Key="service_center_panel" Height="50px" Orientation="Horizontal">
                                <TextEditor Key="Material_code" Caption="扫描物料条码" PromptText="扫描物料条码" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Width="110px" Height="auto">
                                    <KeyEnter>
                                        <![CDATA[
										if(Material_code==''){
											return true;
										}
										var flag=false;
										var count = GetRowCount('list',false);
										var i=0;
										while(i<count){
											if(GetCellValue('list', i,'Materialcode')==Material_code && ToInt(GetCellValue('list', i,'QtyDiff'))<0){
												SetFocusRow('list',i);
												SetRowIndex('list',i);
												ScrollTo('list',i);
												SetCellValue('list',i,'CheckQty',ToInt(GetCellValue('list', i,'CheckQty'))+ToInt(AddQty_code));
												flag=true;
												break;
											}
											i=i+1;
										}
										if(flag==false){
											ShowToast("物料明细中找不到该条码物料");
										}
										SetFocus('Material_code');
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Button Key="query_btn" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none" Height="auto">
                                    <Format HAlign="Left"/>
                                    <OnClick>
                                        <![CDATA[
										if(Material_code==''){
											return true;
										}
										var flag=false;
										var count = GetRowCount('list',false);
										var i=0;
										while(i<count){
											if(GetCellValue('list', i,'Materialcode')==Material_code && ToInt(GetCellValue('list', i,'QtyDiff'))<0){
												SetFocusRow('list',i);
												SetRowIndex('list',i);
												ScrollTo('list',i);
												SetCellValue('list',i,'CheckQty',ToInt(GetCellValue('list', i,'CheckQty'))+ToInt(AddQty_code));
												flag=true;
												break;
											}
											i=i+1;
										}
										if(flag==false){
											ShowToast("物料明细中找不到该条码物料");
										}
										
									]]>
                                    </OnClick>
                                </Button>
                                <Label Key="AddQty_lbl" Caption="增加量" Width="40px" Height="auto"/>
                                <NumberEditor Key="AddQty_code" Caption="增加量" Precision="18" Scale="0" Width="50px" Height="auto">
                                    <DataBinding DefaultValue="1"/>
                                </NumberEditor>
                                <Label Key="TakeStockQty_Null_lbl" Caption="总差异量" Width="55px" Height="auto"/>
                                <NumberEditor Key="TakeStockQty_Null_code" Caption="总差异量" Enable="false" Precision="18" Scale="0" Width="55px" Weight="1.0" Height="auto">
                                    <DataBinding DefaultFormulaValue="Sum('QtyDiff')"/>
                                </NumberEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <TableView Key="locationdetail_table" X="0" Y="1">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="list" SeparatorStyle="solid none solid none" RowType="Detail" SeparatorColor="#dde0e7" TableKey="TakeStockByLocation" SelectColor="#dddddd">
                            <GridLayoutPanel Key="GridLayoutPanel3" Caption="GridLayoutPanel3">
                                <Label Key="Materialcode" LeftPadding="5px" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterialCode"/>
                                </Label>
                                <Label Key="MaterialName" LeftPadding="5px" X="2" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterialName"/>
                                </Label>
                                <Label Key="BasicUnit" LeftPadding="5px" X="4" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="BasicUnit"/>
                                </Label>
                                <Label Key="BatchNo_lbl" Caption="批号" LeftPadding="5px" X="6" Y="0" XSpan="2"/>
                                <Label Key="BatchNo" X="8" Y="0" XSpan="4">
                                    <DataBinding ColumnKey="BatchNo"/>
                                </Label>
                                <Label Key="Qty_lbl" Caption="账面量" LeftPadding="5px" X="0" Y="1" XSpan="2"/>
                                <NumberEditor Key="Qty" Precision="18" Scale="0" X="2" Y="1" Enable="false" XSpan="4">
                                    <DataBinding ColumnKey="Qty"/>
                                </NumberEditor>
                                <Label Key="CheckQty_lbl" Caption="实盘量" LeftPadding="5px" X="6" Y="1" XSpan="2"/>
                                <NumberEditor Key="CheckQty" Caption="实盘量" Precision="18" Scale="0" X="8" Y="1" XSpan="4">
                                    <DataBinding DefaultValue="0" VAlign="Bottom">
                                        <ValueChanged>
                                            <![CDATA[SetValue('TakeStockQty_Null_code', Sum('QtyDiff'))]]>
                                        </ValueChanged>
                                    </DataBinding>
                                </NumberEditor>
                                <Label Key="QtyDiff_lbl" Caption="差异" LeftPadding="5px" X="0" Y="2" XSpan="2"/>
                                <Label Key="QtyDiff" X="2" Y="2" Enable="false" XSpan="4">
                                    <DataBinding DefaultFormulaValue="ToInt(CheckQty)-ToInt(Qty)"/>
                                </Label>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="30px"/>
                                    <RowDef Height="40px"/>
                                    <RowDef Height="30px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="1">
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="18%"/>
                                    <ColumnDef Width="80px"/>
                                    <ColumnDef Width="18%"/>
                                    <ColumnDef Width="20px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef Height="150px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="TitleCenter_bar" Caption="按储位盘点" Location="Center">
            <Label Key="TitleCenter" Caption="按储位盘点" Width="150px">
                <Format ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
