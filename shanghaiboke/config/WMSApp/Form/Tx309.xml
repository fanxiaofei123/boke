<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="Tx309" FormType="View">
    <DataSource>
        <DataObject Key="Tx309_do" PrimaryTableKey="Tx309">
            <TableCollection>
                <Table Key="Tx309" Caption="查找订单" TableMode="Detail" SourceType="Query" Persist="false">
                    <Column Key="OID" Caption="对象标识" DataType="Long" DBColumnName="OID"/>
                    <Column Caption="主对象标识" DataType="Long" Key="SOID" DBColumnName="SOID"/>
                    <Column Caption="父对象标识" DataType="Long" Key="POID" DBColumnName="POID"/>
                    <Column Caption="对象版本" DataType="Integer" Key="VERID" DBColumnName="VERID"/>
                    <Column Caption="对象明细版本" DataType="Integer" Key="DVERID" DBColumnName="DVERID"/>
                    <Column Caption="状态" DataType="Integer" Key="Status" DBColumnName="Status"/>
                    <Column Caption="仓储中心" DataType="Long" Key="WarehouseCenterId" DBColumnName="WarehouseCenterId"/>
                    <Column Key="OwnerId" Caption="货主" DataType="Long" DBColumnName="OwnerId"/>
                    <Column Caption="物料" DataType="Long" Key="MaterialId" DBColumnName="MaterialId"/>
                    <Column Caption="在库量" DataType="Numeric" Key="OnhandQty" Precision="18" Scale="6" DBColumnName="OnhandQty"/>
                    <Column Caption="待入量" DataType="Numeric" Key="ExpectInQty" Precision="18" Scale="6" DBColumnName="ExpectInQty"/>
                    <Column Caption="待补货量" DataType="Numeric" Key="ExpectReplenishQty" Precision="18" Scale="6" DBColumnName="ExpectReplenishQty"/>
                    <Column Caption="待出量" DataType="Numeric" Key="ExpectOutQty" Precision="18" Scale="6" DBColumnName="ExpectOutQty"/>
                    <Column Caption="批号" DataType="Varchar" Key="BatchNo" Length="100" DBColumnName="BatchNo"/>
                    <Column Caption="生产日期" DataType="Date" Key="ManufDate" DBColumnName="ManufDate"/>
                    <Column Caption="失效日期" DataType="Date" Key="ExpireDate" DBColumnName="ExpireDate"/>
                    <Column Caption="项目" DataType="Long" Key="ProjectId" DBColumnName="ProjectId"/>
                    <Column Caption="入库日期" DataType="Date" Key="RecvDate" DBColumnName="RecvDate"/>
                    <Column Caption="字符型1" DataType="Varchar" Key="StrUserDef1" Length="100" DBColumnName="StrUserDef1"/>
                    <Column Caption="字符型2" DataType="Varchar" Key="StrUserDef2" Length="100" DBColumnName="StrUserDef2"/>
                    <Column Caption="字符型3" DataType="Varchar" Key="StrUserDef3" Length="100" DBColumnName="StrUserDef3"/>
                    <Column Caption="字符型4" DataType="Varchar" Key="StrUserDef4" Length="100" DBColumnName="StrUserDef4"/>
                    <Column Caption="字符型5" DataType="Varchar" Key="StrUserDef5" Length="100" DBColumnName="StrUserDef5"/>
                    <Column Caption="字典型1" DataType="Long" Key="DictUserDef1" DBColumnName="DictUserDef1"/>
                    <Column Caption="字典型2" DataType="Long" Key="DictUserDef2" DBColumnName="DictUserDef2"/>
                    <Column Caption="字典型3" DataType="Long" Key="DictUserDef3" DBColumnName="DictUserDef3"/>
                    <Column Caption="字典型4" DataType="Long" Key="DictUserDef4" DBColumnName="DictUserDef4"/>
                    <Column Caption="字典型5" DataType="Long" Key="DictUserDef5" DBColumnName="DictUserDef5"/>
                    <Column Caption="日期型1" DataType="Date" Key="DateUserDef1" DBColumnName="DateUserDef1"/>
                    <Column Caption="日期型2" DataType="Date" Key="DateUserDef2" DBColumnName="DateUserDef2"/>
                    <Column Caption="数值型1" DataType="Numeric" Key="NumUserDef1" Precision="18" Scale="6" DBColumnName="NumUserDef1"/>
                    <Column Caption="数值型2" DataType="Numeric" Key="NumUserDef2" Precision="18" Scale="6" DBColumnName="NumUserDef2"/>
                    <Column Caption="数值型3" DataType="Numeric" Key="NumUserDef3" Precision="18" Scale="6" DBColumnName="NumUserDef3"/>
                    <Column Caption="仓间" DataType="Long" Key="StoreroomId" DBColumnName="StoreroomId"/>
                    <Column Caption="储位" DataType="Long" Key="LocationId" DBColumnName="LocationId"/>
                    <Column Caption="物料状态" DataType="Long" Key="MaterialStatusId" DBColumnName="MaterialStatusId"/>
                    <Column Caption="相关单据id" DataType="Long" Key="RefSOID" DBColumnName="RefSOID"/>
                    <Column Caption="相关单据明细id" DataType="Long" Key="RefLineOID" DBColumnName="RefLineOID"/>
                    <Column Caption="容器号" DataType="Varchar" Key="HandingUnitNo" Length="100" DBColumnName="HandingUnitNo"/>
                    <Column Caption="收货区" DataType="Integer" Key="IsRecvArea" DBColumnName="IsRecvArea"/>
                    <Column Caption="发货区" DataType="Integer" Key="IsShipArea" DBColumnName="IsShipArea"/>
                    <Column Caption="样品检验区" DataType="Integer" Key="IsSampleTestArea" DBColumnName="IsSampleTestArea"/>
                    <Column Caption="加工区" DataType="Integer" Key="IsKittingArea" DBColumnName="IsKittingArea"/>
                    <Column Caption="基本单位" DataType="Varchar" Key="BasicUnit" Length="10" DBColumnName="BasicUnit"/>
                    <Column Caption="添加数量" DataType="Numeric" Key="Qty" Precision="18" Scale="6" DBColumnName="Qty"/>
                    <Column Key="RefOrderNo" Caption="订单号" DataType="Varchar"/>
                    <Column Key="WaybillNo" Caption="运单号" DataType="Varchar"/>
                    <Column Key="StoreareaId" Caption="发货区" DataType="Long"/>
                    <Column Key="OwnerNo" Caption="货主单号" DataType="Varchar"/>
                    <Column Key="RecvPartyId" Caption="收货方" DataType="Long"/>
                    <Column Key="CarrierId" Caption="承运商" DataType="Long"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Formula="GetUserOperator()"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[
							select * from (select distinct  OwnerNoTable.WaybillNo,OwnerNoTable.OwnerNo,OwnerNoTable.RecvPartyId,OwnerNoTable.CarrierId,q.*,q.OnhandQty-q.ExpectOutQty as Qty from lrp_quant q join (select No,OwnerId,WaybillNo,OwnerNo,RecvPartyId,CarrierId from LRP_OutboundNotice_H union select No,OwnerId,WaybillNo,OwnerNo,RecvPartyId,CarrierId from LRP_BackNotice_H)OwnerNoTable  on q.RefOrderNo=OwnerNoTable.No join lrp_Storearea s on q.StoreareaId=s.OID join LRP_WarehouseKeeper w on q.WarehouseCenterId=w.WarehouseCenterId join LRP_Location l on q.LocationId=l.oid WHERE q.OnhandQty-q.ExpectOutQty>0 and s.IsShipArea=1 and l.IsLocked=0 and w.oid=?)a
						]]>
                    </Statement>
                </Table>
                <Table Key="Tx309History" Caption="处理历史" TableMode="Detail" SourceType="Query" Persist="false">
                    <Column Key="OID" Caption="OID" DataType="Long"/>
                    <Column Key="No" Caption="单号" DataType="Varchar"/>
                    <Column Key="OwnerId" Caption="货主" DataType="Long"/>
                    <Column Key="TxDateTime" Caption="事务日期时间" DataType="DateTime"/>
                    <Column Key="RefNo" Caption="订单号" DataType="Varchar"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Formula="GetUserOperator()"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[
							select distinct h.OID,h.No,h.OwnerId,h.TxDateTime,h.RefNo from LRP_WMTx_H h join LRP_WarehouseKeeper w on h.WarehouseKeeperId=w.oid where w.oid=? and TxTypeCode='309' order by TxDateTime
						]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <ScriptCollection>
        <Script Key="FormActive" Range="Action" Verb="">
            <![CDATA[
             LoadData();
			]]>
        </Script>
    </ScriptCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Label Key="ShowValue" X="0" Y="0" Visible="false"/>
                <TabGroup Caption="发货区异常品处理" Key="TabPanel1" IndicatorColor="#ff5000" X="0" Y="0">
                    <TabItem Text="查找订单">
                        <Action>
                            <![CDATA[SetValue('ShowValue', 0);]]>
                        </Action>
                    </TabItem>
                    <TabItem Text="处理历史">
                        <Action>
                            <![CDATA[SetValue('ShowValue', 1);]]>
                        </Action>
                    </TabItem>
                </TabGroup>
                <GridLayoutPanel Key="CheckOrder" Caption="查找订单" X="0" Y="1" TopMargin="5px" Visible="ShowValue==0 ||Length(ShowValue) == 0">
                    <TableView Key="CheckOrder_table" X="0" Y="0">
                        <Format BackColor="#f1f3f8"/>
                        <TableRowCollection>
                            <TableRow Key="QueryTable">
                                <GridLayoutPanel Key="GridLayoutPanel" Caption="GridLayoutPanel">
                                    <TextEditor Key="No" Caption="No" X="2" Y="0" BuddyKey="No_lbl" XSpan="2">
                                        <Condition ColumnKey="RefOrderNo" TableKey="Tx309" CondSign="like"/>
                                    </TextEditor>
                                    <Label Key="No_lbl" Caption="订单号" X="0" Y="0" XSpan="2"/>
                                    <Dict Key="OwnerId" Caption="货主" BuddyKey="Lab_OwnerId" X="6" Y="0" ItemKey="LRP_Owner" XSpan="2">
                                        <Condition ColumnKey="OwnerId" TableKey="Tx309" CondSign="="/>
                                    </Dict>
                                    <Label Key="Lab_OwnerId" Caption="货主" X="4" Y="0" XSpan="2"/>
                                    <ComboBox Key="ShipArea" Caption="发货区" BuddyKey="Lab_ShipArea" X="2" Y="1" SourceType="Query" XSpan="2">
                                        <Condition ColumnKey="StoreareaId" TableKey="Tx309" CondSign="="/>
                                        <QueryDef>
                                            <Statement>
                                                <![CDATA[select s.name as code,s.name as value from LRP_Storearea s join LRP_WarehouseKeeper w on s.WarehouseCenterId=w.WarehouseCenterId where s.IsShipArea=1 and w.oid=?]]>
                                            </Statement>
                                            <ParameterCollection>
                                                <Parameter DataType="Long" Formula="GetUserOperator()"/>
                                            </ParameterCollection>
                                        </QueryDef>
                                    </ComboBox>
                                    <Label Key="Lab_ShipArea" Caption="发货区" X="0" Y="1" XSpan="2"/>
                                    <TextEditor Key="OwnerNo" Caption="货主单号" BuddyKey="Lab_OwnerNo" X="6" Y="1" XSpan="2">
                                        <Condition ColumnKey="OwnerNo" TableKey="Tx309" CondSign="like"/>
                                    </TextEditor>
                                    <Label Key="Lab_OwnerNo" Caption="货主单号" X="4" Y="1" XSpan="2"/>
                                    <Button Key="QueryButton" Caption="查找" X="4" Y="2" XSpan="4">
                                        <Format ForeColor="#ffffff" BackColor="#f14c52"/>
                                        <OnClick>
                                            <![CDATA[DealCondition();LoadData();IsShow = 1;]]>
                                        </OnClick>
                                    </Button>
                                    <TextEditor Key="IsShow" Caption="TextEditor1" X="2" Y="2" Visible="false">
                                        <DataBinding DefaultValue="2"/>
                                    </TextEditor>
                                    <RowDefCollection RowGap="1">
                                        <RowDef Height="40px"/>
                                        <RowDef Height="40px"/>
                                        <RowDef Height="40px"/>
                                    </RowDefCollection>
                                    <ColumnDefCollection ColumnGap="1">
                                        <ColumnDef Width="30px"/>
                                        <ColumnDef Width="15%"/>
                                        <ColumnDef Width="30px"/>
                                        <ColumnDef Width="35%"/>
                                        <ColumnDef Width="30px"/>
                                        <ColumnDef Width="15%"/>
                                        <ColumnDef Width="30px"/>
                                        <ColumnDef Width="35%"/>
                                    </ColumnDefCollection>
                                </GridLayoutPanel>
                            </TableRow>
                        </TableRowCollection>
                    </TableView>
                    <ListView Key="listConfirm" Caption="查找订单" TableKey="Tx309" RowHeight="60" TopMargin="10px" X="0" Y="1" Visible="(ShowValue==0 &amp;&amp; IsShow == 1 )||( Length(ShowValue) == 0&amp;&amp; IsShow == 1)">
                        <Format BackColor="#ffffff"/>
                        <ListViewColumnCollection>
                            <ListViewColumn Key="OID" Caption="OID" ColumnType="TextEditor" DataColumnKey="OID"/>
                            <ListViewColumn Key="No_lv" Caption="订单号" ColumnType="TextEditor" DataColumnKey="RefOrderNo">
                                <Format HAlign="Left"/>
                            </ListViewColumn>
                            <ListViewColumn Key="OwnerId_lv" Caption="货主" ColumnType="Dict" DataColumnKey="OwnerId" ItemKey="LRP_Owner"/>
                            <ListViewColumn Key="RefNo_lbl" Caption="运单"/>
                            <ListViewColumn Key="RefNo_lv" Caption="运单" ColumnType="TextEditor" DataColumnKey="WaybillNo"/>
                            <ListViewColumn Key="RecvPartyName_lbl" Caption="收货方"/>
                            <ListViewColumn Key="RecvPartyName_lv" Caption="收货方" ColumnType="TextEditor" DataColumnKey="RecvPartyId"/>
                            <ListViewColumn Key="OwnerNo_lv" Caption="货主单号" ColumnType="TextEditor" DataColumnKey="OwnerNo"/>
                            <ListViewColumn Key="CarrierId" Caption="承运商" ColumnType="Dict" ItemKey="LRP_Carrier" DataColumnKey="CarrierId"/>
                        </ListViewColumnCollection>
                        <RowClick>
                            <![CDATA[
							var table = InvokeService("LRP_Tx309ByShippingQuant", true, true,OID); 
							PushPara('BillNo_para',No_lv);
							PushPara('OwnerNo_para',OwnerNo_lv);
							PushPara('table_para',table);
							PushPara('OwnerId_para',OwnerId_lv);
							New('Tx309Add');	
							]]>
                        </RowClick>
                    </ListView>
                    <RowDefCollection>
                        <RowDef Height="125px"/>
                        <RowDef Height="100%"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="100%"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <GridLayoutPanel Key="CheckHistory" Caption="处理历史" X="0" Y="1" Visible="ShowValue==1">
                    <RefreshControl ColorSchemes="#17bb92" Key="RefreshControl1" Caption="刷新控件" ProgressBackgroundColorScheme="#cccccc" X="0" Y="0">
                        <RefreshHeader Icon="" PromptText="正在加载" FinishText="加载完成">
                            <![CDATA[var show = IsShow;
DealCondition();
LoadData();ShowToast("没有更多的消息了");
IsShow = show;
]]>
                            <Format/>
                        </RefreshHeader>
                        <RefreshFooter Icon="" PromptText="正在加载" FinishText="加载完成">
                            <![CDATA[var show = IsShow;
DealCondition();LoadData();ShowToast("没有更多的消息了");
IsShow = show;]]>
                            <Format/>
                        </RefreshFooter>
                        <ListView Key="listFinish" Caption="处理历史" TableKey="Tx309History" RowHeight="60" Enable="true" SeparatorStyle="solid none solid none" Padding="5px">
                            <ListViewColumnCollection>
                                <ListViewColumn Key="OID_f" Caption="OID" DataColumnKey="OID" ColumnType="TextEditor" Visible="false"/>
                                <ListViewColumn Key="No_f" Caption="发货单号" DataColumnKey="No" ColumnType="TextEditor"/>
                                <ListViewColumn Key="OwnerId_f" Caption="货主" DataColumnKey="OwnerId" ColumnType="Dict" ItemKey="LRP_Owner"/>
                                <ListViewColumn Key="FinishDateTime_f" Caption="事务日期时间" DataColumnKey="TxDateTime" ColumnType="DatePicker">
                                    <Format HAlign="Left">
                                        <Font Size="13"/>
                                    </Format>
                                </ListViewColumn>
                                <ListViewColumn Key="NoticeNo_f" Caption="订单号" DataColumnKey="RefNo" ColumnType="TextEditor"/>
                            </ListViewColumnCollection>
                            <RowClick>
                                <![CDATA[
								Open('Tx309Detail',OID_f);      
							]]>
                            </RowClick>
                        </ListView>
                    </RefreshControl>
                    <RowDefCollection>
                        <RowDef Height="100%"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="100%"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <RowDefCollection>
                    <RowDef Height="50px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
        <ViewCollection>
            <View Key="Confirm">
                <ComponentView Key="listConfirm">
                    <GridLayout Key="listConfirm">
                        <LayoutSpan Key="No_lv" X="0" Y="0"/>
                        <LayoutSpan Key="OwnerId_lv" X="2" Y="0"/>
                        <LayoutSpan Key="RefNo_lbl" X="4" Y="0"/>
                        <LayoutSpan Key="RefNo_lv" X="5" Y="0"/>
                        <LayoutSpan Key="RecvPartyName_lbl" X="0" Y="1"/>
                        <LayoutSpan Key="RecvPartyName_lv" X="1" Y="1"/>
                        <LayoutSpan Key="OwnerNo_lv" X="2" Y="1" XSpan="2"/>
                        <LayoutSpan Key="CarrierId" X="4" Y="1" XSpan="2"/>
                        <RowDefCollection>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                        </RowDefCollection>
                        <ColumnDefCollection>
                            <ColumnDef Width="40%"/>
                            <ColumnDef Width="10px"/>
                            <ColumnDef Width="20%"/>
                            <ColumnDef Width="10px"/>
                            <ColumnDef Width="10%"/>
                            <ColumnDef Width="10px"/>
                            <ColumnDef Width="20%"/>
                        </ColumnDefCollection>
                    </GridLayout>
                </ComponentView>
                <ComponentView Key="listFinish">
                    <GridLayout Key="listFinish">
                        <LayoutSpan Key="No_f" X="0" Y="0"/>
                        <LayoutSpan Key="OwnerId_f" X="1" Y="0"/>
                        <LayoutSpan Key="FinishDateTime_f" X="0" Y="1"/>
                        <LayoutSpan Key="NoticeNo_f" X="1" Y="1"/>
                        <RowDefCollection>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                        </RowDefCollection>
                        <ColumnDefCollection>
                            <ColumnDef Width="50%"/>
                            <ColumnDef Width="50%"/>
                        </ColumnDefCollection>
                    </GridLayout>
                </ComponentView>
            </View>
        </ViewCollection>
    </Body>
    <OnLoad>
        <![CDATA[
			LoadData();
        ]]>
    </OnLoad>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="TitleCenter_bar" Caption="发货区异常品处理" Location="Center">
            <Label Key="TitleCenter" Caption="发货区异常品处理" Width="200px">
                <Format ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
