<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="OrderPay">
    <DataSource>
        <DataObject Key="OrderPay" Caption="支付订单" PrimaryTableKey="OrderPay" PrimaryType="Entity">
            <TableCollection>
                <Table Key="OrderPay" Caption="支付订单">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="SOID" Caption="主对象标识" DataType="Long"/>
                    <Column Key="POID" Caption="父对象标识" DataType="Long"/>
                    <Column Key="VERID" Caption="对象版本" DataType="Integer"/>
                    <Column Key="DVERID" Caption="对象明细版本" DataType="Integer"/>
                    <Column Key="txt_coupon" Caption="优惠券" DataType="Varchar"/>
                    <Column Key="img_selectcoupon" DataType="Varchar"/>
                    <Column Key="txt_balance" Caption="余额支付" DataType="Varchar"/>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Description="获取余额" Key="GetBalance">
            <Statement>
                <![CDATA[
				
				select Balance from LRP_OwnerAccountBalance where OwnerId=? and oid>0
				
			]]>
            </Statement>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="first_head">
                <Format BackColor="#ffffff"/>
                <TableView Caption="TableView1" Key="TableView1" X="0" Y="0">
                    <TableRowCollection>
                        <TableRow Key="row1">
                            <GridLayoutPanel Key="GridLayoutPanel1" Caption="GridLayoutPanel1">
                                <TextEditor Key="OrderDetail" Caption="订单编号" BuddyKey="Lab_OrderDetail" X="2" Y="1" XSpan="4" Enable="false">
                                    <DataBinding DefaultFormulaValue="Para('OrderNo');"/>
                                    <Format HAlign="Left"/>
                                </TextEditor>
                                <Label Key="Lab_OrderDetail" Caption="订单编号" X="1" Y="1"/>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="5px"/>
                                    <RowDef Height="42px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="65px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="10px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                        <TableRow Key="row5">
                            <GridLayoutPanel Key="GridLayoutPanel5" Caption="GridLayoutPanel5">
                                <NumberEditor Key="OrderAmount" Caption="订单金额" BuddyKey="Lab_OrderAmount" X="2" Y="0" XSpan="4" Enable="false">
                                    <DataBinding DefaultFormulaValue="Para('AllAmount')"/>
                                    <Format>
                                        <Font Size="20" Bold="true"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Lab_OrderAmount" Caption="订单金额" X="1" Y="0"/>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="42px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="65px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="10px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                        <TableRow Key="row6">
                            <GridLayoutPanel Key="GridLayoutPanel6" Caption="GridLayoutPanel6">
                                <Label Key="lab_coupon" BuddyKey="Lab_txt_coupon" X="2" Y="0" XSpan="3" Enable="false"/>
                                <TextEditor Key="txt_couponid" Caption="优惠券id" X="2" Y="0" XSpan="3" Visible="false">
                                    <DataBinding>
                                        <ValueChanged>
                                         <![CDATA[SetValue('realamount',InvokeService('LRP_useCouponCalc',false, false , GetValue('txt_couponid'),GetValue('OrderAmount')))]]>
                                        </ValueChanged>
                                    </DataBinding>
                                </TextEditor>
                                <Label Key="Lab_txt_coupon" Caption="优惠券" X="1" Y="0"/>
                                <Image Key="img_selectcoupon" BuddyKey="Lab_img_selectcoupon" X="5" Y="0" Image="more_arrow.png" SourceType="Resource">
                                    <OnClick>
                                        <![CDATA[Show('V_SelectCoupon');]]>
                                    </OnClick>
                                </Image>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="42px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="65px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="10px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <RowClick>
                                <![CDATA[Show('V_SelectCoupon');]]>
                            </RowClick>
                        </TableRow>
                        <TableRow Key="row4">
                            <GridLayoutPanel Key="GridLayoutPanel4" Caption="GridLayoutPanel4">
                                <NumberEditor Key="realamount" Caption="支付金额" BuddyKey="Lab_realamount" X="2" Y="0" Enable="false" XSpan="4">
                                    <DataBinding DefaultFormulaValue="Para('AllAmount')"/>
                                    <Format>
                                        <Font Size="20" Bold="true"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Lab_realamount" Caption="支付金额" X="1" Y="0"/>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="42px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="65px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%"/>
                                    <ColumnDef Width="10px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                        <TableRow Key="row2">
                            <Label Key="lab_paytype" Caption="   选择支付方式" Height="pref"/>
                        </TableRow>
                        <TableRow Key="row3" SeparatorStyle="solid solid solid solid" SeparatorColor="#e6eaf2">
                            <GridLayoutPanel Key="GridLayoutPanel2" Caption="GridLayoutPanel2">
                                <RadioButton Enable="true" GroupKey="paytype" IsGroupHead="true" Key="rb_WX" X="2" Y="1" XSpan="2" Value="wechat"/>
                                <RadioButton GroupKey="paytype" Key="rb_Balance" X="2" Y="3" XSpan="2" Value="amount"/>
                                <TextEditor Key="txt_balance" Caption="余额支付" BuddyKey="Lab_txt_balance" X="1" Y="3" Enable="false">
                                    <Format>
                                        <Font Size="10" Bold="true"/>
                                    </Format>
                                </TextEditor>
                                <Label Key="Lab_txt_balance" Caption="余额支付" X="0" Y="3"/>
                                <Label Key="lab_wechat" Caption="支付宝或微信支付" X="0" Y="1" XSpan="2"/>
                                <Label Key="lab_cash" Caption="现金支付" X="0" Y="5" XSpan="2"/>
                                <RadioButton GroupKey="paytype" Key="rb_cash" Value="cash" X="2" XSpan="2" Y="5"/>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="10px"/>
                                    <RowDef Height="35px"/>
                                    <RowDef Height="10px"/>
                                    <RowDef Height="30px"/>
                                    <RowDef Height="10px"/>
                                    <RowDef Height="30px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="60px"/>
                                    <ColumnDef Width="35%"/>
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="65%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <LinearLayoutPanel Key="opt_pane2" X="0" Y="1" Orientation="Horizontal" BorderColor="Transparent" BorderStyle="solid none">
                    <Button Key="Pay" Caption="立即支付" Visible="true" BorderStyle="none" Height="auto" Weight="1.0" Width="pref">
                        <Format BackColor="#f14c52" ForeColor="#ffffff"/>
                        <OnClick>
                            <![CDATA[
                            if(GetValue('rb_WX')==''){
                            ShowToast("请选择支付方式");return true;}
                            
                            if(GetValue('rb_WX')=='amount'){
                                var newbillno=InvokeService('LRP_getUniqueBillNo',false, false , GetValue('OrderDetail'));
                                InvokeService('LRP_PayByBalance',false, false , newbillno,GetValue('realamount'),GetValue('OrderDetail'));
                                ShowToast("余额支付成功");Parent.LoadData();Close();return true;
                             }
                            
                            if(GetValue('rb_WX')=='wechat'){
                                var newbillno=InvokeService('LRP_getUniqueBillNo',false, false , GetValue('OrderDetail'));
                                Pay(newbillno,'0.01',GetValue('OrderDetail'),"InvokeService('LRP_UpadtePayStatus',false,false,GetValue('OrderDetail'));InvokeService('LRP_updateCouponRecord',false, false ,GetValue('txt_couponid'),Para('pownerid'),GetValue('OrderDetail'));ShowToast('支付成功');Parent.LoadData();Close()","ShowToast('支付失败');Parent.LoadData();Close()");
                            }
                            if(GetValue('rb_WX')=='cash'){
                                var newbillno=InvokeService('LRP_getUniqueBillNo',false, false , GetValue('OrderDetail'));
                                InvokeService('LRP_PayByCash',false, false , newbillno,GetValue('realamount'),GetValue('OrderDetail'));
                                ShowToast("现金支付成功,待确认");Parent.LoadData();Close();return true;
                            }
                            
                            
							]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <RowDefCollection RowGap="8">
                    <RowDef Height="100%"/>
                    <RowDef Height="45px"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
        SetPara('balancepay',DBNamedQueryValue("GetBalance",GetPara('pownerid')));
        SetValue('txt_balance','可用余额:'+GetPara('balancepay'));
        if(GetPara('paychannel')=='amount'){
        SetValue('rb_WX','amount')
        }
        if(GetPara('paychannel')=='wechat' || GetPara('paychannel')=='alipay' || GetPara('paychannel')=='internet'){
        SetValue('rb_WX','wechat')
        }
        ]]>
    </OnLoad>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="OrderTitle_bar" Caption="支付订单" Location="Center">
            <Label Key="OrderTitle" Caption="支付订单" Height="auto" Weight="1.0" Stretch="true">
                <Format ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
