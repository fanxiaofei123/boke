<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="RecInformation">
    <!-- <DataSource RefObjectKey="LRP_OwnerUserRoute"/> -->
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <TableView Key="info_table" X="0" Y="0">
                    <TableRowCollection>
                        <TableRow Key="r1" SeparatorStyle="solid none" SeparatorColor="#b8becc">
                            <LinearLayoutPanel Key="spec_sel_pa" Orientation="Horizontal" Height="50px" LeftPadding="10px">
                                <Label Key="spec_sel_a" Icon="12.png" OnlyIcon="True" Width="30px" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent"/>
                                </Label>
                                <Label Key="spec_sel_m" Caption="请输入地点，如普陀区xx小区" Width="auto" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent"/>
                                </Label>
                            </LinearLayoutPanel>
                            <RowClick>
                                <![CDATA[
										Show('RecvRouteInformation');
								]]>
                            </RowClick>
                        </TableRow>
                        <TableRow Key="r3" SeparatorStyle="solid none" SeparatorColor="#e6eaf2" TopMargin="20px">
                            <LinearLayoutPanel Key="Address_panel" Orientation="Horizontal" Height="50px" LeftPadding="10px">
                                <Label Key="spec_sel_b" Icon="13.png" OnlyIcon="True" Width="40px" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent"/>
                                </Label>
                                <TextEditor Key="Address" Caption="地址" PromptText="请补充详细地址如门牌号（可不填）" BorderStyle="none" Enable="True" Width="0px" Weight="1.0" Height="auto">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </TextEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r4" SeparatorStyle="solid none" SeparatorColor="#e6eaf2" TopMargin="20px">
                            <LinearLayoutPanel Key="Contact_panel" Orientation="Horizontal" Height="50px" LeftPadding="10px">
                                <Label Key="spec_sel_c" Icon="14.png" OnlyIcon="True" Width="30px" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent"/>
                                </Label>
                                <TextEditor Key="Contact" Caption="收货人" Enable="True" PromptText="请输入收货人姓名(可不填)" BorderStyle="none" Width="0px" Weight="1.0" Height="auto">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </TextEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r5" SeparatorStyle="solid none" SeparatorColor="#e6eaf2" TopMargin="20px">
                            <LinearLayoutPanel Key="Tel_panel" Orientation="Horizontal" Height="50px" LeftPadding="10px">
                                <Label Key="spec_sel_d" Icon="15.png" OnlyIcon="True" Width="30px" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent"/>
                                </Label>
                                <TextEditor Key="Tel" Caption="手机" PromptText="请输入收货人手机号(可不填)" BorderStyle="none" Enable="True" Width="0px" Weight="1.0" Height="auto" Precision="11" Scale="0">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </TextEditor>
                                <TextEditor Key="Longitude" Caption="经度" PromptText="请确认经度" BorderStyle="none" Visible="False" Enable="True" Width="0px" Weight="1.0" Height="auto" Precision="11" Scale="0">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </TextEditor>
                                <TextEditor Key="Latitude" Caption="纬度" PromptText="请确认纬度" BorderStyle="none" Visible="False" Enable="True" Width="0px" Weight="1.0" Height="auto" Precision="11" Scale="0">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </TextEditor>
                                <Dict Key="ProvinceId" Caption="省份" Visible="False" PromptText="请确认省份" ItemKey="LRP_Province" BorderStyle="none" Enable="True" Width="0px" Weight="1.0" Height="auto" Precision="11" Scale="0">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </Dict>
                                <Dict Key="CityId" Caption="城市" Visible="False" PromptText="请确认城市" ItemKey="LRP_City" BorderStyle="none" Enable="True" Width="0px" Weight="1.0" Height="auto" Precision="11" Scale="0">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </Dict>
                                <Dict Key="DistrictId" Caption="区县" Visible="False" PromptText="请确认区县" ItemKey="LRP_District" BorderStyle="none" Enable="True" Width="0px" Weight="1.0" Height="auto" Precision="11" Scale="0">
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </Dict>
                            </LinearLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <LinearLayoutPanel Key="opt_panel" X="0" Y="1" Orientation="Horizontal" BorderStyle="solid none">
                    <Button Key="order" Caption="确认" Enable="True" Width="100%" Height="auto" Weight="1.0" BorderStyle="none">
                        <Format BackColor="#f14c52" ForeColor="#ffffff"/>
                        <OnClick>
                            <![CDATA[
							var rowcount=Para('rowcount');
							var formkey=Para('formkey');
							var parentKey = Parent.GetFormKey();

							if(rowcount==-1){
								Parent.SetValue('DestOrgId',GetValue('spec_sel_m'));
								Parent.SetValue('DestAddress',GetValue('Address'));
								Parent.SetValue('DestContact',GetValue('Contact'));
								Parent.SetValue('DestTel',GetValue('Tel'));
								Parent.SetValue('DestLatitude',GetValue('Latitude'));
								Parent.SetValue('DestLongitude',GetValue('Longitude'));
								Parent.SetValue('DestProvinceId',GetValue('ProvinceId'));
								Parent.SetValue('DestCityId',GetValue('CityId'));
								Parent.SetValue('DestDistrictId',GetValue('DistrictId'));
								if(parentKey == "Order" || parentKey == "MainLineOrder" || parentKey == "DriverChangeOrder"){
									Parent.SetValue('spec_sel_Mileage',-1);
									var distance = Parent.InvokeService("LRP_Distance",true,false,GetValue('Longitude'),GetValue('Latitude'),"99",rowcount);
									if(distance != -1){
										var d = distance/1000 ;
										Parent.SetValue('spec_sel_Mileage',d);
										if(parentKey == "Order"){
											var firstPrice = root.GetPara('FirstPrice');
											var firstMileage = root.GetPara('FirstMileage');
											var additionalMileagePrice = root.GetPara('AdditionalMileagePrice');
											
											var price = InvokeService("LRP_SpecialCarCharge",true,false,d,firstPrice,firstMileage,additionalMileagePrice);
											Parent.SetValue('spec_sel_fee',price);
										}
										
										if(parentKey=="MainLineOrder"){									
										Parent.InvokeService("LRP_LTLQuoteByTransportOrder",true,true);
										
										}
										
										if(parentKey=="DriverChangeOrder"){
											Parent.SetValue('spec_sel_fee',-1);
											var OrderType=Para('OrderType');
											if(OrderType == 'FTL'){
												var price = InvokeService("LRP_TruckChargeByTransportOrder",true,false,d,Parent.GetValue('OID'));
												Parent.SetValue('spec_sel_fee',price);
											}
											else{												
											Parent.InvokeService("LRP_LTLQuoteByTransportOrder",true,true);											
											}											
										}
									}
								}
							}

							if(rowcount>=0){
								if(Para('RecType')==1){
									
									if(formkey=='MyNewRoute' || formkey=='MyModifyRoute'){
									   Parent.InsertRow('list');
									   var rowcount=Para('rowcount');
									   Parent.SetCellValue('list',rowcount,'OrgId',spec_sel_m);
									   Parent.SetCellValue('list',rowcount,'Address',Address);
									   Parent.SetCellValue('list',rowcount,'Contact',Contact);
									   Parent.SetCellValue('list',rowcount,'Tel',Tel);
									   Parent.SetCellValue('list',rowcount,'Latitude',Latitude);
							           Parent.SetCellValue('list',rowcount,'Longitude',Longitude);
									   Parent.SetCellValue('list',rowcount,'ProvinceId',ProvinceId);
							           Parent.SetCellValue('list',rowcount,'CityId',CityId);
									   Parent.SetCellValue('list',rowcount,'DistrictId',DistrictId);
									}else{
									   var rowIndex=Para('rowIndex');
									   var rowcount=Para('rowcount')-1;
									   Parent.SetCellValue('list',rowIndex,'OrgId',spec_sel_m);
									   Parent.SetCellValue('list',rowIndex,'Address',Address);
									   Parent.SetCellValue('list',rowIndex,'Contact',Contact);
									   Parent.SetCellValue('list',rowIndex,'Tel',Tel);
									   Parent.SetCellValue('list',rowIndex,'Latitude',Latitude);
							           Parent.SetCellValue('list',rowIndex,'Longitude',Longitude);
									   Parent.SetCellValue('list',rowIndex,'ProvinceId',ProvinceId);
							           Parent.SetCellValue('list',rowIndex,'CityId',CityId);
									   Parent.SetCellValue('list',rowIndex,'DistrictId',DistrictId);
										
										if(parentKey == "Order" || parentKey == "DriverChangeOrder"){
										   Parent.SetValue('spec_sel_Mileage',-1);
										   var distance = Parent.InvokeService("LRP_Distance",true,false,GetValue('Longitude'),GetValue('Latitude'),"50",rowcount);
											if(distance != -1){
												var d = distance/1000 ;
												Parent.SetValue('spec_sel_Mileage',d);
												if(parentKey == "Order"){
													var firstPrice = root.GetPara('FirstPrice');
													var firstMileage = root.GetPara('FirstMileage');
													var additionalMileagePrice = root.GetPara('AdditionalMileagePrice');
													var price = InvokeService("LRP_SpecialCarCharge",true,false,d,firstPrice,firstMileage,additionalMileagePrice);
													Parent.SetValue('spec_sel_fee',price);
												}
												else{
													Parent.SetValue('spec_sel_fee',-1);
													var OrderType=Para('OrderType');
													if(OrderType == 'FTL'){
														var price = InvokeService("LRP_TruckChargeByTransportOrder",true,false,d,Parent.GetValue('OID'));
														Parent.SetValue('spec_sel_fee',price);
													}
													else{												Parent.InvokeService("LRP_LTLQuoteByTransportOrder",true,true);											
													}
												}
											}										 
										}
									}
									
								}else{
									var rowIndex=Para('rowIndex');
									Parent.SetCellValue('list',rowIndex,'OrgId',spec_sel_m);
									Parent.SetCellValue('list',rowIndex,'Address',Address);
									Parent.SetCellValue('list',rowIndex,'Contact',Contact);
									Parent.SetCellValue('list',rowIndex,'Tel',Tel);
									Parent.SetCellValue('list',rowIndex,'Latitude',Latitude);
							        Parent.SetCellValue('list',rowIndex,'Longitude',Longitude);
									Parent.SetCellValue('list',rowIndex,'ProvinceId',ProvinceId);
							        Parent.SetCellValue('list',rowIndex,'CityId',CityId);
									Parent.SetCellValue('list',rowIndex,'DistrictId',DistrictId);
									
								}
							}
						    Parent.ShowData();
							Close();
							]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <RowDefCollection>
                    <RowDef Height="100%"/>
                    <RowDef Height="50px"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
        <Block Root="false" Key="block_spec_sel">
            <PopView Key="pop_spec_sel" Height="155px">
                <GridLayoutPanel Key="pop_spec_sel_panel" Height="140px">
                    <Format BackColor="#ffffff"/>
                    <Label Key="spec_pop_jine" Caption="是否放弃已输入的信息？" X="1" Y="2" XSpan="6" YSpan="2">
                        <Format ForeColor="#000000" HAlign="Center">
                            <Font Size="16"/>
                        </Format>
                    </Label>
                    <Button Key="spec_pop_esc" Caption="放弃" Enable="True" X="0" Y="5" XSpan="4" BorderStyle="solid" BorderColor="#808080" BorderRadius="4" HasBorder="true">
                        <Format BackColor="#ffffff" ForeColor="#aaaaaa"/>
                        <OnClick>
                            <![CDATA[
								ClosePop('pop_spec_sel');Close();
							]]>
                        </OnClick>
                    </Button>
                    <Button Key="spec_pop_ok" Caption="保留" Enable="True" X="4" Y="5" XSpan="4" BorderStyle="solid" BorderColor="#808080" BorderRadius="4" HasBorder="true">
                        <Format BackColor="#ffffff" ForeColor="#ff0000"/>
                        <OnClick>
                            <![CDATA[
								ClosePop('pop_spec_sel');
							]]>
                        </OnClick>
                    </Button>
                    <RowDefCollection>
                        <RowDef Height="10px"/>
                        <RowDef Height="20px"/>
                        <RowDef Height="10px"/>
                        <RowDef Height="40px"/>
                        <RowDef Height="10px"/>
                        <RowDef Height="40px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="40px"/>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="40px"/>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="10px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <OnClose>
                    <![CDATA[
					]]>
                </OnClose>
            </PopView>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
		
			var rowcount=Para('rowcount');
			if(rowcount>=0){
				var rowIndex=Para('rowIndex');
				if(rowIndex==-1){
					Show('RecvRouteInformation');
					return true;
				}
				if(Parent.GetCellValue('list',rowIndex,'OrgId')==''){
					Show('RecvRouteInformation');
					return true;
				}
				SetValue('spec_sel_m',Parent.GetCellValue('list',rowIndex,'OrgId'));
				SetValue('Address',Parent.GetCellValue('list',rowIndex,'Address'));
				SetValue('Contact',Parent.GetCellValue('list',rowIndex,'Contact'));
				SetValue('Tel',Parent.GetCellValue('list',rowIndex,'Tel'));
				SetValue('Latitude',Parent.GetCellValue('list',rowIndex,'Latitude'));
				SetValue('Longitude',Parent.GetCellValue('list',rowIndex,'Longitude'));
				SetValue('ProvinceId',Parent.GetCellValue('list',rowIndex,'ProvinceId'));
				SetValue('CityId',Parent.GetCellValue('list',rowIndex,'CityId'));
				SetValue('DistrictId',Parent.GetCellValue('list',rowIndex,'DistrictId'));
			}
			if(rowcount==-1){
				if(Parent.GetValue('DestOrgId')==''){
					Show('RecvRouteInformation');
					return true;
				}
				SetValue('spec_sel_m',Parent.GetValue('DestOrgId'));
				SetValue('Address',Parent.GetValue('DestAddress'));
				SetValue('Contact',Parent.GetValue('DestContact'));
				SetValue('Tel',Parent.GetValue('DestTel'));
				SetValue('Latitude',Parent.GetValue('DestLatitude'));
				SetValue('Longitude',Parent.GetValue('DestLongitude'));
				SetValue('ProvinceId',Parent.GetValue('DestProvinceId'));
				SetValue('CityId',Parent.GetValue('DestCityId'));
				SetValue('DistrictId',Parent.GetValue('DestDistrictId'));
			}
			
			 ]]>
    </OnLoad>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="OrderTitle_bar" Caption="收货信息" Location="Center">
            <Label Key="OrderTitle" Caption="收货信息" Height="auto" Weight="1.0" Stretch="true">
                <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
        <BarItem Key="Map_bar" Caption="切换地图选点" Location="Right" RightPadding="20px">
            <Button Key="Map" Caption="切换地图选点" Width="100%" Enable="True" Height="auto" Stretch="true">
                <Format BackColor="Transparent" ForeColor="#ffffff" HighlightColor="Transparent" HAlign="Right"/>
                <OnClick>
                    <![CDATA[PushPara('RItype',0);Show('Map');]]>
                </OnClick>
            </Button>
        </BarItem>
        <LeftButton>
            <![CDATA[
		if(Para('Type')==1){
		 if(IsNull(spec_sel_m)){
			 Close();
		 }else{
			 PopView('pop_spec_sel');
		 }
		 }else{
		 Close();
		 }
		]]>
        </LeftButton>
    </NavigationBar>
</Form>
