<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="DriverReceiveOrderList" FormType="Entity">
    <DataSource>
        <DataObject Key="DriverReceiveOrderList" Caption="接单列表">
            <TableCollection>
                <Table Caption="接单列表" Key="DriverReceiveOrderList" SourceType="Query" TableMode="Detail">
                    <Column Key="TDHOID" Caption="调度单id" DataType="Long"/>
                    <Column Key="TJHOID" Caption="作业单id" DataType="Long"/>
                    <Column Key="Status" Caption="作业单状态" DataType="Integer"/>
                    <Column Key="ExpectArriveTime" Caption="预计送达时间" DataType="DateTime"/>
                    <Column Key="SendPartyName" Caption="发货方名称" DataType="Varchar" Length="100"/>
                    <Column Key="SendAddress" Caption="发货方地址" DataType="Varchar" Length="100"/>
                    <Column Key="SendContactor" Caption="发货方联系人" DataType="Varchar" Length="100"/>
                    <Column Key="SendContactMobile" Caption="发货方联系人电话" DataType="Varchar" Length="100"/>
                    <Column Key="RecvPartyName" Caption="收货方名称" DataType="Varchar" Length="100"/>
                    <Column Key="RecvAddress" Caption="收货方地址" DataType="Varchar" Length="100"/>
                    <Column Key="RecvContactor" Caption="收货方联系人" DataType="Varchar" Length="100"/>
                    <Column Key="PayMethod" Caption="付款方式" DataType="Integer"/>
                    <Column Key="TruckTypeId" Caption="车型id" DataType="Long"/>
                    <Column Key="TruckLicenseNo" Caption="车牌号" DataType="Varchar" Length="100"/>
                    <Column Key="Weight" Caption="重量" DataType="Numeric" Precision="18" Scale="2"/>
                    <Column Key="Cubage" Caption="体积" DataType="Numeric" Precision="18" Scale="2"/>
                    <Column Key="Amount" Caption="服务费" DataType="Numeric" Precision="18" Scale="2"/>
                    <Column Key="Freight" Caption="运费" DataType="Numeric" Precision="18" Scale="2"/>
                    <ParameterCollection>
                        <Parameter DataType="DateTime" Formula="DateAdd(ServerDate(),'h',-8)"/>
                        <Parameter DataType="Long" Formula="GetUserOperator()"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[select 
	TDHOID,
    TJHOID,
    TOHOID,
    Status,
	TJHNo,
	DispatchOrgId,
    ExpectArriveTime,
    RecvPartyName,
    RecvAddress,
    RecvContactor,
    SendPartyName,
    SendAddress,
    SendContactor,
    SendContactMobile,
    PayMethod,
	PayStatus,
    TruckTypeId,
    TruckTypeName,
    TruckLicenseNo,
    Weight,
    Cubage,
    Freight,
    Amount
from
    (select 
        TDH.oid TDHOID,
            TJH.oid as TJHOID,
            TOH.oid as TOHOID,
            TJH.Status,
			TJH.No as TJHNo,
			TOH.DispatchOrgId,
            TOH.ExpectArriveTime,
            TOH.RecvPartyName,
            TOH.RecvAddress,
            TOH.RecvContactor,
            TOH.SendPartyName,
            TOH.SendAddress,
            TOH.SendContactor,
            TOH.SendContactMobile,
            TOH.PayMethod,
			TOH.PayStatus,
            TDH.TruckTypeId,
            TT.Name as TruckTypeName,
            TDH.TruckLicenseNo,
            sum(TJML.Weight) as Weight,
            sum(TJML.Cubage) as Cubage,
            sum(TOML.Freight) as Freight
    from
        LRP_TransportDispatch_H TDH
    join LRP_TransportDJ_L TDL ON TDH.oid = TDL.soid
    join LRP_TransportJob_H TJH ON TJH.oid = TDL.TJId
    join LRP_TransportOrder_H TOH ON TJH.OrderNo = TOH.No
    join LRP_TransportJobMat_L TJML ON TJH.oid = TJML.soid
    join LRP_TransportMaterial_L TOML ON TOH.oid = TOML.soid
    left join LRP_TruckType TT ON TDH.TruckTypeId = TT.oid
	where TOH.ExpectArriveTime  > ? and TJH.Status = 710 and TDH.DriverTaskStatus = 0
						and TDH.DriverId = ?
    group by TDH.oid , TOH.oid, TJH.oid , TJH.Status , TJH.No, DispatchOrgId, TOH.ExpectArriveTime , TOH.RecvPartyName , TOH.RecvAddress , TOH.RecvContactor , TOH.SendPartyName , TOH.SendAddress , TOH.SendContactor , TOH.SendContactMobile , TOH.PayMethod , TOH.PayStatus,TDH.TruckTypeId , TT.Name , TDH.TruckLicenseNo) a
        Left join
    (select 
        TOSL.SOID, sum(TOSL.ServiceAmount) as Amount
    from
        LRP_TransportOrderService_L TOSL
    group by TOSL.SOID) b ON a.TOHOID = b.SOID]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <ScriptCollection>
        <Script Key="FormActive" Range="Action" Verb="">
            <![CDATA[LoadData();]]>
        </Script>
    </ScriptCollection>
    <QueryCollection>
        <Query Key="queryVINNo">
            <Statement>
                <![CDATA[
					select VINNo from LRP_Truck where LicenseNo in(select LicenseNo from LRP_DriverSign where DriverId=? and SignStatus=1)
				]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <GridLayoutPanel Key="OrderList" X="0" Y="0">
                    <Label Key="Lab_None" Caption="当前没有待接单据" X="0" Y="0" Visible="GetRowCount('list')==0">
                        <Format ForeColor="#000000" HAlign="Center">
                            <Font Size="26"/>
                        </Format>
                    </Label>
                    <RefreshControl ColorSchemes="#17bb92" Key="RefreshControl1" Caption="刷新控件" ProgressBackgroundColorScheme="#cccccc" X="0" Y="0">
                        <RefreshHeader Icon="" PromptText="正在加载" FinishText="加载完成">
                            <![CDATA[LoadData()]]>
                            <Format/>
                        </RefreshHeader>
                        <RefreshFooter Icon="" PromptText="正在加载" FinishText="加载完成">
                            <![CDATA[LoadData()]]>
                            <Format/>
                        </RefreshFooter>
                        <ListView Key="list" Caption="list" TableKey="DriverReceiveOrderList" RowHeight="145">
                            <ListViewColumnCollection>
                                <ListViewColumn Key="ExpectArriveTime" Enable="false" DataColumnKey="ExpectArriveTime" ColumnType="DatePicker" Format="MM月dd日 HH:mm">
                                    <Format ForeColor="#000000" HAlign="Left">
                                        <Font Size="20"/>
                                    </Format>
                                </ListViewColumn>
                                <ListViewColumn Key="TJHOID" DataColumnKey="TJHOID"/>
                                <ListViewColumn Key="SendPartyImage" ColumnType="Image" SourceType="Resource" Image="26.png" Stretch="true" ImageScaleType="Fit_XY"/>
                                <ListViewColumn Key="SendAddress" DataColumnKey="SendAddress"/>
                                <ListViewColumn Key="RecvPartyImage" ColumnType="Image" SourceType="Resource" Image="27.png" Stretch="true" ImageScaleType="Fit_XY"/>
                                <ListViewColumn Key="RecvAddress" DataColumnKey="RecvAddress"/>
                                <ListViewColumn Key="MoneyImage" ColumnType="Image" SourceType="Resource" Image="28.png" Stretch="true" ImageScaleType="Fit_XY"/>
                                <ListViewColumn Key="Freight" DataColumnKey="Freight" HasBorder="false" ColumnType="NumberEditor" Precision="18">
                                    <Format BackColor="transparent"/>
                                </ListViewColumn>
                                <ListViewColumn Key="Description" Caption="(订单金额)"/>
                                <ListViewColumn Key="MoneyImage1" ColumnType="Image" SourceType="Resource" Image="28.png" Stretch="true" ImageScaleType="Fit_XY"/>
                                <ListViewColumn Key="Amount" DataColumnKey="Amount" HasBorder="false" ColumnType="NumberEditor" Precision="18">
                                    <Format BackColor="transparent"/>
                                </ListViewColumn>
                                <ListViewColumn Key="Description1" Caption="(总收入)"/>
                                <ListViewColumn Key="DriverReceive" Caption="接单" ColumnType="Button" BorderStyle="none">
                                    <OnClick>
                                        <![CDATA[
										InvokeService('LRP_DriverReceiveOrder', false, false, DriverReceiveOrderList.TDHOID);
                                                                                SendSignal('OrderChanged');
										LoadData();
									]]>
                                    </OnClick>
                                    <Format ForeColor="#ffffff" BackColor="#00b676">
                                        <Font Size="16"/>
                                    </Format>
                                </ListViewColumn>
                            </ListViewColumnCollection>
                            <RowClick>
                                <![CDATA[
						  PushPara('TJHOID',DriverReceiveOrderList.TJHOID);
						  Show('DriverReceiveOrder');	         
						]]>
                            </RowClick>
                        </ListView>
                    </RefreshControl>
                    <RowDefCollection>
                        <RowDef Height="100%"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="100%"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <RowDefCollection>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
        <ViewCollection>
            <View Key="All">
                <ComponentView Key="list">
                    <GridLayout Key="list">
                        <LayoutSpan Key="ExpectArriveTime" X="1" Y="1" XSpan="3"/>
                        <LayoutSpan Key="SendPartyImage" X="1" Y="2"/>
                        <LayoutSpan Key="SendAddress" X="2" Y="2" XSpan="2"/>
                        <LayoutSpan Key="RecvPartyImage" X="1" Y="3"/>
                        <LayoutSpan Key="RecvAddress" X="2" Y="3" XSpan="2"/>
                        <LayoutSpan Key="MoneyImage" X="1" Y="4"/>
                        <LayoutSpan Key="Freight" X="2" Y="4"/>
                        <LayoutSpan Key="Description" X="3" Y="4"/>
                        <LayoutSpan Key="MoneyImage1" X="1" Y="5"/>
                        <LayoutSpan Key="Amount" X="2" Y="5"/>
                        <LayoutSpan Key="Description1" X="3" Y="5"/>
                        <LayoutSpan Key="DriverReceive" X="4" Y="1" YSpan="5"/>
                        <RowDefCollection>
                            <RowDef Height="5px"/>
                            <RowDef Height="50px"/>
                            <RowDef Height="20px"/>
                            <RowDef Height="20px"/>
                            <RowDef Height="25px"/>
                            <RowDef Height="25px"/>
                            <RowDef Height="5px"/>
                        </RowDefCollection>
                        <ColumnDefCollection>
                            <ColumnDef Width="5px"/>
                            <ColumnDef Width="20px"/>
                            <ColumnDef Width="100%"/>
                            <ColumnDef Width="90px"/>
                            <ColumnDef Width="40px"/>
                        </ColumnDefCollection>
                    </GridLayout>
                </ComponentView>
            </View>
        </ViewCollection>
    </Body>
    <OnLoad>
        <![CDATA[                   LoadData();
		   var dt=DBNamedQuery('queryVINNo',GetOperator());
		   Root.SetPara('VINNo',dt.VINNo);
              ]]>
    </OnLoad>
    <EventHandlerCollection>
        <EventHandler Key="SessionChanged" Trigger="Show" MergeEvent="true">
            <![CDATA[LoadData()]]>
        </EventHandler>
        <EventHandler Key="Receipt" Trigger="Show" MergeEvent="true">
            <![CDATA[LoadData()]]>
        </EventHandler>
        <EventHandler Key="UserInfoChanged" Trigger="Show" MergeEvent="true">
            <![CDATA[LoadData()]]>
        </EventHandler>
    </EventHandlerCollection>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="Centertitle2" Caption="接单" Location="Center">
            <Label Key="TitleCenter" Caption="接单" Width="60px">
                <Format ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
