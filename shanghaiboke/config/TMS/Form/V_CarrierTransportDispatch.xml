<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Caption="委外运输调度单" FormType="Entity" Key="V_CarrierTransportDispatch">
    <DataSource RefObjectKey="LRP_TransportDispatch"/>
    <OperationCollection>
        <Operation Caption="新增" Key="New" Visible="ReadOnly()">
            <Action>
                <![CDATA[
				New('V_CarrierTransportDispatch');
			]]>
            </Action>
        </Operation>
        <Operation Caption="复制新增" Key="CopyNew" RefKey="CopyNew" ShortCuts="Ctrl+E"/>
        <Operation Caption="保存" Key="Save" ShortCuts="Ctrl+S" Visible="!ReadOnly()&amp;&amp;(Status==StatusValue('prepared')||Status==StatusValue('ontheway'))">
            <Action>
                <![CDATA[	
					if(TransMethod == ""){
						Confirm('承运商不可为空','OK','OK:{}');
						return true;
					}
					if(GetRowCount('Grid0',false)<=0){
						Confirm('明细不可为空','OK','OK:{}');
						return true;
					}
					SaveData();
					var BatchAdd = parent.GetPara('BatchAdd_para');
					if(ToString(BatchAdd) == "1"){
						Parent.ReloadGrid("Grid0");
					}
					UpdateView();
				]]>
            </Action>
        </Operation>
        <Operation Caption="编辑" Key="Edit" Visible="ReadOnly()&amp;&amp;(Status==StatusValue('prepared')||Status==StatusValue('ontheway'))">
            <Action>
                <![CDATA[Edit();]]>
            </Action>
        </Operation>
        <Operation Caption="删除" Key="Delete" ShortCuts="Ctrl+D" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[
						InvokeService("LRP_TransportDispatchDelete", false, false,OID);
						UpdateView();Close();
				]]>
            </Action>
        </Operation>
        <Operation Caption="取消" Key="Cancel" RefKey="Cancel"/>
        <Operation Caption="添加作业单" Key="AddNewDetail" Visible="!ReadOnly()">
            <Action>
                <![CDATA[
				if(Length(TransMethod)>0){
					//SetPara('Form_para',"V_CarrierTransportDispatch");
					//SetPara('TransMethod_para',TransMethod);
					//SetPara('DispatchOrgId_para',DispatchOrgId);
					ShowModal('V_QuoteTransportJobView',{Form_para:"V_CarrierTransportDispatch",TransMethod_para:{TransMethod},DispatchOrgId_para:{DispatchOrgId}});
				}else{
					Confirm('请先选择运输类型', 'OK',{OK:{}});
				}
				]]>
            </Action>
        </Operation>
        <Operation Caption="发车" Key="Depart" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[
				//检查引用的作业单类型是否正确
				var rst = DBNamedQuery('CheckTransportJobDetailStatus',OID);
				var b = false;
				rst.beforefirst();
				while(rst.next()){
					b = true;
				}
				if(b){
					Confirm('明细中发现还未装货的运输作业单，是否自动将其状态改成已装货？','YES_NO_CANCEL',{
						CANCEL:{},
						YES:{SetValue("Par_ChangeDetailStatus",1);Status=StatusValue('ontheway');SaveData();UpdateView();},
						NO:{SetValue("Par_ChangeDetailStatus",0);Status=StatusValue('ontheway');SaveData();UpdateView();}
						});
				}
				else{
					SetValue("Par_ChangeDetailStatus",0);
					Status=StatusValue('ontheway');SaveData();UpdateView();
				}		
				]]>
            </Action>
            <ExceptionHandler>
                <![CDATA[				
				Status=StatusValue('prepared');
			]]>
            </ExceptionHandler>
        </Operation>
        <Operation Caption="撤销发车" Key="Depart-R" Visible="ReadOnly()&amp;&amp;Status==StatusValue('ontheway')">
            <Action>
                <![CDATA[Status=StatusValue('prepared');SaveData();UpdateView();]]>
            </Action>
            <ExceptionHandler>
                <![CDATA[				
				Status=StatusValue('ontheway');
			]]>
            </ExceptionHandler>
        </Operation>
        <Operation Caption="完成" Key="Finish" Visible="ReadOnly()&amp;&amp;Status==StatusValue('ontheway')">
            <Action>
                <![CDATA[Status=StatusValue('finished');SaveData();UpdateView();]]>
            </Action>
            <ExceptionHandler>
                <![CDATA[				
				Status=StatusValue('ontheway');
			]]>
            </ExceptionHandler>
        </Operation>
        <Operation Caption="撤销完成" Key="Finish-R" Visible="ReadOnly()&amp;&amp;Status==StatusValue('finished')">
            <Action>
                <![CDATA[Status=StatusValue('ontheway');SaveData();UpdateView();]]>
            </Action>
            <ExceptionHandler>
                <![CDATA[				
				Status=StatusValue('finished');
			]]>
            </ExceptionHandler>
        </Operation>
        <Operation Caption="费用计算" Key="ExpenseLineCharge">
            <Action>
                <![CDATA[
				ShowModal('V_C_ExpenseLine_LRP',{dispatchorgOIDs_para:{DispatchOrgId},No_para:{No},pDateField:{"OrderDateTime"},oid_para:{GetOID()}});
				]]>
            </Action>
        </Operation>
        <Operation Caption="关闭界面" Key="Close" RefKey="Close"/>
        <Operation Key="SendRailway" Caption="发站月台预约" Enable="ReadOnly()&amp;&amp;Status &lt; 900">
            <Action>
                <![CDATA[
var select1 = 0;
var selectTransportJobNo = 0;
var selectTJId = 0;
var selectSendOrg= 0;
loop "Grid0" (true){
    if(Select == true){
        select1 = select1 + 1;
        if(select1 > 1){
             Confirm("只能选择一条运输作业单明细");
            return true;
        }
        if(SendOrg == "" || IsNull(SendOrg)){
           Confirm("发站不能为空！！");
            return true;
        }
         selectTransportJobNo =  TransportJobNo;
         selectTJId = TJId;
         selectSendOrg= SendOrg;       
    } 
}
if(select1==0){
    Confirm("请选择一条运输作业单明细。");
    return true;
}

PlatformOrder2(
    5, 
   SendOrg,
    selectTJId,
    selectTransportJobNo,
    CarrierId,
    TruckLicenseNo,Driver,DriverMobile);

   

 
]]>
            </Action>
        </Operation>
        <Operation Key="DestRailway" Caption="到站月台预约" Enable="ReadOnly()&amp;&amp;Status &lt; 900">
            <Action>
                <![CDATA[
var select1 = 0;
var selectTransportJobNo = 0;
var selectTJId = 0;
var selectSendOrg= 0;
loop "Grid0" (true){
    if(Select == true){
        select1 = select1 + 1;
        if(select1 > 1){
             Confirm("只能选择一条运输作业单明细");
            return true;
        }
        if(DestOrg == "" || IsNull(DestOrg)){
           Confirm("到站不能为空！！");
            return true;
        }
         selectTransportJobNo =  TransportJobNo;
         selectTJId = TJId; 
          selectSendOrg= SendOrg;           
    } 
}
if(select1==0){
    Confirm("请选择一条运输作业单明细。");
    return true;
}
PlatformOrder2(
    6, 
   SendOrg,
    selectTJId,
    selectTransportJobNo,
    CarrierId,
    TruckLicenseNo,Driver,DriverMobile);]]>
            </Action>
        </Operation>
    </OperationCollection>
    <QueryCollection>
        <Query Description="读取引用的作业单明细的详细信息" Key="GetTransportJobDetails">
            <Statement>
                <![CDATA[				
		select j.* from LRP_TransportJob_H j join LRP_TransportDJ_L l on j.oid =l.TJId where l.SOID =?				
			]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
        <Query Description="读取引用的作业单明细的状态中是否有小于已装货" Key="CheckTransportJobDetailStatus">
            <Statement>
                <![CDATA[				
		select j.* from LRP_TransportJob_H j join LRP_TransportDJ_L l on j.oid =l.TJId where l.SOID =? and 	j.Status<730		
			]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
        <Query Key="QueryOid" Description="查询月台预约单oid">
            <Statement DBType="MySql">
                <![CDATA[SELECT oid FROM LRP_PlatformReservation WHERE RefNo = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="main">
                <ToolBar Height="pref" Key="main_toolbar">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="main_split" Orientation="Vertical">
                    <TabPanel Caption="TabPanel0" Key="TabPanel0">
                        <GridLayoutPanel Caption="基本信息" Key="BasicTab" Padding="10px">
                            <TextEditor Caption="调度单号" Enable="false" Key="No" X="1" XSpan="2" Y="0">
                                <DataBinding ColumnKey="No" TableKey="LRP_TransportDispatch_H"/>
                            </TextEditor>
                            <Label Caption="调度单号" Key="L_No" X="0" Y="0"/>
                            <ComboBox Caption="运输类型" Key="TransMethod" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="5" XSpan="2" Y="0">
                                <DataBinding ColumnKey="TransMethod" TableKey="LRP_TransportDispatch_H" Required="true" DefaultValue="808"/>
                                <Item Caption="外车" Key="808" Value="808"/>
                                <Item Caption="水运" Key="809" Value="809"/>
                                <Item Caption="空运" Key="810" Value="810"/>
                                <Item Caption="铁运" Key="811" Value="811"/>
                            </ComboBox>
                            <Label Caption="运输类型" Key="L_TransMethod" X="4" Y="0"/>
                            <Dict BuddyKey="Lab_CarrierId" Caption="承运商" ItemKey="LRP_Carrier" Key="CarrierId" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="9" XSpan="2" Y="0">
                                <DataBinding ColumnKey="CarrierId" TableKey="LRP_TransportDispatch_H" Required="true"/>
                            </Dict>
                            <Label Caption="承运商" Key="Lab_CarrierId" X="8" Y="0"/>
                            <GridLayoutPanel Caption="车辆信息" Key="TruckMessager" X="0" XSpan="3" Y="1">
                                <TextEditor Caption="车牌号" Key="TruckLicenseNo" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="1" Y="0">
                                    <DataBinding ColumnKey="TruckLicenseNo" TableKey="LRP_TransportDispatch_H"/>
                                </TextEditor>
                                <Label Caption="车牌号" Key="L_TruckLicenseNo" X="0" Y="0"/>
                                <Dict Caption="车型" Key="TruckTypeId" ItemKey="LRP_TruckType" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="3" Y="0">
                                    <DataBinding ColumnKey="TruckTypeId" TableKey="LRP_TransportDispatch_H"/>
                                </Dict>
                                <Label Caption="车型" Key="L_TruckTypeId" X="2" Y="0"/>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="100%"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="4">
                                    <ColumnDef Width="70px"/>
                                    <ColumnDef Width="50%" MinWidth="20px"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%" MinWidth="20px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <GridLayoutPanel Caption="司机信息" Key="DriverMessager" X="4" XSpan="3" Y="1">
                                <TextEditor Caption="司机" Key="Driver" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="1" Y="0">
                                    <DataBinding ColumnKey="Driver" TableKey="LRP_TransportDispatch_H"/>
                                </TextEditor>
                                <Label Caption="司机" Key="L_Driver" X="0" Y="0"/>
                                <TextEditor Caption="手机" Key="DriverMobile" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="3" Y="0">
                                    <DataBinding ColumnKey="DriverMobile" TableKey="LRP_TransportDispatch_H"/>
                                </TextEditor>
                                <Label Caption="手机" Key="L_DriverMobile" X="2" Y="0"/>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="100%"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="4">
                                    <ColumnDef Width="70px"/>
                                    <ColumnDef Width="50%" MinWidth="20px"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%" MinWidth="20px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <TextEditor Caption="航班号" Key="FlightNo" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="9" XSpan="2" Y="1">
                                <DataBinding ColumnKey="FlightNo" TableKey="LRP_TransportDispatch_H"/>
                            </TextEditor>
                            <Label Caption="航班号" Key="L_FlightNo" X="8" Y="1"/>
                            <TextEditor Caption="铁路车次" Key="TrainNo" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="1" XSpan="2" Y="2">
                                <DataBinding ColumnKey="TrainNo" TableKey="LRP_TransportDispatch_H"/>
                            </TextEditor>
                            <Label Caption="铁路车次" Key="L_TrainNo" X="0" Y="2"/>
                            <TextEditor Caption="车皮号" Key="WagonNo" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="5" XSpan="2" Y="2">
                                <DataBinding ColumnKey="WagonNo" TableKey="LRP_TransportDispatch_H"/>
                            </TextEditor>
                            <Label Caption="车皮号" Key="L_WagonNo" X="4" Y="2"/>
                            <GridLayoutPanel Caption="水运信息" Key="VoyageMessager" X="8" XSpan="3" Y="2">
                                <TextEditor Caption="船名" Key="VesselName" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="1" Y="0">
                                    <DataBinding ColumnKey="VesselName" TableKey="LRP_TransportDispatch_H"/>
                                </TextEditor>
                                <Label Caption="船名" Key="L_VesselName" X="0" Y="0"/>
                                <TextEditor Caption="航次" Key="VoyageNo" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" X="3" Y="0">
                                    <DataBinding ColumnKey="VoyageNo" TableKey="LRP_TransportDispatch_H"/>
                                </TextEditor>
                                <Label Caption="航次" Key="L_VoyageNo" X="2" Y="0"/>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="100%"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="4">
                                    <ColumnDef Width="70px"/>
                                    <ColumnDef Width="50%" MinWidth="20px"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="50%" MinWidth="20px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <GridLayoutPanel Caption="地址信息" Key="AddressMessager" X="0" XSpan="11" Y="3">
                                <Dict BuddyKey="Lab_StartProvinceId" Caption="起运省" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" ItemKey="LRP_Province" Key="StartProvinceId" X="1" Y="0">
                                    <DataBinding ColumnKey="StartProvinceId" TableKey="LRP_TransportDispatch_H" Required="true" ErrorInfo="起运省不能为空"/>
                                </Dict>
                                <Label Caption="起运省" Key="Lab_StartProvinceId" X="0" Y="0"/>
                                <Dict BuddyKey="Lab_StartCityId" Caption="市" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" ItemKey="LRP_City" Key="StartCityId" X="3" Y="0">
                                    <DataBinding ColumnKey="StartCityId" TableKey="LRP_TransportDispatch_H" Required="true" ErrorInfo="起运市不能为空"/>
                                    <ItemFilter ItemKey="LRP_City">
                                        <Filter Type="FieldValue">
                                            <FilterValue FieldKey="ProvinceId" RefValue="StartProvinceId" Type="Field"/>
                                        </Filter>
                                    </ItemFilter>
                                </Dict>
                                <Label Caption="市" Key="Lab_StartCityId" X="2" Y="0"/>
                                <Dict BuddyKey="Lab_StartDistrictId" Caption="区县" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" ItemKey="LRP_District" Key="StartDistrictId" X="5" Y="0">
                                    <DataBinding ColumnKey="StartDistrictId" TableKey="LRP_TransportDispatch_H"/>
                                    <ItemFilter ItemKey="LRP_District">
                                        <Filter Type="FieldValue">
                                            <FilterValue FieldKey="SOID" RefValue="StartCityId" Type="Field"/>
                                        </Filter>
                                    </ItemFilter>
                                </Dict>
                                <Label Caption="区县" Key="Lab_StartDistrictId" X="4" Y="0"/>
                                <Dict BuddyKey="Lab_EndProvinceId" Caption="目的省" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" ItemKey="LRP_Province" Key="EndProvinceId" X="7" Y="0">
                                    <DataBinding ColumnKey="EndProvinceId" TableKey="LRP_TransportDispatch_H" Required="true" ErrorInfo="目的省不能为空"/>
                                </Dict>
                                <Label Caption="目的省" Key="Lab_EndProvinceId" X="6" Y="0"/>
                                <Dict BuddyKey="Lab_EndCityId" Caption="市" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" ItemKey="LRP_City" Key="EndCityId" X="9" Y="0">
                                    <DataBinding ColumnKey="EndCityId" TableKey="LRP_TransportDispatch_H" Required="true" ErrorInfo="目的市不能为空"/>
                                    <ItemFilter ItemKey="LRP_City">
                                        <Filter Type="FieldValue">
                                            <FilterValue FieldKey="ProvinceId" RefValue="EndProvinceId" Type="Field"/>
                                        </Filter>
                                    </ItemFilter>
                                </Dict>
                                <Label Caption="市" Key="Lab_EndCityId" X="8" Y="0"/>
                                <Dict BuddyKey="Lab_EndDistrictId" Caption="区县" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" ItemKey="LRP_District" Key="EndDistrictId" X="11" Y="0">
                                    <DataBinding ColumnKey="EndDistrictId" TableKey="LRP_TransportDispatch_H"/>
                                    <ItemFilter ItemKey="LRP_District">
                                        <Filter Type="FieldValue">
                                            <FilterValue FieldKey="SOID" RefValue="EndCityId" Type="Field"/>
                                        </Filter>
                                    </ItemFilter>
                                </Dict>
                                <Label Caption="区县" Key="Lab_EndDistrictId" X="10" Y="0"/>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="100%"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="4">
                                    <ColumnDef Width="70px"/>
                                    <ColumnDef Width="16%" MinWidth="20px"/>
                                    <ColumnDef Width="30px"/>
                                    <ColumnDef Width="16%" MinWidth="20px"/>
                                    <ColumnDef Width="30px"/>
                                    <ColumnDef Width="16%" MinWidth="20px"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="17%" MinWidth="20px"/>
                                    <ColumnDef Width="30px"/>
                                    <ColumnDef Width="17%" MinWidth="20px"/>
                                    <ColumnDef Width="30px"/>
                                    <ColumnDef Width="17%" MinWidth="20px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <DatePicker Caption="下单日期时间" Enable="false" Key="OrderDateTime" X="1" XSpan="2" Y="4">
                                <DataBinding ColumnKey="OrderDateTime" DefaultFormulaValue="ServerDate()" TableKey="LRP_TransportDispatch_H"/>
                            </DatePicker>
                            <Label Caption="下单日期时间" Key="L_OrderDateTime" X="0" Y="4"/>
                            <ComboBox Caption="状态" Enable="false" Key="Status" SourceType="Formula" X="9" XSpan="2" Y="4">
                                <DataBinding ColumnKey="Status" TableKey="LRP_TransportDispatch_H" DefaultValue="100"/>
                                <FormulaItems>
                                    <![CDATA[
									GetStatusItems();
								]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Caption="状态" Key="L_Status" X="8" Y="4"/>
                            <TextEditor BuddyKey="Lab_Remark" Caption="备注" Enable="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')" Key="Remark" X="1" XSpan="6" Y="5">
                                <DataBinding ColumnKey="Remark" TableKey="LRP_TransportDispatch_H"/>
                            </TextEditor>
                            <Label Caption="备注" Key="Lab_Remark" X="0" Y="5"/>
                            <Dict BuddyKey="Lab_DispatchOrgId" Caption="调度组织" ItemKey="LRP_DispatchOrg" Key="DispatchOrgId" Visible="false" X="9" XSpan="2" Y="6">
                                <DataBinding ColumnKey="DispatchOrgId" DefaultFormulaValue="getCurDispatchOrgID()" TableKey="LRP_TransportDispatch_H"/>
                            </Dict>
                            <Label Caption="调度组织" Key="Lab_DispatchOrgId" Visible="false" X="8" Y="6"/>
                            <TextEditor BuddyKey="Lab_OID" Caption="OID" Enable="false" Key="OID" Visible="false" X="1" Y="6">
                                <DataBinding ColumnKey="OID" TableKey="LRP_TransportDispatch_H"/>
                            </TextEditor>
                            <Label Caption="OID" Key="Lab_OID" X="0" Y="6"/>
                            <Label Caption="0" Key="FirstLoad" Visible="false" X="0" Y="0"/>
                            <Label Caption="Par_ChangeDetailStatus" Key="Par_ChangeDetailStatus" Visible="false" X="0" Y="0"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="4">
                                <ColumnDef Width="70px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="70px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="70px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <GridLayoutPanel Caption="系统信息" Height="pref" Key="SystemInfo" Padding="10px">
                            <Label Caption="创建人" Key="L_CREATOR" X="0" Y="0"/>
                            <Dict BuddyKey="L_CREATOR" Caption="创建人" Enable="false" ItemKey="Operator" Key="CREATOR" X="1" XSpan="2" Y="0">
                                <DataBinding ColumnKey="CREATOR" DefaultFormulaValue="GetOperator()" TableKey="LRP_TransportDispatch_H"/>
                            </Dict>
                            <DatePicker Caption="修改时间" Enable="false" Key="MODIFYTIME" X="5" XSpan="2" Y="1">
                                <DataBinding ColumnKey="MODIFYTIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_TransportDispatch_H"/>
                            </DatePicker>
                            <Label Caption="修改时间" Key="L_MODIFYTIME" X="4" Y="1"/>
                            <DatePicker Caption="创建时间" Enable="false" Key="CREATETIME" X="1" XSpan="2" Y="1">
                                <DataBinding ColumnKey="CREATETIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_TransportDispatch_H"/>
                            </DatePicker>
                            <Label Caption="创建时间" Key="L_CREATETIME" X="0" Y="1"/>
                            <Dict Caption="修改人" Enable="false" ItemKey="Operator" Key="MODIFIER" X="5" XSpan="2" Y="0">
                                <DataBinding ColumnKey="MODIFIER" DefaultFormulaValue="GetOperator()" TableKey="LRP_TransportDispatch_H"/>
                            </Dict>
                            <Label Caption="修改人" Key="L_MODIFIER" X="4" Y="0"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="50%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="50%" MinWidth="50px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <TabPanel Caption="TabPanel1" Key="TabPanel1">
                        <GridLayoutPanel Caption="运输作业单明细" Key="DetailTab">
                            <Grid Caption="运输作业单明细" Key="Grid0" CanInsert="false" NewEmptyRow="false" X="0" Y="0">
                                <GridColumnCollection>
                                    <GridColumn Caption="选择" Key="Select" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="作业单ID" Key="TJId" Visible="false" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="状态" Key="DetailStatus" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="作业单号" Key="TransportJobNo" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="运输订单号" Key="OrderNo" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="货主" Key="OwnerId" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="下单日期时间" Key="TransportJobOrderDateTime" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="收货方" Key="RecvPartyName" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="收货地址" Key="RecvAddress" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="发货方" Key="SendPartyName" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="发货地址" Key="SendAddress" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="发站" Key="SendOrg" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="到站" Key="DestOrg" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="作业单类型" Key="JobType" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="运输要求" Key="Requirement" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="代收货款" Key="AgencyFund" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="付款方式" Key="PayMethod" Width="80px" Sortable="true"/>
                                </GridColumnCollection>
                                <GridRowCollection>
                                    <GridRow Key="R3" TableKey="LRP_TransportDJ_L">
                                        <GridCell Caption="选择" CellType="CheckBox" IsSelect="true" Key="Select" Enable="true"/>
                                        <GridCell Caption="作业单ID" CellType="TextEditor" Enable="false" Key="TJId">
                                            <DataBinding ColumnKey="TJId" Required="true"/>
                                        </GridCell>
                                        <GridCell Caption="状态" CellType="ComboBox" Enable="false" SourceType="Status" Key="DetailStatus"/>
                                        <GridCell Caption="作业单号" CellType="HyperLink" Enable="true" Key="TransportJobNo">
                                            <OnClick>
                                                <![CDATA[	
													if(JobType == "701"){
														Open('V_701', TJId);
													}
													if(JobType == "702"){
														Open('V_702', TJId);
													}
													if(JobType == "703"){
														Open('V_703', TJId);
													}
													if(JobType == "704"){
														Open('V_704', TJId);
													}
													if(JobType == "705"){
														Open('V_705', TJId);
													}
													if(JobType == "706"){
														Open('V_706', TJId);
													}
												]]>
                                            </OnClick>
                                        </GridCell>
                                        <GridCell Caption="运输订单号" CellType="TextEditor" Enable="false" Key="OrderNo" OnlyDate="false"/>
                                        <GridCell Caption="货主" CellType="Dict" Enable="false" ItemKey="LRP_Owner" Key="OwnerId"/>
                                        <GridCell Caption="下单日期时间" CellType="DatePicker" Enable="false" Key="TransportJobOrderDateTime"/>
                                        <GridCell Caption="收货方" CellType="TextEditor" Enable="false" Key="RecvPartyName"/>
                                        <GridCell Caption="收货地址" CellType="TextEditor" Enable="false" Key="RecvAddress"/>
                                        <GridCell Caption="发货方" CellType="TextEditor" Enable="false" Key="SendPartyName"/>
                                        <GridCell Caption="发货地址" CellType="TextEditor" Enable="false" Key="SendAddress"/>
                                        <GridCell Caption="发站" CellType="Dict" Enable="false" Key="SendOrg" ItemKey="LRP_WarehouseCenter"/>
                                        <GridCell Caption="到站" CellType="Dict" Enable="false" Key="DestOrg" ItemKey="LRP_WarehouseCenter"/>
                                        <GridCell Caption="作业单类型" CellType="ComboBox" Enable="false" Key="JobType">
                                            <Item Caption="提货" Key="701" Value="701"/>
                                            <Item Caption="配送" Key="702" Value="702"/>
                                            <Item Caption="中转" Key="703" Value="703"/>
                                            <Item Caption="直发" Key="704" Value="704"/>
                                            <Item Caption="自送" Key="705" Value="705"/>
                                            <Item Caption="自提" Key="706" Value="706"/>
                                            <Item Caption="客退" Key="707" Value="707"/>
                                        </GridCell>
                                        <GridCell Caption="运输要求" CellType="TextEditor" Enable="false" Key="Requirement"/>
                                        <GridCell Caption="代收货款" CellType="NumberEditor" Enable="false" Key="AgencyFund"/>
                                        <GridCell Caption="付款方式" CellType="ComboBox" Enable="false" Key="PayMethod">
                                            <Item Caption="现付" Key="0" Value="0"/>
                                            <Item Caption="回单付 " Key="1" Value="1"/>
                                            <Item Caption="月结 " Key="2" Value="2"/>
                                            <Item Caption="到付 " Key="3" Value="3"/>
                                            <Item Caption="预付 " Key="4" Value="4"/>
                                            <Item Caption="提付" Key="5" Value="5"/>
                                        </GridCell>
                                    </GridRow>
                                </GridRowCollection>
                            </Grid>
                            <RowDefCollection RowGap="2">
                                <RowDef Height="100%"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="4">
                                <ColumnDef Width="100%"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <SplitSize Size="270px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnPostShow>
        <![CDATA[
		if(!IsNew()){
			RefreshTransportJobDetails();
		}
		if(Length(GetValue("FirstLoad")) == 0){
			SetValue("FirstLoad", "1");
			var BatchAdd = parent.GetPara('BatchAdd_para');
			if(ToString(BatchAdd) == "1"){
				//从批量调度窗口复制数据				
				var count = Parent.GetRowCount('Grid0',false);
				var i=0;				
				while ( i < count ){
					if(Parent.GetCellValue('Grid0', i, 'Select')){
						var index = InsertRow('Grid0',-1);
						SetCellValue('Grid0', index,'TJId',Parent.GetCellValue('Grid0', i, 'OID'));
						SetCellValue('Grid0', index,'DetailStatus',Parent.GetCellValue('Grid0', i, 'Status'));
						SetCellValue('Grid0', index,'TransportJobNo',Parent.GetCellValue('Grid0', i, 'No'));
						SetCellValue('Grid0', index,'JobType',Parent.GetCellValue('Grid0', i, 'JobType'));
						SetCellValue('Grid0', index,'OrderNo',Parent.GetCellValue('Grid0', i, 'OrderNo'));
						SetCellValue('Grid0', index,'OwnerId',Parent.GetCellValue('Grid0', i, 'OwnerId'));
						SetCellValue('Grid0', index,'TransportJobOrderDateTime',Parent.GetCellValue('Grid0', i, 'OrderDateTime'));
						SetCellValue('Grid0', index,'RecvPartyName',Parent.GetCellValue('Grid0', i, 'RecvPartyName'));
						SetCellValue('Grid0', index,'RecvAddress',Parent.GetCellValue('Grid0', i, 'RecvAddress'));
						SetCellValue('Grid0', index,'SendPartyName',Parent.GetCellValue('Grid0', i, 'SendPartyName'));
						SetCellValue('Grid0', index,'SendAddress',Parent.GetCellValue('Grid0', i, 'SendAddress'));
						SetCellValue('Grid0', index,'SendOrg',Parent.GetCellValue('Grid0', i, 'SendOrg'));
						SetCellValue('Grid0', index,'DestOrg',Parent.GetCellValue('Grid0', i, 'DestOrg'));
						
						SetCellValue('Grid0', index,'Requirement',Parent.GetCellValue('Grid0', i, 'Requirement'));
						SetCellValue('Grid0', index,'AgencyFund',Parent.GetCellValue('Grid0', i, 'AgencyFund'));
						SetCellValue('Grid0', index,'PayMethod',Parent.GetCellValue('Grid0', i, 'PayMethod'));
					}
					i = i + 1;
				}
			}
		}
		
	]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="RefreshTransportJobDetails">
            <![CDATA[			
			//读取作业单引用并填入明细表			
			var rst = DBNamedQuery('GetTransportJobDetails',OID);
			rst.beforefirst();
			while(rst.next()){
				var b = false;
				var index = 0;
				loop"Grid0"(true){
					if(rst.OID == TJId){
						b = true;
						
						//复制明细
						SetCellValue('Grid0', index,'DetailStatus',rst.Status);
						SetCellValue('Grid0', index,'TransportJobNo',rst.No);
						SetCellValue('Grid0', index,'JobType',rst.JobType);
						SetCellValue('Grid0', index,'OrderNo',rst.OrderNo);
						SetCellValue('Grid0', index,'OwnerId',rst.OwnerId);
						SetCellValue('Grid0', index,'TransportJobOrderDateTime',rst.OrderDateTime);
						SetCellValue('Grid0', index,'RecvPartyName',rst.RecvPartyName);
						SetCellValue('Grid0', index,'RecvAddress',rst.RecvAddress);
						SetCellValue('Grid0', index,'SendPartyName',rst.SendPartyName);
						SetCellValue('Grid0', index,'SendAddress',rst.SendAddress);
						SetCellValue('Grid0', index,'SendOrg',rst.SendOrg);
						SetCellValue('Grid0', index,'DestOrg',rst.DestOrg);
						SetCellValue('Grid0', index,'Requirement',rst.Requirement);
						SetCellValue('Grid0', index,'AgencyFund',rst.AgencyFund);
						SetCellValue('Grid0', index,'PayMethod',rst.PayMethod);
					}
					index = index + 1;
				}
			}				
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara Key="Par_ChangeDetailStatus" Type="Formula" Formula="GetValue({Par_ChangeDetailStatus})"/>
    </FormParaCollection>
</Form>
