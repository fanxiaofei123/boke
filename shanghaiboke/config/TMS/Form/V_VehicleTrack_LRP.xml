<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_VehicleTrack_LRP" Caption="车辆运行轨迹" FormType="Report">
    <DataSource RefObjectKey="LRP_VehicleTrack"/>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="root" Caption="根面板">
                <SplitPanel Key="SplitPanel1" Height="100%" Caption="SplitPanel1" Width="100%">
                    <SplitPanel Key="SplitPanel2" Orientation="Vertical" Height="100%" Caption="SplitPanel2" Width="100%" BottomMargin="4px" LeftMargin="4px" Margin="4px" RightMargin="4px" TopMargin="4px">
                        <GridLayoutPanel Key="GridLayoutPanel1" Caption="GridLayoutPanel1" BottomMargin="4px" LeftMargin="4px" RightMargin="4px" TopMargin="4px">
                            <Dict Key="Truck_C" Caption="车辆" BuddyKey="Lab_Truck_C" X="1" Y="0" ItemKey="LRP_Truck">
                                <Condition ColumnKey="TruckId" TableKey="LRP_VehicleTrack" CondSign="="/>
                            </Dict>
                            <Label Key="Lab_Truck_C" Caption="车辆" X="0" Y="0"/>
                            <DatePicker Key="DatePicker1" Caption="时间范围" BuddyKey="Lab_DatePicker1" X="1" Y="1">
                                <DataBinding DefaultFormulaValue="Format(ServerDate(),'yyyy-MM-dd')&amp;' 00:00:00'"/>
                                <Condition Group="RecordTime" ColumnKey="RecordTime" TableKey="LRP_VehicleTrack" CondSign="between" GroupHead="true"/>
                            </DatePicker>
                            <Label Key="Lab_DatePicker1" Caption="时间范围" X="0" Y="1"/>
                            <DatePicker Key="DatePicker2" Caption="至" BuddyKey="Lab_DatePicker2" X="1" Y="2">
                                <DataBinding DefaultFormulaValue="Format(ServerDate(),'yyyy-MM-dd')&amp;' 23:59:59'"/>
                                <Condition Group="RecordTime" ColumnKey="RecordTime" TableKey="LRP_VehicleTrack" CondSign="between" GroupTail="true"/>
                            </DatePicker>
                            <Label Key="Lab_DatePicker2" Caption="至" X="0" Y="2"/>
                            <Button Key="Query" Caption="查询" X="3" Y="0">
                                <OnClick>
                                    <![CDATA[if(IsControlNull('Truck_C')){
    Confirm("请先选择车辆。", "OK","OK:{}");
    return true;
}
DealCondition();LoadData();ShowData();]]>
                                </OnClick>
                            </Button>
                            <Button Key="Reset" Caption="重置" X="3" Y="1">
                                <OnClick>
                                    <![CDATA[ResetCondition();]]>
                                </OnClick>
                            </Button>
                            <Button Key="ShowTrack" Caption="显示轨迹" X="3" Y="2">
                                <OnClick>
                                    <![CDATA[//根据列表中的数据显示百度地图轨迹
//先判断列表明细不可为空
if (GetRowCount('ListView1') < 1){
    Confirm('明细列表不可为空', 'OK','OK:{}');
    return true;
}

var plat = "lat=";
var plong = "long=";
var c = GetRowCount('ListView1');

var i = 0;
while (i < c){
    plat = plat + GetCellValue('ListView1', i, 'Latitude') + "Z";
    plong = plong + GetCellValue('ListView1', i, 'Longitude') + "Z";
    i = i + 1;
}
plat = Left(plat, Length(plat) - 1);
plong = Left(plong, Length(plong) - 1);


//取第一行坐标类型为所有坐标类型
var ctype = GetCellValue('ListView1', 0, 'CoordinateType');
var pctype = "bdl90";
if (ctype == "WGS84"){
    pctype = "ctype=WGS84";
}
if (ctype == "GCJ02") {
    pctype = "ctype=GCJ02";
}


var url = "LRP_Map/baidumap_track.html?" & plat & "&" & plong & "&" & pctype;
SetValue('WebBrowser', url);



]]>
                                </OnClick>
                            </Button>
                            <RowDefCollection RowGap="4">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="4">
                                <ColumnDef Width="70px"/>
                                <ColumnDef Width="100%"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="70px"/>
                                <ColumnDef Width="8px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <ListView Caption="ListView1" Key="ListView1" PageLoadType="DB" TableKey="LRP_VehicleTrack" Height="100%" Width="100%" PageRowCount="70">
                            <ListViewColumnCollection>
                                <ListViewColumn Key="RecordTime" Caption="时间" ColumnType="DatePicker" DataColumnKey="RecordTime" Enable="false" Width="150px"/>
                                <ListViewColumn Key="Longitude" Caption="经度" ColumnType="NumberEditor" DataColumnKey="Longitude" Enable="false" Width="100px" Precision="10" Scale="6"/>
                                <ListViewColumn Key="Latitude" Caption="纬度" ColumnType="NumberEditor" DataColumnKey="Latitude" Enable="false" Width="100px" Precision="10" Scale="6"/>
                                <ListViewColumn Key="CoordinateType" Caption="坐标类型" ColumnType="TextEditor" DataColumnKey="CoordinateType" Visible="false" Enable="false"/>
                            </ListViewColumnCollection>
                        </ListView>
                        <SplitSize Size="130px"/>
                        <SplitSize Size="100%"/>
                    </SplitPanel>
                    <WebBrowser Caption="WebBrowser" Key="WebBrowser" Height="100%" Width="100%"/>
                    <SplitSize Size="400px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
</Form>
