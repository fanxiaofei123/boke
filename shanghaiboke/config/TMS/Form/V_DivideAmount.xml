<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_DivideAmount" Caption="分量" FormType="Entity">
    <DataSource>
        <DataObject Key="V_DivideAmount" Caption="分量" PrimaryType="Entity">
            <TableCollection>
                <Table Key="LRP_TransportJobMat" Caption="分量" TableMode="Detail" SourceType="Query" Persist="false">
                    <Column Caption="对象标识" DataType="Long" Key="OID"/>
                    <Column Caption="主对象标识" DataType="Long" Key="SOID"/>
                    <Column Caption="父对象标识" DataType="Long" Key="POID"/>
                    <Column Caption="对象版本" DataType="Integer" Key="VERID"/>
                    <Column Caption="对象明细版本" DataType="Integer" Key="DVERID"/>
                    <Column Caption="序号" DataType="Integer" Key="SEQUENCE"/>
                    <Column Caption="创建用户ID" DataType="Long" Key="CREATOR"/>
                    <Column Caption="创建时间" DataType="DateTime" Key="CREATETIME"/>
                    <Column Caption="修改用户ID" DataType="Long" Key="MODIFIER"/>
                    <Column Caption="修改时间" DataType="DateTime" Key="MODIFYTIME"/>
                    <Column Caption="数据映射key" DataType="Varchar" Key="MapKey" Length="100"/>
                    <Column Caption="来源单据明细ID" DataType="Long" Key="SrcOID"/>
                    <Column Caption="来源单据头id" DataType="Long" Key="SrcSOID"/>
                    <Column Key="RefOID" Caption="关联运输订单明细OID" DataType="Long"/>
                    <Column Key="MaterialId" Caption="物料" DataType="Long"/>
                    <Column Key="MaterialName" Caption="物料名称" DataType="Varchar" Length="100"/>
                    <Column Key="Qty" Caption="数量" DataType="Numeric" Precision="10" Scale="0"/>
                    <Column Key="MaterialUnit" Caption="单位" DataType="Varchar" Length="40"/>
                    <Column Key="Weight" Caption="重量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="Cubage" Caption="体积" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="Package" Caption="包装" DataType="Varchar" Length="100"/>
                    <Column Key="ShipQty" Caption="装货量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="SignQty" Caption="签收量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="RejectQty" Caption="拒收量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="AbnormalQty" Caption="异常量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="AbnormalCause" Caption="异常说明" DataType="Varchar" Length="1000"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Description="取到父界面的OID" Formula="GetPara('GetOID');"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[select * from LRP_TransportJobMat_L where soid=?]]>
                    </Statement>
                </Table>
                <Table Key="LRP_TransportJobMat_L2" TableMode="Detail" Caption="拆分物料明细">
                    <Column Caption="对象标识" DataType="Long" Key="OID"/>
                    <Column Caption="主对象标识" DataType="Long" Key="SOID"/>
                    <Column Caption="父对象标识" DataType="Long" Key="POID"/>
                    <Column Caption="对象版本" DataType="Integer" Key="VERID"/>
                    <Column Caption="对象明细版本" DataType="Integer" Key="DVERID"/>
                    <Column Caption="序号" DataType="Integer" Key="SEQUENCE"/>
                    <Column Caption="创建用户ID" DataType="Long" Key="CREATOR"/>
                    <Column Caption="创建时间" DataType="DateTime" Key="CREATETIME"/>
                    <Column Caption="修改用户ID" DataType="Long" Key="MODIFIER"/>
                    <Column Caption="修改时间" DataType="DateTime" Key="MODIFYTIME"/>
                    <Column Caption="数据映射key" DataType="Varchar" Key="MapKey" Length="100"/>
                    <Column Caption="来源单据明细ID" DataType="Long" Key="SrcOID"/>
                    <Column Caption="来源单据头id" DataType="Long" Key="SrcSOID"/>
                    <Column Key="RefOID" Caption="关联运输订单明细OID" DataType="Long"/>
                    <Column Key="SeNo" Caption="次序号" DataType="Numeric" Precision="18" Scale="0"/>
                    <Column Key="MaterialId" Caption="物料" DataType="Long"/>
                    <Column Key="MaterialName" Caption="物料名称" DataType="Varchar" Length="100"/>
                    <Column Key="Qty" Caption="数量" DataType="Numeric" Precision="10" Scale="0"/>
                    <Column Key="MaterialUnit" Caption="单位" DataType="Varchar" Length="40"/>
                    <Column Key="Weight" Caption="重量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="Cubage" Caption="体积" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Caption="对应物料明细OID" DataType="Long" Key="DetailOID"/>
                    <Column Key="Package" Caption="包装" DataType="Varchar" Length="100"/>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <Body PopHeight="70%" PopWidth="70%">
        <Block>
            <SplitPanel Key="SplitPanel1" Orientation="Vertical" Caption="SplitPanel1">
                <SplitPanel Key="SplitPanel2" Orientation="Vertical" Caption="SplitPanel2">
                    <TabPanel Caption="TabPanel2" Height="pref" Key="TabPanel2">
                        <Grid Key="Grid1" Caption="物料明细列表" NewEmptyRow="false" Height="pref" RowAlterable="false">
                            <GridColumnCollection>
                                <GridColumn Key="Select" Caption="选择" Width="80px"/>
                                <GridColumn Key="SOID" Caption="SOID" Width="80px" Visible="false"/>
                                <GridColumn Key="OID" Caption="OID" Width="80px" Visible="false"/>
                                <GridColumn Key="RefOID" Caption="关联运输订单明细OID" Width="80px" Visible="false"/>
                                <GridColumn Key="Package" Caption="包装" Width="80px" Visible="false"/>
                                <GridColumn Key="MaterialId" Caption="物料" Width="80px"/>
                                <GridColumn Key="MaterialName" Caption="物料名称" Width="80px"/>
                                <GridColumn Key="Qty" Caption="数量" Width="80px"/>
                                <GridColumn Key="MaterialUnit" Caption="单位" Width="80px"/>
                                <GridColumn Key="Weight" Caption="重量" Width="80px"/>
                                <GridColumn Key="Cubage" Caption="体积" Width="80px"/>
                                <GridColumn Key="SplitQty" Caption="待拆分量" Width="80px"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="row1" RowHeight="35" TableKey="LRP_TransportJobMat">
                                    <GridCell Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true" Key="Select"/>
                                    <GridCell Key="SOID" Caption="SOID" CellType="TextEditor">
                                        <DataBinding ColumnKey="SOID"/>
                                    </GridCell>
                                    <GridCell Key="OID" Caption="OID" CellType="TextEditor">
                                        <DataBinding ColumnKey="OID"/>
                                    </GridCell>
                                    <GridCell Key="RefOID" Caption="关联运输订单明细OID" CellType="TextEditor">
                                        <DataBinding ColumnKey="RefOID"/>
                                    </GridCell>
                                    <GridCell Key="Package" Caption="包装" CellType="TextEditor">
                                        <DataBinding ColumnKey="Package"/>
                                    </GridCell>
                                    <GridCell Key="MaterialId" Caption="物料" CellType="Dict" Enable="false" ItemKey="LRP_Material">
                                        <DataBinding ColumnKey="MaterialId"/>
                                    </GridCell>
                                    <GridCell Key="MaterialName" Caption="物料名称" CellType="TextEditor" Enable="false">
                                        <DataBinding ColumnKey="MaterialName"/>
                                    </GridCell>
                                    <GridCell Key="Qty" Caption="数量" CellType="NumberEditor" Enable="false" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="Qty"/>
                                    </GridCell>
                                    <GridCell Key="MaterialUnit" Caption="单位" CellType="TextEditor" Enable="false">
                                        <DataBinding ColumnKey="MaterialUnit"/>
                                    </GridCell>
                                    <GridCell Key="Weight" Caption="重量" CellType="NumberEditor" Enable="false" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="Weight"/>
                                    </GridCell>
                                    <GridCell Key="Cubage" Caption="体积" CellType="NumberEditor" Enable="false" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="Cubage"/>
                                    </GridCell>
                                    <GridCell Key="SplitQty" Caption="待拆分量" CellType="NumberEditor" Enable="false" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding DefaultFormulaValue="Qty"/>
                                    </GridCell>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <TabPanel Caption="TabPanel4" Height="pref" Key="TabPanel4">
                        <Grid Key="Grid2" Caption="新拆分明细列表" RowAlterable="false" Height="pref">
                            <GridColumnCollection>
                                <GridColumn Key="Select_2" Caption="选择" Width="80px"/>
                                <GridColumn Key="SeNo_2" Caption="次序号" Width="80px"/>
                                <GridColumn Key="RefOID_2" Caption="关联运输订单明细OID" Width="80px" Visible="false"/>
                                <GridColumn Key="MaterialId_2" Caption="物料" Width="80px"/>
                                <GridColumn Key="MaterialName_2" Caption="物料名称" Width="80px"/>
                                <GridColumn Key="Qty_2" Caption="数量" Width="80px"/>
                                <GridColumn Key="MaterialUnit_2" Caption="单位" Width="80px"/>
                                <GridColumn Key="Weight_2" Caption="重量" Width="80px"/>
                                <GridColumn Key="Cubage_2" Caption="体积" Width="80px"/>
                                <GridColumn Key="OID_2" Caption="对应物料明细OID" Width="107px" Visible="false"/>
                                <GridColumn Key="Package_2" Caption="包装" Width="80px" Visible="false"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="row1" RowHeight="35" TableKey="LRP_TransportJobMat_L2">
                                    <GridCell Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true" Key="Select_2"/>
                                    <GridCell Key="SeNo_2" Caption="次序号" CellType="NumberEditor" Enable="false" Precision="15" Scale="0">
                                        <DataBinding ColumnKey="SeNo"/>
                                    </GridCell>
                                    <GridCell Key="RefOID_2" Caption="关联运输订单明细OID" CellType="TextEditor">
                                        <DataBinding ColumnKey="RefOID"/>
                                    </GridCell>
                                    <GridCell Key="MaterialId_2" Caption="物料" CellType="Dict" Enable="false" ItemKey="LRP_Material">
                                        <DataBinding ColumnKey="MaterialId"/>
                                    </GridCell>
                                    <GridCell Key="MaterialName_2" Caption="物料名称" CellType="TextEditor" Enable="false">
                                        <DataBinding ColumnKey="MaterialName"/>
                                    </GridCell>
                                    <GridCell Key="Qty_2" Caption="数量" CellType="NumberEditor" Enable="false" Precision="15" Scale="3">
                                        <DataBinding ColumnKey="Qty"/>
                                    </GridCell>
                                    <GridCell Key="MaterialUnit_2" Caption="单位" CellType="TextEditor" Enable="false">
                                        <DataBinding ColumnKey="MaterialUnit"/>
                                    </GridCell>
                                    <GridCell Key="Weight_2" Caption="重量" CellType="NumberEditor" Enable="false" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="Weight"/>
                                    </GridCell>
                                    <GridCell Key="Cubage_2" Caption="体积" CellType="NumberEditor" Enable="false" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="Cubage"/>
                                    </GridCell>
                                    <GridCell Key="OID_2" Caption="对应物料明细OID" CellType="TextEditor" Enable="false">
                                        <DataBinding ColumnKey="DetailOID"/>
                                    </GridCell>
                                    <GridCell Key="Package_2" CellType="TextEditor" Caption="包装" Enable="false">
                                        <DataBinding ColumnKey="Package"/>
                                    </GridCell>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="50%"/>
                    <SplitSize Size="50%"/>
                </SplitPanel>
                <GridLayoutPanel Key="GridLayoutPanel1" Padding="10px" Caption="GridLayoutPanel1">
                    <NumberEditor Key="PerQty" Caption="每份数量" BuddyKey="Lab_PerQty" X="5" Y="0" Precision="15" Scale="3"/>
                    <Label Key="Lab_PerQty" Caption="每份数量" X="4" Y="0"/>
                    <NumberEditor Key="StartNo" Caption="起始次序号" BuddyKey="Lab_StartNo" X="2" Y="0" Precision="15" Scale="0">
                        <DataBinding DefaultValue="1"/>
                    </NumberEditor>
                    <Label Key="Lab_StartNo" Caption="起始次序号" X="1" Y="0"/>
                    <NumberEditor Key="Copies" Caption="份数" BuddyKey="Lab_Copies" X="8" Y="0" Precision="15" Scale="0">
                        <DataBinding DefaultValue="1"/>
                    </NumberEditor>
                    <Label Key="Lab_Copies" Caption="份数" X="7" Y="0"/>
                    <Button Key="Split" Caption="拆分" X="10" Y="0">
                        <OnClick>
                            <![CDATA[	
							var flag=0;
							
							var count = GetRowCount('Grid1',false);//grid1的明细行数
							var count2 = GetRowCount('Grid2',false);//grid2的明细行数
							var i=0;
							var j=GetRowCount('Grid2',false);
							var m=0;//分数
							var SeNo=StartNo;
							if(StartNo<=0 || PerQty<=0 || Copies<=0){
								Confirm("点击拆分先要判断起始次序号、每份数量、份数必须大于0。", "OK","OK:{}");
								return true;
							} 
							if(count==0){
								return true;
							}
							while(m<Copies){
									while(i<count){
										if(GetCellValue('Grid1', i, 'Select')==1 && GetCellValue('Grid1',i,'SplitQty')>0){
										
										//若拆分明细中次序号有和起始次序号相同的，则判断是不是同一个物料明细，
										//若是，则数量合并
										//若不是,则新增一个次序号相同的拆分明细
										var flag2=0;
										if(count2>0){
											var n=0;
											while(n<count2){
												if(SeNo==GetCellValue('Grid2', n,'SeNo_2')&&GetCellValue('Grid1',i,'OID')==GetCellValue('Grid2',n,'OID_2')){

													//数量
													var _Qty_2=0;
													if(GetCellValue('Grid1',i,'SplitQty')>=PerQty){
														_Qty_2=PerQty;
														//扣减物料明细中待拆分量
														SetCellValue('Grid1', i,'SplitQty',GetCellValue('Grid1',i,'SplitQty')-PerQty);
													}else{
														_Qty_2=GetCellValue('Grid1',i,'SplitQty');
														SetCellValue('Grid1', i,'SplitQty',0);
													}
													SetCellValue('Grid2', n,'Qty_2',GetCellValue('Grid2',n,'Qty_2')+_Qty_2);
													
													//重量
													//重量和数量的比例
													var WeightPer=GetCellValue('Grid1',i,'Weight')/GetCellValue('Grid1',i,'Qty');
													SetCellValue('Grid2', n,'Weight_2',GetCellValue('Grid2', n,'Weight_2')+_Qty_2*WeightPer);
													
													//体积
													//体积和数量的比例
													var CubagePer=GetCellValue('Grid1',i,'Cubage')/GetCellValue('Grid1',i,'Qty');
													SetCellValue('Grid2', n,'Cubage_2',GetCellValue('Grid2', n,'Cubage_2')+_Qty_2*CubagePer);

													flag2=1;
													flag=1;
													break;
												}
												n=n+1;
											}
										}
										if(flag2==0){
										//若拆分明细中次序号有和起始次序号相同的或者有相同次序号但是oid没有相同的,则新增一条拆分明细
											//次序号
											SetCellValue('Grid2', j,'SeNo_2',SeNo);
											//物料
											SetCellValue('Grid2', j,'MaterialId_2',GetCellValue('Grid1',i,'MaterialId'));
											//物料名称
											SetCellValue('Grid2', j,'MaterialName_2',GetCellValue('Grid1',i,'MaterialName'));
											

											//单位
											SetCellValue('Grid2', j,'MaterialUnit_2',GetCellValue('Grid1',i,'MaterialUnit'));

											//数量
											var _Qty_2=0;
											if(GetCellValue('Grid1',i,'SplitQty')>=PerQty){
												_Qty_2=PerQty;
												//扣减物料明细中待拆分量
												SetCellValue('Grid1', i,'SplitQty',GetCellValue('Grid1',i,'SplitQty')-PerQty);
											}else{
												_Qty_2=GetCellValue('Grid1',i,'SplitQty');
												SetCellValue('Grid1', i,'SplitQty',0);
											}
											SetCellValue('Grid2', j,'Qty_2',_Qty_2);
											
											//重量
											//重量和数量的比例
											var WeightPer=GetCellValue('Grid1',i,'Weight')/GetCellValue('Grid1',i,'Qty');
											SetCellValue('Grid2', j,'Weight_2',_Qty_2*WeightPer);
											
											//体积
											//体积和数量的比例
											var CubagePer=GetCellValue('Grid1',i,'Cubage')/GetCellValue('Grid1',i,'Qty');
											SetCellValue('Grid2', j,'Cubage_2',_Qty_2*CubagePer);
											
											//对应物料明细OID
											SetCellValue('Grid2', j,'OID_2',GetCellValue('Grid1',i,'OID'));
											
											//包装
											SetCellValue('Grid2', j,'Package_2',GetCellValue('Grid1',i,'Package'));
											
											//关联运输订单明细OID
											SetCellValue('Grid2', j,'RefOID_2',GetCellValue('Grid1',i,'RefOID'));
											
											flag=1;
											j=j+1;
										}
									}	
									i=i+1;
								}
								//重新遍历grid
								i=0;	
								m=m+1;
								SeNo=SeNo+1;
							}
								
							
							if(flag==0){
								Confirm("请先选择需要拆分的物料明细。", "OK","OK:{}");
								return true;
							}
							
							while(i<count){
								if(GetCellValue('Grid1', i, 'Select')==1){
									SetCellValue('Grid1',i,'Select',0);
								}
								i=i+1;
							}
							
							]]>
                        </OnClick>
                    </Button>
                    <Button Key="DeleteSplitDetail" Caption="删除拆分明细" X="2" Y="1">
                        <OnClick>
                            <![CDATA[
							var count1 = GetRowCount('Grid1',false);//grid1的明细行数
							var count2 = GetRowCount('Grid2',false);//grid2的明细行数
							var i=0;
							var j=0;
							var flag=0;
							
							//遍历带拆分列表
							while(i<count2){
								if(GetCellValue('Grid2', i, 'Select_2')==1){

									//遍历物料明细表，自动将数量添加到对应物料明细的待拆分量中
									while(j<count1){

										if(GetCellValue('Grid1',j,'OID')==GetCellValue('Grid2',i,'OID_2')){
											//待拆分量等于待拆分量+数量
											SetCellValue('Grid1',j,'SplitQty',GetCellValue('Grid1',j,'SplitQty')+GetCellValue('Grid2',i,'Qty_2'));
											DeleteRow('Grid2',i);
											//表格行数减少
											count2=count2-1;
											//grid2游标后退一步
											i=i-1;
											//grid1游标设置为0
											j=0;
											break;
										}
										j=j+1;
									}
									flag=1;
								}
								i=i+1;
							}
							if(flag==0){
								Confirm("请先选择拆分明细。","OK","OK:{}");
								return true;
							}
							]]>
                        </OnClick>
                    </Button>
                    <Button Key="SaveAndExit" Caption="保存并退出" X="5" Y="1">
                        <OnClick>
                            <![CDATA[
							var count1 = GetRowCount('Grid1',false);//grid1的明细行数
							var i=0;
							var SplitQtyStr='';
							while(i<count1){
								SplitQtyStr=SplitQtyStr&ToString(GetCellValue('Grid1',i,'SplitQty'))&',';
								i=i+1;
							}
							//保存时若物料明细还有待拆分量
							var a2= "InvokeService({LRP_TransportJobDivide}, true, true,\'"+SplitQtyStr+"')";
							var a3="Cancel();Close()";
							var a4="Parent.LoadData()";
							var yesno="YES:{"+a2+";"+a3+";"+a4+"},NO:{}";
							Confirm('是否确定保存并退出？','YES_NO',yesno);
							UpdateView();
							]]>
                        </OnClick>
                    </Button>
                    <Button Key="CancleAndExit" Caption="取消并退出" X="8" Y="1">
                        <OnClick>
                            <![CDATA[Cancel();Close();]]>
                        </OnClick>
                    </Button>
                    <RowDefCollection RowGap="8">
                        <RowDef Height="30px"/>
                        <RowDef Height="30px"/>
                    </RowDefCollection>
                    <ColumnDefCollection ColumnGap="8">
                        <ColumnDef Width="50px"/>
                        <ColumnDef Width="77px"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="50px"/>
                        <ColumnDef Width="77px"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="50px"/>
                        <ColumnDef Width="55px"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="30px"/>
                        <ColumnDef Width="100px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <SplitSize Size="100%"/>
                <SplitSize Size="100px"/>
            </SplitPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[LoadData();ShowData();]]>
    </OnLoad>
    <FormParaCollection>
        <FormPara Formula="GetPara(&quot;OID&quot;)" Key="GetOID" Type="Formula" DataType="Long"/>
    </FormParaCollection>
</Form>
