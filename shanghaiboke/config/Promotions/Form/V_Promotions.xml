<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Caption="优惠活动管理" FormType="Entity" Key="V_Promotions">
    <DataSource RefObjectKey="LRP_Promotions"/>
    <OperationCollection>
        <Operation Caption="新增" Key="New" Visible="ReadOnly()">
            <Action>
                <![CDATA[
				New('V_Promotions');
			]]>
            </Action>
        </Operation>
        <Operation Caption="保存" Key="Save" ShortCuts="Ctrl+S" Visible="!ReadOnly()&amp;&amp;Status==100">
            <Action>
                <![CDATA[
					if(EffectiveDateTime > ExpireDateTime){
						Confirm('生效日期时间必须小于失效日期时间','OK','OK:{}');	
						return true;
					}
					if(GetRowCount('Grid0',false)<=0){
						Confirm('明细不可为空','OK','OK:{}');	
						return true;
					}
					LimitOrgNames = GetCaption('LimitOrgIds');
					SaveData();UpdateView();
				]]>
            </Action>
        </Operation>
        <Operation Caption="编辑" Key="Edit" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[Edit();]]>
            </Action>
        </Operation>
        <Operation Caption="删除" Key="Delete" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[
			Confirm('是否确定删除当前单据？','YES_NO',{YES:{DeleteData();UpdateView();Close();},NO:{}});
			
			]]>
            </Action>
        </Operation>
        <Operation Caption="取消" Key="Cancel" RefKey="Cancel"/>
        <Operation Caption="确认" Key="Confirm" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[Status=StatusValue('confirmed');SaveData();UpdateView();]]>
            </Action>
			<ExceptionHandler><![CDATA[				
				Status=StatusValue('prepared');
			]]></ExceptionHandler>
        </Operation>
        <Operation Caption="撤销确认" Key="Confirm-R" Visible="ReadOnly()&amp;&amp;Status==StatusValue('confirmed')">
            <Action>
                <![CDATA[
				//检查是否已经有使用过的记录
				var rst = DBNamedQuery('GetUserPromotionsLog',OID);
				if(rst.size() > 0){
					Confirm('本活动已经被领取，不能再撤销确认','OK','OK:{}');	
					return true;
				}
				Status=StatusValue('prepared');
				SaveData();
				UpdateView();
				]]>
            </Action>
			<ExceptionHandler><![CDATA[				
				Status=StatusValue('confirmed');
			]]></ExceptionHandler>
        </Operation>
        <Operation Caption="关闭界面" Key="Close" RefKey="Close"/>
    </OperationCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="main">
                <ToolBar Height="pref" Key="main_toolbar">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="main_split" Orientation="Vertical">
                    <TabPanel Caption="TabPanel0" Key="TabPanel0">
                        <GridLayoutPanel Caption="基本信息" Key="BasicTab" Padding="10px">
                            <TextEditor Caption="活动号" Enable="false" Key="No" X="1" Y="0" BuddyKey="L_No">
                                <DataBinding ColumnKey="No" TableKey="LRP_Promotions_H"/>
                            </TextEditor>
                            <Label Caption="活动号" Key="L_No" X="0" Y="0"/>
							<TextEditor Caption="活动名称" Enable="!ReadOnly()" Key="Name" X="3" Y="0" BuddyKey="L_Name">
                                <DataBinding ColumnKey="Name" TableKey="LRP_Promotions_H" Required="true"/>
                            </TextEditor>
                            <Label Caption="活动名称" Key="L_Name" X="2" Y="0"/>
							<ComboBox Caption="活动类型" Enable="!ReadOnly()" Key="ActivityType" X="5" Y="0" BuddyKey="L_ActivityType">
                                <Item Caption="新手活动" Key="1" Value="1"/>
								<Item Caption="分享活动" Key="2" Value="2"/>
								<Item Caption="其它活动" Key="99" Value="99"/>
								<DataBinding ColumnKey="ActivityType" TableKey="LRP_Promotions_H" Required="true"/>
                            </ComboBox>
                            <Label Caption="活动类型" Key="L_ActivityType" X="4" Y="0"/>
							<NumberEditor Key="LimitsPerUser" Caption="限制用户次数" Enable="!ReadOnly()" BuddyKey="Lab_LimitsPerUser" X="1" Y="1" Scale="0">
                                <DataBinding ColumnKey="LimitsPerUser" DefaultValue="0" TableKey="LRP_Promotions_H"/>
                            </NumberEditor>
                            <Label Key="Lab_LimitsPerUser" Caption="限制用户次数" X="0" Y="1"/>					
							<CheckBox Caption="限制可用机构" Key="IsLimitOrg" Enable="!ReadOnly()" X="2" XSpan="2" Y="1">
								<DataBinding ColumnKey="IsLimitOrg" TableKey="LRP_Promotions_H" DefaultValue="0"/>									
							</CheckBox>
							<Dict AllowMultiSelection="true" Caption="可用机构" Key="LimitOrgIds" Enable="!ReadOnly()&amp;&amp;IsLimitOrg" ItemKey="LRP_DispatchOrg" X="5" Y="1">
								<DataBinding ColumnKey="LimitOrgIds" TableKey="LRP_Promotions_H"/>
							</Dict>
							<Label Caption="可用机构" Key="L_LimitOrgIds" X="4" Y="1"/>
							<TextEditor Caption="可用机构名称" Visible="false" Enable="!ReadOnly()" Key="LimitOrgNames" X="5" Y="1" BuddyKey="L_LimitOrgNames">
                                <DataBinding ColumnKey="LimitOrgNames" TableKey="LRP_Promotions_H"/>
                            </TextEditor>
                            <Label Caption="可用机构名称" Key="L_LimitOrgNames" X="4" Y="1"/>
							<DatePicker Caption="失效日期时间" Enable="!ReadOnly()" Key="ExpireDateTime" OnlyDate="false" X="3" Y="2" BuddyKey="L_ExpireDateTime">
                                <DataBinding ColumnKey="ExpireDateTime" TableKey="LRP_Promotions_H" Required="true"/>
                            </DatePicker>
                            <Label Caption="失效日期时间" Key="L_ExpireDateTime" X="2" Y="2"/>
                            <DatePicker Caption="生效日期时间" Enable="!ReadOnly()" Key="EffectiveDateTime" OnlyDate="false" X="1" Y="2" BuddyKey="L_EffectiveDateTime">
                                <DataBinding ColumnKey="EffectiveDateTime" TableKey="LRP_Promotions_H" Required="true"/>
                            </DatePicker>
                            <Label Caption="生效日期时间" Key="L_EffectiveDateTime" X="0" Y="2"/>
							<NumberEditor Key="SortOrder" Caption="排序" Enable="!ReadOnly()" BuddyKey="Lab_SortOrder" X="5" Y="2" Scale="0">
                                <DataBinding ColumnKey="SortOrder" TableKey="LRP_Promotions_H"/>
                            </NumberEditor>
                            <Label Key="Lab_SortOrder" Caption="排序" X="4" Y="2"/>		
							<Image Key="ImageUrl" Enable="!ReadOnly()" Caption="图片" BuddyKey="Lab_ImageUrl" X="1" Y="3" ImageScaleType="Fit_Center" MaxSize="2048" Stretch="true" XSpan="3" YSpan="2">
								<DataBinding ColumnKey="ImageUrl" TableKey="LRP_Promotions_H" Required="true"/>
							</Image>
                            <Label Key="Lab_ImageUrl" Caption="图片" X="0" Y="3"/>
							<TextEditor BuddyKey="Lab_InfoUrl" Caption="详细信息路径" Enable="!ReadOnly()" Key="InfoUrl" X="5" Y="3" YSpan="2">
                                <DataBinding ColumnKey="InfoUrl" TableKey="LRP_Promotions_H" Required="true"/>
                            </TextEditor>
                            <Label Caption="详细信息路径" Key="Lab_InfoUrl" X="4" Y="3"/>
							
                            <TextEditor BuddyKey="Lab_Remark" Caption="备注" Enable="!ReadOnly()" Key="Remark" X="1" Y="5" XSpan="3">
                                <DataBinding ColumnKey="Remark" TableKey="LRP_Promotions_H"/>
                            </TextEditor>
                            <Label Caption="备注" Key="Lab_Remark" X="0" Y="5"/>
                            <ComboBox Caption="状态" Enable="false" Key="Status" SourceType="Status" X="5" Y="5" BuddyKey="L_Status">
                                <DataBinding ColumnKey="Status" TableKey="LRP_Promotions_H" DefaultValue="100"/>
                            </ComboBox>
                            <Label Caption="状态" Key="L_Status" X="4" Y="5"/>
							<TextEditor Caption="OID" Visible="false" Key="OID" X="4" Y="5">
								<DataBinding ColumnKey="OID" TableKey="LRP_Promotions_H"/>
							</TextEditor>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
								<RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="34%"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>                        
                    </TabPanel>
                    <TabPanel Caption="TabPanel1" Key="TabPanel1">
                        <Grid Caption="劵明细" Key="Grid0">
                            <GridColumnCollection>
                                <GridColumn Caption="选择" Key="column-s" Width="80px"/>
                                <GridColumn Caption="劵号" Key="CouponId" Width="200px" Sortable="true"/>
                                <GridColumn Key="CouponName" Caption="名称" Width="150px"/>
                                <GridColumn Key="Qty" Caption="数量" Width="150px"/>
                                <GridColumn Key="CouponTypeId" Caption="劵类型" Width="150px"/>
                                <GridColumn Caption="计算方式" Key="CalculationMethod" Width="80px"/>
                                <GridColumn Caption="生效日期" Key="CouponEffectiveDateTime" Width="80px" Sortable="true"/>
                                <GridColumn Caption="截止日期" Key="CouponExpireDateTime" Width="80px" Sortable="true"/>
								<GridColumn Caption="面值" Key="FaceValue" Width="80px" Sortable="true"/>
                                <GridColumn Caption="描述" Key="Description" Width="80px"/>
                                <GridColumn Key="EnoughMoney" Caption="满多少钱" Width="80px"/>
                                <GridColumn Key="Discount" Caption="折扣" Width="80px"/>
                                <GridColumn Caption="去零头类型" Key="MinusChangeType" Width="120px"/>
                                <GridColumn Caption="可用业务范围" Key="UseBusiness" Width="80px"/>
                                <GridColumn Caption="可用调度组织名称" Key="UseDispatchOrgName" Width="80px"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="R3" TableKey="LRP_Promotions_L">
                                    <GridCell Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true" Key="Select">
										<DataBinding DefaultValue="1"/>
									</GridCell>
									<GridCell Caption="劵号" CellType="ComboBox" Enable="!ReadOnly()" Key="CouponId" SourceType="Formula">
                                        <DataBinding ColumnKey="CouponId" Required="true">
											<ValueChanged>
												<![CDATA[SetCouponDetail();]]>
											</ValueChanged>
										</DataBinding>
										<FormulaItems>
											<![CDATA[DBNamedQuery('GetCoupon');]]>
										</FormulaItems>
                                    </GridCell>
									<GridCell Key="CouponName" Caption="名称" CellType="TextEditor" Enable="false"/>
									<GridCell Caption="数量" CellType="NumberEditor" Enable="!ReadOnly()" Key="Qty" Scale="0">
                                        <DataBinding ColumnKey="Qty" DefaultValue="1"/>
                                    </GridCell>								
                                    <GridCell Caption="劵类型" CellType="Dict" Enable="false" ItemKey="LRP_CouponType" Key="CouponTypeId"/>
									<GridCell Caption="计算方式" CellType="ComboBox" Enable="false" Key="CalculationMethod">
                                        <Item Caption="按面值" Key="1" Value="1"/>
										<Item Caption="按折扣" Key="2" Value="2"/>
										<Item Caption="去零头" Key="3" Value="3"/>
                                    </GridCell>
									<GridCell Caption="生效日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="CouponEffectiveDateTime" Format="yyyy-MM-dd"/>
                                    <GridCell Caption="截止日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="CouponExpireDateTime" Format="yyyy-MM-dd"/>
                                    <GridCell Caption="面值" CellType="NumberEditor" Enable="false" Key="FaceValue"/>
									<GridCell Key="Description" Caption="描述" CellType="TextEditor" Enable="false"/>
									<GridCell Caption="满多少钱" CellType="NumberEditor" Enable="false" Key="EnoughMoney"/>
									<GridCell Caption="折扣" CellType="NumberEditor" Enable="false" Key="Discount"/>
									<GridCell Caption="去零头类型" CellType="ComboBox" Enable="false" Key="MinusChangeType">
                                        <Item Caption="个位" Key="unit" Value="unit"/>
										<Item Caption="十位" Key="decade" Value="decade"/>
                                    </GridCell>
									<GridCell Key="UseBusiness" Caption="可用业务范围" CellType="TextEditor" Enable="false"/>
									<GridCell Key="UseDispatchOrgName" Caption="可用调度组织名称" CellType="TextEditor" Enable="false"/>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="265px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[	
	]]>
    </OnLoad>
	<OnPostShow>
        <![CDATA[
		if(!IsNew()){
			var i = 0;
			loop"Grid0"(true){
				var id = GetCellValue('Grid0',i,'CouponId');
				var rst = DBNamedQuery('GetCouponDetail',id);
				if(rst.size() > 0){				
					rst.beforefirst();
					rst.next();
				
					SetCellValue('Grid0', i,'CouponName',rst.Name);
					SetCellValue('Grid0', i,'CouponTypeId',rst.CouponTypeId);
					SetCellValue('Grid0', i,'CalculationMethod',rst.CalculationMethod);
					SetCellValue('Grid0', i,'CouponEffectiveDateTime',rst.EffectiveDateTime);
					SetCellValue('Grid0', i,'CouponExpireDateTime',rst.ExpireDateTime);
					SetCellValue('Grid0', i,'FaceValue',rst.FaceValue);
					SetCellValue('Grid0', i,'Description',rst.Description);
					SetCellValue('Grid0', i,'EnoughMoney',rst.EnoughMoney);
					SetCellValue('Grid0', i,'Discount',rst.Discount);
					SetCellValue('Grid0', i,'MinusChangeType',rst.MinusChangeType);
					SetCellValue('Grid0', i,'UseBusiness',rst.UseBusiness);
					SetCellValue('Grid0', i,'UseDispatchOrgName',rst.UseDispatchOrgName);
				}
				i = i+1;
			}
		}
	]]>
    </OnPostShow>
	<MacroCollection>
        <Macro Key="SetCouponDetail">
            <![CDATA[
			//读取券明细填入明细表			
			var rst = DBNamedQuery('GetCouponDetail',CouponId);
			if(rst.size() > 0){				
				rst.beforefirst();
				rst.next();		
				CouponName = rst.Name;	
				CouponTypeId = rst.CouponTypeId;
				CalculationMethod = rst.CalculationMethod;
				CouponEffectiveDateTime = rst.EffectiveDateTime;
				CouponExpireDateTime = rst.ExpireDateTime;
				FaceValue = rst.FaceValue;
				Description = rst.Description;
				EnoughMoney = rst.EnoughMoney;
				Discount = rst.Discount;
				MinusChangeType = rst.MinusChangeType;
				UseBusiness = rst.UseBusiness;
				UseDispatchOrgName = rst.UseDispatchOrgName;
			}
			]]>
        </Macro>
    </MacroCollection>
	<QueryCollection>  
		<Query Description="读取券" Key="GetCoupon">
            <Statement>
                <![CDATA[select OID as N_KEY,No as N_NAME from LRP_Coupon where status=200]]>
            </Statement>
        </Query>
        <Query Description="读取券明细" Key="GetCouponDetail">
            <Statement>
                <![CDATA[select * from LRP_Coupon where OID=?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
		<Query Description="读取优惠活动日志" Key="GetUserPromotionsLog">
            <Statement>
                <![CDATA[select OID from LRP_UserPromotionsLog where PromotionId=?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
</Form>
