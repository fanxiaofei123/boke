<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Caption="调度单成本分摊" FormType="View" Key="V_DispatchApportion_LRP">
    <DataSource>
        <DataObject Caption="费用明细" Key="LRP_ExpenseLine" PrimaryTableKey="LRP_ExpenseLine">
            <TableCollection>
                <Table Caption="费用明细" Key="LRP_ExpenseLine" Persist="false" SourceType="Query" TableMode="Detail">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="SOID" Caption="主对象标识" DataType="Long"/>
                    <Column Key="POID" Caption="父对象标识" DataType="Long"/>
                    <Column Key="VERID" Caption="对象版本" DataType="Integer"/>
                    <Column Key="DVERID" Caption="对象明细版本" DataType="Integer"/>
                    <Column Key="DispatchOrgId" Caption="调度组织" DataType="Long"/>
                    <Column Key="WarehouseCenterId" Caption="仓储中心" DataType="Long"/>
                    <Column Key="ComputeNo" Caption="计算号" DataType="Varchar" Length="40"/>
                    <Column Key="CarrierId" Caption="承运商" DataType="Long"/>
                    <Column Key="SettlementId" Caption="结算方" DataType="Long"/>
                    <Column Key="ExpenseId" Caption="费用名称" DataType="Long"/>
                    <Column Key="BizDate" Caption="业务日期" DataType="Date"/>
                    <Column Key="BizQty" Caption="业务量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="CalculationAmount" Caption="计算金额" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="AdjustAmount" Caption="调整后金额" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="GenMethod" Caption="生成方式" DataType="Integer"/>
                    <Column Key="BillOID" Caption="单据ID" DataType="Long"/>
                    <Column Key="BillNo" Caption="单据号" DataType="Varchar" Length="100"/>
                    <Column Key="ExpenseContractTermId" Caption="条款ID" DataType="Long"/>
                    <Column Key="ExpenseContractTermName" Caption="条款名称" DataType="Varchar" Length="100"/>
                    <Column Key="TermLineId" Caption="条款明细ID" DataType="Long"/>
                    <Column Key="TermLineName" Caption="条款明细名称" DataType="Varchar" Length="100"/>
                    <Column Key="ExpenseContractId" Caption="合约ID" DataType="Long"/>
                    <Column Key="ExpenseContractName" Caption="合约名称" DataType="Varchar" Length="100"/>
                    <Column Key="SourceType" Caption="来源类型" DataType="Varchar" Length="10"/>
                    <Column Key="CostApportionStatus" Caption="成本分摊状态" DataType="Integer"/>
                    <Column Key="Status" Caption="状态" DataType="Integer"/>
                    <TableFilter>
                        <![CDATA[BillNo like 'TD%']]>
                    </TableFilter>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <Body PopHeight="80%" PopWidth="80%">
        <Block>
            <FlexFlowLayoutPanel Caption="根面板" Key="root">
                <ToolBar Caption="ToolBar1" Height="pref" Key="ToolBar1">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Caption="SplitPanel1" Height="100%" Key="SplitPanel1" Orientation="Vertical">
                    <GridLayoutPanel Caption="基本信息" Height="pref" Key="first_head" Padding="5px">
                        <Dict BuddyKey="L_DispatchOrgId_C" Caption="调度组织" ItemKey="LRP_DispatchOrg" Key="DispatchOrgId_C" X="1" XSpan="3" Y="0" AllowMultiSelection="true">
                            <DataBinding Required="true"/>
                            <Condition CondSign="in">
                                <ConditionTarget TableKey="LRP_ExpenseLine" ColumnKey="DispatchOrgId"/>
                            </Condition>
                        </Dict>
                        <Label Caption="调度组织" Key="L_DispatchOrgId_C" X="0" Y="0"/>
                        <Dict BuddyKey="L_ExpenseId_C" Caption="费用名称" ItemKey="LRP_Expense" Key="ExpenseId_C" X="6" XSpan="3" Y="0" AllowMultiSelection="true">
                            <DataBinding Required="true"/>
                            <Condition CondSign="in">
                                <ConditionTarget TableKey="LRP_ExpenseLine" ColumnKey="ExpenseId"/>
                            </Condition>
                        </Dict>
                        <Label Caption="费用名称" Key="L_ExpenseId_C" X="5" Y="0"/>
                        <DatePicker Caption="业务日期" Key="BizDate_C" X="1" XSpan="3" Y="1" BuddyKey="L_BizDate">
                            <DataBinding DefaultFormulaValue="Format(ServerDate(),'yyyy-MM-dd')&amp;' 00:00:00'" Required="true"/>
                            <Condition CondSign="between" ColumnKey="BizDate" Group="BizDate" GroupHead="true" TableKey="LRP_ExpenseLine">
                                <ConditionTarget TableKey="LRP_ExpenseLine" ColumnKey="BizDate"/>
                            </Condition>
                        </DatePicker>
                        <Label Caption="业务日期" Key="L_BizDate" X="0" Y="1"/>
                        <DatePicker Caption="至" Key="BizDate_C_1" X="6" XSpan="3" Y="1" BuddyKey="L_BizDate_1">
                            <DataBinding DefaultFormulaValue="Format(ServerDate(),'yyyy-MM-dd')&amp;' 23:59:59'" Required="true"/>
                            <Condition CondSign="none" Group="BizDate" GroupTail="true">
                                <ConditionTarget TableKey="LRP_ExpenseLine" ColumnKey="BizDate"/>
                            </Condition>
                        </DatePicker>
                        <Label Caption="至" Key="L_BizDate_1" X="5" Y="1"/>
                        <ComboBox BuddyKey="Lab_ApportionMethod" Caption="分摊方式" Key="ApportionMethod" X="1" XSpan="3" Y="2">
                            <Item Caption="按数量" Key="qty" Value="qty"/>
                            <Item Caption="按重量" Key="weight" Value="weight"/>
                            <Item Caption="按体积" Key="cubage" Value="cubage"/>
                            <Item Caption="按单据数" Key="count" Value="count"/>
                        </ComboBox>
                        <Label Caption="分摊方式" Key="L_ApportionMethod" X="0" Y="2"/>
                        <TextEditor Caption="调度单号" Key="BillNo_C" X="6" XSpan="3" Y="2">
                            <Condition CondSign="like">
                                <ConditionTarget TableKey="LRP_ExpenseLine" ColumnKey="BillNo"/>
                            </Condition>
                        </TextEditor>
                        <Label Caption="调度单号" Key="L_BillNo" X="5" Y="2"/>
                        <Button Caption="查询" Enable="true" Key="Query" X="0" XSpan="4" Y="3">
                            <OnClick>
                                <![CDATA[
								UICheck();
								DealCondition();LoadData();ShowData();	
								
								]]>
                            </OnClick>
                        </Button>
                        <Label Key="L_QueryResult" X="5" XSpan="4" Y="3"/>
                        <CheckBox Caption="删除已分摊记录" Key="IsDelete" X="0" XSpan="4" Y="4"/>
                        <GridLayoutPanel Caption="操作" Height="pref" Key="Operation" X="5" XSpan="4" Y="4" Padding="5px">
                            <Button Caption="确定分摊" Enable="true" Key="Apportion" X="0" Y="0">
                                <OnClick>
                                    <![CDATA[
									UICheck();		
									if(ApportionMethod == ""){
										Confirm('请选择分摊方式。','OK','OK:{}');
										return true;
									}
									var IDS = "";
									loop "ListView0" (true){
										IDS = IDS&OID&",";
									}					
									if(Length(IDS) > 0){
										IDS = Left(IDS, Length(IDS)-1);
										InvokeService("LRP_DispatchApportion", false, false,IDS,ApportionMethod,IsDelete);
									}							
									else{									
										Confirm('没有要分摊的计费明细','OK','OK:{}');
									}									
									]]>
                                </OnClick>
                            </Button>
                            <Button Caption="重置" Enable="true" Key="cancle" X="2" Y="0">
                                <OnClick>
                                    <![CDATA[
									ResetCondition(); 									
									]]>
                                </OnClick>
                            </Button>
                            <RowDefCollection RowGap="2">
                                <RowDef Height="25px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="4">
                                <ColumnDef Width="50%"/>
                                <ColumnDef Width="8px"/>
                                <ColumnDef Width="50%"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <RowDefCollection RowGap="8">
                            <RowDef Height="25px"/>
                            <RowDef Height="25px"/>
                            <RowDef Height="25px"/>
                            <RowDef Height="25px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                        </RowDefCollection>
                        <ColumnDefCollection ColumnGap="8">
                            <ColumnDef Width="100px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="100px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="30px"/>
                        </ColumnDefCollection>
                    </GridLayoutPanel>
                    <ListView Caption="ListView0" Key="ListView0" TableKey="LRP_ExpenseLine" PageLoadType="DB" Visible="false">
                        <ListViewColumnCollection>
                            <ListViewColumn Caption="对象标识" ColumnType="TextEditor" DataColumnKey="OID" Key="OID" Visible="true"/>
                            <ListViewColumn Caption="成本分摊状态" ColumnType="TextEditor" DataColumnKey="CostApportionStatus" Key="CostApportionStatus"/>
                            <ListViewColumn Caption="单据号" ColumnType="TextEditor" DataColumnKey="BillNo" Key="BillNo"/>
                            <ListViewColumn Caption="业务日期" ColumnType="DatePicker" DataColumnKey="BizDate" Key="BizDate"/>
                        </ListViewColumnCollection>
                    </ListView>
                    <SplitSize Size="190px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnPostShow>
        <![CDATA[
		var c = 0;
		var c1 = 0;
		var c2 = 0;
		loop "ListView0" (true){
			c = c + 1;								
			if(CostApportionStatus == "1"){ 
				c1 = c1 + 1;
			}		
			else{
				c2 = c2 + 1;
			}									
		}
		var s = "未分摊费用明细数 "&c2&"   已分摊费用明细数 "&c1;
                if(GetSessionPara('Language')=="en"){
                    s = "The outstanding cost is "&c2&
                        "  The apportionment cost is "&c1;
                }
		SetValue('L_QueryResult',s);
	]]>
    </OnPostShow>
</Form>
