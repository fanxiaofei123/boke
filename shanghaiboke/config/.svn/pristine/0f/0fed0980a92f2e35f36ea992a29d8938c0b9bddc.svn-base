<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="CHCS_Replenishment_H" Caption="补货申请单" FormType="Entity" ViewKey="CHCS_Replenishment_HView">
    <DataSource RefObjectKey="CHCS_Replenishment_H"/>
    <OperationCollection>
        <Operation Key="WORKITEM" Caption="WORKITEM" Tag="WORKITEM"/>
        <Operation Key="BPM" Caption="BPM" Tag="BPM"/>
        <Operation Key="Save" Caption="保存" Visible="!ReadOnly()">
            <Action>
                <![CDATA[SaveData(); UpdateView();]]>
            </Action>
        </Operation>
        <Operation Key="New" Caption="新增" Visible="ReadOnly()">
            <Action>
                <![CDATA[New('CHCS_Replenishment_H', 'self');]]>
            </Action>
        </Operation>
        <Operation Key="Edit" Caption="修改" Visible="ReadOnly()">
            <Action>
                <![CDATA[Edit();]]>
            </Action>
        </Operation>
        <Operation Key="Cancel" Caption="取消" Visible="!ReadOnly()">
            <Action>
                <![CDATA[Cancel();]]>
            </Action>
        </Operation>
        <Operation Key="Put" Caption="生成调拨单" Visible="ReadOnly()">
            <Action>
                <![CDATA[var rowCount=GetRowCount('Grid2');
var i=0;
var flag = false;
while(i<rowCount){
    if(GetCellValue('Grid2', i, 'Actual_Approvals_Number')>GetCellValue('Grid2', i, 'Quantity_Backfilled'))
        {Map('CHCS_Replenishment_H2CHCS_Transfer_H', 'CHCS_Transfer_H');break;}
    else{
        flag = true;
    }
    i=i+1;
}
if(flag){
    Confirm('调拨数量已超过实际批准数量，下推失败！','ok', '');
}
    ]]>
            </Action>
        </Operation>
        <Operation Key="Close" Caption="关闭" Visible="ReadOnly()">
            <Action>
                <![CDATA[Close()]]>
            </Action>
        </Operation>
        <Operation Key="Export" Caption="导出" Visible="ReadOnly()">
            <Action>
                <![CDATA[UIExportExcel()]]>
            </Action>
        </Operation>
        <Operation Key="Print" Caption="打印补货申请单" Visible="ReadOnly()">
            <Action>
                <![CDATA[Print();]]>
            </Action>
        </Operation>
        <Operation Key="Audit" Caption="审核" Visible="ReadOnly()">
            <Action>
                <![CDATA[SetValue("Status", 80);
DBUpdate("update CHCS_Replenishment_H set Status=? where OID=?", 80, GetOID());
SetEnable("Close", False);
Load();
]]>
            </Action>
        </Operation>
    </OperationCollection>
    <ScriptCollection>
        <Script Key="Load" Caption="载入" Range="Action" Verb="Load">
            <![CDATA[LoadData();]]>
        </Script>
    </ScriptCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="root" Caption="根面板">
                <ToolBar Key="ToolBar1" Height="pref" Caption="ToolBar1">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Key="main" Orientation="Vertical" Height="100%" Caption="主面板">
                    <TabPanel Caption="TabPanel2" Key="TabPanel2">
                        <GridLayoutPanel Key="first_head" Height="pref" Padding="5px" Caption="基本信息">
                            <TextEditor Key="NO" Caption="补货申请单号" BuddyKey="Lab_NO" X="1" Y="0" Enable="false" AsQuery="true" XSpan="2">
                                <DataBinding ColumnKey="NO" TableKey="CHCS_Replenishment_H"/>
                            </TextEditor>
                            <Label Key="Lab_NO" Caption="补货申请单号" X="0" Y="0"/>
                            <DatePicker Key="BillDate" Caption="申请日期" BuddyKey="Lab_BillDate" X="5" Y="1" Enable="false" OnlyDate="true" XSpan="2">
                                <DataBinding DefaultFormulaValue="ServerDate()" ColumnKey="BillDate" TableKey="CHCS_Replenishment_H"/>
                            </DatePicker>
                            <Label Key="Lab_BillDate" Caption="申请日期" X="4" Y="1"/>
                            <DatePicker Key="Approval_Date" Caption="审批日期" BuddyKey="Lab_Approval_Date" X="1" Y="2" Enable="false" OnlyDate="true" XSpan="2">
                                <DataBinding DefaultFormulaValue="ServerDate()" ColumnKey="Approval_Date" TableKey="CHCS_Replenishment_H"/>
                            </DatePicker>
                            <Label Key="Lab_Approval_Date" Caption="审批日期" X="0" Y="2"/>
                            <Dict Key="Applicant" Caption="申请人" BuddyKey="Lab_Applicant" X="1" Y="1" ItemKey="CHCS_Employee" XSpan="2">
                                <DataBinding ColumnKey="Applicant" TableKey="CHCS_Replenishment_H"/>
                            </Dict>
                            <Label Key="Lab_Applicant" Caption="申请人" X="0" Y="1"/>
                            <Dict Key="Approver" Caption="审批人" BuddyKey="Lab_Approver" X="9" Y="1" ItemKey="CHCS_Employee" XSpan="2">
                                <DataBinding ColumnKey="Approver" TableKey="CHCS_Replenishment_H"/>
                            </Dict>
                            <Label Key="Lab_Approver" Caption="审批人" X="8" Y="1"/>
                            <Dict Key="Vendor" Caption="航食公司" BuddyKey="Lab_Vendor" X="5" Y="0" ItemKey="Vendor" XSpan="2">
                                <DataBinding ColumnKey="Vendor" TableKey="CHCS_Replenishment_H"/>
                            </Dict>
                            <Label Key="Lab_Vendor" Caption="航食公司" X="4" Y="0"/>
                            <ComboBox Key="Status" Caption="申请单状态" BuddyKey="Lab_Status" X="9" Y="0" SourceType="Status" Enable="false" XSpan="2">
                                <DataBinding ColumnKey="Status" TableKey="CHCS_Replenishment_H" DefaultValue="100"/>
                            </ComboBox>
                            <Label Key="Lab_Status" Caption="申请单状态" X="8" Y="0"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="120px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <GridLayoutPanel Key="GridLayoutPanel1" Caption="系统信息">
                            <Dict Key="CREATOR" Caption="创建人" BuddyKey="Lab_CREATOR" X="1" Y="0" Enable="false" ItemKey="Operator" XSpan="2">
                                <DataBinding DefaultFormulaValue="GetOperator()" ColumnKey="CREATOR" TableKey="CHCS_Replenishment_H"/>
                            </Dict>
                            <Label Key="Lab_CREATOR" Caption="创建人" X="0" Y="0"/>
                            <DatePicker Key="CREATETIME" Caption="创建时间" BuddyKey="Lab_CREATETIME" X="5" Y="0" Enable="false" XSpan="2">
                                <DataBinding DefaultFormulaValue="ServerDate()" ColumnKey="CREATETIME" TableKey="CHCS_Replenishment_H"/>
                            </DatePicker>
                            <Label Key="Lab_CREATETIME" Caption="创建时间" X="4" Y="0"/>
                            <Dict Key="MODIFIER" Caption="修改人" BuddyKey="Lab_MODIFIER" X="1" Y="1" Enable="false" ItemKey="Operator" XSpan="2">
                                <DataBinding DefaultFormulaValue="GetOperator()" ColumnKey="MODIFIER" TableKey="CHCS_Replenishment_H"/>
                            </Dict>
                            <Label Key="Lab_MODIFIER" Caption="修改人" X="0" Y="1"/>
                            <DatePicker Key="MODIFYTIME" Caption="修改时间" BuddyKey="Lab_MODIFYTIME" X="5" Y="1" Enable="false" XSpan="2">
                                <DataBinding DefaultFormulaValue="ServerDate()" ColumnKey="MODIFYTIME" TableKey="CHCS_Replenishment_H"/>
                            </DatePicker>
                            <Label Key="Lab_MODIFYTIME" Caption="修改时间" X="4" Y="1"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="50%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="50%" MinWidth="50px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <TabPanel Caption="TabPanel1" Key="TabPanel1" Height="pref">
                        <Grid Key="Grid2" Caption="补货申请单明细">
                            <GridColumnCollection>
                                <GridColumn Key="Tableware_Name" Caption="餐具名称" Width="80px"/>
                                <GridColumn Key="Standard_Stock" Caption="标准库存数量" Width="154px"/>
                                <GridColumn Key="Extant_Number" Caption="现存数量" Width="127px"/>
                                <GridColumn Key="Applications_Number" Caption="申请数量" Width="113px"/>
                                <GridColumn Key="Actual_Approvals_Number" Caption="实际批准数量" Width="166px"/>
                                <GridColumn Key="Quantity_Backfilled" Caption="调拨数量" Width="131px"/>
                                <GridColumn Key="Unit" Caption="单位" Width="128px"/>
                                <GridColumn Key="IsUrgency" Caption="紧急程度" Width="129px"/>
                                <GridColumn Key="Remark" Caption="备注" Width="80px"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="row1" TableKey="CHCS_Replenishment_L">
                                    <GridCell Key="Tableware_Name" Caption="餐具名称" CellType="Dict" ItemKey="CHCS_Product">
                                        <DataBinding ColumnKey="Tableware_Name"/>
                                        <ItemFilter>
                                            <Filter Query="select oid from CHCS_Product where Type=(select oid from LRP_Lookup_L where code='CPLX-CJ')" Type="DataSet"/>
                                        </ItemFilter>
                                    </GridCell>
                                    <GridCell Key="Standard_Stock" Caption="标准库存数量" CellType="NumberEditor" IntegerValue="true" Format="">
                                        <DataBinding ColumnKey="Standard_Stock"/>
                                    </GridCell>
                                    <GridCell Key="Extant_Number" Caption="现存数量" CellType="NumberEditor" IntegerValue="true" Format="">
                                        <DataBinding CheckDependency="Extant_Number,Standard_Stock" CheckRule="Standard_Stock &gt; Extant_Number" ColumnKey="Extant_Number" ErrorInfo="现存数量不能大于标准库存数量！"/>
                                    </GridCell>
                                    <GridCell Key="Applications_Number" Caption="申请数量" CellType="NumberEditor" IntegerValue="true" Format="">
                                        <DataBinding DefaultFormulaValue="Standard_Stock-Extant_Number" ColumnKey="Applications_Number"/>
                                    </GridCell>
                                    <GridCell Key="Actual_Approvals_Number" Caption="实际批准数量" CellType="NumberEditor" IntegerValue="true" Format="">
                                        <DataBinding ColumnKey="Actual_Approvals_Number"/>
                                    </GridCell>
                                    <GridCell Key="Quantity_Backfilled" Caption="调拨数量" CellType="NumberEditor" IntegerValue="true" ShowZero="true">
                                        <DataBinding CheckDependency="Actual_Approvals_Number,Quantity_Backfilled" ColumnKey="Quantity_Backfilled" DefaultValue="0"/>
                                    </GridCell>
                                    <GridCell Key="Unit" Caption="单位" CellType="Dict" ItemKey="LRP_Lookup_L">
                                        <DataBinding ColumnKey="Unit"/>
                                        <ItemFilter>
                                            <Filter Query="select oid  from LRP_Lookup_L where HeadCode='DW'" Type="DataSet"/>
                                        </ItemFilter>
                                    </GridCell>
                                    <GridCell Key="IsUrgency" Caption="紧急程度" CellType="ComboBox" IntegerValue="true">
                                        <DataBinding ColumnKey="IsUrgency"/>
                                        <Item Caption="一般" Key="0" Value="0"/>
                                        <Item Caption="紧急" Key="1" Value="1"/>
                                    </GridCell>
                                    <GridCell Key="Remark" Caption="备注" CellType="TextEditor">
                                        <DataBinding ColumnKey="Remark"/>
                                    </GridCell>
                                </GridRow>
                                <GridRow Key="row2" RowType="Total">
                                    <GridCell Key="cell35" Caption="合计"/>
                                    <GridCell Key="cell36">
                                        <DataBinding DefaultFormulaValue="Sum('Standard_Stock')"/>
                                    </GridCell>
                                    <GridCell Key="cell37">
                                        <DataBinding DefaultFormulaValue="Sum('Extant_Number')"/>
                                    </GridCell>
                                    <GridCell Key="cell38">
                                        <DataBinding DefaultFormulaValue="Sum('Applications_Number')"/>
                                    </GridCell>
                                    <GridCell Key="cell39">
                                        <DataBinding DefaultFormulaValue="Sum('Actual_Approvals_Number')"/>
                                    </GridCell>
                                    <GridCell Key="cell44"/>
                                    <GridCell Key="cell40"/>
                                    <GridCell Key="cell41"/>
                                    <GridCell Key="cell42"/>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="150px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
</Form>
