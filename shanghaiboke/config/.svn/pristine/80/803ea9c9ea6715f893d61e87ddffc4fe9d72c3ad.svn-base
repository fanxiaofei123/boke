<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="NoInformNewReceive" Caption="无通知单新增收货" Authenticate="false" HasNavigationBar="false">
    <DataSource>
        <DataObject Key="LRP_NoInformNewReceive" Caption="无通知单新增收货" PrimaryTableKey="LRP_WMTx_L">
            <TableCollection>
                <Table Key="LRP_WMTx_L" Caption="通知单收货明细" TableMode="Detail" SourceType="Query">
                    <Column Caption="对象标识" DataType="Long" Key="OID"/>
                    <Column Caption="状态" DataType="Integer" Key="Status"/>
                    <Column Caption="状态" DataType="Integer" Key="listStatus"/>
                    <Column Caption="物料ID" DataType="Long" Key="MaterialId"/>
                    <Column Key="MaterialCode" Caption="物料代码" DataType="Varchar" Length="100"/>
                    <Column Key="MaterialName" Caption="物料名称" DataType="Varchar" Length="200"/>
                    <Column Caption="单位" DataType="Varchar" Key="MaterialUnit" Length="10"/>
                    <Column Caption="收货量" DataType="Numeric" Key="Qty" Precision="18" Scale="6"/>
                    <Column Caption="批号" DataType="Varchar" Key="DestBatchNo" Length="100"/>
                    <Column Caption="收货区" DataType="Long" Key="DestStoreareaId"/>
                    <Column Key="DestStoreareaCode" Caption="收货区名称" DataType="Varchar" Length="200"/>
                    <Column Caption="明细oid" DataType="Long" Key="toid"/>
                    <!-- <ParameterCollection>
						<Parameter DataType="Long" Formula="GetPara('Owner')"/> 
                    </ParameterCollection> -->
                    <Statement>
                        <![CDATA[ 
select 
    h.OID,
    h.WarehouseCenterId,
	h.OwnerId,
	h.status,
    m.Code as MaterialCode,
	  m.Name as MaterialName,
	 l.oid as toid,
    l.MaterialUnit,
	l.MaterialId,
    l.qty,
    l.DestBatchNo,
    l.DestStoreareaId,
	l.status as listStatus,
    s.Code as DestStoreareaCode, 	
    h.TxDateTime,
	  h.WarehouseKeeperId
from LRP_WMTx_H h left join LRP_WMTx_L l on h.oid=l.soid left join LRP_Material m on m.oid = l.MaterialId left join LRP_Owner o on o.oid = h.OwnerId left join lrp_Storearea s on s.oid = l.DestStoreareaId 
    where
        h.TxTypeCode = '102' and (h.status=100 or h.status=500) and 1=0
    ]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Key="SelectStorearea" Description="查找收货库区">
            <Statement>
                <![CDATA[select code as c,name as n  from LRP_Storearea where IsRecvArea=1]]>
            </Statement>
        </Query>
        <Query Key="SelectMaterial" Description="查找该货主下的物料">
            <Statement>
                <![CDATA[select m.oid,m.code,m.name from lrp_material m left join LRP_OwnerMaterial o on m.oid=o.soid left join lrp_owner w on w.oid=o.ownerid where w.code= ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectOwner" Description="查找该货主名称">
            <Statement>
                <![CDATA[select name from lrp_owner where code = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectOid" Description="查找物料">
            <Statement>
                <![CDATA[select oid from lrp_material where code = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectName" Description="查找物料名称">
            <Statement>
                <![CDATA[select name from lrp_material where code = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectUnit" Description="查找物料单位">
            <Statement>
                <![CDATA[select basicunit from lrp_material where code = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#e6e6e6"/>
                <LinearLayoutPanel Caption="Title3" Key="Title" Orientation="Horizontal" X="0" Y="0">
                    <Format BackColor="#f14c52"/>
                    <Button Key="Cancel" Caption="取消" Height="auto" Width="60px">
                        <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Left">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									ShowConfirm('是否放弃本次收货？', 'YES_NO', 
										{
											YES: {
													Back();
												}, 
											NO: {} 
										}
												)
								]]>
                        </OnClick>
                    </Button>
                    <Label Key="OrderTitle3" Caption="新增收货" Height="auto" Weight="1.0">
                        <Format ForeColor="#ffffff" HAlign="Center">
                            <Font Size="20"/>
                        </Format>
                    </Label>
                    <Button Key="Finish" Caption="完成" Height="auto" Width="60px">
                        <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Right">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									var count = GetRowCount('list',false);
									var b = true;
									if(count > 0){
										InvokeService("LRP_NoInformReceive", true, false,Para('OwnerId'),Para('OwnerNo'),root.GetPara('WarehouseCenterId'),GetOperator());
										ShowToast("收货完成");
										Parent.LoadData();
										Back();
									}
									else{	
										ShowToast("本次收货明细无数据，无法完成。");								
									}
																													
									]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <TableView Key="RouteName_table" X="0" Y="1">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="r1" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel33" Height="50px" Orientation="Horizontal">
                                <TextEditor Key="Material_code" Caption="扫描物料条码" PromptText="扫描物料条码" BorderStyle="none" Weight="1.0" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                    <KeyEnter>
                                        <![CDATA[
										     CheckMaterial();
										
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Button Key="query_btn" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none" Height="auto">
                                    <Format HAlign="Left">
                                        <Font Size="6"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
										CheckMaterial();
									]]>
                                    </OnClick>
                                </Button>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r2" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel34" Height="50px" Orientation="Horizontal">
                                <Label Key="AddQty_lbl" Caption="增加量" Width="60px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="AddQty_code" Caption="增加量" Enable="false" Precision="18" Scale="0" Width="120px" Height="auto">
                                    <DataBinding DefaultValue="1"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="RecvQty_Null_lbl" Caption="总收货量" Width="55px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="RecvQty_Null_code" Caption="总收货量" Enable="false" Precision="18" Scale="0" Width="pref" Weight="1.0" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="list" SeparatorStyle="solid none solid none" RowType="Detail" SeparatorColor="#dde0e7" TableKey="LRP_WMTx_L" SelectColor="#dddddd">
                            <GridLayoutPanel Key="GridLayoutPanel3" Caption="GridLayoutPanel3">
                                <Label Key="oid" LeftPadding="5px" Visible="false" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="toid"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterialId" LeftPadding="5px" Visible="false" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterialId"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="Materialcode" LeftPadding="5px" X="0" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MaterialCode"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterialName" LeftPadding="5px" X="2" Y="0" XSpan="3">
                                    <DataBinding ColumnKey="MaterialName"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="lab_MaterialUnit" Caption="单位" LeftPadding="5px" X="6" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterialUnit" LeftPadding="5px" X="8" Y="0" XSpan="4">
                                    <DataBinding ColumnKey="MaterialUnit"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="Qty_lbl" Caption="收货量" LeftPadding="5px" X="0" Y="1" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="Qty" Precision="18" Scale="0" Enable="Status==10" X="2" Y="1" XSpan="2">
                                    <DataBinding ColumnKey="Qty"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="BatchNo_lbl" Caption="批号" LeftPadding="5px" X="6" Y="1" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <TextEditor Key="BatchNo" Caption="批号" Enable="Status==10" X="8" Y="1" XSpan="4">
                                    <DataBinding ColumnKey="DestBatchNo" VAlign="Bottom"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </TextEditor>
                                <Label Key="lab_Storearea" Caption="收货区" LeftPadding="5px" X="0" Y="2" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <ComboBox Key="Storearea" Caption="收货区" SourceType="Formula" Enable="Status==10" LeftPadding="5px" X="2" Y="2" XSpan="6">
                                    <DataBinding ColumnKey="DestStoreareaCode"/>
                                    <Format HAlign="Left">
                                        <Font Size="13"/>
                                    </Format>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery('SelectStorearea')]]>
                                    </FormulaItems>
                                </ComboBox>
                                <ComboBox Key="Status" Caption="状态" LeftPadding="5px" Visible="false" X="6" Y="2" XSpan="3">
                                    <DataBinding ColumnKey="listStatus"/>
                                    <Format HAlign="Left">
                                        <Font Size="13"/>
                                    </Format>
                                    <Item Caption="已输入" Key="10" Value="10"/>
                                    <Item Caption="已完成" Key="90" Value="90"/>
                                </ComboBox>
                                <Button Key="Delete" Caption="删除" Enable="Status==10" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" X="0" Y="3" XSpan="3">
                                    <Format BackColor="#f14c52" ForeColor="#ffffff">
                                        <Font Size="13"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
								          ShowConfirm('确定删除该条明细吗?', 'YES_NO', 
												{
													YES: {
														DeleteRow('list', GetRowIndex('list'));
														var rowcount = GetRowCount('list');
														var i = 0;
														var totalQty = 0.0;
														while(i < rowcount){
															var qty2 = GetCellValue('list',i,'Qty');			
															totalQty = totalQty + qty2;
															i=i+1;
															}
														   SetValue('RecvQty_Null_code',totalQty);	
														ShowToast('已删除');	  
													  }, 
													NO: {} 
												}	
											)
											
										
									]]>
                                    </OnClick>
                                </Button>
                                <Button Key="CopyRecv" Caption="复制新增" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" X="3" Y="3" XSpan="5">
                                    <Format BackColor="#f14c52" ForeColor="#ffffff">
                                        <Font Size="13"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
								       var MtlCode = GetCellValue('list', -1, 'Materialcode');
								       var MtlName = GetCellValue('list', -1, 'MaterialName');
									   var MtlUnit = GetCellValue('list', -1, 'MaterialUnit');
									   var qty = GetCellValue('list', -1, 'Qty');
									   var batchNo = GetCellValue('list', -1, 'BatchNo');
									   var storearea = GetCellValue('list', -1, 'Storearea');
									    var oid = GetCellValue('list', -1, 'oid');
								
									   var rowIndex= InsertRow('list',GetRowIndex('list')+1);

									   SetCellValue('list', rowIndex, 'Materialcode', MtlCode);
									   SetCellValue('list', rowIndex, 'MaterialName', MtlName);
									   SetCellValue('list', rowIndex, 'MaterialUnit', MtlUnit);
									   SetCellValue('list', rowIndex, 'Qty', qty);
									   SetCellValue('list', rowIndex, 'BatchNo',batchNo);
									   SetCellValue('list', rowIndex, 'Storearea',storearea);
									   SetCellValue('list', rowIndex, 'Status',10);
									   SetCellValue('list', rowIndex, 'oid',oid);
									   
									   CalculateQty();
									]]>
                                    </OnClick>
                                </Button>
                                <Button Key="Finish_Recv" Caption="完成" Visible="Status==10" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" X="8" Y="3" XSpan="4">
                                    <Format BackColor="#f14c52" ForeColor="#ffffff">
                                        <Font Size="13"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
								       SetCellValue('list',-1,'Status',90);
										
									]]>
                                    </OnClick>
                                </Button>
                                <Button Key="Finish_R_Recv" Caption="撤销完成" Visible="Status==90" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" X="8" Y="3" XSpan="4">
                                    <Format BackColor="#f14c52" ForeColor="#ffffff">
                                        <Font Size="13"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
								       SetCellValue('list',-1,'Status',10);
										
									]]>
                                    </OnClick>
                                </Button>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="30px"/>
                                    <RowDef Height="40px"/>
                                    <RowDef Height="40px"/>
                                    <RowDef Height="40px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="1">
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="18%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="18%"/>
                                    <ColumnDef Width="20px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="80px"/>
                                    <ColumnDef Width="16%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef Height="50px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
		   
			LoadData();			
			CalculateQty();   
        ]]>
    </OnLoad>
    <MacroCollection>
        <Macro Key="CalculateQty" Description="计算并设置总收货量">
            <![CDATA[
				var total = 0.0; 
				
				var count = GetRowCount('list');
				var i = 0;
				while(i < count){
					total = total + GetCellValue('list',i,'Qty');
					i = i + 1;							
				}
				SetValue('RecvQty_Null_code',total);
			]]>
        </Macro>
        <Macro Key="CheckMaterial" Description="根据扫入的物料条码定位对应的物料">
            <![CDATA[
				if(Material_code<>''){
					var focusRowIndex=GetFocusRow('list');
					var flag=false;
					var count = GetRowCount('list',false);
					var i=0;
					var j=0;

					while(i<count){
					    var qty = GetCellValue('list',i,'Qty');
						var addQty = GetValue('AddQty_code');
						if(GetCellValue('list', i,'Materialcode')==Material_code && GetCellValue('list', i,'Status') == 10){
							SetFocusRow('list',i);
							SetRowIndex('list',i);
							qty = qty + addQty;
							SetCellValue('list',i,'Qty',qty,false);	
							ScrollTo('list',i);
							flag=true;
							break;
								}
								i=i+1;							
					          }
					if(flag==false){
					    var b = false;
					    var rs = DBNamedQuery('SelectMaterial',Para('OwnerId'));
					 rs.beforefirst(); 
                   while(rs.next()){
					 if(Material_code == rs.code){
					   b = true;
					   break;
					  }
					}
					  if(b == false){
					    var name = DBNamedQueryValue('SelectOwner',Para('OwnerId'));
						ShowToast("货主" + name + "找不到此条码物料。");
						}else{
						 var count = GetRowCount('list');
						 InsertRow('list');
						 var matOid = DBNamedQueryValue('SelectOid',Material_code);
						 var matName = DBNamedQueryValue('SelectName',Material_code);
						 var unit = DBNamedQueryValue('SelectUnit',Material_code);
						 SetCellValue('list',count,'Materialcode',Material_code);
						 SetCellValue('list',count,'MaterialName',matName);
						 SetCellValue('list',count,'MaterialUnit',unit);
						 SetCellValue('list',count,'MaterialId',matOid);
						 SetCellValue('list',count,'BatchNo','*');
						 SetCellValue('list',count,'Status',10);
						  SetCellValue('list',count,'Qty',1);
						 ScrollTo('list',count);
						}
					  }
				}
				SetFocus('Material_code');
				var rowcount = GetRowCount('list');
					var i = 0;
					var totalQty = 0.0;
					while(i < rowcount){
						var qty2 = GetCellValue('list',i,'Qty');			
						totalQty = totalQty + qty2;
						i=i+1;
						}
					   SetValue('RecvQty_Null_code',totalQty);	
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara DataType="Long" Key="Owner" Type="Formula" Formula="Para('OwnerId')"/>
    </FormParaCollection>
</Form>
