<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="NewReceive" Caption="新增收货" Authenticate="false" HasNavigationBar="false">
    <DataSource>
        <DataObject Key="LRP_NewReceive" Caption="新增收货" PrimaryTableKey="LRP_NewReceive_L">
            <TableCollection>
                <Table Key="LRP_NewReceive_L" Caption="新增收货" TableMode="Detail" SourceType="Query">
                    <Column Caption="对象标识" DataType="Long" Key="OID"/>
                    <Column Caption="物料ID" DataType="Long" Key="MaterialId"/>
                    <Column Caption="单位" DataType="Varchar" Key="MaterialUnit" Length="10"/>
                    <Column Caption="通知量" DataType="Numeric" Key="Qty" Precision="18" Scale="6"/>
                    <Column Caption="收货量" DataType="Numeric" Key="RecvQty" Precision="18" Scale="6"/>
                    <Column Key="MaterialName" Caption="物料名称" DataType="Varchar" Length="200"/>
                    <Column Key="MaterialCode" Caption="物料代码" DataType="Varchar" Length="100"/>
                    <Statement>
                        <![CDATA[ select 
  l.OID,
  l.SOID,
  l.MaterialId,
  l.qty,
  l.MaterialUnit,  
  l.recvqty,
  m.Name as MaterialName,
  m.Code as MaterialCode
  from LRP_InboundNotic_L l 
  left join LRP_Material m on m.oid = l.MaterialId where 1=0
    ]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Key="SelectStorearea" Description="查找库区">
            <Statement>
                <![CDATA[select code as c,name as n  from LRP_Storearea where IsRecvArea=1 and WarehouseCenterId = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectStoreareaId" Description="查找库区ID">
            <Statement>
                <![CDATA[select oid from LRP_Storearea where code = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectStoreroomId" Description="查找仓间ID">
            <Statement>
                <![CDATA[select storeroomid from LRP_Storearea where code = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="SelectOwnerName" Description="查找货主名称">
            <Statement>
                <![CDATA[select name from LRP_Owner where oid = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#e6e6e6"/>
                <LinearLayoutPanel Caption="Title3" Key="Title" Orientation="Horizontal" X="0" Y="0">
                    <Format BackColor="#f14c52"/>
                    <Button Key="Cancel" Caption="取消" Height="auto" Width="60px">
                        <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Left">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									ShowConfirm('是否放弃本次收货明细？', 'YES_NO', 
										{
											YES: {
													Back();
												}, 
											NO: {} 
										}
												)
								]]>
                        </OnClick>
                    </Button>
                    <Label Key="OrderTitle3" Caption="新增收货明细" Height="auto" Weight="1.0">
                        <Format ForeColor="#ffffff" HAlign="Center">
                            <Font Size="20"/>
                        </Format>
                    </Label>
                    <Button Key="Comfirm" Caption="确定" Height="auto" Width="60px">
                        <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Right">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									var count = GetRowCount('list',false);
									var rowcount = Para('rowcount');
                                                                        var parentRecvQty = Para('RecvQty_Null_code');//总收货量
                                                                        //Confirm("parentRecvQty=="+parentRecvQty);
									var flag = true;
									if(count > 0){  
									    var i = 0;
										while(i < count){
											var qty2 = GetCellValue('list',i,'Qty');			
											var storearea = GetCellValue('list',i,'Storearea');
											if(qty2 <= 0 || storearea == ''){
											   flag = false;
											   ShowToast("明细中数量要大于0，收货区不可为空。");
											   break;
											}	
											i = i+1;
											}
																					
									if(flag == true){
									     var k = 0;
                                                                                 Parent.SetValue("RecvQty_Null_code",parentRecvQty+RecvQty_Null_code);             
										 while(k < count){
											Parent.InsertRow('list2',k);
											Parent.SetCellValue('list2',k,'Materialcode2',GetValue('MaterialCode1'));
										        Parent.SetCellValue('list2',k,'MaterialName2',GetValue('MaterialName1'));
											Parent.SetCellValue('list2',k,'BasicUnit2',GetValue('MaterialUnit1'));
											Parent.SetCellValue('list2',k,'MaterialId2',GetValue('MaterialId1'));
											Parent.SetCellValue('list2',k,'BatchNo2',
											                    GetCellValue('list',k,'BatchNo'));
											Parent.SetCellValue('list2',k,'CheckQty2',
											                    GetCellValue('list',k,'Qty'));
											Parent.SetCellValue('list2',k,'StoreareaId',
											                    GetCellValue('list',k,'lab_StoreareaId'));	
                                                                                        k = k+1;
										}   
                                                                                
										//Parent.SetPara("parentRecvQty", parentRecvQty+RecvQty_Null_code);
                                                                                Back();
										}
									
									}
        
										
									
									]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <TableView Key="RouteName_table" X="0" Y="1">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="r1" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel" Height="50px" Orientation="Horizontal">
                                <TextEditor Key="MaterialId1" Caption="物料ID" Enable="false" Visible="false" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Width="70px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </TextEditor>
                                <TextEditor Key="MaterialCode1" Caption="物料代码" Enable="false" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Width="70px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </TextEditor>
                                <TextEditor Key="MaterialName1" Caption="物料名称" Enable="false" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Width="80px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </TextEditor>
                                <Label Key="Lab_Unit" Caption="单位" Width="40px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <TextEditor Key="MaterialUnit1" Caption="单位" Enable="false" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Width="auto" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </TextEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r2" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel22" Height="50px" Orientation="Horizontal">
                                <Label Key="NoticeQty_lbl" Caption="可收货量" Width="55px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="NoticeQty_code" Caption="可收货量" Enable="false" Precision="18" Scale="0" Width="110px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="RecvQty_Null_lbl" Caption="本次收货量" Width="65px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="RecvQty_Null_code" Caption="本次收货量" Enable="false" Precision="18" Scale="0" Width="pref" Weight="1.0" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r3" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel33" Height="50px" Orientation="Horizontal">
                                <TextEditor Key="Material_code" Caption="扫描物料条码" PromptText="扫描物料条码" BorderStyle="none" Width="250px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                    <KeyEnter>
                                        <![CDATA[
										CheckMaterial();
										
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Button Key="query_btn" Icon="12.png" OnlyIcon="True" Enable="true" Width="pref" Weight="1.0" BorderStyle="none" Height="auto">
                                    <Format HAlign="Left">
                                        <Font Size="6"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[var count =  GetRowCount("list");
if(count<>0){
    CheckMaterial();
}else{
    Confirm("请先添加明细!");
}

									]]>
                                    </OnClick>
                                </Button>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r4" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel44" Height="50px" Orientation="Horizontal">
                                <Label Key="NoticeQty_lbl2" Caption="增加量" Width="60px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="NoticeQty_code2" Caption="增加量" Precision="18" Scale="0" Width="120px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Recv_Null_lbl2" Caption="收货区" Width="55px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <ComboBox Key="Recv_Null_2" Caption="收货区" Requird="true" SourceType="Formula" Width="pref" Weight="1.0" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery('SelectStorearea',root.GetPara('WarehouseCenterId'))]]>
                                    </FormulaItems>
                                </ComboBox>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r5" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel34" Height="50px" Orientation="Horizontal">
                                <Label Key="Null_lbl2" Width="200px" Weight="1.0" Height="auto"/>
                                <Button Key="NewDetail" Caption="添加明细" BorderRadius="4" BorderColor="#dde0e7" HasBorder="true" Width="100px" Height="auto">
                                    <Format BackColor="#f14c52" ForeColor="#ffffff">
                                        <Font Size="13"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
								        
										var rowcount = GetRowCount('list');	
										if(rowcount == 0){
										  	InsertRow('list');
											SetCellValue('list',0,'BatchNo',"*");
										    SetCellValue('list',0,'Qty',"0");
											SetCellValue('list',0,'Storearea',GetValue('Recv_Null_2'));
										
										}else{
											InsertRow('list');	
											SetCellValue('list',rowcount,'BatchNo',"*");
										    SetCellValue('list',rowcount,'Qty',"0");
											SetCellValue('list',rowcount,'Storearea',GetValue('Recv_Null_2'));
											SetCellValue('list',rowcount,'lab_StoreareaId',
											DBNamedQueryValue('SelectStoreareaId',GetValue('Recv_Null_2')));
										}											
									]]>
                                    </OnClick>
                                </Button>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="list" SeparatorStyle="solid none solid none" RowType="Detail" SeparatorColor="#dde0e7" TableKey="LRP_NewReceive_L" SelectColor="#dddddd">
                            <GridLayoutPanel Key="GridLayoutPanel3" Caption="GridLayoutPanel3">
                                <Label Key="lab_BatchNo" Caption="批号" LeftPadding="5px" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <TextEditor Key="BatchNo" LeftPadding="5px" Caption="批号" X="2" Y="0" XSpan="6">
                                    <DataBinding DefaultValue="*"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </TextEditor>
                                <Label Key="lab_Qty" Caption="数量" LeftPadding="5px" X="0" Y="1" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="Qty" Precision="18" Caption="数量" Scale="0" X="2" Y="1" OnlyShow="true" Enable="false" XSpan="2">
                                    <DataBinding DefaultValue="0"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="lab_Storearea" Caption="收货区" LeftPadding="5px" X="4" Y="1" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <ComboBox Key="Storearea" Caption="收货区" OnlyShow="true" SourceType="Formula" Enable="false" LeftPadding="5px" X="6" Y="1" XSpan="4">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery('SelectStorearea',root.GetPara('WarehouseCenterId'))]]>
                                    </FormulaItems>
                                </ComboBox>
                                <Label Key="lab_StoreareaId" Caption="收货区id" LeftPadding="5px" Visible="false" X="4" Y="1" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Button Key="spec_sel35" Caption="删除" Enable="true" Width="38px" Height="auto" X="9" Y="1" XSpan="3" BorderRadius="4" HasBorder="true">
                                    <Format BackColor="#f14c52" ForeColor="#ffffff">
                                        <Font Size="15"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
										  
									       ShowConfirm('确定删除该条明细吗?', 'YES_NO', 
												{
													YES: {
														DeleteRow('list', GetRowIndex('list'));
														var rowcount = GetRowCount('list');
														var i = 0;
														var totalQty = 0.0;
														while(i < rowcount){
															var qty2 = GetCellValue('list',i,'Qty');			
															totalQty = totalQty + qty2;
															i=i+1;
														}
														SetValue('RecvQty_Null_code',totalQty);	
														var focusRowIndex=GetFocusRow('list');
														if(GetRowIndex('list')>0 && focusRowIndex == GetRowIndex('list')){
														       SetFocusRow('list',0);
														}
														ShowToast('已删除');	  
													  }, 
													NO: {} 
												}	
											)
											

											
									     ]]>
                                    </OnClick>
                                </Button>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="40px"/>
                                    <RowDef Height="40px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="1">
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="18%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="18%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="30px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="50px"/>
                                    <ColumnDef Width="16%"/>
                                    <ColumnDef Width="60px"/>
                                    <ColumnDef Width="16%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef Height="50px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnPostShow>
        <![CDATA[
		    var dt = DBNamedQuery('SelectStorearea',root.GetPara('WarehouseCenterId'));
			if(dt.next()){
		         SetSelectIndex('Recv_Null_2',0);
			}else{
			     ShowToast("当前用户的仓储中心下没有收货区");
			}
		    SetValue('MaterialCode1',Para('Materialcode'));
			SetValue('MaterialName1',Para('MaterialName'));
			SetValue('MaterialUnit1',Para('MaterialUnit'));
			SetValue('MaterialId1',Para('MaterialId'));
			SetValue('NoticeQty_code',Para('qty'));
			SetValue('NoticeQty_code2',1);
			InsertRow('list');					
			SetCellValue('list',0,'BatchNo',"*");
			SetCellValue('list',0,'Qty',"0");
			SetCellValue('list',0,'Storearea',GetValue('Recv_Null_2'));
            SetCellValue('list',0,'lab_StoreareaId',
			DBNamedQueryValue('SelectStoreareaId',GetValue('Recv_Null_2')));			
			SetFocusRow('list',0);
				
			var rowcount = GetRowCount('list');
			var i = 0;
			var totalQty = 0.0;
			while(i < rowcount){
				var qty2 = GetCellValue('list',i,'Qty');			
				totalQty = totalQty + qty2;
				i=i+1;
				}
			   SetValue('RecvQty_Null_code',totalQty);			
			
			  
        ]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="CheckMaterial" Description="根据扫入的物料条码定位对应的物料">
            <![CDATA[
				if(Material_code<>''){
					var focusRowIndex=GetFocusRow('list');
					var flag=false;
					var count = GetRowCount('list',false);
					var j=0;
					 if(GetValue('MaterialCode1') == Material_code ){
						     var qty = GetCellValue('list',focusRowIndex,'Qty');
						     var addQty = GetValue('NoticeQty_code2');
							 var noticeQty = GetValue('NoticeQty_code');
						     var recvQty = GetValue('RecvQty_Null_code');
							 if(recvQty < noticeQty){
							     qty = qty + addQty;
							     SetCellValue('list',focusRowIndex,'Qty',qty);
						         SetCellValue('list',focusRowIndex,'Storearea',GetValue('Recv_Null_2'));
							 }else{
							     ShowToast("本次收货量不能超出可收货量。");
							 }	
					 }else{
						   ShowToast("通知明细中找不到该条码物料。");
						}
									
					}
					
					var rowcount = GetRowCount('list');
					var i = 0;
					var totalQty = 0.0;
					while(i < rowcount){
						var qty2 = GetCellValue('list',i,'Qty');			
						totalQty = totalQty + qty2;
						i=i+1;
						}
					   SetValue('RecvQty_Null_code',totalQty);	
						
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara Formula="Para('OID')" Key="OID" Type="Formula"/>
        <FormPara Formula="Para('NoticeNo')" Key="NoticeNo" Type="Formula"/>
        <FormPara Formula="Para('OwnerId')" Key="OwnerId" Type="Formula"/>
        <FormPara Formula="Para('OwnerNo')" Key="OwnerNo" Type="Formula"/>
        <FormPara Formula="Para('rowcount')" Key="rowcount" Type="Formula"/>
    </FormParaCollection>
</Form>
