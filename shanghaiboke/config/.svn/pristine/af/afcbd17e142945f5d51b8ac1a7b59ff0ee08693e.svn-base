<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="ChartCollection" Caption="运输业务监控" FormType="Report">
    <DataSource>
        <DataObject Key="ChartCollection" Caption="运输业务监控">
            <TableCollection>
                <Table Key="TotalOrderMileage" Caption="今年每月订单总量" TableMode="Detail" SourceType="Query">
                    <Column Key="qty" Caption="总单数" DataType="Integer" Precision="16" Scale="2"/>
                    <Column Key="m" Caption="月份" DataType="Varchar"/>
                    <Column Key="vname" Caption="业务类型" DataType="Varchar"/>
                    <Statement>
                        <![CDATA[select count(1)  qty,
ifnull(v.name, '其它') vname, 
date_format(t.createtime, '%Y%m') m
from lrp_transportorder_h t 
left join lrp_transvrtype v on t.TranSvrType = v.oid 
where t.createtime >= date_sub(sysdate(), interval 12 month) and t.status >= 100 
group by date_format(t.createtime, '%Y%m'), vname
order by date_format(t.createtime, '%Y%m'), vname]]>
                    </Statement>
                </Table>
                <Table Key="OrderTruck" Caption="今年每月订单总金额" TableMode="Detail" SourceType="Query">
                    <Column Key="qty" Caption="数量" DataType="Numeric" Precision="16" Scale="2"/>
                    <Column Key="m" Caption="月份" DataType="Varchar"/>
                    <Column Key="vname" Caption="业务类型" DataType="Varchar"/>
                    <Statement>
                        <![CDATA[select convert(sum(totalamount), decimal(16,2))  qty,
ifnull(v.name, '其它') vname, 
date_format(t.createtime, '%Y%m') m
from lrp_transportorder_h t 
left join lrp_transvrtype v on t.TranSvrType = v.oid 
where t.createtime >= date_sub(sysdate(), interval 12 month) and t.status >= 100 
group by date_format(t.createtime, '%Y%m'), vname
order by date_format(t.createtime, '%Y%m'), vname]]>
                    </Statement>
                </Table>
                <Table Key="NewOrders" Caption="今日订单总数" SourceType="Query" TableMode="Detail">
                    <Column Key="qty" DataType="Integer"/>
                    <Statement>
                        <![CDATA[select count(1) qty from lrp_logisticsorder_h
where status >= 100 and createtime >= curdate()]]>
                    </Statement>
                </Table>
                <Table Key="NewOrdersMoney" Caption="当日完成订单总金额" SourceType="Query" TableMode="Detail">
                    <Column Key="order_amount" DataType="Numeric" Precision="16" Scale="2"/>
                    <Statement>
                        <![CDATA[select ifnull(sum(totalamount),0) as order_amount from lrp_transportorder_h 
where status >= 100 and createtime >= curdate()
]]>
                    </Statement>
                </Table>
                <Table Key="SuspendingOrder" Caption="待处理订单" TableMode="Detail" SourceType="Query">
                    <Column Key="qty" Caption="数量" DataType="Integer"/>
                    <Statement>
                        <![CDATA[select count(1) qty from lrp_logisticsorder_h
where status = 100 and 
date_add(createtime, interval 120 minute) < sysdate()]]>
                    </Statement>
                </Table>
                <Table Key="NotReached" Caption="未送达订单" TableMode="Detail" SourceType="Query">
                    <Column Key="qty" Caption="数量" DataType="Integer"/>
                    <Statement>
                        <![CDATA[select count(1) qty from lrp_transportorder_h 
where status >= 100 and status < 900 and ExpectArriveTime is not null
 and  ExpectArriveTime < sysdate()
]]>
                    </Statement>
                </Table>
                <Table Key="YearDelayed" Caption="今年交付及时率" TableMode="Detail" SourceType="Query">
                    <Column Key="vname" Caption="服务等级" DataType="Varchar"/>
                    <Column Key="ratio" Caption="交付及时率" DataType="Numeric" Precision="16" Scale="2"/>
                    <Statement>
                        <![CDATA[select a.vname, convert((1 - ifnull(b.qty,0) / a.qty) * 100, decimal(10,2)) ratio
from (
select ifnull(v.name, '其它') vname, count(1) qty 
from lrp_transportorder_h h
left join lrp_transvrlevel v on h.tranSvrLevel = v.oid
where h.status >= 100 and year(h.createtime) = year(curdate())
group by v.Name) a left join 
(select ifnull(v.name, '其它') vname, count(1) qty 
 from lrp_transportorder_h h
 left join lrp_transvrlevel v on h.tranSvrLevel = v.oid
where ((h.status >= 100 and h.status < 900 and h.ExpectArriveTime is not null
 and  h.ExpectArriveTime < sysdate()) or 
 (h.status >= 900 and h.FinishDateTime is not null and h.ExpectArriveTime is not null and 
h.FinishDateTime > h.ExpectArriveTime)) and year(h.createtime) = year(curdate()) 
group by v.name ) b on a.vname = b.vname

]]>
                    </Statement>
                </Table>
                <Table Key="YearLoss" Caption="今年货损货差率" TableMode="Detail" SourceType="Query">
                    <Column Key="vname" Caption="业务类型" DataType="Varchar"/>
                    <Column Key="ratio" Caption="货损货差率" DataType="Numeric" Precision="16" Scale="2"/>
                    <Statement>
                        <![CDATA[select a.vname, convert((1 - ifnull(b.qty,0) / a.qty) * 100, decimal(10,2)) ratio
from (
select ifnull(v.name, '其它') vname, count(1) qty 
from lrp_transportorder_h h
left join lrp_transvrtype v on h.TranSvrType = v.oid
where h.status >= 100 and year(h.createtime) = year(curdate())
group by v.Name) a left join 
(select ifnull(v.name, '其它') vname, count(1) qty 
 from lrp_transportorder_h h
 left join lrp_transvrtype v on h.TranSvrType = v.oid
where ((h.status >= 100 and h.status < 900 and h.ExpectArriveTime is not null
 and  h.ExpectArriveTime < sysdate()) or 
 (h.status >= 900 and h.FinishDateTime is not null and h.ExpectArriveTime is not null and 
h.FinishDateTime > h.ExpectArriveTime)) and year(h.createtime) = year(curdate()) 
group by v.name ) b on a.vname = b.vname]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <OperationCollection>
        <Operation Key="close" Caption="关闭">
            <Action>
                <![CDATA[Close()]]>
            </Action>
        </Operation>
        <Operation Key="Export" Caption="导出" Visible="false">
            <Action>
                <![CDATA[ExportExcel()]]>
            </Action>
        </Operation>
    </OperationCollection>
    <Body>
        <Block>
            <SplitPanel Key="SplitPanel1" Orientation="Vertical" Height="100%" Caption="SplitPanel1" Width="100%" OverflowY="Scroll">
                <GridLayoutPanel Key="GridLayoutPanel5" Height="100%" Caption="GridLayoutPanel5" Width="100%">
                    <Label Key="suspendCount" Caption="100" X="1" Y="1" Class="newCount">
                        <DataBinding TableKey="SuspendingOrder" ColumnKey="qty"/>
                    </Label>
                    <Label Key="orderCount" Caption="200" X="3" Y="1" Class="orderCount">
                        <DataBinding TableKey="NewOrders" ColumnKey="qty"/>
                    </Label>
                    <Label Key="total" Caption="10" X="5" Y="1" Class="total">
                        <DataBinding TableKey="NewOrdersMoney" ColumnKey="order_amount"/>
                    </Label>
                    <Label Key="NotReachedQty" Caption="0" X="7" Y="1" Class="bonus">
                        <DataBinding TableKey="NotReached" ColumnKey="qty"/>
                    </Label>
                    <Label Key="lb1" Caption="超时未处理单据数" X="1" Y="2" Class="userlb">
                        <Format HAlign="Left"/>
                    </Label>
                    <Label Key="lb2" Caption="今日总订单数" X="3" Y="2" Class="userlb" XSpan="2">
                        <Format HAlign="Left"/>
                    </Label>
                    <Label Key="lb3" Caption="今日订单总金额(元)" X="5" Y="2" Class="userlb" XSpan="2">
                        <Format HAlign="Left"/>
                    </Label>
                    <Label Key="lb4" Caption="未及时交付单据数(笔)" X="7" Y="2" Class="userlb" XSpan="2">
                        <Format HAlign="Left"/>
                    </Label>
                    <RowDefCollection RowGap="8">
                        <RowDef Height="5px"/>
                        <RowDef Height="30px"/>
                        <RowDef Height="30px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="20%"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="15%"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="15%"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="15%"/>
                        <ColumnDef Width="100px"/>
                        <ColumnDef Width="25%"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <GridLayoutPanel Key="GridLayoutPanel6" Height="100%" OverflowY="Auto" Caption="GridLayoutPanel6" Width="100%">
                    <Chart Caption="今年交付及时率" Key="Chart1" SourceType="DataObject" CategoryAxisTitle="服务等级" Title="今年交付及时率" SeriesAxisTitle="及时率" Height="pref" X="1" Y="3" ChartType="VBar">
                        <ChartDataSource BindingKey="YearDelayed">
                            <Series DataKey="ratio" Title="及时率"/>
                            <Category DataKey="vname" Title="服务等级"/>
                        </ChartDataSource>
                    </Chart>
                    <Chart Caption="今年货损货差率" Key="Chart2" SourceType="DataObject" Height="pref" X="3" Y="3" ChartType="VBar" CategoryAxisTitle="业务类型" SeriesAxisTitle="货损货差率" Title="今年货损货差率">
                        <ChartDataSource BindingKey="YearLoss">
                            <Series DataKey="ratio" Title="货损货差率"/>
                            <Category DataKey="vname" Title="服务等级"/>
                        </ChartDataSource>
                    </Chart>
                    <Label Key="lb5" Caption="今年交付及时率" X="1" Y="1" Class="userlb" Icon="1.jpg">
                        <Format HAlign="Left"/>
                    </Label>
                    <Label Key="lb6" Caption="今年货损货差率" X="3" Y="1" Class="userlb" Icon="1.jpg">
                        <Format HAlign="Left"/>
                    </Label>
                    <Chart Caption="每月订单量" Key="Chart3" SourceType="DataObject" X="1" Y="7" ChartType="VBar">
                        <ChartDataSource BindingKey="TotalOrderMileage">
                            <Series DataKey="qty" Title="订单数"/>
                            <Category DataKey="m"/>
                        </ChartDataSource>
                    </Chart>
                    <Chart Caption="每月订单金额" Key="Chart4" SourceType="DataObject" X="3" Y="7" ChartType="VBar">
                        <ChartDataSource BindingKey="OrderTruck">
                            <Series DataKey="qty" Title="订单总金额"/>
                            <Category DataKey="m"/>
                        </ChartDataSource>
                    </Chart>
                    <Label Key="lb7" Caption="每月订单量" X="1" Y="5" Class="userlb" Icon="1.jpg">
                        <Format HAlign="Left"/>
                    </Label>
                    <Label Key="lb8" Caption="每月订单金额" X="3" Y="5" Class="userlb" Icon="1.jpg">
                        <Format HAlign="Left"/>
                    </Label>
                    <Separator Caption="Separator1" Key="Separator1" X="1" Y="6" Class="usersp"/>
                    <Separator Caption="Separator2" Key="Separator2" X="3" Y="6" Class="usersp"/>
                    <Separator Caption="Separator3" Key="Separator3" X="1" Y="2" Class="usersp"/>
                    <Separator Caption="Separator4" Key="Separator4" X="3" Y="2" Class="usersp"/>
                    <RowDefCollection>
                        <RowDef Height="5px"/>
                        <RowDef Height="30px"/>
                        <RowDef Height="10px"/>
                        <RowDef Height="200px"/>
                        <RowDef Height="30px"/>
                        <RowDef Height="30px"/>
                        <RowDef Height="10px"/>
                        <RowDef Height="200px"/>
                        <RowDef Height="30px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="3%"/>
                        <ColumnDef Width="45%"/>
                        <ColumnDef Width="4%"/>
                        <ColumnDef Width="45%"/>
                        <ColumnDef Width="3%"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <SplitSize Size="80px"/>
                <SplitSize Size="100%"/>
            </SplitPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[LoadData();]]>
    </OnLoad>
</Form>
