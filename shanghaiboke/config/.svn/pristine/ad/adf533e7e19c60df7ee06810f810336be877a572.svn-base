<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_T_IncomeLine_LRP" Caption="运输收入明细调整" InitState="Default">
    <DataSource RefObjectKey="LRP_IncomeLine"/>
    <OperationCollection>
        <Operation Key="Edit" Caption="编辑" Visible="ReadOnly()" ShortCuts="Ctrl+E">
            <Action>
                <![CDATA[Edit()]]>
            </Action>
        </Operation>
        <Operation Key="Save" Caption="保存" Visible="!ReadOnly()" ShortCuts="Ctrl+S">
            <Action>
                <![CDATA[SaveData(); 
UpdateView();]]>
            </Action>
        </Operation>
        <Operation Key="Cancel" Caption="取消" Visible="!ReadOnly()">
            <Action>
                <![CDATA[//重新查询
//DealCondition();LoadData();ShowData();
Cancel();	]]>
            </Action>
        </Operation>
        <Operation Key="BatchConfirm" Caption="确认" Visible="ReadOnly()">
            <Action>
                <![CDATA[var noselect = true;
var i=0;
var count = GetRowCount("Grid1",false); 
while (i < count){		
    if(GetCellValue("Grid1", i, "Select") == true){ 	
	noselect = false;
        
        if (Status > 100){
            Confirm(LocaleString('CHshow','chkey6'));
            return 0;
        }			
    }	
    i=i+1;				
}
if (noselect) {
    Confirm(LocaleString('CHshow','chkey7'));
    return 0;
}

Confirm(LocaleString('CommonDef','key19'),'YES_NO',{YES:{
    loop "Grid1" (true){
        if(Select == true){ 
	  Status = 200;
          Select = false;
	}					
    }
    SaveData(); 
    UpdateView();
},NO:{}});
]]>
            </Action>
        </Operation>
        <Operation Caption="撤销确认" Key="BatchConfirm-R" Visible="ReadOnly()">
            <Action>
                <![CDATA[var noselect = true;
var i=0;
var count = GetRowCount("Grid1",false); 
while (i < count){		
    if(GetCellValue("Grid1", i, "Select") == true){ 	
	noselect = false;
        
        if (Status != 200){
            Confirm(LocaleString('CHshow','chkey8'));
            return 0;
        }			
    }	
    i=i+1;				
}
if (noselect) {
    Confirm(LocaleString('CHshow','chkey9'));
    return 0;
}

Confirm(LocaleString('CommonDef','key22'),'YES_NO',{YES:{
    loop "Grid1" (true){
        if(Select == true){ 
	  Status = 100;
          Select = false;
	}					
    }
    SaveData(); 
    UpdateView();
},NO:{}});]]>
            </Action>
        </Operation>
        <Operation Caption="删除" Key="BatchDelete">
            <Action>
                <![CDATA[
//由于该数据对象只有明细，因此不能用batchdeletedata
var noselect = true;
var i=0;
var count = GetRowCount("Grid1"); 
while (i < count){		
    if(GetCellValue("Grid1", i, "Select") == true){ 	
	noselect = false;
        //若选择了状态大于100的明细则不允许删除
        if (Status > 100){
            Confirm(LocaleString('CHshow','chkey10'));
            return 0;
        }			
    }	
    i=i+1;				
}
if (noselect) {
    Confirm(LocaleString('CHshow','chkey11'));
    return 0;
}
//编辑状态和非编辑状态有两种删除方式
if (ReadOnly()){
    //非编辑状态下，因为会直接删除，所以要进行判断
    Confirm(LocaleString('CommonDef','key37'),'YES_NO',{YES:{
        var i=0;
        var count = GetRowCount("Grid1",false);
        while ( i < count ) {
            if(GetCellValue("Grid1", i, "Select") == true){ 
                DeleteRow("Grid1",i);
                i=i-1; 
	        count=count-1; 
            }
            i=i+1;
        }  
        //如果是非编辑情况下，直接保存
        SaveData(); 
        UpdateView();
    },NO:{return 0;}});

}else {
    
    i=0;
    while ( i < count - 1 ) {
        if(GetCellValue("Grid1", i, "Select") == true){ 
            DeleteRow("Grid1",i); 
            i=i-1; 
	    count=count-1; 
        }
        i=i+1;
    }    
}
       			   



]]>
            </Action>
        </Operation>
        <Operation Caption="关闭界面" Key="Close" RefKey="Close"/>
    </OperationCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="root" Caption="根面板">
                <ToolBar Key="ToolBar1" Height="pref" Caption="ToolBar1">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Key="SplitPanel1" Orientation="Vertical" Height="100%" Caption="SplitPanel1">
                    <GridLayoutPanel Key="query" Height="100%" Padding="5px" Caption="查询字段" BottomPadding="5px">
                        <Button Key="Query" Caption="查询" X="10" Y="0" Enable="ReadOnly()" TabOrder="200">
                            <OnClick>
                                <![CDATA[//清空故意设置的查无数据的条件
SetValue("OID_C", "");
DealCondition();
LoadData();
ShowData();	
								]]>
                            </OnClick>
                        </Button>
                        <Button Key="cancel" Caption="重置" X="10" Y="1" Enable="ReadOnly()" TabOrder="210">
                            <OnClick>
                                <![CDATA[ResetCondition();
SetValue("DispatchOrg_C", getCurDispatchOrgID());
SetValue("SourceType_C", "T");
								]]>
                            </OnClick>
                        </Button>
                        <Dict Key="IncomeId_C" Caption="收入名称" BuddyKey="Lab_IncomeId_C" X="1" Y="0" Enable="ReadOnly()" TabOrder="10" XSpan="3" AllowMultiSelection="true" ItemKey="LRP_Income">
                            <Condition ColumnKey="IncomeId" TableKey="LRP_IncomeLine" CondSign="in"/>
                        </Dict>
                        <Label Key="Lab_IncomeId_C" Caption="收入名称" X="0" Y="0"/>
                        <TextEditor Key="ContractName_C" Caption="合约名称" BuddyKey="Lab_ContractName_C" X="6" Y="0" Enable="ReadOnly()" MaxLength="40" TabOrder="20" XSpan="3">
                            <Condition ColumnKey="IncomeContractName" TableKey="LRP_IncomeLine" CondSign="like"/>
                        </TextEditor>
                        <Label Key="Lab_ContractName_C" Caption="合约名称" X="5" Y="0"/>
                        <TextEditor Key="TermName_C" Caption="条款名称" BuddyKey="Lab_TermName_C" X="1" Y="1" Enable="ReadOnly()" MaxLength="40" TabOrder="30" XSpan="3">
                            <Condition ColumnKey="IncomeContractTermName" TableKey="LRP_IncomeLine" CondSign="like"/>
                        </TextEditor>
                        <Label Key="Lab_TermName_C" Caption="条款名称" X="0" Y="1"/>
                        <TextEditor Key="TermLineName_C" Caption="条款明细" BuddyKey="Lab_TermLineName_C" X="6" Y="1" Enable="ReadOnly()" MaxLength="40" TabOrder="40" XSpan="3">
                            <Condition ColumnKey="TermLineName" TableKey="LRP_IncomeLine" CondSign="like"/>
                        </TextEditor>
                        <Label Key="Lab_TermLineName_C" Caption="条款明细" X="5" Y="1"/>
                        <TextEditor Key="BillNo_C" Caption="运输订单号" BuddyKey="Lab_BillNo_C" X="1" Y="2" Enable="ReadOnly()" MaxLength="40" TabOrder="50" XSpan="3">
                            <Condition ColumnKey="BillNo" TableKey="LRP_IncomeLine" CondSign="like"/>
                        </TextEditor>
                        <Label Key="Lab_BillNo_C" Caption="运输订单号" X="0" Y="2"/>
                        <CheckListBox Key="Status_C" Caption="状态" BuddyKey="Lab_Status_C" X="6" Y="2" Enable="ReadOnly()" TabOrder="60" XSpan="3">
                            <Condition ColumnKey="Status" TableKey="LRP_IncomeLine" CondSign="in"/>
                            <Item Caption="已输入" Key="100" Value="100"/>
                            <Item Caption="已确认" Key="200" Value="200"/>
                            <Item Caption="已对账" Key="960" Value="960"/>
                        </CheckListBox>
                        <Label Key="Lab_Status_C" Caption="状态" X="5" Y="2"/>
                        <Dict Key="Owner_C" Caption="货主" BuddyKey="Lab_Owner_C" X="1" Y="3" Enable="ReadOnly()" AllowMultiSelection="true" ItemKey="LRP_Owner" TabOrder="70" XSpan="3">
                            <Condition ColumnKey="OwnerId" TableKey="LRP_IncomeLine" CondSign="in"/>
                        </Dict>
                        <Label Key="Lab_Owner_C" Caption="货主" X="0" Y="3"/>
                        <Dict Key="SettlementId_C" Caption="结算方" BuddyKey="Lab_SettlementId_C" X="6" Y="3" Enable="ReadOnly()" AllowMultiSelection="true" ItemKey="Customer" TabOrder="80" XSpan="3">
                            <Condition ColumnKey="SettlementId" TableKey="LRP_IncomeLine" CondSign="in"/>
                        </Dict>
                        <Label Key="Lab_SettlementId_C" Caption="结算方" X="5" Y="3"/>
                        <DatePicker Key="StartDate_C" Caption="业务日期" BuddyKey="Lab_StartDate_C" X="1" Y="4" Enable="ReadOnly()" TabOrder="90" XSpan="3">
                            <Condition ColumnKey="BizDate" TableKey="LRP_IncomeLine" CondSign="between" Group="BizDate" GroupHead="true"/>
                        </DatePicker>
                        <Label Key="Lab_StartDate_C" Caption="业务日期" X="0" Y="4"/>
                        <DatePicker Key="EndDate_C" Caption="至" BuddyKey="Lab_EndDate_C" X="6" Y="4" Enable="ReadOnly()" TabOrder="100" XSpan="3">
                            <Condition ColumnKey="BizDate" TableKey="LRP_IncomeLine" CondSign="between" Group="BizDate" GroupTail="true"/>
                        </DatePicker>
                        <Label Key="Lab_EndDate_C" Caption="至" X="5" Y="4"/>
                        <TextEditor Key="DispatchOrg_C" Caption="调度组织" X="10" Y="3" Visible="false" Enable="false">
                            <DataBinding DefaultFormulaValue="getCurDispatchOrgID()"/>
                            <Condition ColumnKey="DispatchOrgId" TableKey="LRP_IncomeLine" CondSign="="/>
                        </TextEditor>
                        <TextEditor Key="SourceType_C" Caption="来源类型" X="10" Y="4" Visible="false" Enable="false">
                            <DataBinding DefaultValue="T"/>
                            <Condition ColumnKey="SourceType" TableKey="LRP_IncomeLine" CondSign="="/>
                        </TextEditor>
                        <TextEditor Key="OID_C" Caption="OID" X="10" Y="2" Enable="false" Visible="false">
                            <DataBinding DefaultValue="-999"/>
                            <Condition ColumnKey="OID" TableKey="LRP_IncomeLine" CondSign="="/>
                        </TextEditor>
                        <RowDefCollection RowGap="8">
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                        </RowDefCollection>
                        <ColumnDefCollection ColumnGap="8">
                            <ColumnDef Width="70px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="70px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="30px"/>
                            <ColumnDef Width="80px"/>
                        </ColumnDefCollection>
                    </GridLayoutPanel>
                    <Grid Key="Grid1" Caption="Grid1" Height="pref" PageLoadType="DB" CanDelete="false" CanShift="false">
                        <GridColumnCollection>
                            <GridColumn Key="Select" Caption="选择" Width="55px"/>
                            <GridColumn Key="Status" Caption="状态" Width="55px" Sortable="true"/>
                            <GridColumn Key="DispatchOrgId" Caption="调度组织" Width="80px" Visible="false" Sortable="true"/>
                            <GridColumn Key="OwnerId" Caption="货主" Width="80px" Sortable="true"/>
                            <GridColumn Key="IncomeId" Caption="收入名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="BizDate" Caption="业务日期" Width="80px" Sortable="true"/>
                            <GridColumn Key="BizQty" Caption="业务量" Width="59px" Sortable="true"/>
                            <GridColumn Key="CalculationAmount" Caption="计算金额" Width="65px" Sortable="true"/>
                            <GridColumn Key="AdjustAmount" Caption="调整后金额" Width="72px" Sortable="true"/>
                            <GridColumn Key="BillNo" Caption="运输订单号" Width="131px" Sortable="true"/>
                            <GridColumn Key="GenMethod" Caption="生成方式" Width="63px" Sortable="true"/>
                            <GridColumn Key="ComputeNo" Caption="计算号" Width="95px" Visible="false" Sortable="true"/>
                            <GridColumn Key="BillOID" Caption="单据ID" Width="80px" Visible="false"/>
                            <GridColumn Key="SettlementId" Caption="结算方" Width="80px" Sortable="true"/>
                            <GridColumn Key="IncomeContractTermId" Caption="条款ID" Width="80px" Visible="false"/>
                            <GridColumn Key="IncomeContractTermName" Caption="条款名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="TermLineId" Caption="条款明细ID" Width="80px" Visible="false"/>
                            <GridColumn Key="TermLineName" Caption="条款明细名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="IncomeContractId" Caption="合约ID" Width="80px" Visible="false"/>
                            <GridColumn Key="IncomeContractName" Caption="合约名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="SourceType" Caption="来源类型" Width="67px" Visible="false"/>
                            <GridColumn Key="OID" Caption="OID" Visible="false" Width="80px"/>
                        </GridColumnCollection>
                        <GridRowCollection>
                            <GridRow Key="row1" RowHeight="35" TableKey="LRP_IncomeLine">
                                <GridCell Key="Select" Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true"/>
                                <GridCell Key="Status" Caption="状态" CellType="ComboBox" Enable="false">
                                    <DataBinding ColumnKey="Status" DefaultValue="100"/>
                                    <Item Caption="已输入" Key="100" Value="100"/>
                                    <Item Caption="已确认" Key="200" Value="200"/>
                                    <Item Caption="已对账" Key="960" Value="960"/>
                                </GridCell>
                                <GridCell Key="DispatchOrgId" Caption="调度组织" CellType="Dict" Enable="false" ItemKey="LRP_DispatchOrg">
                                    <DataBinding ColumnKey="DispatchOrgId" DefaultFormulaValue="getCurDispatchOrgID()" Required="true"/>
                                </GridCell>
                                <GridCell Key="OwnerId" Caption="货主" CellType="Dict" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" ItemKey="LRP_Owner">
                                    <DataBinding ColumnKey="OwnerId" Required="true"/>
                                </GridCell>
                                <GridCell Key="IncomeId" Caption="收入名称" CellType="Dict" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" ItemKey="LRP_Income">
                                    <DataBinding ColumnKey="IncomeId" Required="true"/>
                                </GridCell>
                                <GridCell Key="BizDate" Caption="业务日期" CellType="DatePicker" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" Format="yyyy-MM-dd">
                                    <DataBinding ColumnKey="BizDate" Required="true"/>
                                </GridCell>
                                <GridCell Key="BizQty" Caption="业务量" CellType="NumberEditor" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" ShowZero="true">
                                    <DataBinding ColumnKey="BizQty" DefaultValue="0"/>
                                </GridCell>
                                <GridCell Key="CalculationAmount" Caption="计算金额" CellType="NumberEditor" Enable="false" ShowZero="true">
                                    <DataBinding ColumnKey="CalculationAmount" DefaultValue="0"/>
                                </GridCell>
                                <GridCell Key="AdjustAmount" Caption="调整后金额" CellType="NumberEditor" Enable="IIF(ReadOnly() || Status &gt; 100, false, true);" ShowZero="true">
                                    <DataBinding ColumnKey="AdjustAmount" DefaultValue="0"/>
                                </GridCell>
                                <GridCell Key="BillNo" Caption="运输订单号" CellType="TextEditor" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" MaxLength="40" Trim="true">
                                    <DataBinding ColumnKey="BillNo" Required="true"/>
                                </GridCell>
                                <GridCell Key="GenMethod" Caption="生成方式" CellType="ComboBox" Enable="false">
                                    <DataBinding ColumnKey="GenMethod" DefaultValue="2"/>
                                    <Item Caption="系统生成" Key="1" Value="1"/>
                                    <Item Caption="手工输入" Key="2" Value="2"/>
                                </GridCell>
                                <GridCell Key="ComputeNo" Caption="计算号" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="ComputeNo"/>
                                </GridCell>
                                <GridCell Key="BillOID" Caption="单据ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="BillOID"/>
                                </GridCell>
                                <GridCell Key="SettlementId" Caption="结算方" CellType="Dict" Enable="false" ItemKey="Customer">
                                    <DataBinding ColumnKey="SettlementId" DefaultFormulaValue="GetDictValue(&quot;LRP_Owner&quot;, OwnerId, &quot;CustomerId&quot;);  "/>
                                </GridCell>
                                <GridCell Key="IncomeContractTermId" Caption="条款ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="IncomeContractTermId"/>
                                </GridCell>
                                <GridCell Key="IncomeContractTermName" Caption="条款名称" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="IncomeContractTermName"/>
                                </GridCell>
                                <GridCell Key="TermLineId" Caption="条款明细ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="TermLineId"/>
                                </GridCell>
                                <GridCell Key="TermLineName" Caption="条款明细名称" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="TermLineName"/>
                                </GridCell>
                                <GridCell Key="IncomeContractId" Caption="合约ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="IncomeContractId"/>
                                </GridCell>
                                <GridCell Key="IncomeContractName" Caption="合约名称" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="IncomeContractName"/>
                                </GridCell>
                                <GridCell Key="SourceType" Caption="来源类型" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="SourceType" DefaultValue="T"/>
                                </GridCell>
                                <GridCell Key="OID" Caption="OID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="OID"/>
                                </GridCell>
                            </GridRow>
                        </GridRowCollection>
                    </Grid>
                    <SplitSize Size="200px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnPostShow>
        <![CDATA[//先加载条件，防止用户打开界面后直接编辑，然后取消而导致的加载所有数据
DealCondition();]]>
    </OnPostShow>
</Form>
