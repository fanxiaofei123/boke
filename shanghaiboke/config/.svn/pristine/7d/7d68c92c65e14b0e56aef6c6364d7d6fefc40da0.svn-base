<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="SendRouteInformation">
    <DataSource>
        <DataObject Caption="详细路线" Key="LRP_TransportOrder">
            <TableCollection>
                <Table Caption="详细路线" Key="LRP_TransportOrderRoute_L" DBTableName="LRP_TransportOrderRoute_L" SourceType="Query" Persist="false">
                    <Column Caption="地点名" DataType="Varchar" Key="AddressName" Length="100"/>
                    <Column Caption="地址" DataType="Varchar" Key="Address" Length="40"/>
                    <Column Key="Longitude" Caption="经度" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="Latitude" Caption="纬度" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="ProvinceId" Caption="省" DataType="Long"/>
                    <Column Key="CityId" Caption="市" DataType="Long"/>
                    <TableFilter>
                        <![CDATA[AddressName='-1']]>
                    </TableFilter>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Description="查询城市" Key="SelectCity">
            <Statement>
                <![CDATA[select d.cityid as d,c.name as c from LRP_DispatchOrg_City  d left join lrp_city c on d.cityid=c.oid where d.soid = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#f1f3f8"/>
                <TableView Key="info_table" X="0" Y="0">
                    <TableRowCollection>
                        <TableRow Key="r1" SeparatorStyle="solid none" SeparatorColor="#b8becc">
                            <LinearLayoutPanel Key="spec_sel_pa" Orientation="Horizontal" Height="50px" LeftPadding="10px">
                                <Label Key="spec_sel_a" Icon="12.png" OnlyIcon="True" Width="30px" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent"/>
                                </Label>
                                <TextEditor Key="spec_sel_m" Caption="目的地" PromptText="请输入地点，如普陀区xx小区" Width="auto" Height="auto" BorderStyle="none">
                                    <DataBinding>
                                        <ValueChanged>
                                            <![CDATA[ 	
                                            if(GetValue('spec_sel_m') != ""){											
								            ReplaceTable('LRP_TransportOrderRoute_L', InvokeService("LRP_MapMatching", false, false,GetValue("spec_sel_m"),GetValue('City'),Root.GetPara('UserDispatchOrg')));  
											RefreshControl('info_table');
											}
										  ]]>
                                        </ValueChanged>
                                    </DataBinding>
                                    <Format BackColor="transparent"/>
                                </TextEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r2" SeparatorStyle="solid none" SeparatorColor="#b8becc">
                            <LinearLayoutPanel Key="spec_sel_paa" Orientation="Horizontal" Height="pref" LeftPadding="10px">
                                <Label Key="spec_sel_aa" Caption="发货到" Width="60px" Height="auto" BorderStyle="none">
                                    <Format BackColor="transparent" ForeColor="#969696">
                                        <Font Size="20"/>
                                    </Format>
                                </Label>
                                <ComboBox Key="City" Caption="市" Style="tag" SourceType="Formula" Height="pref" Width="pref">
                                    <DataBinding Required="true">
                                        <ValueChanged>
                                            <![CDATA[
												if(GetValue('spec_sel_m') != ""){
											   ReplaceTable('LRP_TransportOrderRoute_L', InvokeService("LRP_MapMatching", false, false,GetValue("spec_sel_m"),GetValue('City'),Root.GetPara('UserDispatchOrg')));  
											   RefreshControl('info_table');
											   }else{
											     var table = GetBDLocation();
												 if(table==null){	
													ShowToast("定位当前位置失败！");
													return true;
												}
		                                         var lat = table.get('latitude');
												 var long = table.get('longitude');
												 if(IsNull(LoadLocalData(GetValue('City')))){
												   ReplaceTable('LRP_TransportOrderRoute_L',InvokeService('LRP_GetCityByGPS',false,false,lat,long,GetValue('City'))); 
												  }else{ 
													var dt = LoadLocalData(GetValue('City'));
													if(dt.next()){
														 ReplaceTable('LRP_TransportOrderRoute_L',LoadLocalData(GetValue('City')));
													}else{
													   ReplaceTable('LRP_TransportOrderRoute_L',InvokeService('LRP_GetCityByGPS',false,false,lat,long,GetValue('City'))); 
													}    
												  }
																								 										  
		                                              RefreshControl('info_table');
											   }
												]]>
                                        </ValueChanged>
                                    </DataBinding>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery('SelectCity',Root.GetPara('UserDispatchOrg'))]]>
                                    </FormulaItems>
                                </ComboBox>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r3" RowType="Detail" TableKey="LRP_TransportOrderRoute_L" SeparatorStyle="none none solid none" SeparatorColor="#b8becc">
                            <GridLayoutPanel Key="product_panel" Height="60px">
                                <Label Key="Name" Caption="地点名" X="1" Y="1">
                                    <DataBinding ColumnKey="AddressName"/>
                                    <Format ForeColor="#969696">
                                        <Font Size="20"/>
                                    </Format>
                                </Label>
                                <Label Key="Address" Caption="地址" X="1" Y="2">
                                    <DataBinding ColumnKey="Address"/>
                                    <Format ForeColor="#dde0e7" HAlign="Left">
                                        <Font Size="16"/>
                                    </Format>
                                </Label>
                                <Label Key="Latitude" Caption="经度" Visible="false" X="1" Y="3">
                                    <DataBinding ColumnKey="Latitude"/>
                                    <Format>
                                        <Font Size="16"/>
                                    </Format>
                                </Label>
                                <Label Key="Longitude" Caption="纬度" Visible="false" X="1" Y="3">
                                    <DataBinding ColumnKey="Longitude"/>
                                    <Format HAlign="Left">
                                        <Font Size="14"/>
                                    </Format>
                                </Label>
                                <Dict Key="ProvinceId" Caption="省" X="1" Y="3" Visible="false" Enable="false" ItemKey="LRP_Province">
                                    <DataBinding ColumnKey="ProvinceId" TableKey="CurrentOrder"/>
                                    <Format HAlign="Left">
                                        <Font Size="14"/>
                                    </Format>
                                </Dict>
                                <Dict Key="CityId" Caption="市" X="1" Y="3" Visible="false" Enable="false" ItemKey="LRP_City">
                                    <DataBinding ColumnKey="CityId" TableKey="CurrentOrder"/>
                                    <Format HAlign="Left">
                                        <Font Size="14"/>
                                    </Format>
                                </Dict>
                                <RowDefCollection>
                                    <RowDef Height="5px"/>
                                    <RowDef Height="30px"/>
                                    <RowDef Height="20px"/>
                                    <RowDef Height="5px"/>
                                </RowDefCollection>
                                <ColumnDefCollection>
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="100%"/>
                                    <ColumnDef Width="10px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <RowClick>
                                <![CDATA[ 
								    var districtId = InvokeService("LRP_GetRegion", false, false,Longitude,Latitude);
									
									var table = GetBDLocation();
									var lat = table.get('latitude');
									var long = table.get('longitude');	
												 
									var s = "[当前位置]";
									var ss = "[历史]";
									if(IndexOf(Name, s) < 0){
									    if(IndexOf(Name, ss) < 0){
										  Parent.SetValue('spec_sel_m',Name);
										}else{
										  var r = Replace(Name, "[历史]","");
									      Parent.SetValue('spec_sel_m',r); 
										}
									}else{
									   var r = Replace(Name, "[当前位置]","");
									   Parent.SetValue('spec_sel_m',r); 
									}
									
									if(Address != "无"){
										Parent.SetValue('Address',Address);
									}else{
										Parent.SetValue('Address',"");
									}
									Parent.SetValue('Latitude',Latitude);
									Parent.SetValue('Longitude',Longitude);
									Parent.SetValue('ProvinceId',ProvinceId);
									Parent.SetValue('CityId',CityId);
									Parent.SetValue('DistrictId',districtId);
									SaveLocalData(GetValue('City'),InvokeService("LRP_GetHistoricalRecords", false, false,Name,Address,Latitude,Longitude,ProvinceId,CityId,LoadLocalData(GetValue('City')),GetValue('City'),lat,long));
									Close();
								]]>
                            </RowClick>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
        <Block Root="false" Key="block_spec_sel">
            <PopView Key="pop_spec_sel" Height="155px">
                <GridLayoutPanel Key="pop_spec_sel_panel" Height="140px">
                    <Format BackColor="#ffffff"/>
                    <Label Key="spec_pop_jine" Caption="是否放弃已输入的信息？" X="1" Y="2" XSpan="6" YSpan="2">
                        <Format ForeColor="#000000" HAlign="Center">
                            <Font Size="16"/>
                        </Format>
                    </Label>
                    <Button Key="spec_pop_esc" Caption="放弃" Enable="True" X="0" Y="5" XSpan="4" BorderStyle="solid" BorderColor="#808080" BorderRadius="4" HasBorder="true">
                        <Format BackColor="#ffffff" ForeColor="#aaaaaa"/>
                        <OnClick>
                            <![CDATA[
								ClosePop('pop_spec_sel');
								if(Parent.GetValue('spec_sel_m')==''){
									BackTo(root.GetPara('grandfatherKey'));
								}else{
									Close();
								}
							]]>
                        </OnClick>
                    </Button>
                    <Button Key="spec_pop_ok" Caption="保留" Enable="True" X="4" Y="5" XSpan="4" BorderStyle="solid" BorderColor="#808080" BorderRadius="4" HasBorder="true">
                        <Format BackColor="#ffffff" ForeColor="#ff0000"/>
                        <OnClick>
                            <![CDATA[
								ClosePop('pop_spec_sel');
							]]>
                        </OnClick>
                    </Button>
                    <RowDefCollection>
                        <RowDef Height="10px"/>
                        <RowDef Height="20px"/>
                        <RowDef Height="10px"/>
                        <RowDef Height="40px"/>
                        <RowDef Height="10px"/>
                        <RowDef Height="40px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="40px"/>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="40px"/>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="10px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <OnClose>
                    <![CDATA[
					]]>
                </OnClose>
            </PopView>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
		SetSelectIndex('City',0);
		LoadData();
		var table = GetBDLocation();
		var lat = table.get('latitude');
		var long = table.get('longitude');	  
	    var rs = DBNamedQuery('SelectCity',Root.GetPara('UserDispatchOrg'));		
		var city = rs.D; 
		
		if(IsNull(LoadLocalData(GetValue('City')))){
		   ReplaceTable('LRP_TransportOrderRoute_L',InvokeService('LRP_GetCityByGPS',false,false,lat,long,city)); 
		  }else{ 
		    var dt = LoadLocalData(GetValue('City'));
		    if(dt.next()){
			     ReplaceTable('LRP_TransportOrderRoute_L',LoadLocalData(city));
			}else{
			   ReplaceTable('LRP_TransportOrderRoute_L',InvokeService('LRP_GetCityByGPS',false,false,lat,long,city)); 
			}    
		  }

		]]>
    </OnLoad>
    <OnPostShow>
        <![CDATA[
		
		]]>
    </OnPostShow>
    <FormParaCollection>
        <FormPara Formula="Para('DispatchOrg')" Key="DispatchOrg" Type="Formula"/>
    </FormParaCollection>
    <EventHandlerCollection>
        <EventHandler Key="CloseSelect" Trigger="Show" MergeEvent="true">
            <![CDATA[Close();]]>
        </EventHandler>
    </EventHandlerCollection>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="OrderTitle_bar" Caption="发货信息" Location="Center">
            <Label Key="OrderTitle" Caption="发货信息" Height="auto" Weight="1.0" Stretch="true">
                <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Center">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
        <BarItem Key="Map_bar" Caption="切换地图选点" Location="Right">
            <Button Key="Map" Caption="切换地图选点" Width="120px" Enable="True" Height="auto" Stretch="true">
                <Format BackColor="Transparent" ForeColor="#ffffff" HighlightColor="Transparent" HAlign="Right">
                    <Font Size="16"/>
                </Format>
                <OnClick>
                    <![CDATA[Parent.PushPara('RItype',1);Parent.Show('Map');]]>
                </OnClick>
            </Button>
        </BarItem>
        <LeftButton>
            <![CDATA[
		 if(IsNull(spec_sel_m)){
			if(Parent.GetValue('spec_sel_m')==''){
				BackTo(root.GetPara('grandfatherKey'));
			}else{
				Close();
			}
		 }else{
			 PopView('pop_spec_sel');
		 }
		]]>
        </LeftButton>
    </NavigationBar>
</Form>
