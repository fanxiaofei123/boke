<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="DoKittingPick" Caption="拣货" HasNavigationBar="false" Authenticate="false">
    <DataSource>
        <DataObject Key="DoKittingPick" PrimaryTableKey="LRP_WMTx_L">
            <TableCollection>
                <Table Key="LRP_WMTx_L" Caption="按加工通知单拣货明细" TableMode="Detail" SourceType="Query">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="MaterialId" Caption="物料ID" DataType="Long"/>
                    <Column Key="MaterialUnit" Caption="单位" DataType="Varchar" Length="10"/>
                    <Column Key="SrcBatchNo" Caption="批号" DataType="Varchar" Length="100"/>
                    <Column Key="SampleMoveQty" Caption="样品移位量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="Qty" Caption="数量" DataType="Numeric" Precision="18" Scale="6"/>
                    <Column Key="SrcLocationId" Caption="储位" DataType="Long"/>
                    <Column Key="MtlName" Caption="物料名称" DataType="Varchar" Length="200"/>
                    <Column Key="MtlCode" Caption="物料代码" DataType="Varchar" Length="100"/>
                    <Column Key="SrcLocationName" Caption="源储位名称" DataType="Varchar" Length="200"/>
                    <Column Key="DestLocationName" Caption="目标储位名称" DataType="Varchar"/>
                    <Column Key="SrcLocCode" Caption="源储位代码" DataType="Varchar"/>
                    <Column Key="DestLocCode" Caption="目标储位代码" DataType="Varchar"/>
                    <Column Key="PickQty" Caption="实拣" DataType="Numeric" Precision="18" Scale="6"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Formula="GetPara('OID');"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[ select 
    l.OID,
	l.SOID,
	l.MaterialId,
	l.MaterialUnit,
    l.SrcBatchNo,
    l.Qty,
    0.0 as PickQty,
    l.SrcLocationId,
    m.Name as MtlName,
    m.Code as MtlCode,
	srcloc.code as SrcLocCode,
	srcloc.Name as SrcLocationName,
	destloc.code as DestLocCode,
	destloc.Name as DestLocationName
	from LRP_WMTx_L l 
	left join LRP_Material m on m.oid = l.MaterialId 
	left join LRP_Location srcloc on srcloc.oid = l.SrcLocationId 
	left join LRP_Location destloc on destloc.oid = l.DestLocationId 
    where
        l.SOID = ? 
	Order by srcloc.Code DESC
    ]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#e6e6e6"/>
                <LinearLayoutPanel Caption="Title3" Key="Title" Orientation="Horizontal" X="0" Y="0">
                    <Format BackColor="#f14c52"/>
                    <Button Key="Cancel" Caption="取消" Height="auto" Width="60px">
                        <Format HAlign="Left" ForeColor="#ffffff" BackColor="#f14c52">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									ShowConfirm('是否放弃本次移位？', 'YES_NO', 
										{
											YES: {
													Back();
												}, 
											NO: {} 
										}
												)
								]]>
                        </OnClick>
                    </Button>
                    <Label Key="OrderTitle3" Caption="拣货" Height="auto" Weight="1.0">
                        <Format HAlign="Center" ForeColor="#ffffff">
                            <Font Size="20"/>
                        </Format>
                    </Label>
                    <Button Key="Comfirm" Caption="完成" Height="auto" Width="60px">
                        <Format HAlign="Right" ForeColor="#ffffff" BackColor="#f14c52">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									var lack = GetValue('LackQty');
									var b = true;
									if(lack > 0){
										ShowConfirm('存在未拣完的物料明细，是否继续完成？', 'YES_NO', 
											{
												YES: {
													InvokeService("LRP_SavePick", true, false,GetPara('OID'));
													ShowToast("拣货完成");
													Parent.LoadData();
													Back();
												}, 
												NO: {} 
											}
										);
									}else{
										InvokeService("LRP_SavePick", true, false,GetPara('OID'));
										ShowToast("拣货完成");
										Parent.LoadData();
										Back();
									}
																		
									]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <GridLayoutPanel Key="EnterCode" Caption="扫描" X="0" Y="1">
                    <Format BackColor="#FFFFFF">
                        <Font Size="20"/>
                    </Format>
                    <TextEditor Key="TextMaterialCode" Caption="扫描物料条码" X="1" Y="1" Enable="True" PromptText="扫描物料条码" XSpan="5">
                        <Format HAlign="Left"/>
                        <KeyEnter>
                            <![CDATA[
										PickMaterial();
										
									  ]]>
                        </KeyEnter>
                    </TextEditor>
                    <Image Key="GetMaterialCode" X="6" Y="1" Enable="true" Image="12.png" ImageScaleType="Fit_XY" SourceType="Resource" Stretch="true" Padding="10px">
                        <OnClick>
                            <![CDATA[PickMaterial();]]>
                        </OnClick>
                    </Image>
                    <NumberEditor Key="AddQty" Caption="增加量" BuddyKey="Lab_AddQty" X="2" Y="3">
                        <DataBinding DefaultValue="1"/>
                    </NumberEditor>
                    <Label Key="Lab_AddQty" Caption="增加量：" X="1" Y="3"/>
                    <NumberEditor Key="LackQty" Caption="总未拣量" BuddyKey="Lab_LackQty" X="5" Y="3"/>
                    <Label Key="Lab_LackQty" Caption="总未拣量：" X="4" Y="3"/>
                    <RowDefCollection RowGap="5">
                        <RowDef Height="10px"/>
                        <RowDef Height="36px"/>
                        <RowDef Height="3px"/>
                        <RowDef Height="36px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="60px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="10px"/>
                        <ColumnDef Width="65px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="35px"/>
                        <ColumnDef Width="20px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                <TableView Caption="物料明细" Key="TableView1" X="0" Y="2" Padding="5px">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="list" RowType="Detail" TableKey="LRP_WMTx_L" SelectColor="#dddddd" SeparatorStyle="none none solid none" SeparatorColor="#e6eaf2">
                            <GridLayoutPanel Key="GridLayoutPanel2" Caption="GridLayoutPanel2">
                                <Label Key="MtlCode" Caption="物料代码" X="1" Y="0" XSpan="2">
                                    <DataBinding ColumnKey="MtlCode"/>
                                    <Format HAlign="Left"/>
                                </Label>
                                <Label Key="MtlName" Caption="无物料名称" X="4" Y="0" XSpan="3">
                                    <DataBinding ColumnKey="MtlName"/>
                                    <Format HAlign="Left"/>
                                </Label>
                                <TextEditor Key="SrcBatchNo" Caption="批号" X="8" Y="0" Enable="false" XSpan="2">
                                    <DataBinding ColumnKey="SrcBatchNo"/>
                                    <Format HAlign="Left"/>
                                </TextEditor>
                                <NumberEditor Key="Qty" Caption="应拣" BuddyKey="Lab_Qty" X="2" Y="1" Enable="false" Scale="0">
                                    <DataBinding ColumnKey="Qty">
                                        <ValueChanged>
                                            <![CDATA[
												if(GetValue('PickQty') < 0){
												   SetValue('PickQty',0,false);
												   }
												if(GetValue('PickQty') > GetValue('Qty')){
												   SetValue('PickQty',GetValue('Qty'),false);
												   }
												   CalculatePick();
												]]>
                                        </ValueChanged>
                                    </DataBinding>
                                    <Format HAlign="Left"/>
                                </NumberEditor>
                                <Label Key="Lab_Qty" Caption="应拣：" X="1" Y="1"/>
                                <TextEditor Key="MaterialUnit" X="6" Y="1" Enable="false">
                                    <DataBinding ColumnKey="MaterialUnit"/>
                                </TextEditor>
                                <TextEditor Key="SrcLocCode" Caption="源储位代码" X="8" Y="1" Enable="false" XSpan="2">
                                    <DataBinding ColumnKey="SrcLocCode"/>
                                </TextEditor>
                                <Label Key="OID" Caption="OID" X="7" Y="0" Visible="false">
                                    <DataBinding ColumnKey="OID"/>
                                </Label>
                                <NumberEditor Key="PickQty" Caption="实拣：" BuddyKey="Lab_PickQty" X="5" Y="1">
                                    <DataBinding ColumnKey="PickQty" TableKey="LRP_WMTx_L"/>
                                </NumberEditor>
                                <Label Key="Lab_PickQty" Caption="实拣：" X="4" Y="1"/>
                                <RowDefCollection RowGap="5">
                                    <RowDef Height="35px"/>
                                    <RowDef Height="35px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="5">
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="33%"/>
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="20%"/>
                                    <ColumnDef Width="13%"/>
                                    <ColumnDef Width="10px"/>
                                    <ColumnDef Width="30px"/>
                                    <ColumnDef Width="33%"/>
                                    <ColumnDef Width="10px"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <RowDefCollection>
                    <RowDef Height="50px"/>
                    <RowDef Height="100px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
			LoadData();
			]]>
    </OnLoad>
    <OnPostShow>
        <![CDATA[CalculatePick();]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="CalculatePick" Description="计算并设置总未拣量">
            <![CDATA[
				var total = 0.0;
				var picked = 0.0; 
				
				var count = GetRowCount('list');
				var index = 0;
				while(index < count){
					total = total + GetCellValue('list',index,'Qty');
					picked = picked + GetCellValue('list',index,'PickQty');
					index = index + 1;							
				}
				
				SetValue('LackQty',total - picked);
			]]>
        </Macro>
        <Macro Key="PickMaterial" Description="根据扫入的物料码定位对应的物料并加上增加量">
            <![CDATA[				
				var count = GetRowCount('list');
				var index = 0;
				var Code = GetValue('TextMaterialCode');
				if(Code == "") {return true;}
				var b = false;
				while(index < count){
					var mtlCode = GetCellValue('list',index,'MtlCode');
					if(Code == mtlCode){
						var Qty = GetCellValue('list',index,'Qty');
						var PickQty = GetCellValue('list',index,'PickQty');
						if(Qty > PickQty){
							var Add = GetValue('AddQty');
							PickQty = PickQty + Add;
							if(PickQty > Qty){
								index = index + 1;
								ShowToast("第" & index & "条明细的实拣量不能超出应拣量");
							}else{								
								SetCellValue('list',index,'PickQty',PickQty,false);								
								CalculatePick();
							}
							SetFocusRow('list',index);
							ScrollTo('list',index);
							b = true;
							break;
						}
					}
					index = index + 1;							
				}
				
				if(!b) {ShowToast("拣货明细中不存在该物料条码或已拣完！");}
				SetFocus('GetMaterialCode');
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara Formula="Para('OID')" Key="OID" Type="Formula"/>
    </FormParaCollection>
    <NavigationBar BackColor="#f14c52" Style="Custom">
        <BarItem Key="Centertitle" Caption="拣货" Location="Center">
            <Label Key="TitleCenter" Caption="拣货" Width="60px">
                <Format HAlign="Center" ForeColor="#ffffff">
                    <Font Size="20"/>
                </Format>
            </Label>
        </BarItem>
    </NavigationBar>
</Form>
