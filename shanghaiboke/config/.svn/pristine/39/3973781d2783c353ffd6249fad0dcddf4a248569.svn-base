<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Caption="用户积分兑换项目" FormType="Entity" Key="V_ExchangeItem" ViewKey="V_ExchangeItemView">
    <DataSource RefObjectKey="LRP_ExchangeItem"/>
    <OperationCollection>
        <Operation Caption="新增" Key="New" Visible="ReadOnly()">
            <Action>
                <![CDATA[
				New('V_ExchangeItem');
			]]>
            </Action>
        </Operation>
        <Operation Caption="复制新增" Key="CopyNew" RefKey="CopyNew" ShortCuts="Ctrl+E"/>
        <Operation Caption="保存" Key="Save" Visible="!ReadOnly()">
            <Action>
                <![CDATA[		
                if(GetValue('ExpireDateTime')<GetValue('EffectDateTime')){
				Confirm('生效日期不能大于失效日期', 'OK','OK:{}');
				return true;
				}
                if(GetRowCount('Grid0', false)<=0){ 
				Confirm('明细列表不可为空', 'OK','OK:{}');
				return true;
				}
				
			    SaveData(); UpdateView();
				]]>
            </Action>
        </Operation>
        <Operation Caption="编辑" Key="Edit" RefKey="Edit" ShortCuts="Ctrl+E"/>
        <Operation Caption="删除" Key="Delete" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[
			Confirm('是否确定删除当前单据？','YES_NO',{YES:{DeleteData();UpdateView();Close();},NO:{}});
			
			]]>
            </Action>
        </Operation>
        <Operation Caption="取消" Key="Cancel" RefKey="Cancel"/>
        <Operation Caption="确认" Key="Confirm" RefKey="Confirm"/>
        <Operation Caption="撤销确认" Key="Confirm-R">
            <Action>
                <![CDATA[var exchangeitem  = DBNamedQueryValue("exchangeitem", GetOID());
if(exchangeitem>0){
	Confirm('用户积分兑换记录中存在该项目，不能撤销确认!','OK','OK:{}');
	return true;
}else{
Status=StatusValue('prepared');SaveData();UpdateView();
}]]>
            </Action>
        </Operation>
        <Operation Caption="作废" Key="ToCancel" RefKey="ToCancel"/>
        <Operation Caption="撤销作废" Key="ToCancel-R" RefKey="ToCancel-R"/>
        <Operation Caption="关闭界面" Key="Close" RefKey="Close"/>
    </OperationCollection>
    <QueryCollection>
        <Query Key="exchangeitem">
            <Statement>
                <![CDATA[select count(*) as num from LRP_UPE_Records_H h where  h.UPEItemId = ?]]>
            </Statement>
        </Query>
        <Query Key="dropitems">
            <Statement>
                <![CDATA[select OID as key1 ,CONCAT(no,',',name) as value1 from LRP_Coupon where status=200 and EFFECTIVEDATETIME<= ? and EXPIREDATETIME>= ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="DateTime"/>
                <Parameter DataType="DateTime"/>
            </ParameterCollection>
        </Query>
        <Query Description="读取券明细" Key="GetCouponDetail">
            <Statement>
                <![CDATA[select * from LRP_Coupon where OID=?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Caption="根面板" Key="root">
                <ToolBar Caption="ToolBar1" Height="pref" Key="ToolBar1">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="main_split" Orientation="Vertical">
                    <TabPanel Caption="TabPanel1" Height="pref" Key="TabPanel1">
                        <GridLayoutPanel Caption="基本信息" Key="first_head" Padding="5px">
                            <TextEditor Key="ItemNo" Caption="项目号" BuddyKey="Lab_ItemNo" X="1" Y="0" Enable="false" AsQuery="true">
                                <DataBinding ColumnKey="No" TableKey="LRP_UPExchangeItem_H"/>
                            </TextEditor>
                            <Label Key="Lab_ItemNo" Caption="项目号" X="0" Y="0"/>
                            <TextEditor Key="name" Caption="项目名称" BuddyKey="Lab_name" X="4" Y="0" Enable="!ReadOnly()" AsQuery="true">
                                <DataBinding ColumnKey="Name" TableKey="LRP_UPExchangeItem_H" Required="true"/>
                            </TextEditor>
                            <Label Key="Lab_name" Caption="项目名称" X="3" Y="0"/>
                            <ComboBox BuddyKey="Lab_Status" Caption="状态" Enable="false" Key="Status" SourceType="Status" X="7" Y="2" AsQuery="true">
                                <DataBinding ColumnKey="Status" TableKey="LRP_UPExchangeItem_H" DefaultValue="100"/>
                            </ComboBox>
                            <Label Caption="状态" Key="Lab_Status" X="6" Y="2"/>
                            <TextEditor BuddyKey="Lab_Remark" Caption="备注" Enable="!ReadOnly()" Key="Remark" X="1" XSpan="4" Y="4" AsQuery="true">
                                <DataBinding ColumnKey="Remarks" TableKey="LRP_UPExchangeItem_H"/>
                            </TextEditor>
                            <Label Caption="备注" Key="Lab_Remark" X="0" Y="4"/>
                            <NumberEditor Key="SortOrder" Caption="排序" BuddyKey="Lab_SortOrder" X="4" Y="1" AsQuery="true">
                                <DataBinding ColumnKey="SortOrder" TableKey="LRP_UPExchangeItem_H" DefaultValue="0"/>
                            </NumberEditor>
                            <Label Key="Lab_SortOrder" Caption="排序" X="3" Y="1"/>
                            <DatePicker Key="EffectDateTime" Caption="生效日期时间" BuddyKey="Lab_EffectDateTime" X="1" Y="2" AsQuery="true">
                                <DataBinding ColumnKey="EffectDateTime" DefaultFormulaValue="ServerDate();" TableKey="LRP_UPExchangeItem_H" Required="true"/>
                            </DatePicker>
                            <Label Key="Lab_EffectDateTime" Caption="生效日期时间" X="0" Y="2"/>
                            <DatePicker Key="ExpireDateTime" Caption="失效日期时间" BuddyKey="Lab_ExpireDateTime" X="4" Y="2" AsQuery="true">
                                <DataBinding ColumnKey="ExpireDateTime" DefaultFormulaValue="ServerDate();" TableKey="LRP_UPExchangeItem_H" Required="true"/>
                            </DatePicker>
                            <Label Key="Lab_ExpireDateTime" Caption="失效日期时间" X="3" Y="2"/>
                            <NumberEditor Key="Points" Caption="积分数" BuddyKey="Lab_Points" X="7" Y="0">
                                <DataBinding ColumnKey="Points" CheckRule="Points&gt;0" TableKey="LRP_UPExchangeItem_H"/>
                            </NumberEditor>
                            <Label Key="Lab_Points" Caption="积分数" X="6" Y="0"/>
                            <NumberEditor Key="LimitsPerUser" Caption="限制用户次数" BuddyKey="Lab_LimitsPerUser" X="1" Y="1">
                                <DataBinding ColumnKey="LimitsPerUser" TableKey="LRP_UPExchangeItem_H" DefaultValue="0"/>
                            </NumberEditor>
                            <Label Key="Lab_LimitsPerUser" Caption="限制用户次数" X="0" Y="1"/>
                            <Image Key="ImageUrl" BuddyKey="Lab_ImageUrl" X="1" Y="3">
                                <DataBinding ColumnKey="ImageUrl" TableKey="LRP_UPExchangeItem_H" Required="true"/>
                            </Image>
                            <Label Key="Lab_ImageUrl" X="0" Y="3"/>
                            <TextEditor Key="InfoUrl" Caption="详细信息路径" BuddyKey="Lab_InfoUrl" X="4" Y="3">
                                <DataBinding ColumnKey="InfoUrl" TableKey="LRP_UPExchangeItem_H" Required="true"/>
                            </TextEditor>
                            <Label Key="Lab_InfoUrl" Caption="详细信息路径" X="3" Y="3"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="36px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="99px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="55px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <GridLayoutPanel Caption="系统信息" Height="pref" Key="SystemInfo" Padding="10px">
                            <Label Caption="创建人" Key="L_CREATOR" X="0" Y="0"/>
                            <Dict BuddyKey="L_CREATOR" Caption="创建人" Enable="false" ItemKey="Operator" Key="CREATOR" X="1" XSpan="2" Y="0">
                                <DataBinding ColumnKey="CREATOR" DefaultFormulaValue="GetOperator()" TableKey="LRP_UPExchangeItem_H"/>
                            </Dict>
                            <DatePicker Caption="修改时间" Enable="false" Key="MODIFYTIME" X="5" XSpan="2" Y="1">
                                <DataBinding ColumnKey="MODIFYTIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_UPExchangeItem_H"/>
                            </DatePicker>
                            <Label Caption="修改时间" Key="L_MODIFYTIME" X="4" Y="1"/>
                            <DatePicker Caption="创建时间" Enable="false" Key="CREATETIME" X="1" XSpan="2" Y="1">
                                <DataBinding ColumnKey="CREATETIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_UPExchangeItem_H"/>
                            </DatePicker>
                            <Label Caption="创建时间" Key="L_CREATETIME" X="0" Y="1"/>
                            <Dict Caption="修改人" Enable="false" ItemKey="Operator" Key="MODIFIER" X="5" XSpan="2" Y="0">
                                <DataBinding ColumnKey="MODIFIER" DefaultFormulaValue="GetOperator()" TableKey="LRP_UPExchangeItem_H"/>
                            </Dict>
                            <Label Caption="修改人" Key="L_MODIFIER" X="4" Y="0"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="50px" Width="50%"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="50px" Width="50%"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <TabPanel Caption="TabPanel2" Height="pref" Key="TabPanel2">
                        <Grid Caption="劵明细" Key="Grid0" Enable="!ReadOnly()">
                            <GridColumnCollection>
                                <GridColumn Key="CouponId" Caption="券号" Width="80px" Sortable="true"/>
                                <GridColumn Key="couponname" Caption="名称" Width="80px" Sortable="true"/>
                                <GridColumn Key="qty" Caption="数量" Width="80px" Sortable="true"/>
                                <GridColumn Key="coupontype" Caption="券类型" Width="80px" Sortable="true"/>
                                <GridColumn Key="calctype" Caption="计算方式" Width="80px" Sortable="true"/>
                                <GridColumn Key="EffectDate" Caption="生效日期" Width="80px" Sortable="true"/>
                                <GridColumn Key="ExpireDate" Caption="失效日期" Width="80px" Sortable="true"/>
                                <GridColumn Key="facevalue" Caption="面值" Width="80px" Sortable="true"/>
                                <GridColumn Key="Description" Caption="描述" Width="80px" Sortable="true"/>
                                <GridColumn Key="EnoughMoney" Caption="满多少钱" Width="80px" Sortable="true"/>
                                <GridColumn Key="Discount" Caption="折扣" Width="80px" Sortable="true"/>
                                <GridColumn Key="MinusChangeType" Caption="去零头类型" Width="80px" Sortable="true"/>
                                <GridColumn Key="UseBusiness" Caption="使用业务范围" Width="80px" Sortable="true"/>
                                <GridColumn Key="UseDispatchOrgID" Caption="可用调度组织" Width="80px" Sortable="true"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="row1" RowHeight="35" TableKey="LRP_UPEI_Coupon_L">
                                    <GridCell Key="CouponId" Caption="券号" CellType="ComboBox" SourceType="Formula">
                                        <DataBinding ColumnKey="CouponId" Required="true">
                                            <ValueChanged>
                                                <![CDATA[SetCouponDetail();]]>
                                            </ValueChanged>
                                        </DataBinding>
                                        <FormulaItems>
                                            <![CDATA[DBNamedQuery('dropitems',ServerDBDate(),ServerDBDate())]]>
                                        </FormulaItems>
                                    </GridCell>
                                    <GridCell Key="couponname" Caption="名称" CellType="TextEditor" Enable="false">
                                        <DataBinding/>
                                    </GridCell>
                                    <GridCell Key="qty" Caption="数量" CellType="NumberEditor" Enable="!ReadOnly()">
                                        <DataBinding ColumnKey="Qty" DefaultValue="1"/>
                                    </GridCell>
                                    <GridCell Key="coupontype" Caption="券类型" CellType="Dict" ItemKey="LRP_CouponType" Enable="false"/>
                                    <GridCell Key="calctype" Caption="计算方式" CellType="ComboBox" Enable="false">
                                        <Item Caption="按面值" Key="1" Value="1"/>
                                        <Item Caption="按折扣" Key="2" Value="2"/>
                                        <Item Caption="去零头" Key="3" Value="3"/>
                                    </GridCell>
                                    <GridCell Key="EffectDate" Caption="生效日期" CellType="DatePicker" Format="yyyy-MM-dd" Enable="false"/>
                                    <GridCell Key="ExpireDate" Caption="失效日期" CellType="DatePicker" Format="yyyy-MM-dd" Enable="false"/>
                                    <GridCell Key="facevalue" Caption="面值" CellType="NumberEditor" Enable="false"/>
                                    <GridCell Key="Description" Caption="描述" CellType="TextEditor" Enable="false"/>
                                    <GridCell Key="EnoughMoney" Caption="满多少钱" CellType="NumberEditor" Enable="false"/>
                                    <GridCell Key="Discount" Caption="折扣" CellType="NumberEditor" Enable="false"/>
                                    <GridCell Key="MinusChangeType" Caption="去零头类型" CellType="ComboBox" Enable="false">
                                        <Item Caption="个位" Key="unit" Value="unit"/>
                                        <Item Caption="十位" Key="decade" Value="decade"/>
                                    </GridCell>
                                    <GridCell Key="UseBusiness" Caption="使用业务范围" CellType="TextEditor" Enable="false"/>
                                    <GridCell Key="UseDispatchOrgID" Caption="可用调度组织" CellType="TextEditor" Enable="false"/>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="240px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[	
	]]>
    </OnLoad>
    <OnPostShow>
        <![CDATA[
		if(!IsNew()){
			var i = 0;
			loop"Grid0"(true){
				var id = GetCellValue('Grid0',i,'CouponId');
				var rst = DBNamedQuery('GetCouponDetail',id);
				if(rst.size() > 0){				
					rst.beforefirst();
					rst.next();
				
					SetCellValue('Grid0', i,'couponname',rst.Name);
					SetCellValue('Grid0', i,'coupontype',rst.CouponTypeId);
					SetCellValue('Grid0', i,'calctype',rst.CalculationMethod);
					SetCellValue('Grid0', i,'EffectDate',rst.EffectiveDateTime);
					SetCellValue('Grid0', i,'ExpireDate',rst.ExpireDateTime);
					SetCellValue('Grid0', i,'facevalue',rst.FaceValue);
					SetCellValue('Grid0', i,'Description',rst.Description);
					SetCellValue('Grid0', i,'EnoughMoney',rst.EnoughMoney);
					SetCellValue('Grid0', i,'Discount',rst.Discount);
					SetCellValue('Grid0', i,'MinusChangeType',rst.MinusChangeType);
					SetCellValue('Grid0', i,'UseBusiness',rst.UseBusiness);
					SetCellValue('Grid0', i,'UseDispatchOrgID',rst.UseDispatchOrgName);
				}
				i = i+1;
			}
		}
	]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="SetCouponDetail">
            <![CDATA[
			//读取券明细填入明细表			
			var rst = DBNamedQuery('GetCouponDetail',CouponId);
			if(rst.size() > 0){				
				rst.beforefirst();
				rst.next();		
				couponname = rst.Name;	
				coupontype = rst.CouponTypeId;
				calctype = rst.CalculationMethod;
				EffectDate = rst.EffectiveDateTime;
				ExpireDate = rst.ExpireDateTime;
				facevalue = rst.FaceValue;
				Description = rst.Description;
				EnoughMoney = rst.EnoughMoney;
				Discount = rst.Discount;
				MinusChangeType = rst.MinusChangeType;
				UseBusiness = rst.UseBusiness;
				UseDispatchOrgID = rst.UseDispatchOrgName;
			}
			]]>
        </Macro>
    </MacroCollection>
</Form>
