<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_DailyQuantQuery" Caption="日结期间库存查询" FormType="Report">
    <DataSource>
        <DataObject Key="DailyQuantQuery" Caption="日结期间库存查询" PrimaryTableKey="LRP_QUANT_D">
            <TableCollection>
                <Table Key="LRP_QUANT_D" Caption="日结期间库存" TableMode="Detail" SourceType="Query">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="SOID" Caption="主对象标识" DataType="Long"/>
                    <Column Key="POID" Caption="父对象标识" DataType="Long"/>
                    <Column Key="VERID" Caption="对象版本" DataType="Integer"/>
                    <Column Key="DVERID" Caption="对象明细版本" DataType="Integer"/>
                    <Column Caption="仓储中心" Key="WarehouseCenterId" DataType="Long"/>
                    <Column Caption="货主" Key="OwnerId" DataType="Long"/>
                    <Column Caption="日结日期" DataType="DateTime" Key="QuantDate"/>
                    <Column Caption="物料" DataType="Long" Key="MaterialId"/>
                    <Column Caption="基本单位" Key="BasicUnit" DataType="Varchar"/>
                    <Column Caption="期初量" DataType="Numeric" DefaultValue="0" Key="BeginQty" Precision="18" Scale="6"/>
                    <Column Caption="入库量" DataType="Numeric" DefaultValue="0" Key="InQty" Precision="18" Scale="6"/>
                    <Column Caption="出库量" DataType="Numeric" DefaultValue="0" Key="OutQty" Precision="18" Scale="6"/>
                    <Column Caption="调整增加量" DataType="Numeric" DefaultValue="0" Key="AdjustAddQty" Precision="18" Scale="6"/>
                    <Column Caption="调整减少量" DataType="Numeric" DefaultValue="0" Key="AdjustSubtractQty" Precision="18" Scale="6"/>
                    <Column Caption="加工原料减少量" DataType="Numeric" DefaultValue="0" Key="KittingRawQty" Precision="18" Scale="6"/>
                    <Column Caption="加工成品增加量" DataType="Numeric" DefaultValue="0" Key="KittingCompleteQty" Precision="18" Scale="6"/>
                    <Column Caption="货权转入量" DataType="Numeric" DefaultValue="0" Key="OwnerTransInQty" Precision="18" Scale="6"/>
                    <Column Caption="货权转出量" DataType="Numeric" DefaultValue="0" Key="OwnerTransOutQty" Precision="18" Scale="6"/>
                    <Column Caption="期末量" DataType="Numeric" DefaultValue="0" Key="EndQty" Precision="18" Scale="6"/>
                    <ParameterCollection>
                        <Parameter Formula="GetPara('QuantDate_1')" DataType="DateTime"/>
                        <Parameter Formula="GetPara('QuantDate_2')" DataType="DateTime"/>
                        <Parameter Formula="GetPara('QuantDate_1')" DataType="DateTime"/>
                        <Parameter Formula="GetPara('QuantDate_2')" DataType="DateTime"/>
                        <Parameter Formula="GetPara('QuantDate_1')" DataType="DateTime"/>
                        <Parameter Formula="GetPara('QuantDate_2')" DataType="DateTime"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[select * from (select m.*,b.Qty_begin as BeginQty,n.Qty_end as endqty from (SELECT d.WarehouseCenterId,d.OwnerId,d.MaterialId,m.basicunit,SUM(InQty) InQty,
					 SUM(OutQty) OutQty,
					 SUM(AdjustAddQty) AdjustAddQty,
					 SUM(AdjustSubtractQty) AdjustSubtractQty,
					 SUM(KittingRawQty) KittingRawQty,
					 SUM(KittingCompleteQty) KittingCompleteQty,
					 SUM(OwnerTransInQty) OwnerTransInQty,
					 SUM(OwnerTransOutQty) OwnerTransOutQty          					       			        
					from  LRP_DailyQuant d
					left join lrp_material m on d.MaterialId=m.oid where QuantDate  between ? and ? and (InQty>0 or OutQty>0 or AdjustAddQty>0 or AdjustSubtractQty>0 or KittingRawQty>0 or KittingCompleteQty>0
					 or OwnerTransInQty>0 or OwnerTransOutQty>0)
					GROUP BY d.WarehouseCenterId,d.OwnerId,d.MaterialId,m.basicunit ) m
join 
(select min(QuantDate),Qty_begin,WarehouseCenterId,OwnerId,MaterialId,m.basicunit from LRP_DailyQuant d left join lrp_material m on d.MaterialId=m.oid where QuantDate  between ? and ? group by WarehouseCenterId,OwnerId,MaterialId,m.basicunit) b
on b.WarehouseCenterId=m.WarehouseCenterId and b.OwnerId=m.OwnerId and b.MaterialId=m.MaterialId and m.basicunit=b.basicunit
join 
(select max(QuantDate),Qty_end,WarehouseCenterId,OwnerId,MaterialId,m.basicunit from LRP_DailyQuant d left join lrp_material m on d.MaterialId=m.oid where QuantDate  between ? and ? group by WarehouseCenterId,OwnerId,MaterialId,m.basicunit)n
on m.WarehouseCenterId=n.WarehouseCenterId and m.OwnerId=n.OwnerId and m.MaterialId=n.MaterialId and m.basicunit=n.basicunit) a
						]]>
                    </Statement>
                </Table>
            </TableCollection>
            <OIDFilter/>
        </DataObject>
    </DataSource>
    <OperationCollection>
        <Operation Key="Close" Caption="关闭" RefKey="Close"/>
    </OperationCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="root" Caption="根面板">
                <ToolBar Key="ToolBar1" Height="pref" Caption="ToolBar1">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="main_split" Orientation="Vertical">
                    <GridLayoutPanel Key="first_head" Padding="5px" Height="pref" Caption="基本信息">
                        <Dict AllowMultiSelection="true" Key="WarehouseCenterId" Caption="仓储中心" BuddyKey="Lab_WarehouseCenterId" X="1" Y="0" XSpan="3" ItemKey="LRP_WarehouseCenter">
                            <DataBinding Required="true"/>
                            <Condition CondSign="in" ColumnKey="WarehouseCenterId" TableKey="LRP_QUANT_D"/>
                        </Dict>
                        <Label Key="Lab_WarehouseCenterId" Caption="仓储中心" X="0" Y="0"/>
                        <Dict AllowMultiSelection="true" Key="OwnerId" Caption="货主" BuddyKey="Lab_OwnerId" X="6" Y="0" XSpan="3" ItemKey="LRP_Owner">
                            <DataBinding Required="true"/>
                            <Condition CondSign="in" ColumnKey="OwnerId" TableKey="LRP_QUANT_D"/>
                        </Dict>
                        <Label Key="Lab_OwnerId" Caption="货主" X="5" Y="0"/>
                        <Dict Key="MaterialId" Caption="物料" BuddyKey="Lab_MaterialId" X="1" Y="1" XSpan="3" ItemKey="LRP_Material">
                            <Condition CondSign="=" ColumnKey="MaterialId" TableKey="LRP_QUANT_D"/>
                        </Dict>
                        <Label Key="Lab_MaterialId" Caption="物料" X="0" Y="1"/>
                        <DatePicker AsQuery="true" BuddyKey="Lab_QuantDate" Caption="开始日期" Enable="!ReadOnly()" Key="QuantDate" X="1" Y="2" XSpan="3">
                            <DataBinding Required="true"/>
                        </DatePicker>
                        <Label Caption="开始日期" Key="Lab_QuantDate" X="0" Y="2"/>
                        <DatePicker AsQuery="true" BuddyKey="Lab_QuantDate_To" Caption="结束日期" Enable="!ReadOnly()" Key="QuantDate_To" X="6" Y="2" XSpan="3">
                            <DataBinding Required="true"/>
                        </DatePicker>
                        <Label Caption="结束日期" Key="Lab_QuantDate_To" X="5" Y="2"/>
                        <Button Key="Query" Caption="查询" X="10" Y="0" Enable="true">
                            <OnClick>
                                <![CDATA[
								if(GetValue("WarehouseCenterId")<=0||GetValue("OwnerId")<=0||IsControlNull("QuantDate")||IsControlNull("QuantDate_To")){
								 Confirm(LocaleString('OwnerNull','key111'), 'OK','OK:{}');
								 return true;
								}
								if(QuantDate>QuantDate_To){
								 Confirm(LocaleString('OwnerNull','key112'), 'OK','OK:{}');
								 return true;
								}
								DealCondition();LoadData();ShowData();	
								]]>
                            </OnClick>
                        </Button>
                        <Button Key="cancel" Caption="重置" X="10" Y="1" Enable="true">
                            <OnClick>
                                <![CDATA[
								ResetCondition();
								]]>
                            </OnClick>
                        </Button>
                        <RowDefCollection RowGap="8" RowHeight="30">
                            <RowDef/>
                            <RowDef/>
                            <RowDef/>
                            <RowDef/>
                        </RowDefCollection>
                        <ColumnDefCollection ColumnGap="8">
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="30px"/>
                            <ColumnDef Width="80px"/>
                        </ColumnDefCollection>
                    </GridLayoutPanel>
                    <TabPanel Caption="TabPanel1" Key="TabPanel1" Height="100%">
                        <ListView Caption="期间库存" Key="ListView0" PageLoadType="UI" PageRowCount="10" TableKey="LRP_QUANT_D">
                            <ListViewColumnCollection>
                                <ListViewColumn Key="V_MaterialId" Caption="物料" ColumnType="Dict" DataColumnKey="MaterialId" ItemKey="LRP_Material"/>
                                <ListViewColumn Key="V_BasicUnit" Caption="基本单位" ColumnType="TextEditor" DefaultFormulaValue="GetDictValue('LRP_Material', MaterialId, 'BasicUnit');" DataColumnKey="BasicUnit"/>
                                <ListViewColumn Key="BeginQty" Caption="期初量" ColumnType="NumberEditor" DataColumnKey="BeginQty" ShowZero="true"/>
                                <ListViewColumn Key="InQty" Caption="入库量" ColumnType="NumberEditor" DataColumnKey="InQty" ShowZero="true"/>
                                <ListViewColumn Key="OutQty" Caption="出库量" ColumnType="NumberEditor" DataColumnKey="OutQty" ShowZero="true"/>
                                <ListViewColumn Key="AdjustAddQty" Caption="调整增加量" ColumnType="NumberEditor" DataColumnKey="AdjustAddQty" ShowZero="true"/>
                                <ListViewColumn Key="AdjustSubtractQty" Caption="调整减少量" ColumnType="NumberEditor" DataColumnKey="AdjustSubtractQty" ShowZero="true"/>
                                <ListViewColumn Key="KittingRawQty" Caption="加工原料减少量" ColumnType="NumberEditor" DataColumnKey="KittingRawQty" Width="120px" ShowZero="true"/>
                                <ListViewColumn Key="KittingCompleteQty" Caption="加工成品增加量" ColumnType="NumberEditor" DataColumnKey="KittingCompleteQty" Width="120px" ShowZero="true"/>
                                <ListViewColumn Key="OwnerTransInQty" Caption="货权转入量" ColumnType="NumberEditor" DataColumnKey="OwnerTransInQty" ShowZero="true"/>
                                <ListViewColumn Key="OwnerTransOutQty" Caption="货权转出量" ColumnType="NumberEditor" DataColumnKey="OwnerTransOutQty" ShowZero="true"/>
                                <ListViewColumn Key="EndQty" Caption="期末量" ColumnType="NumberEditor" DataColumnKey="EndQty" ShowZero="true"/>
                            </ListViewColumnCollection>
                        </ListView>
                    </TabPanel>
                    <SplitSize Size="120px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[                
		
		]]>
    </OnLoad>
    <FormParaCollection>
        <FormPara DataType="DateTime" Formula="GetValue('QuantDate')" Key="QuantDate_1" Type="Formula"/>
        <FormPara DataType="DateTime" Formula="GetValue('QuantDate_To')" Key="QuantDate_2" Type="Formula"/>
    </FormParaCollection>
</Form>
