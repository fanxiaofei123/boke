<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Caption="波次单" FormType="Entity" Key="V_Wave">
    <DataSource RefObjectKey="LRP_Wave"/>
    <OperationCollection>
        <Operation Caption="保存" Key="Save" ShortCuts="Ctrl+S" Visible="!ReadOnly()&amp;&amp;Status==100">
            <Action>
                <![CDATA[
					if(OwnerId<=0){			
						Confirm(LocaleString('OwnerNull','keyo'),'OK','OK:{}');	
						return true;
					}
					
					if(GetRowCount('Grid0',false)==0){
						Confirm(LocaleString('CommonDef','key1'),'OK','OK:{}');
						return true;
					}						
					//为订单明细填入序号
					var i = 0;
					loop"Grid1"(true){
						SetCellValue('Grid1', i,'RowIndex',i+1);
						i = i + 1;
					}
					SaveData();
					UpdateView();
			]]>
            </Action>
        </Operation>
        <Operation Caption="编辑" Key="Edit" RefKey="Edit" ShortCuts="Ctrl+E"/>
        <Operation Caption="删除" Key="Delete" ShortCuts="Ctrl+D" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[
					var msg = InvokeService("LRP_WaveDelete", true, false);
					UpdateView();Close();
				]]>
            </Action>
        </Operation>
        <Operation Caption="取消" Key="Cancel" Visible="!ReadOnly()">
            <Action>
                <![CDATA[Cancel();RefreshOutboundNoticeQuantDetails();]]>
            </Action>
        </Operation>
        <Operation Caption="确认" Key="Confirm" RefKey="Confirm"/>
        <Operation Caption="撤销确认" Key="Confirm-R" RefKey="Confirm-R"/>
        <Operation Caption="拣货" Key="Pick" Visible="ReadOnly()&amp;&amp;Status==StatusValue('confirmed')">
            <Action>
                <![CDATA[
					//GridSelectAll("Grid0");
					MidMap('Wave-Tx202','V_Tx202');
			]]>
            </Action>
        </Operation>
        <Operation Caption="引入出库订单" Key="QuoteOutboundNotice" Visible="!ReadOnly()&amp;&amp;Status==100">
            <Action>
                <![CDATA[
					if(OwnerId>0){
                            //SetPara('OwnerId_para',OwnerId);
							//SetPara('WarehouseCenterId_para',getCurOrgID());
							ShowModal('V_QuoteOutboundNoticeView',{OwnerId_para:{OwnerId},WarehouseCenterId_para:{getCurOrgID()}});
					}else{
                        Confirm(LocaleString('OwnerNull','key146'), 'OK',{OK:{}});
					}
				]]>
            </Action>
        </Operation>
        <Operation Caption="关闭界面" Key="Close" RefKey="Close"/>
    </OperationCollection>
    <QueryCollection>
        <Query Description="读取出库订单引用" Key="GetOutboundNotice">
            <Statement>
                <![CDATA[
				
		select o.* from LRP_OutboundNotice_H o join LRP_Wave_Notice_L l on o.oid =l.NoticeLineSOID where l.soid=?
				
			]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
        <Query Description="读取出库订单引用的所有明细记录" Key="GetOutboundNoticeDetail_bak">
            <Statement>
                <![CDATA[
				
		select l.*,m.BasicUnit,m.PackingUnit,m.PackingQty from LRP_OutboundNotice_L l join LRP_Material m on m.oid =l.MaterialId where l.SOID in(?)
				
			]]>
            </Statement>
            <ParameterCollection>
                <Parameter/>
            </ParameterCollection>
        </Query>
        <Query Description="读取出库订单引用的所有明细记录" Key="GetOutboundNoticeDetail">
            <Statement>
                <![CDATA[
				
		select l.*,m.BasicUnit,m.PackingUnit,m.PackingQty from LRP_OutboundNotice_L l join LRP_Material m on m.oid =l.MaterialId where l.SOID =?
				
			]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="main">
                <ToolBar Height="pref" Key="main_toolbar">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="main_split" Orientation="Vertical">
                    <TabPanel Caption="TabPanel0" Key="TabPanel0">
                        <GridLayoutPanel Caption="基本信息" Key="BasicTab" Padding="10px" OverflowX="Scroll">
                            <TextEditor Caption="波次单号" Enable="false" Key="No" X="1" XSpan="2" Y="0">
                                <DataBinding ColumnKey="No" TableKey="LRP_Wave_H"/>
                            </TextEditor>
                            <Label Caption="波次单号" Key="L_No" X="0" Y="0"/>
                            <Dict Caption="货主" Enable="!ReadOnly()" ItemKey="LRP_Owner" Key="OwnerId" X="5" XSpan="2" Y="0">
                                <DataBinding ColumnKey="OwnerId" TableKey="LRP_Wave_H" Required="true"/>
                            </Dict>
                            <Label Caption="货主" Key="L_OwnerId" X="4" Y="0"/>
                            <ComboBox Caption="状态" Enable="false" Key="Status" SourceType="Status" X="9" XSpan="2" Y="0">
                                <DataBinding ColumnKey="Status" TableKey="LRP_Wave_H" DefaultValue="100"/>
                            </ComboBox>
                            <Label Caption="状态" Key="L_Status" X="8" Y="0"/>
                            <CheckBox Caption="分配库存允许缺货" Enable="!ReadOnly()" Key="PickAllowLack" X="0" XSpan="3" Y="1">
                                <DataBinding ColumnKey="PickAllowLack" DefaultFormulaValue="GetDictValue('LRP_Owner',OwnerId,'PickAllowLack')" TableKey="LRP_Wave_H"/>
                            </CheckBox>
                            <TextEditor BuddyKey="Lab_Remark" Caption="备注" Enable="!ReadOnly()" Key="Remark" X="1" XSpan="10" Y="2">
                                <DataBinding ColumnKey="Remark" TableKey="LRP_Wave_H"/>
                            </TextEditor>
                            <Label Caption="备注" Key="Lab_Remark" X="0" Y="2"/>
                            <TextEditor BuddyKey="Lab_OID" Caption="OID" Enable="false" Key="OID" Visible="false" X="1" Y="3">
                                <DataBinding ColumnKey="OID" TableKey="LRP_Wave_H"/>
                            </TextEditor>
                            <Label Caption="OID" Key="Lab_OID" X="0" Y="3"/>
                            <Dict BuddyKey="Lab_WarehouseCenterId" Caption="仓储中心" ItemKey="LRP_WarehouseCenter" Key="WarehouseCenterId" Visible="false" X="9" XSpan="2" Y="3">
                                <DataBinding ColumnKey="WarehouseCenterId" DefaultFormulaValue="getCurOrgID()" TableKey="LRP_Wave_H"/>
                            </Dict>
                            <Label Caption="仓储中心" Key="Lab_WarehouseCenterId" Visible="false" X="8" Y="3"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="80px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="33%" MinWidth="50px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <GridLayoutPanel Caption="系统信息" Height="pref" Key="SystemInfo" Padding="10px">
                            <Label Caption="创建人" Key="L_CREATOR" X="0" Y="0"/>
                            <Dict BuddyKey="L_CREATOR" Caption="创建人" Enable="false" ItemKey="Operator" Key="CREATOR" X="1" XSpan="2" Y="0">
                                <DataBinding ColumnKey="CREATOR" DefaultFormulaValue="GetOperator()" TableKey="LRP_Wave_H"/>
                            </Dict>
                            <DatePicker Caption="修改时间" Enable="false" Key="MODIFYTIME" X="5" XSpan="2" Y="1">
                                <DataBinding ColumnKey="MODIFYTIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_Wave_H"/>
                            </DatePicker>
                            <Label Caption="修改时间" Key="L_MODIFYTIME" X="4" Y="1"/>
                            <DatePicker Caption="创建时间" Enable="false" Key="CREATETIME1" X="1" XSpan="2" Y="1">
                                <DataBinding ColumnKey="CREATETIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_Wave_H"/>
                            </DatePicker>
                            <Label Caption="创建时间" Key="L_CREATETIME" X="0" Y="1"/>
                            <Dict Caption="修改人" Enable="false" ItemKey="Operator" Key="MODIFIER" X="5" XSpan="2" Y="0">
                                <DataBinding ColumnKey="MODIFIER" DefaultFormulaValue="GetOperator()" TableKey="LRP_Wave_H"/>
                            </Dict>
                            <Label Caption="修改人" Key="L_MODIFIER" X="4" Y="0"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="50%" MinWidth="50px"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="50%" MinWidth="50px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <TabPanel Caption="TabPanel1" Key="TabPanel1">
                        <GridLayoutPanel Caption="订单明细" Key="DetailTab">
                            <Grid Caption="订单明细" Key="Grid1" CanInsert="false" CanDelete="false" CanShift="false" NewEmptyRow="false" X="0" XSpan="2" Y="1">
                                <GridColumnCollection>
                                    <GridColumn Caption="选择" Key="Select" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="出库订单ID" Key="NoticeLineSOID" Visible="false" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="序号" Key="RowIndex" Visible="false" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="出库订单号" Key="NoticeLineNo" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="货主单号" Key="OwnerNo" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="创建日期时间" Key="CREATETIME" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="省" Key="ProvinceId" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="市" Key="CityId" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="区" Key="DistrictId" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="收货方" Key="RecvPartyName" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="电商订单类型" Key="ECOrderType" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="面单打印方式" Key="ECPrintType" Width="80px" Sortable="true"/>
                                    <GridColumn Caption="开票类型" Key="ECInvoiceType" Width="80px" Sortable="true"/>
                                </GridColumnCollection>
                                <GridRowCollection>
                                    <GridRow Key="R3" TableKey="LRP_Wave_Notice_L">
                                        <GridCell Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true" Key="Select">
                                            <DataBinding DefaultValue="1"/>
                                        </GridCell>
                                        <GridCell Caption="出库订单ID" CellType="TextEditor" Enable="false" Key="NoticeLineSOID">
                                            <DataBinding ColumnKey="NoticeLineSOID" Required="true"/>
                                        </GridCell>
                                        <GridCell Caption="序号" CellType="TextEditor" Enable="false" Key="RowIndex">
                                            <DataBinding ColumnKey="RowIndex"/>
                                        </GridCell>
                                        <GridCell Caption="出库订单号" CellType="TextEditor" Enable="false" Key="NoticeLineNo"/>
                                        <GridCell Caption="货主单号" CellType="TextEditor" Enable="false" Key="OwnerNo"/>
                                        <GridCell Caption="创建日期时间" CellType="DatePicker" Enable="false" Key="CREATETIME"/>
                                        <GridCell Caption="省" CellType="Dict" Enable="false" ItemKey="LRP_Province" Key="ProvinceId"/>
                                        <GridCell Caption="市" CellType="Dict" Enable="false" ItemKey="LRP_City" Key="CityId"/>
                                        <GridCell Caption="区" CellType="Dict" Enable="false" ItemKey="LRP_District" Key="DistrictId"/>
                                        <GridCell Caption="收货方" CellType="TextEditor" Enable="false" Key="RecvPartyName"/>
                                        <GridCell Caption="电商订单类型" CellType="ComboBox" Enable="false" Key="ECOrderType">
                                            <Item Caption="单品单件" Key="1" Value="1"/>
                                            <Item Caption="单品多件" Key="2" Value="2"/>
                                            <Item Caption="多品多件" Key="3" Value="3"/>
                                        </GridCell>
                                        <GridCell Caption="面单打印方式" CellType="ComboBox" Enable="false" Key="ECPrintType">
                                            <Item Caption="pre 前置 " Key="1" Value="1"/>
                                            <Item Caption="post 后置" Key="2" Value="2"/>
                                        </GridCell>
                                        <GridCell Caption="开票类型" CellType="ComboBox" Enable="false" Key="ECInvoiceType">
                                            <Item Caption="不开票 " Key="0" Value="0"/>
                                            <Item Caption="普通发票 " Key="1" Value="1"/>
                                            <Item Caption="增值税发票 " Key="2" Value="2"/>
                                            <Item Caption="电子发票 " Key="3" Value="3"/>
                                            <Item Caption="促销 " Key="4" Value="4"/>
                                            <Item Caption="秒杀" Key="5" Value="5"/>
                                        </GridCell>
                                    </GridRow>
                                </GridRowCollection>
                            </Grid>
                            <Button Caption="删除明细" Key="DeleteDetail" X="0" Y="0" Visible="!ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
                                <OnClick>
                                    <![CDATA[DeleteRow("Grid1",-1);RefreshOutboundNoticeQuantDetails();]]>
                                </OnClick>
                            </Button>
                            <RowDefCollection RowGap="2">
                                <RowDef Height="20px"/>
                                <RowDef Height="100%"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="2">
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="100%"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <Grid Caption="物料汇总明细" Key="Grid_Sum" CanInsert="false" CanDelete="false" CanShift="false" NewEmptyRow="false">
                            <GridColumnCollection>
                                <GridColumn Caption="选择" Key="Select1_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="物料" Key="MaterialId_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="批号" Key="BatchNo_Sum" Visible="ToBool(GetSessionPara('BatchNo_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="生产日期" Key="ManufDate_Sum" Visible="ToBool(GetSessionPara('ManufDate_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="失效日期" Key="ExpireDate_Sum" Visible="ToBool(GetSessionPara('ExpireDate_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="入库日期" Key="RecvDate_Sum" Visible="ToBool(GetSessionPara('RecvDate_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="项目" Key="ProjectId_Sum" Visible="ToBool(GetSessionPara('ProjectId_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型1" Key="StrUserDef1_Sum" Visible="ToBool(GetSessionPara('StrUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型2" Key="StrUserDef2_Sum" Visible="ToBool(GetSessionPara('StrUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型3" Key="StrUserDef3_Sum" Visible="ToBool(GetSessionPara('StrUserDef3_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型4" Key="StrUserDef4_Sum" Visible="ToBool(GetSessionPara('StrUserDef4_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型5" Key="StrUserDef5_Sum" Visible="ToBool(GetSessionPara('StrUserDef5_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型1" Key="DictUserDef1_Sum" Visible="ToBool(GetSessionPara('DictUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型2" Key="DictUserDef2_Sum" Visible="ToBool(GetSessionPara('DictUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型3" Key="DictUserDef3_Sum" Visible="ToBool(GetSessionPara('DictUserDef3_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型4" Key="DictUserDef4_Sum" Visible="ToBool(GetSessionPara('DictUserDef4_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型5" Key="DictUserDef5_Sum" Visible="ToBool(GetSessionPara('DictUserDef5_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="日期型1" Key="DateUserDef1_Sum" Visible="ToBool(GetSessionPara('DateUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="日期型2" Key="DateUserDef2_Sum" Visible="ToBool(GetSessionPara('DateUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数值型1" Key="NumUserDef1_Sum" Visible="ToBool(GetSessionPara('NumUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数值型2" Key="NumUserDef2_Sum" Visible="ToBool(GetSessionPara('NumUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数值型3" Key="NumUserDef3_Sum" Visible="ToBool(GetSessionPara('NumUserDef3_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数量" Key="Qty_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="单位" Key="MaterialUnit_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="基本单位量" Key="BasicQty_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="物料状态" Key="MaterialStatusId_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="分配量" Key="ExpectPickQty_Sum" Width="80px" Sortable="true"/>
                                <GridColumn Caption="实拣量" Key="PickQty_Sum" Width="80px" Sortable="true"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="R_Sum" TableKey="LRP_Wave_MaterialSum">
                                    <GridCell Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true" Key="Select1_Sum">
                                        <DataBinding DefaultValue="1">
                                            <ValueChanged>
                                                <![CDATA[RefreshMaterialDetailSelect();]]>
                                            </ValueChanged>
                                        </DataBinding>
                                    </GridCell>
                                    <GridCell Caption="物料" CellType="Dict" Enable="false" ItemKey="LRP_Material" Key="MaterialId_Sum">
                                        <DataBinding ColumnKey="MaterialId"/>
                                    </GridCell>
                                    <GridCell Caption="批号" CellType="TextEditor" Enable="false" Key="BatchNo_Sum">
                                        <DataBinding ColumnKey="BatchNo"/>
                                    </GridCell>
                                    <GridCell Caption="生产日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="ManufDate_Sum" Format="yyyy-MM-dd">
                                        <DataBinding ColumnKey="ManufDate"/>
                                    </GridCell>
                                    <GridCell Caption="失效日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="ExpireDate_Sum" Format="yyyy-MM-dd">
                                        <DataBinding ColumnKey="ExpireDate"/>
                                    </GridCell>
                                    <GridCell Caption="入库日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="RecvDate_Sum" Format="yyyy-MM-dd">
                                        <DataBinding ColumnKey="RecvDate"/>
                                    </GridCell>
                                    <GridCell Caption="项目" CellType="Dict" Enable="false" Key="ProjectId_Sum" ItemKey="LRP_Project">
                                        <DataBinding ColumnKey="ProjectId"/>
                                    </GridCell>
                                    <GridCell Caption="字符型1" CellType="TextEditor" Enable="false" Key="StrUserDef1_Sum">
                                        <DataBinding ColumnKey="StrUserDef1"/>
                                    </GridCell>
                                    <GridCell Caption="字符型2" CellType="TextEditor" Enable="false" Key="StrUserDef2_Sum">
                                        <DataBinding ColumnKey="StrUserDef2"/>
                                    </GridCell>
                                    <GridCell Caption="字符型3" CellType="TextEditor" Enable="false" Key="StrUserDef3_Sum">
                                        <DataBinding ColumnKey="StrUserDef3"/>
                                    </GridCell>
                                    <GridCell Caption="字符型4" CellType="TextEditor" Enable="false" Key="StrUserDef4_Sum">
                                        <DataBinding ColumnKey="StrUserDef4"/>
                                    </GridCell>
                                    <GridCell Caption="字符型5" CellType="TextEditor" Enable="false" Key="StrUserDef5_Sum">
                                        <DataBinding ColumnKey="StrUserDef5"/>
                                    </GridCell>
                                    <GridCell Caption="字典型1" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser1ItemKey" Enable="false" Key="DictUserDef1_Sum">
                                        <DataBinding ColumnKey="DictUserDef1"/>
                                    </GridCell>
                                    <GridCell Caption="字典型2" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser2ItemKey" Enable="false" Key="DictUserDef2_Sum">
                                        <DataBinding ColumnKey="DictUserDef2"/>
                                    </GridCell>
                                    <GridCell Caption="字典型3" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser3ItemKey" Enable="false" Key="DictUserDef3_Sum">
                                        <DataBinding ColumnKey="DictUserDef3"/>
                                    </GridCell>
                                    <GridCell Caption="字典型4" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser4ItemKey" Enable="false" Key="DictUserDef4_Sum">
                                        <DataBinding ColumnKey="DictUserDef4"/>
                                    </GridCell>
                                    <GridCell Caption="字典型5" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser5ItemKey" Enable="false" Key="DictUserDef5_Sum">
                                        <DataBinding ColumnKey="DictUserDef5"/>
                                    </GridCell>
                                    <GridCell Caption="日期型1" CellType="DatePicker" Enable="false" Key="DateUserDef1_Sum" Format="yyyy-MM-dd" OnlyDate="true">
                                        <DataBinding ColumnKey="DateUserDef1"/>
                                    </GridCell>
                                    <GridCell Caption="日期型2" CellType="DatePicker" Enable="false" Key="DateUserDef2_Sum" Format="yyyy-MM-dd" OnlyDate="true">
                                        <DataBinding ColumnKey="DateUserDef2"/>
                                    </GridCell>
                                    <GridCell Caption="数值型1" CellType="NumberEditor" Enable="false" Key="NumUserDef1_Sum">
                                        <DataBinding ColumnKey="NumUserDef1"/>
                                    </GridCell>
                                    <GridCell Caption="数值型2" CellType="NumberEditor" Enable="false" Key="NumUserDef2_Sum">
                                        <DataBinding ColumnKey="NumUserDef2"/>
                                    </GridCell>
                                    <GridCell Caption="数值型3" CellType="NumberEditor" Enable="false" Key="NumUserDef3_Sum">
                                        <DataBinding ColumnKey="NumUserDef3"/>
                                    </GridCell>
                                    <GridCell Caption="数量" CellType="NumberEditor" Enable="false" Key="Qty_Sum">
                                        <DataBinding ColumnKey="Qty"/>
                                    </GridCell>
                                    <GridCell Caption="单位" CellType="ComboBox" Enable="false" Key="MaterialUnit_Sum" SourceType="Query">
                                        <DataBinding ColumnKey="MaterialUnit"/>
                                        <QueryDef>
                                            <Statement>
                                                <![CDATA[select BasicUnit as N_KEY,BasicUnit as N_NAME from LRP_Material where OID=? union select PackingUnit as N_KEY,PackingUnit as N_NAME from LRP_Material where OID=?]]>
                                            </Statement>
                                            <ParameterCollection>
                                                <Parameter DataType="Long" FieldKey="MaterialId_Sum" SourceType="Field"/>
                                                <Parameter DataType="Long" FieldKey="MaterialId_Sum" SourceType="Field"/>
                                            </ParameterCollection>
                                        </QueryDef>
                                    </GridCell>
                                    <GridCell Caption="基本单位量" CellType="NumberEditor" Enable="false" Key="BasicQty_Sum" ItemsDependency="MaterialId_Sum,Qty_Sum,MaterialUnit_Sum">
                                        <DataBinding DefaultFormulaValue="if(MaterialUnit_Sum !=''){if(MaterialUnit_Sum==GetDictValue('LRP_Material',MaterialId_Sum,'PackingUnit')){Qty_Sum * GetDictValue('LRP_Material',MaterialId_Sum,'PackingQty');}else{Qty_Sum;}}else{Qty_Sum;}"/>
                                    </GridCell>
                                    <GridCell Caption="物料状态" CellType="Dict" Enable="false" ItemKey="LRP_MaterialStatus" Key="MaterialStatusId_Sum">
                                        <DataBinding ColumnKey="MaterialStatusId"/>
                                    </GridCell>
                                    <GridCell Caption="分配量" CellType="NumberEditor" Enable="false" Key="ExpectPickQty_Sum">
                                        <DataBinding ColumnKey="ExpectPickQty"/>
                                    </GridCell>
                                    <GridCell Caption="实拣量" CellType="NumberEditor" Enable="false" Key="PickQty_Sum">
                                        <DataBinding ColumnKey="PickQty"/>
                                    </GridCell>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                        <Grid Caption="物料明细" Key="Grid0" Visible="false" CanInsert="false" CanDelete="false" CanShift="false" NewEmptyRow="false">
                            <GridColumnCollection>
                                <GridColumn Caption="选择" Key="Select1" Width="80px" Sortable="true"/>
                                <GridColumn Caption="物料" Key="MaterialId" Width="80px" Sortable="true"/>
                                <GridColumn Caption="批号" Key="BatchNo" Visible="ToBool(GetSessionPara('BatchNo_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="生产日期" Key="ManufDate" Visible="ToBool(GetSessionPara('ManufDate_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="失效日期" Key="ExpireDate" Visible="ToBool(GetSessionPara('ExpireDate_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="入库日期" Key="RecvDate" Visible="ToBool(GetSessionPara('RecvDate_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="项目" Key="ProjectId" Visible="ToBool(GetSessionPara('ProjectId_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型1" Key="StrUserDef1" Visible="ToBool(GetSessionPara('StrUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型2" Key="StrUserDef2" Visible="ToBool(GetSessionPara('StrUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型3" Key="StrUserDef3" Visible="ToBool(GetSessionPara('StrUserDef3_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型4" Key="StrUserDef4" Visible="ToBool(GetSessionPara('StrUserDef4_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字符型5" Key="StrUserDef5" Visible="ToBool(GetSessionPara('StrUserDef5_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型1" Key="DictUserDef1" Visible="ToBool(GetSessionPara('DictUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型2" Key="DictUserDef2" Visible="ToBool(GetSessionPara('DictUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型3" Key="DictUserDef3" Visible="ToBool(GetSessionPara('DictUserDef3_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型4" Key="DictUserDef4" Visible="ToBool(GetSessionPara('DictUserDef4_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="字典型5" Key="DictUserDef5" Visible="ToBool(GetSessionPara('DictUserDef5_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="日期型1" Key="DateUserDef1" Visible="ToBool(GetSessionPara('DateUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="日期型2" Key="DateUserDef2" Visible="ToBool(GetSessionPara('DateUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数值型1" Key="NumUserDef1" Visible="ToBool(GetSessionPara('NumUserDef1_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数值型2" Key="NumUserDef2" Visible="ToBool(GetSessionPara('NumUserDef2_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数值型3" Key="NumUserDef3" Visible="ToBool(GetSessionPara('NumUserDef3_IsShow'))" Width="80px" Sortable="true"/>
                                <GridColumn Caption="数量" Key="Qty" Width="80px" Sortable="true"/>
                                <GridColumn Caption="单位" Key="MaterialUnit" Width="80px" Sortable="true"/>
                                <GridColumn Caption="基本单位量" Key="BasicQty" Width="80px" Sortable="true"/>
                                <GridColumn Caption="物料状态" Key="MaterialStatusId" Width="80px" Sortable="true"/>
                                <GridColumn Caption="分配量" Key="ExpectPickQty" Width="80px" Sortable="true"/>
                                <GridColumn Caption="实拣量" Key="PickQty" Width="80px" Sortable="true"/>
                                <GridColumn Caption="相关单据明细id" Key="RefLineOID" Width="80px" Sortable="true"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="R3" TableKey="LRP_Wave_MaterialSum_L">
                                    <GridCell Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true" Key="Select1">
                                        <DataBinding DefaultValue="1"/>
                                    </GridCell>
                                    <GridCell Caption="物料" CellType="Dict" Enable="false" ItemKey="LRP_Material" Key="MaterialId">
                                        <DataBinding ColumnKey="MaterialId" Required="true"/>
                                    </GridCell>
                                    <GridCell Caption="批号" CellType="TextEditor" Enable="false" Key="BatchNo">
                                        <DataBinding ColumnKey="BatchNo"/>
                                    </GridCell>
                                    <GridCell Caption="生产日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="ManufDate" Format="yyyy-MM-dd">
                                        <DataBinding ColumnKey="ManufDate"/>
                                    </GridCell>
                                    <GridCell Caption="失效日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="ExpireDate" Format="yyyy-MM-dd">
                                        <DataBinding ColumnKey="ExpireDate"/>
                                    </GridCell>
                                    <GridCell Caption="入库日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="RecvDate" Format="yyyy-MM-dd">
                                        <DataBinding ColumnKey="RecvDate"/>
                                    </GridCell>
                                    <GridCell Caption="项目" CellType="Dict" Enable="false" Key="ProjectId" ItemKey="LRP_Project">
                                        <DataBinding ColumnKey="ProjectId"/>
                                    </GridCell>
                                    <GridCell Caption="字符型1" CellType="TextEditor" Enable="false" Key="StrUserDef1">
                                        <DataBinding ColumnKey="StrUserDef1" DefaultValue="*"/>
                                    </GridCell>
                                    <GridCell Caption="字符型2" CellType="TextEditor" Enable="false" Key="StrUserDef2">
                                        <DataBinding ColumnKey="StrUserDef2" DefaultValue="*"/>
                                    </GridCell>
                                    <GridCell Caption="字符型3" CellType="TextEditor" Enable="false" Key="StrUserDef3">
                                        <DataBinding ColumnKey="StrUserDef3" DefaultValue="*"/>
                                    </GridCell>
                                    <GridCell Caption="字符型4" CellType="TextEditor" Enable="false" Key="StrUserDef4">
                                        <DataBinding ColumnKey="StrUserDef4" DefaultValue="*"/>
                                    </GridCell>
                                    <GridCell Caption="字符型5" CellType="TextEditor" Enable="false" Key="StrUserDef5">
                                        <DataBinding ColumnKey="StrUserDef5" DefaultValue="*"/>
                                    </GridCell>
                                    <GridCell Caption="字典型1" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser1ItemKey" Enable="false" Key="DictUserDef1">
                                        <DataBinding ColumnKey="DictUserDef1"/>
                                    </GridCell>
                                    <GridCell Caption="字典型2" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser2ItemKey" Enable="false" Key="DictUserDef2">
                                        <DataBinding ColumnKey="DictUserDef2"/>
                                    </GridCell>
                                    <GridCell Caption="字典型3" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser3ItemKey" Enable="false" Key="DictUserDef3">
                                        <DataBinding ColumnKey="DictUserDef3"/>
                                    </GridCell>
                                    <GridCell Caption="字典型4" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser4ItemKey" Enable="false" Key="DictUserDef4">
                                        <DataBinding ColumnKey="DictUserDef4"/>
                                    </GridCell>
                                    <GridCell Caption="字典型5" CellType="Dict" ItemKeySourceType="Para" ItemKeySource="DictUserItemKey.DictUser5ItemKey" Enable="false" Key="DictUserDef5">
                                        <DataBinding ColumnKey="DictUserDef5"/>
                                    </GridCell>
                                    <GridCell Caption="日期型1" CellType="DatePicker" Enable="false" Key="DateUserDef1" Format="yyyy-MM-dd" OnlyDate="true">
                                        <DataBinding ColumnKey="DateUserDef1"/>
                                    </GridCell>
                                    <GridCell Caption="日期型2" CellType="DatePicker" Enable="false" Key="DateUserDef2" Format="yyyy-MM-dd" OnlyDate="true">
                                        <DataBinding ColumnKey="DateUserDef2"/>
                                        <DblClick>
                                            <![CDATA[
                                            
                                        ]]>
                                        </DblClick>
                                    </GridCell>
                                    <GridCell Caption="数值型1" CellType="NumberEditor" Enable="false" Key="NumUserDef1">
                                        <DataBinding ColumnKey="NumUserDef1" DefaultValue="0"/>
                                    </GridCell>
                                    <GridCell Caption="数值型2" CellType="NumberEditor" Enable="false" Key="NumUserDef2">
                                        <DataBinding ColumnKey="NumUserDef2" DefaultValue="0"/>
                                    </GridCell>
                                    <GridCell Caption="数值型3" CellType="NumberEditor" Enable="false" Key="NumUserDef3">
                                        <DataBinding ColumnKey="NumUserDef3" DefaultValue="0"/>
                                    </GridCell>
                                    <GridCell Caption="数量" CellType="NumberEditor" Enable="false" Key="Qty">
                                        <DataBinding ColumnKey="Qty" CheckRule="Qty&gt;0" ErrorInfo="数量必须大于0"/>
                                    </GridCell>
                                    <GridCell Caption="单位" CellType="ComboBox" Enable="false" Key="MaterialUnit" SourceType="Query">
                                        <DataBinding ColumnKey="MaterialUnit"/>
                                        <QueryDef>
                                            <Statement>
                                                <![CDATA[select BasicUnit as N_KEY,BasicUnit as N_NAME from LRP_Material where OID=? union select PackingUnit as N_KEY,PackingUnit as N_NAME from LRP_Material where OID=?]]>
                                            </Statement>
                                            <ParameterCollection>
                                                <Parameter DataType="Long" FieldKey="MaterialId" SourceType="Field"/>
                                                <Parameter DataType="Long" FieldKey="MaterialId" SourceType="Field"/>
                                            </ParameterCollection>
                                        </QueryDef>
                                    </GridCell>
                                    <GridCell Caption="基本单位量" CellType="NumberEditor" Enable="false" Key="BasicQty" ItemsDependency="MaterialId,Qty,MaterialUnit">
                                        <DataBinding ColumnKey="BasicQty" DefaultFormulaValue="if(MaterialUnit !=''){if(MaterialUnit==GetDictValue('LRP_Material',MaterialId,'PackingUnit')){Qty * GetDictValue('LRP_Material',MaterialId,'PackingQty');}else{Qty;}}else{Qty;}"/>
                                    </GridCell>
                                    <GridCell Caption="物料状态" CellType="Dict" Enable="false" ItemKey="LRP_MaterialStatus" Key="MaterialStatusId">
                                        <DataBinding ColumnKey="MaterialStatusId"/>
                                    </GridCell>
                                    <GridCell Caption="分配量" CellType="NumberEditor" Enable="false" Key="ExpectPickQty">
                                        <DataBinding ColumnKey="ExpectPickQty" DefaultFormulaValue="Qty"/>
                                    </GridCell>
                                    <GridCell Caption="实拣量" CellType="NumberEditor" Enable="false" Key="PickQty">
                                        <DataBinding ColumnKey="PickQty"/>
                                    </GridCell>
                                    <GridCell Caption="相关单据明细id" CellType="TextEditor" Enable="false" Key="RefLineOID">
                                        <DataBinding ColumnKey="RefLineOID"/>
                                    </GridCell>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="180px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnPostShow>
        <![CDATA[
		if(!IsNew()){
			RefreshOutboundNoticeQuant();
			ClearAllRows('Grid_Sum',false);
			//根据物料明细创建汇总明细
			var j = 0;
			var count1 = GetRowCount('Grid0');
			while ( j < count1 ){	
				var b = false;
				var count = GetRowCount('Grid_Sum');
				var i = 0;
				while ( i < count ) {					
					SetRowIndex('Grid_Sum', i);						
					if(GetCellValue('Grid0', j, 'MaterialId') == MaterialId_Sum 
					&& GetCellValue('Grid0', j, 'BatchNo') == BatchNo_Sum
					&& GetCellValue('Grid0', j, 'ManufDate') == ManufDate_Sum
					&& GetCellValue('Grid0', j, 'ExpireDate') == ExpireDate_Sum
					&& GetCellValue('Grid0', j, 'RecvDate') == RecvDate_Sum
					&& GetCellValue('Grid0', j, 'ProjectId') == ProjectId_Sum
					&& GetCellValue('Grid0', j, 'StrUserDef1') == StrUserDef1_Sum
					&& GetCellValue('Grid0', j, 'StrUserDef2') == StrUserDef2_Sum
					&& GetCellValue('Grid0', j, 'StrUserDef3') == StrUserDef3_Sum
					&& GetCellValue('Grid0', j, 'StrUserDef4') == StrUserDef4_Sum
					&& GetCellValue('Grid0', j, 'StrUserDef5') == StrUserDef5_Sum
					&& GetCellValue('Grid0', j, 'DictUserDef1') == DictUserDef1_Sum
					&& GetCellValue('Grid0', j, 'DictUserDef2') == DictUserDef2_Sum
					&& GetCellValue('Grid0', j, 'DictUserDef3') == DictUserDef3_Sum
					&& GetCellValue('Grid0', j, 'DictUserDef4') == DictUserDef4_Sum
					&& GetCellValue('Grid0', j, 'DictUserDef5') == DictUserDef5_Sum
					&& GetCellValue('Grid0', j, 'DateUserDef1') == DateUserDef1_Sum
					&& GetCellValue('Grid0', j, 'DateUserDef2') == DateUserDef2_Sum
					&& GetCellValue('Grid0', j, 'NumUserDef1') == NumUserDef1_Sum
					&& GetCellValue('Grid0', j, 'NumUserDef2') == NumUserDef2_Sum
					&& GetCellValue('Grid0', j, 'NumUserDef3') == NumUserDef3_Sum
					&& GetCellValue('Grid0', j, 'MaterialUnit') == MaterialUnit_Sum
					&& GetCellValue('Grid0', j, 'MaterialStatusId') == MaterialStatusId_Sum){
						//认为是同种物料，直接添加数量
						b = true;
						SetCellValue('Grid_Sum', i,'Qty_Sum',GetCellValue('Grid0', j, 'Qty') + Qty_Sum);
					}		
					i = i + 1;
				}
				if(b == false){
					//没有同种物料，直接新增一行物料明细
					var index = InsertRow('Grid_Sum',-1);
					SetCellValue('Grid_Sum', index,'MaterialId_Sum',GetCellValue('Grid0', j, 'MaterialId'));
					SetCellValue('Grid_Sum', index,'BatchNo_Sum',GetCellValue('Grid0', j, 'BatchNo'));
					SetCellValue('Grid_Sum', index,'ManufDate_Sum',GetCellValue('Grid0', j, 'ManufDate'));
					SetCellValue('Grid_Sum', index,'ExpireDate_Sum',GetCellValue('Grid0', j, 'ExpireDate'));
					SetCellValue('Grid_Sum', index,'RecvDate_Sum',GetCellValue('Grid0', j, 'RecvDate'));
					SetCellValue('Grid_Sum', index,'ProjectId_Sum',GetCellValue('Grid0', j, 'ProjectId'));
					SetCellValue('Grid_Sum', index,'StrUserDef1_Sum',GetCellValue('Grid0', j, 'StrUserDef1'));
					SetCellValue('Grid_Sum', index,'StrUserDef2_Sum',GetCellValue('Grid0', j, 'StrUserDef2'));
					SetCellValue('Grid_Sum', index,'StrUserDef3_Sum',GetCellValue('Grid0', j, 'StrUserDef3'));
					SetCellValue('Grid_Sum', index,'StrUserDef4_Sum',GetCellValue('Grid0', j, 'StrUserDef4'));
					SetCellValue('Grid_Sum', index,'StrUserDef5_Sum',GetCellValue('Grid0', j, 'StrUserDef5'));
					SetCellValue('Grid_Sum', index,'DictUserDef1_Sum',GetCellValue('Grid0', j, 'DictUserDef1'));
					SetCellValue('Grid_Sum', index,'DictUserDef2_Sum',GetCellValue('Grid0', j, 'DictUserDef2'));
					SetCellValue('Grid_Sum', index,'DictUserDef3_Sum',GetCellValue('Grid0', j, 'DictUserDef3'));
					SetCellValue('Grid_Sum', index,'DictUserDef4_Sum',GetCellValue('Grid0', j, 'DictUserDef4'));
					SetCellValue('Grid_Sum', index,'DictUserDef5_Sum',GetCellValue('Grid0', j, 'DictUserDef5'));
					SetCellValue('Grid_Sum', index,'DateUserDef1_Sum',GetCellValue('Grid0', j, 'DateUserDef1'));
					SetCellValue('Grid_Sum', index,'DateUserDef2_Sum',GetCellValue('Grid0', j, 'DateUserDef2'));
					SetCellValue('Grid_Sum', index,'NumUserDef1_Sum',GetCellValue('Grid0', j, 'NumUserDef1'));
					SetCellValue('Grid_Sum', index,'NumUserDef2_Sum',GetCellValue('Grid0', j, 'NumUserDef2'));
					SetCellValue('Grid_Sum', index,'NumUserDef3_Sum',GetCellValue('Grid0', j, 'NumUserDef3'));
					SetCellValue('Grid_Sum', index,'Qty_Sum',GetCellValue('Grid0', j, 'Qty'));
					SetCellValue('Grid_Sum', index,'MaterialUnit_Sum',GetCellValue('Grid0', j, 'MaterialUnit'));
					SetCellValue('Grid_Sum', index,'MaterialStatusId_Sum',GetCellValue('Grid0', j, 'MaterialStatusId'));
				}
						
				j = j + 1;
			}			
		}
		SetColumnCaption("Grid0","BatchNo",ToString(GetSessionPara('BatchNo_Name')));
		SetColumnCaption("Grid0","ManufDate",ToString(GetSessionPara('ManufDate_Name')));
		SetColumnCaption("Grid0","ExpireDate",ToString(GetSessionPara('ExpireDate_Name')));
		SetColumnCaption("Grid0","RecvDate",ToString(GetSessionPara('RecvDate_Name')));
		SetColumnCaption("Grid0","ProjectId",ToString(GetSessionPara('ProjectId_Name')));
		SetColumnCaption("Grid0","StrUserDef1",ToString(GetSessionPara('StrUserDef1_Name')));
		SetColumnCaption("Grid0","StrUserDef2",ToString(GetSessionPara('StrUserDef2_Name')));
		SetColumnCaption("Grid0","StrUserDef3",ToString(GetSessionPara('StrUserDef3_Name')));
		SetColumnCaption("Grid0","StrUserDef4",ToString(GetSessionPara('StrUserDef4_Name')));
		SetColumnCaption("Grid0","StrUserDef5",ToString(GetSessionPara('StrUserDef5_Name')));
		SetColumnCaption("Grid0","DictUserDef1",ToString(GetSessionPara('DictUserDef1_Name')));
		SetColumnCaption("Grid0","DictUserDef2",ToString(GetSessionPara('DictUserDef2_Name')));
		SetColumnCaption("Grid0","DictUserDef3",ToString(GetSessionPara('DictUserDef3_Name')));
		SetColumnCaption("Grid0","DictUserDef4",ToString(GetSessionPara('DictUserDef4_Name')));
		SetColumnCaption("Grid0","DictUserDef5",ToString(GetSessionPara('DictUserDef5_Name')));
		SetColumnCaption("Grid0","DateUserDef1",ToString(GetSessionPara('DateUserDef1_Name')));
		SetColumnCaption("Grid0","DateUserDef2",ToString(GetSessionPara('DateUserDef2_Name')));
		SetColumnCaption("Grid0","NumUserDef1",ToString(GetSessionPara('NumUserDef1_Name')));
		SetColumnCaption("Grid0","NumUserDef2",ToString(GetSessionPara('NumUserDef2_Name')));
		SetColumnCaption("Grid0","NumUserDef3",ToString(GetSessionPara('NumUserDef3_Name')));
		
		SetColumnCaption("Grid_Sum","BatchNo_Sum",ToString(GetSessionPara('BatchNo_Name')));
		SetColumnCaption("Grid_Sum","ManufDate_Sum",ToString(GetSessionPara('ManufDate_Name')));
		SetColumnCaption("Grid_Sum","ExpireDate_Sum",ToString(GetSessionPara('ExpireDate_Name')));
		SetColumnCaption("Grid_Sum","RecvDate_Sum",ToString(GetSessionPara('RecvDate_Name')));
		SetColumnCaption("Grid_Sum","ProjectId_Sum",ToString(GetSessionPara('ProjectId_Name')));
		SetColumnCaption("Grid_Sum","StrUserDef1_Sum",ToString(GetSessionPara('StrUserDef1_Name')));
		SetColumnCaption("Grid_Sum","StrUserDef2_Sum",ToString(GetSessionPara('StrUserDef2_Name')));
		SetColumnCaption("Grid_Sum","StrUserDef3_Sum",ToString(GetSessionPara('StrUserDef3_Name')));
		SetColumnCaption("Grid_Sum","StrUserDef4_Sum",ToString(GetSessionPara('StrUserDef4_Name')));
		SetColumnCaption("Grid_Sum","StrUserDef5_Sum",ToString(GetSessionPara('StrUserDef5_Name')));
		SetColumnCaption("Grid_Sum","DictUserDef1_Sum",ToString(GetSessionPara('DictUserDef1_Name')));
		SetColumnCaption("Grid_Sum","DictUserDef2_Sum",ToString(GetSessionPara('DictUserDef2_Name')));
		SetColumnCaption("Grid_Sum","DictUserDef3_Sum",ToString(GetSessionPara('DictUserDef3_Name')));
		SetColumnCaption("Grid_Sum","DictUserDef4_Sum",ToString(GetSessionPara('DictUserDef4_Name')));
		SetColumnCaption("Grid_Sum","DictUserDef5_Sum",ToString(GetSessionPara('DictUserDef5_Name')));
		SetColumnCaption("Grid_Sum","DateUserDef1_Sum",ToString(GetSessionPara('DateUserDef1_Name')));
		SetColumnCaption("Grid_Sum","DateUserDef2_Sum",ToString(GetSessionPara('DateUserDef2_Name')));
		SetColumnCaption("Grid_Sum","NumUserDef1_Sum",ToString(GetSessionPara('NumUserDef1_Name')));
		SetColumnCaption("Grid_Sum","NumUserDef2_Sum",ToString(GetSessionPara('NumUserDef2_Name')));
		SetColumnCaption("Grid_Sum","NumUserDef3_Sum",ToString(GetSessionPara('NumUserDef3_Name')));
	]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="RefreshOutboundNoticeQuantDetails">
            <![CDATA[
			//var ids = "";
			//loop"Grid1"(true){
			//	ids = ids + NoticeLineSOID + ",";
			//}
			//if(Length(ids) > 0){
			//	ids = Left(ids, Length(ids)-1);
			//}
			//不能使用，因为平台sql不支持传送in参数
			//var rst = DBNamedQuery('GetOutboundNoticeDetail_bak',ids);  
			ClearAllRows('Grid0');
			ClearAllRows('Grid_Sum',false);
			
			//读取出库订单引用并填入明细表
			loop"Grid1"(true){
				var rst = DBNamedQuery('GetOutboundNoticeDetail',NoticeLineSOID);
				rst.beforefirst();
				while(rst.next()){
					var b = false;
					var count = GetRowCount('Grid_Sum');
                    var i = 0;
					while ( i < count ) {
						SetRowIndex('Grid_Sum', i);						
						if(rst.MaterialId == MaterialId_Sum 
						&& rst.BatchNo == BatchNo_Sum
						&& rst.ManufDate == ManufDate_Sum
						&& rst.ExpireDate == ExpireDate_Sum
						&& rst.RecvDate == RecvDate_Sum
						&& rst.ProjectId == ProjectId_Sum
						&& rst.StrUserDef1 == StrUserDef1_Sum
						&& rst.StrUserDef2 == StrUserDef2_Sum
						&& rst.StrUserDef3 == StrUserDef3_Sum
						&& rst.StrUserDef4 == StrUserDef4_Sum
						&& rst.StrUserDef5 == StrUserDef5_Sum
						&& rst.DictUserDef1 == DictUserDef1_Sum
						&& rst.DictUserDef2 == DictUserDef2_Sum
						&& rst.DictUserDef3 == DictUserDef3_Sum
						&& rst.DictUserDef4 == DictUserDef4_Sum
						&& rst.DictUserDef5 == DictUserDef5_Sum
						&& rst.DateUserDef1 == DateUserDef1_Sum
						&& rst.DateUserDef2 == DateUserDef2_Sum
						&& rst.NumUserDef1 == NumUserDef1_Sum
						&& rst.NumUserDef2 == NumUserDef2_Sum
						&& rst.NumUserDef3 == NumUserDef3_Sum
						&& rst.MaterialStatusId == MaterialStatusId_Sum){
							//认为是同种物料，直接添加数量
							b = true;
							if(rst.MaterialUnit == MaterialUnit_Sum){
								//单位相同，直接添加
								SetCellValue('Grid_Sum', i,'Qty_Sum',rst.Qty + Qty_Sum);
							}
							else{
								//单位换算之后添加
								var value1 = rst.Qty;
								var value2 = Qty_Sum;							
								if(rst.MaterialUnit == rst.PackingUnit){
									value1 = rst.Qty * rst.PackingQty;							
								}
								if(MaterialUnit == rst.PackingUnit){
									value2 = Qty_Sum * rst.PackingQty;							
								}								
								SetCellValue('Grid_Sum', i,'Qty_Sum',value2 + value1);
								SetCellValue('Grid_Sum', i,'MaterialUnit_Sum',rst.BasicUnit);
							}
						}		
						i = i + 1;
					}
					if(b == false){
						//没有同种物料，直接新增一行物料明细
						var index = InsertRow('Grid_Sum',-1);
						SetCellValue('Grid_Sum', index,'MaterialId_Sum',rst.MaterialId);
						SetCellValue('Grid_Sum', index,'BatchNo_Sum',rst.BatchNo);
						SetCellValue('Grid_Sum', index,'ManufDate_Sum',rst.ManufDate);
						SetCellValue('Grid_Sum', index,'ExpireDate_Sum',rst.ExpireDate);
						SetCellValue('Grid_Sum', index,'RecvDate_Sum',rst.RecvDate);
						SetCellValue('Grid_Sum', index,'ProjectId_Sum',rst.ProjectId);
						SetCellValue('Grid_Sum', index,'StrUserDef1_Sum',rst.StrUserDef1);
						SetCellValue('Grid_Sum', index,'StrUserDef2_Sum',rst.StrUserDef2);
						SetCellValue('Grid_Sum', index,'StrUserDef3_Sum',rst.StrUserDef3);
						SetCellValue('Grid_Sum', index,'StrUserDef4_Sum',rst.StrUserDef4);
						SetCellValue('Grid_Sum', index,'StrUserDef5_Sum',rst.StrUserDef5);
						SetCellValue('Grid_Sum', index,'DictUserDef1_Sum',rst.DictUserDef1);
						SetCellValue('Grid_Sum', index,'DictUserDef2_Sum',rst.DictUserDef2);
						SetCellValue('Grid_Sum', index,'DictUserDef3_Sum',rst.DictUserDef3);
						SetCellValue('Grid_Sum', index,'DictUserDef4_Sum',rst.DictUserDef4);
						SetCellValue('Grid_Sum', index,'DictUserDef5_Sum',rst.DictUserDef5);
						SetCellValue('Grid_Sum', index,'DateUserDef1_Sum',rst.DateUserDef1);
						SetCellValue('Grid_Sum', index,'DateUserDef2_Sum',rst.DateUserDef2);
						SetCellValue('Grid_Sum', index,'NumUserDef1_Sum',rst.NumUserDef1);
						SetCellValue('Grid_Sum', index,'NumUserDef2_Sum',rst.NumUserDef2);
						SetCellValue('Grid_Sum', index,'NumUserDef3_Sum',rst.NumUserDef3);
						SetCellValue('Grid_Sum', index,'Qty_Sum',rst.Qty);
						SetCellValue('Grid_Sum', index,'MaterialUnit_Sum',rst.MaterialUnit);
						SetCellValue('Grid_Sum', index,'MaterialStatusId_Sum',rst.MaterialStatusId);
					}
					
					//直接新增一行
					var index = InsertRow('Grid0',-1);
					SetCellValue('Grid0', index,'MaterialId',rst.MaterialId);
					SetCellValue('Grid0', index,'BatchNo',rst.BatchNo);
					SetCellValue('Grid0', index,'ManufDate',rst.ManufDate);
					SetCellValue('Grid0', index,'ExpireDate',rst.ExpireDate);
					SetCellValue('Grid0', index,'RecvDate',rst.RecvDate);
					SetCellValue('Grid0', index,'ProjectId',rst.ProjectId);
					SetCellValue('Grid0', index,'StrUserDef1',rst.StrUserDef1);
					SetCellValue('Grid0', index,'StrUserDef2',rst.StrUserDef2);
					SetCellValue('Grid0', index,'StrUserDef3',rst.StrUserDef3);
					SetCellValue('Grid0', index,'StrUserDef4',rst.StrUserDef4);
					SetCellValue('Grid0', index,'StrUserDef5',rst.StrUserDef5);
					SetCellValue('Grid0', index,'DictUserDef1',rst.DictUserDef1);
					SetCellValue('Grid0', index,'DictUserDef2',rst.DictUserDef2);
					SetCellValue('Grid0', index,'DictUserDef3',rst.DictUserDef3);
					SetCellValue('Grid0', index,'DictUserDef4',rst.DictUserDef4);
					SetCellValue('Grid0', index,'DictUserDef5',rst.DictUserDef5);
					SetCellValue('Grid0', index,'DateUserDef1',rst.DateUserDef1);
					SetCellValue('Grid0', index,'DateUserDef2',rst.DateUserDef2);
					SetCellValue('Grid0', index,'NumUserDef1',rst.NumUserDef1);
					SetCellValue('Grid0', index,'NumUserDef2',rst.NumUserDef2);
					SetCellValue('Grid0', index,'NumUserDef3',rst.NumUserDef3);
					SetCellValue('Grid0', index,'Qty',rst.Qty);
					SetCellValue('Grid0', index,'MaterialUnit',rst.MaterialUnit);
					SetCellValue('Grid0', index,'MaterialStatusId',rst.MaterialStatusId);
					SetCellValue('Grid0', index,'RefLineOID',rst.OID);
				}
			}
			]]>
        </Macro>
        <Macro Key="RefreshOutboundNoticeQuant">
            <![CDATA[
			//读取出库订单引用并填入明细表			
			var rst = DBNamedQuery('GetOutboundNotice',OID);
			
			var i = 0;
			loop"Grid1"(true){
				rst.beforefirst();
				while(rst.next()){
					if(rst.OID == NoticeLineSOID){
						SetCellValue('Grid1', i,'NoticeLineNo',rst.No);
						SetCellValue('Grid1', i,'OwnerNo',rst.OwnerNo);
						SetCellValue('Grid1', i,'CREATETIME',rst.CREATETIME);
						SetCellValue('Grid1', i,'ProvinceId',rst.ProvinceId);
						SetCellValue('Grid1', i,'CityId',rst.CityId);
						SetCellValue('Grid1', i,'DistrictId',rst.DistrictId);
						SetCellValue('Grid1', i,'RecvPartyName',rst.RecvPartyName);
						SetCellValue('Grid1', i,'ECOrderType',rst.ECOrderType);
						SetCellValue('Grid1', i,'ECPrintType',rst.ECPrintType);
						SetCellValue('Grid1', i,'ECInvoiceType',rst.ECInvoiceType);
					}				
				}
				i = i+1;
			}
			]]>
        </Macro>
        <Macro Key="RefreshMaterialDetailSelect">
            <![CDATA[
			//根据汇总表的选择情况刷新物料明细的选择情况	
			var j = 0;	
			loop"Grid0"(true){
				var count = GetRowCount('Grid_Sum');
                var i = 0;
				while ( i < count ) {
					SetRowIndex('Grid_Sum', i);	
					if(MaterialId == MaterialId_Sum 
					&& BatchNo == BatchNo_Sum
					&& ManufDate == ManufDate_Sum
					&& ExpireDate == ExpireDate_Sum
					&& RecvDate == RecvDate_Sum
					&& ProjectId == ProjectId_Sum
					&& StrUserDef1 == StrUserDef1_Sum
					&& StrUserDef2 == StrUserDef2_Sum
					&& StrUserDef3 == StrUserDef3_Sum
					&& StrUserDef4 == StrUserDef4_Sum
					&& StrUserDef5 == StrUserDef5_Sum
					&& DictUserDef1 == DictUserDef1_Sum
					&& DictUserDef2 == DictUserDef2_Sum
					&& DictUserDef3 == DictUserDef3_Sum
					&& DictUserDef4 == DictUserDef4_Sum
					&& DictUserDef5 == DictUserDef5_Sum
					&& DateUserDef1 == DateUserDef1_Sum
					&& DateUserDef2 == DateUserDef2_Sum
					&& NumUserDef1 == NumUserDef1_Sum
					&& NumUserDef2 == NumUserDef2_Sum
					&& NumUserDef3 == NumUserDef3_Sum
					&& MaterialStatusId == MaterialStatusId_Sum){
						//认为是同种物料，刷新物料明细的选择情况
						SetCellValue('Grid0', j,'Select1',Select1_Sum);
					}
					i = i+1;					
				}
				j = j + 1;
			}
			]]>
        </Macro>
    </MacroCollection>
</Form>
