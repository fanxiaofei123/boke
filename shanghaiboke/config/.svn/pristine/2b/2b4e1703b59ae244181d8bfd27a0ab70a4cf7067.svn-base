<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="DoWavePick" Caption="波次拣货" Authenticate="false" HasNavigationBar="false">
    <DataSource>
        <DataObject Key="LRP_PickDetail" Caption="拣货明细" PrimaryTableKey="LRP_WMTx_L">
            <TableCollection>
                <Table Key="LRP_WMTx_L" Caption="拣货明细" TableMode="Detail" SourceType="Query">
                    <Column Caption="对象标识" DataType="Long" Key="OID"/>
                    <Column Caption="物料ID" DataType="Long" Key="MaterialId"/>
                    <Column Caption="单位" DataType="Varchar" Key="MaterialUnit" Length="10"/>
                    <Column Caption="批号" DataType="Varchar" Key="SrcBatchNo" Length="100"/>
                    <Column Caption="实拣量" DataType="Numeric" Key="PickQty" Precision="18" Scale="6"/>
                    <Column Caption="数量" DataType="Numeric" Key="Qty" Precision="18" Scale="6"/>
                    <Column Caption="储位" DataType="Long" Key="SrcLocationId"/>
                    <Column Caption="发货区储位" DataType="Long" Key="DestLocationId"/>
                    <Column Key="MaterilName" Caption="物料名称" DataType="Varchar" Length="200"/>
                    <Column Key="MaterilCode" Caption="物料代码" DataType="Varchar" Length="100"/>
                    <Column Key="SrcLocationName" Caption="储位名称" DataType="Varchar" Length="200"/>
                    <Column Key="SrcLocationCode" Caption="储位代码" DataType="Varchar" Length="200"/>
                    <Column Key="DestLocationName" Caption="发货区储位名称" DataType="Varchar" Length="200"/>
                    <Column Caption="序号" Key="RowIndex" DataType="Integer"/>
                    <Column Caption="对应汇总记录序号" Key="SumIndex" DataType="Integer"/>
                    <Column Caption="订单号" DataType="Varchar" Key="NoticeNo" Length="100"/>
                    <ParameterCollection>
                        <Parameter DataType="Long" Formula="GetPara('OID');"/>
                    </ParameterCollection>
                    <Statement>
                        <![CDATA[ select 
    l.OID,
	l.SOID,
	l.MaterialId,
	l.MaterialUnit,
    l.SrcBatchNo,
	0.0 as PickQty,
	0 as SumIndex,
    l.Qty,
    l.SrcLocationId,
    l.DestLocationId,
    m.Name as MaterilName,
    m.Code as MaterilCode,
	srcloc.Name as SrcLocationName,
	srcloc.Code as SrcLocationCode,
	destloc.Name as DestLocationName,
	wol.RowIndex, 
	oh.No as NoticeNo 
	from LRP_WMTx_L l left join LRP_Material m on m.oid = l.MaterialId 
	left join LRP_Location srcloc on srcloc.oid = l.SrcLocationId 
	left join LRP_Location destloc on destloc.oid = l.DestLocationId 
	join LRP_Wave_MaterialSum_L wl on wl.oid = l.SrcOID 
	join LRP_OutboundNotice_L ol on ol.oid = wl.RefLineOID 
	join LRP_OutboundNotice_H oh on oh.soid = ol.soid 
	join LRP_Wave_Notice_L wol on wol.NoticeLineSOID = oh.soid 
    where
        l.SOID = ? 
	Order by srcloc.Code
    ]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <Body>
        <Block>
            <GridLayoutPanel Key="root">
                <Format BackColor="#e6e6e6"/>
                <LinearLayoutPanel Caption="Title" Key="Title" Orientation="Horizontal" X="0" Y="0">
                    <Format BackColor="#f14c52"/>
                    <Button Key="Cancel" Caption="取消" Width="60px" Height="auto">
                        <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Left">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									ShowConfirm('是否放弃本次拣货？', 'YES_NO', 
										{
											YES: {
												Back();
											}, 
											NO: {} 
										}
									)
								]]>
                        </OnClick>
                    </Button>
                    <Label Key="OrderTitle3" Caption="波次拣货" Height="auto" Weight="1.0">
                        <Format ForeColor="#ffffff" HAlign="Center">
                            <Font Size="20"/>
                        </Format>
                    </Label>
                    <Button Key="Finish" Caption="完成" Height="auto" Width="60px">
                        <Format BackColor="#f14c52" ForeColor="#ffffff" HAlign="Right">
                            <Font Size="16"/>
                        </Format>
                        <OnClick>
                            <![CDATA[
									var lack = GetValue('LackQty');
									var b = true;
									if(lack > 0){
										ShowConfirm('存在未拣完的物料明细，是否继续完成？', 'YES_NO', 
											{
												YES: {
													InvokeService("LRP_SavePick", true, false,GetPara('OID'));
													ShowToast("拣货完成");
													Parent.LoadData();
													Back();
												}, 
												NO: {} 
											}
										);
									}
									else{
										InvokeService("LRP_SavePick", true, false,GetPara('OID'));
										ShowToast("拣货完成");
										Parent.LoadData();
										Back();
									}
																													
									]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>
                <!--
                <GridLayoutPanel Key="EnterCode" Caption="扫描" X="0" Y="1">
                    <Format BackColor="#FFFFFF">
                        <Font Size="20"/>
                    </Format>
                    <TextEditor Key="GetLocationCode" Caption="扫描储位" Padding="2px" PromptText="扫描储位" BorderStyle="none" Enable="True" X="0" Y="0" XSpan="2">
                        <KeyEnter>
                            <![CDATA[
								FocusLocation();
							]]>
                        </KeyEnter>
                    </TextEditor>
                    <LinearLayoutPanel Key="opt_panel2" X="2" Y="0" Orientation="Horizontal" BorderStyle="solid none">
                        <Button Key="GetLocCode" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none">
                            <Format HAlign="Left"/>
                            <OnClick>
                                <![CDATA[
									FocusLocation();
								]]>
                            </OnClick>
                        </Button>
                    </LinearLayoutPanel>
                    <TextEditor Key="GetMaterialCode" Caption="扫描物料条码" Padding="2px" PromptText="扫描物料条码" BorderStyle="none" Enable="True" X="4" Y="0" XSpan="2">
                        <KeyEnter>
                            <![CDATA[
								PickMaterial();
							]]>
                        </KeyEnter>
                    </TextEditor>
                    <LinearLayoutPanel Key="opt_panel1" X="6" Y="0" Orientation="Horizontal" BorderStyle="solid none">
                        <Button Key="GetMatCode" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none">
                            <Format HAlign="Left"/>
                            <OnClick>
                                <![CDATA[
									PickMaterial();
								]]>
                            </OnClick>
                        </Button>
                    </LinearLayoutPanel>
                    <NumberEditor Key="AddQty" Precision="18" Scale="0" Padding="0px" BorderStyle="none" X="1" Y="1">
                        <DataBinding DefaultValue="1"/>
                        <Format BackColor="transparent">
                            <Font Size="18"/>
                        </Format>
                    </NumberEditor>
                    <Label Key="Lab_AddQty" Caption="增加量" X="0" Y="1">
                        <Format>
                            <Font Size="18"/>
                        </Format>
                    </Label>
                    <NumberEditor Key="LackQty" Precision="18" Scale="0" Enable="false" Padding="0px" BorderStyle="none" X="5" Y="1">
                        <Format BackColor="transparent">
                            <Font Size="18"/>
                        </Format>
                    </NumberEditor>
                    <Label Key="Lab_LackQty" Caption="总未拣量" X="4" Y="1">
                        <Format>
                            <Font Size="18"/>
                        </Format>
                    </Label>
                    <RowDefCollection RowGap="5">
                        <RowDef Height="35px"/>
                        <RowDef Height="35px"/>
                    </RowDefCollection>
                    <ColumnDefCollection>
                        <ColumnDef Width="70px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="40px"/>
                        <ColumnDef Width="5px"/>
                        <ColumnDef Width="70px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="40px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
                -->
                <TableView Key="MaterialDetail" X="0" Y="1">
                    <Format BackColor="#f1f3f8"/>
                    <TableRowCollection>
                        <TableRow Key="r3" SeparatorStyle="solid solid solid none" SeparatorColor="#dde0e7" TopMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel33" Height="50px" Orientation="Horizontal">
                                <TextEditor Key="GetLocationCode" Caption="扫描储位" BorderStyle="none" Weight="1.0" Height="auto" PromptText="扫描储位">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                    <KeyEnter>
                                        <![CDATA[
										     FocusLocation();
										
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Button Key="GetLocCode" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none" Height="auto">
                                    <Format HAlign="Left">
                                        <Font Size="6"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
										FocusLocation();
									]]>
                                    </OnClick>
                                </Button>
                                <TextEditor Key="GetMaterialCode" Caption="扫描物料条码" BorderStyle="none" Weight="1.0" Height="auto" PromptText="扫描物料条码">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                    <KeyEnter>
                                        <![CDATA[
										     PickMaterial();
										
									  ]]>
                                    </KeyEnter>
                                </TextEditor>
                                <Button Key="GetMatCode" Icon="12.png" OnlyIcon="True" Enable="true" Width="40px" BorderStyle="none" Height="auto">
                                    <Format HAlign="Left">
                                        <Font Size="6"/>
                                    </Format>
                                    <OnClick>
                                        <![CDATA[
										PickMaterial();
									]]>
                                    </OnClick>
                                </Button>
                            </LinearLayoutPanel>
                        </TableRow>
                        <TableRow Key="r4" SeparatorStyle="solid solid solid solid" SeparatorColor="#dde0e7" TopMargin="5px" BottomMargin="5px">
                            <LinearLayoutPanel Key="service_center_panel34" Height="50px" Orientation="Horizontal">
                                <Label Key="Lab_AddQty" Caption="增加量" Width="60px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="AddQty" Caption="增加量" Enable="false" Height="auto" Precision="18" Scale="0" Width="120px">
                                    <DataBinding DefaultValue="1"/>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Lab_LackQty" Caption="总未拣量" Width="55px" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="LackQty" Caption="总未拣量" Enable="false" Height="auto" Precision="18" Scale="0" Weight="1.0" Width="pref">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                            </LinearLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <TableView Key="MaterialDetailSum" X="0" Y="2">
                    <TableRowCollection>
                        <TableRow Key="list" TopMargin="5px" SeparatorStyle="none none solid none" RowType="Detail" SeparatorColor="#b8becc">
                            <GridLayoutPanel Key="GridLayoutPanel3" Padding="5px" Caption="MaterialDetai">
                                <Label Key="MaterialId" Caption="物料ID" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SrcLocationId" Caption="储位ID" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SrcBatchNo" Caption="批号" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterilCode" Caption="物料代码" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="MaterilName" Caption="物料名称" Width="pref" Height="auto" X="2" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="PickQty_label" Caption="实拣" Width="pref" X="0" Y="1" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="PickQty" Caption="实拣" Precision="18" Scale="0" Width="pref" Height="auto" Enable="true" X="1" Y="1">
                                    <DataBinding>
                                        <ValueChanged>
                                            <![CDATA[
											if(GetValue('PickQty') < 0){
											   SetValue('PickQty',0,false);
											}
											if(GetValue('PickQty') > GetValue('Qty')){
											   SetValue('PickQty',GetValue('Qty'),false);
											}
											CalculateNoticePick(GetRowIndex('list'));
											CalculatePick();
											]]>
                                        </ValueChanged>
                                    </DataBinding>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Qty_label" Caption="应拣" Width="pref" X="2" Y="1" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="Qty" Caption="应拣" Precision="18" Scale="0" Width="pref" Height="auto" Enable="false" X="3" Y="1">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="MaterialUnit" Caption="单位" Width="pref" Height="auto" X="4" Y="1">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SrcLocationCode" Caption="储位代码" Width="pref" Height="auto" X="4" Y="0">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="40px"/>
                                    <RowDef Height="40px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="3">
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="35%"/>
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="35%"/>
                                    <ColumnDef Width="30%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                            <FocusRowChanged>
                                <![CDATA[
							
							var i = GetRowIndex('list');
							while(GetRowCount('list1')>0){
								DeleteRow('list1',0);
							}	
							var index = 0;
							var dt=GetDataTable("LRP_WMTx_L");
							dt.beforefirst();
							while(dt.next()){
								if(dt.SumIndex == i){
									InsertRow('list1');
									SetCellValue('list1',index,'DetailID' ,dt.OID);
									SetCellValue('list1',index,'RowIndex' ,dt.RowIndex);
									SetCellValue('list1',index,'SumIndex' ,dt.SumIndex);
									SetCellValue('list1',index,'NoticeNo' ,dt.NoticeNo);
									SetCellValue('list1',index,'PickQty1' ,dt.PickQty,false);
									SetCellValue('list1',index,'Qty1' ,dt.Qty);
									SetCellValue('list1',index,'DestLocationName' ,dt.DestLocationName);
									index = index + 1;
								}
							}
									]]>
                            </FocusRowChanged>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <TableView Key="NoticeDetail" X="0" Y="3">
                    <TableRowCollection>
                        <TableRow Key="list1" TopMargin="5px" SeparatorStyle="none none solid none" RowType="Detail" SeparatorColor="#b8becc">
                            <GridLayoutPanel Key="GridLayoutPanel4" Padding="5px" Caption="MaterialDetai">
                                <Label Key="DetailID" Caption="对象标识" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="RowIndex" Caption="序号" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="SumIndex" Caption="对应汇总记录序号" Visible="false" Width="pref" Height="auto" X="0" Y="0" XSpan="2">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="NoticeNo" Caption="订单号" Width="pref" Height="auto" X="2" Y="0" XSpan="3">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <Label Key="PickQty1_label" Caption="实拣" Width="pref" X="0" Y="1" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="PickQty1" Caption="实拣" Precision="13" Scale="0" Width="pref" Height="auto" Enable="true" X="1" Y="1">
                                    <DataBinding>
                                        <ValueChanged>
                                            <![CDATA[
											if(GetValue('PickQty1') < 0){
											   SetValue('PickQty1',0,false);
											}
											if(GetValue('PickQty1') > GetValue('Qty1')){
											   SetValue('PickQty1',GetValue('Qty1'),false);
											}
											var SumIndex = GetValue('SumIndex');
											var picked = 0.0; 
											
											SaveDetailChangeToTable(GetRowIndex('list1'));
											var count = GetRowCount('list1');
											var index = 0;
											while(index < count){
												picked = picked + GetCellValue('list1',index,'PickQty1');
												index = index + 1;							
											}
											SetCellValue('list',SumIndex,'PickQty',picked,false);
											CalculatePick();
											]]>
                                        </ValueChanged>
                                    </DataBinding>
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="Qty1_label" Caption="应拣" Width="pref" X="2" Y="1" Height="auto">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <NumberEditor Key="Qty1" Caption="应拣" Precision="18" Scale="0" Width="pref" Height="auto" Enable="false" X="3" Y="1">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </NumberEditor>
                                <Label Key="DestLocationName" Caption="发货区" Width="pref" Height="auto" X="4" Y="1">
                                    <Format>
                                        <Font Size="13"/>
                                    </Format>
                                </Label>
                                <RowDefCollection RowGap="1">
                                    <RowDef Height="40px"/>
                                    <RowDef Height="40px"/>
                                </RowDefCollection>
                                <ColumnDefCollection ColumnGap="3">
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="35%"/>
                                    <ColumnDef Width="40px"/>
                                    <ColumnDef Width="35%"/>
                                    <ColumnDef Width="30%"/>
                                </ColumnDefCollection>
                            </GridLayoutPanel>
                        </TableRow>
                    </TableRowCollection>
                </TableView>
                <!--
                <LinearLayoutPanel Key="opt_panel3" X="0" Y="4" Orientation="Horizontal" BorderStyle="solid none">
                    <Button Key="Save" Caption="完成" Enable="True" Width="20%" Height="auto" Weight="1.0" BorderStyle="none">
                        <Format ForeColor="#ffffff" HAlign="Center" BackColor="#ff5000"/>
                        <OnClick>
                            <![CDATA[
									var lack = GetValue('LackQty');
									var b = true;
									if(lack > 0){
										ShowConfirm('存在未拣完的物料明细，是否继续完成？', 'YES_NO', 
											{
												YES: {
													InvokeService("LRP_SavePick", true, false,GetPara('OID'));
													ShowToast("拣货完成");
													Parent.LoadData();
													Back();
												}, 
												NO: {} 
											}
										);
									}
									else{
										InvokeService("LRP_SavePick", true, false,GetPara('OID'));
										ShowToast("拣货完成");
										Parent.LoadData();
										Back();
									}
									]]>
                        </OnClick>
                    </Button>
                    <Button Key="Cancel" Caption="取消" Enable="True" Width="20%" Height="auto" Weight="1.0" BorderStyle="none">
                        <Format ForeColor="#ffffff" HAlign="Center" BackColor="#80b380"/>
                        <OnClick>
                            <![CDATA[
									ShowConfirm('是否放弃本次拣货？', 'YES_NO', 
										{
											YES: {
												Back();
											}, 
											NO: {} 
										}
									)
									]]>
                        </OnClick>
                    </Button>
                </LinearLayoutPanel>-->
                <RowDefCollection>
                    <RowDef Height="50px"/>
                    <RowDef Height="118px"/>
                    <RowDef Height="50%"/>
                    <RowDef Height="50%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
			LoadData();
			var dt=GetDataTable("LRP_WMTx_L");
			dt.beforefirst();
			while(dt.next()){
				var count = GetRowCount('list');
				var i = 0;
				
				var b = false;
				while(i<count){
					if(dt.MaterialId == GetCellValue('list',i,'MaterialId') 
					&& dt.SrcLocationId == GetCellValue('list',i,'SrcLocationId')
					&& dt.SrcBatchNo == GetCellValue('list',i,'SrcBatchNo')){
						var CurQty = GetCellValue('list',i,'Qty');
						SetCellValue('list',i,'Qty' ,CurQty + dt.Qty);
                                                                     
						dt.SumIndex = i;
						b =true;
						break;
					}
                                          
					i= i + 1;
				}
                
				
				if(!b){
					InsertRow('list');
					SetCellValue('list',i,'MaterialId' ,dt.MaterialId);
					SetCellValue('list',i,'SrcLocationId' ,dt.SrcLocationId);
					SetCellValue('list',i,'SrcBatchNo' ,dt.SrcBatchNo);
					SetCellValue('list',i,'MaterilCode' ,dt.MaterilCode);
					SetCellValue('list',i,'MaterilName' ,dt.MaterilName);
					SetCellValue('list',i,'PickQty' ,0.0,false);
					SetCellValue('list',i,'Qty' ,dt.Qty);
					SetCellValue('list',i,'MaterialUnit' ,dt.MaterialUnit);
					SetCellValue('list',i,'SrcLocationCode' ,dt.SrcLocationCode);
                                       
					dt.SumIndex = i;
				}
			}
			
			
				
			
        ]]>
    </OnLoad>
    <OnPostShow>
        <![CDATA[CalculatePick();]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="CalculatePick" Description="计算并设置总未拣量">
            <![CDATA[
				var total = 0.0;
				var picked = 0.0; 
				
				var count = GetRowCount('list');
				var index = 0;
				while(index < count){
					total = total + GetCellValue('list',index,'Qty');
					picked = picked + GetCellValue('list',index,'PickQty');
					index = index + 1;							
				}
				
				SetValue('LackQty',total - picked);
			]]>
        </Macro>
        <Macro Key="FocusLocation" Description="根据扫入的储位代码定位对应的汇总明细">
            <![CDATA[				
				var count = GetRowCount('list');
				var index = 0;
				var LocCode = GetValue('GetLocationCode');
				if(LocCode == "") {return true;}
				var b = false;
				while(index < count){
					var SrcLocationCode = GetCellValue('list',index,'SrcLocationCode');	
					if(LocCode == SrcLocationCode){
						SetFocusRow('list',index);
						ScrollTo('list',index);
						b = true;
					}
					index = index + 1;							
				}
				
				if(!b) {
					ShowToast("应拣货列表中不存在该储位代码");
					SetFocus('GetLocationCode');
				}
				else{
					SetFocus('GetMaterialCode');
				}
			]]>
        </Macro>
        <Macro Key="PickMaterial" Description="根据扫入的物料码定位对应的物料并加上增加量">
            <![CDATA[				
				var count = GetRowCount('list');
				var index = 0;
				var Code = GetValue('GetMaterialCode');
				if(Code == "") {return true;}
				var LocCode = GetValue('GetLocationCode');
				if(LocCode == "") {return true;}
				var b = false;
				while(index < count){
					var MatrialCode = GetCellValue('list',index,'MaterilCode');
					var SrcLocationCode = GetCellValue('list',index,'SrcLocationCode');
					if(Code == MatrialCode && LocCode == SrcLocationCode){
						SetFocusRow('list',index);
						ScrollTo('list',index);
					
						var Qty = GetCellValue('list',index,'Qty');
						var PickQty = GetCellValue('list',index,'PickQty');
						
						var Add = GetValue('AddQty');
						PickQty = PickQty + Add;
						if(PickQty > Qty){
							index = index + 1;
							ShowToast("第" & index & "条明细的实拣量不能超出应拣量");
						}
						else{								
							SetCellValue('list',index,'PickQty',PickQty,false);
							b = true;
							CalculateNoticePick(index);
							CalculatePick();
							SetFocusRow('list',index);
							ScrollTo('list',index);
							break;
						}						
					}
					index = index + 1;							
				}
				
				if(!b) {ShowToast("拣货明细中找不到该条码物料");}
				SetFocus('GetMaterialCode');
			]]>
        </Macro>
        <Macro Key="CalculateNoticePick" Description="汇总明细的拣货数量修改后将新的数量分拆到订单明细中并保存到真实数据里" Args="i">
            <![CDATA[
				var PickQty = GetCellValue('list',i,'PickQty');
				var count = GetRowCount('list1');
				var index = 0;
				while(index < count){					
					var Qty = GetCellValue('list1',index,'Qty1');
					if(PickQty > Qty){														
						SetCellValue('list1',index,'PickQty1',Qty,false);
						SaveDetailChangeToTable(index);
						PickQty = PickQty - Qty;
					}
					else{
						SetCellValue('list1',index,'PickQty1',PickQty,false);
						SaveDetailChangeToTable(index);
						break;
					}
					index = index + 1;							
				}
			]]>
        </Macro>
        <Macro Key="SaveDetailChangeToTable" Description="将指定行界面明细的修改保存到对应的数据表中" Args="i">
            <![CDATA[
				var DetailID = GetCellValue('list1',i,'DetailID');
				var dt=GetDataTable("LRP_WMTx_L");
				dt.beforefirst();
				while(dt.next()){
					if(dt.OID == DetailID){
						dt.PickQty = GetCellValue('list1',i,'PickQty1');
						break;
					}
				}
			]]>
        </Macro>
    </MacroCollection>
    <FormParaCollection>
        <FormPara Formula="Para('OID')" Key="OID" Type="Formula"/>
    </FormParaCollection>
</Form>
