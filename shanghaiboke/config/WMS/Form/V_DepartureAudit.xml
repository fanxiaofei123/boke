<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_DepartureAudit" Caption="离场审核" FormType="View">
    <DataSource>
        <DataObject Key="LRP_PlatformReservation" Caption="月台预约">
            <TableCollection>
                <Table Key="LRP_PlatformReservation" Caption="月台预约" SourceType="Query" TableMode="Detail">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="SOID" Caption="主对象标识" DataType="Long"/>
                    <Column Key="POID" Caption="父对象标识" DataType="Long"/>
                    <Column Key="VERID" Caption="对象版本" DataType="Integer"/>
                    <Column Key="DVERID" Caption="对象明细版本" DataType="Integer"/>
                    <Column Key="Status" Caption="状态" DataType="Integer"/>
                    <Column Key="CREATOR" Caption="创建人" DataType="Long"/>
                    <Column Key="CREATETIME" Caption="创建时间" DataType="DateTime"/>
                    <Column Key="MODIFIER" Caption="修改人" DataType="Long"/>
                    <Column Key="MODIFYTIME" Caption="修改时间" DataType="DateTime"/>
                    <Column Key="No" Caption="预约单号" DataType="Varchar"/>
                    <Column Key="ReservationType" Caption="预约类型" DataType="Integer"/>
                    <Column Key="RefOID" Caption="相关单据OID" DataType="Long"/>
                    <Column Key="RefNo" Caption="相关单据号" DataType="Varchar"/>
                    <Column Key="PlatformId" Caption="月台ID" DataType="Long"/>
                    <Column Key="CarrierId" Caption="承运商ID" DataType="Long"/>
                    <Column Key="Driver" Caption="司机" DataType="Varchar"/>
                    <Column Key="CertificateNo" Caption="证件号" DataType="Varchar"/>
                    <Column Key="DriverMobile" Caption="手机号" DataType="Varchar"/>
                    <Column Key="TruckLicenseNo" Caption="车牌号" DataType="Varchar"/>
                    <Column Key="ReservationDate" Caption="预约日期" DataType="Date"/>
                    <Column Key="StartTime" Caption="开始时间" DataType="DateTime"/>
                    <Column Key="EndTime" Caption="结束时间" DataType="DateTime"/>
                    <Column Key="EnterTime" Caption="入场时间" DataType="DateTime"/>
                    <Column Key="ExitTime" Caption="离场时间" DataType="DateTime"/>
					<!--oracle
						 SELECT
OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime,MapCount ,rownum rn
  FROM LRP_PlatformReservation 
  WHERE Status = 400  and rownum = 1
					-->
                    <Statement>
                        <![CDATA[  SELECT
OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime,MapCount
  FROM LRP_PlatformReservation 
  WHERE Status = 400 limit 1
]]>
                    </Statement>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Key="Departure" Description="入场审核，修改字段(已入场,进场时间)">
            <Statement DBType="MySql">
                <![CDATA[update LRP_PlatformReservation set status = 900,ExitTime = NOW() where OID = ?]]>
            </Statement>
            <Statement DBType="Oracle">
                <![CDATA[update LRP_PlatformReservation set status = 900,ExitTime = sysdate where OID = ?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
        <Query Key="queryKey1" Description="通过证件号，车牌号查询">
            <Statement DBType="MySql">
                <![CDATA[SELECT   OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime   FROM LRP_PlatformReservation   WHERE Status = 400   and ReservationDate = ?    and WarehouseCenterId =?  and CertificateNo = ? and TruckLicenseNo = ? order by StartTime limit 1]]>
            </Statement>
            <Statement DBType="Oracle">
                <![CDATA[SELECT   OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime,rownum rn   FROM LRP_PlatformReservation   WHERE Status = 400   and ReservationDate = ?    and WarehouseCenterId =?  and CertificateNo = ? and TruckLicenseNo = ? and rownum=1  order by StartTime ]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Date"/>
                <Parameter DataType="Long"/>
                <Parameter DataType="Varchar"/>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="queryKey2" Description="通过证件号查询">
            <Statement DBType="MySql">
                <![CDATA[SELECT   OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime   FROM LRP_PlatformReservation   WHERE Status = 400   and ReservationDate = ?    and WarehouseCenterId =?  and CertificateNo = ? order by StartTime limit 1]]>
            </Statement>
            <Statement DBType="Oracle">
                <![CDATA[SELECT   OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime,rownum rn   FROM LRP_PlatformReservation   WHERE Status = 400   and ReservationDate = ?    and WarehouseCenterId =?  and CertificateNo = ? and rownum = 1 order by StartTime ]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Date"/>
                <Parameter DataType="Long"/>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
        <Query Key="queryKey3" Description="通过车牌号查询">
            <Statement DBType="MySql">
                <![CDATA[SELECT OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime   FROM LRP_PlatformReservation   WHERE Status = 400   and ReservationDate = ?    and WarehouseCenterId =?  and TruckLicenseNo = ?  order by StartTime limit 1]]>
            </Statement>
            <Statement DBType="Oracle">
                <![CDATA[SELECT OID,SOID,POID,VERID,DVERID,Status,CREATOR,CREATETIME,MODIFIER,MODIFYTIME,No,ReservationType,RefOID,RefNo,PlatformId,CarrierId,Driver,CertificateNo,DriverMobile,TruckLicenseNo,ReservationDate,StartTime,EndTime,EnterTime,ExitTime,rownum rn   FROM LRP_PlatformReservation   WHERE Status = 400   and ReservationDate = ?    and WarehouseCenterId =?  and TruckLicenseNo = ? and rownum = 1 order by StartTime ]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Date"/>
                <Parameter DataType="Long"/>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <GridLayoutPanel Height="100%" Key="main" Padding="0px">
                <ToolBar Key="main_toolbar" X="0" Y="0">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="base_split" Orientation="Vertical" X="0" Y="1">
                    <GridLayoutPanel Key="first_head" Padding="5px" Height="pref" Caption="基本信息">
                        <TextEditor Key="q_CertificateNo" Caption="证件号" BuddyKey="Lab_q_CertificateNo" X="1" Y="0" XSpan="3">
                            <Condition ColumnKey="CertificateNo" TableKey="LRP_PlatformReservation" CondSign="="/>
                        </TextEditor>
                        <Label Key="Lab_q_CertificateNo" Caption="证件号" X="0" Y="0"/>
                        <TextEditor Key="q_TruckLicenseNo" Caption="车牌号" BuddyKey="Lab_q_TruckLicenseNo" X="6" Y="0" XSpan="3">
                            <Condition ColumnKey="TruckLicenseNo" TableKey="LRP_PlatformReservation" CondSign="="/>
                        </TextEditor>
                        <Label Key="Lab_q_TruckLicenseNo" Caption="车牌号" X="5" Y="0"/>
                        <Button Key="Button1" Caption="查询" X="10" Y="0">
                            <OnClick>
                                <![CDATA[
if(GetValue('q_CertificateNo')=="" && GetValue('q_TruckLicenseNo')==""){
    Confirm(LocaleString('PRshow','prkey5'));
    return true;
}
SetSessionPara("tip2","1");
LoadData();
ShowData();
]]>
                            </OnClick>
                        </Button>
                        <Button Key="Button2" Caption="重置" X="10" Y="1">
                            <OnClick>
                                <![CDATA[ResetCondition();
ClearAllRows('ListView0');
]]>
                            </OnClick>
                        </Button>
                        <Button Key="Button3" Caption="离场" X="10" Y="2">
                            <OnClick>
                                <![CDATA[
if(GetRowCount('ListView0')>0)
{

    loop "ListView0" (true)
    {	
         var flag = DBNamedUpdate("Departure",OID);
         Status = 900;
         EnterTime = ServerDate();
         Confirm(LocaleString('PRshow','prkey13'),'OK','OK:{}');						
         ResetCondition();
         ClearAllRows('ListView0');			
    }

}else{
    Confirm(LocaleString('PRshow','prkey14'));
}

				]]>
                            </OnClick>
                        </Button>
                        <RowDefCollection RowGap="8">
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                            <RowDef Height="30px"/>
                        </RowDefCollection>
                        <ColumnDefCollection ColumnGap="8">
                            <ColumnDef Width="77px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="55px"/>
                            <ColumnDef Width="25%"/>
                            <ColumnDef Width="30px"/>
                            <ColumnDef Width="80px"/>
                        </ColumnDefCollection>
                    </GridLayoutPanel>
                    <ListView Caption="ListView0" Key="ListView0" PageRowCount="1" TableKey="LRP_PlatformReservation">
                        <ListViewColumnCollection>
                            <ListViewColumn Key="OID" Caption="对象标识" DataColumnKey="OID" Visible="false"/>
                            <ListViewColumn Key="Status" Caption="状态" ColumnType="ComboBox" DataColumnKey="Status" SourceType="Status"/>
                            <ListViewColumn Key="ReservationType" Caption="预约类型" ColumnType="ComboBox" DataColumnKey="ReservationType">
                                <Item Caption="入库收货" Key="1" Value="1"/>
                                <Item Caption="退货收货" Key="2" Value="2"/>
                                <Item Caption="出库发货" Key="3" Value="3"/>
                                <Item Caption="退厂发货" Key="4" Value="4"/>
                                <Item Caption="运输发货" Key="5" Value="5"/>
                                <Item Caption="运输到货" Key="6" Value="6"/>
                                <Item Caption="其它" Key="99" Value="99"/>
                            </ListViewColumn>
                            <ListViewColumn Key="PlatformId" Caption="月台" ColumnType="Dict" DataColumnKey="PlatformId" ItemKey="LRP_Platform"/>
                            <ListViewColumn Key="StartTime" Caption="开始时间" ColumnType="DatePicker" DataColumnKey="StartTime" Width="130px"/>
                            <ListViewColumn Key="EndTime" Caption="结束时间" ColumnType="DatePicker" DataColumnKey="EndTime" Width="130px"/>
                            <ListViewColumn Key="CarrierId" Caption="承运商" ColumnType="Dict" DataColumnKey="CarrierId" Width="100px" ItemKey="LRP_Carrier"/>
                            <ListViewColumn Key="Driver" Caption="司机" DataColumnKey="Driver"/>
                            <ListViewColumn Key="CertificateNo" Caption="证件号" DataColumnKey="CertificateNo" Width="150px"/>
                            <ListViewColumn Key="TruckLicenseNo" Caption="车牌号" DataColumnKey="TruckLicenseNo" Width="100px"/>
                            <ListViewColumn Key="DriverMobile" Caption="手机号" DataColumnKey="DriverMobile"/>
                            <ListViewColumn Key="EnterTime" Caption="入场时间" ColumnType="DatePicker" DataColumnKey="EnterTime" Width="130px"/>
                            <ListViewColumn Key="ExitTime" Caption="离场时间" ColumnType="DatePicker" DataColumnKey="ExitTime" Width="130px"/>
                        </ListViewColumnCollection>
                    </ListView>
                    <SplitSize Size="150px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
                <RowDefCollection RowHeight="25">
                    <RowDef Height="30px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection>
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
    <OnLoad>
        <![CDATA[
]]>
    </OnLoad>
    <OnClose>
        <![CDATA[SetSessionPara("tip2")=="0"]]>
    </OnClose>
    <OnPostShow>
        <![CDATA[if(GetSessionPara("tip2")=="1"){
    
var table = "";

if(GetValue('q_CertificateNo')<>""&&GetValue('q_TruckLicenseNo')<>""){
    table = DBNamedQuery("queryKey1",Format(ServerDBDate(),'yyyy-MM-dd'),getCurOrgID(),q_CertificateNo,q_TruckLicenseNo);
}
if(GetValue('q_CertificateNo')<>""&&GetValue('q_TruckLicenseNo')==""){
    table = DBNamedQuery("queryKey2",Format(ServerDBDate(),'yyyy-MM-dd'),getCurOrgID(),q_CertificateNo);
}
if(GetValue('q_CertificateNo')==""&&GetValue('q_TruckLicenseNo')<>""){  
    table = DBNamedQuery("queryKey3",Format(ServerDBDate(),'yyyy-MM-dd'),getCurOrgID(),q_TruckLicenseNo);
}

    
var tempOID = 0;
    table.beforefirst();
    while(table.next()){
        if(tempOID==0){
        loop "ListView0" (true){
            OID = table.OID;
            Status = table.Status;
            ReservationType=table.ReservationType;
            PlatformId = table.PlatformId;
            StartTime = table.StartTime;
            EndTime = table.EndTime;
            CarrierId = table.CarrierId;
            Driver = table.Driver;
            CertificateNo = table.CertificateNo;
            TruckLicenseNo = table.TruckLicenseNo;
            DriverMobile = table.DriverMobile;
            EnterTime = table.EnterTime;
            ExitTime = table.ExitTime;

            tempOID=table.OID;
        }
        }	
    }      

if(tempOID==0){
    ClearAllRows("ListView0");
}
    var count = GetRowCount('ListView0');
    if(count==0){
        Confirm(LocaleString('PRshow','prkey10'));
        return true;
    }
}
   

   

]]>
    </OnPostShow>
    <NavigationBar Style="Custom"/>
</Form>
