<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_C_ExpenseLine_LRP" Caption="费用计算" InitState="Default">
    <DataSource>
        <DataObject Key="V_C_ExpenseLine_LRP" Caption="费用明细" PrimaryType="Entity">
            <TableCollection>
                <Table Key="LRP_ExpenseLine" Caption="费用明细" DBTableName="LRP_ExpenseLine" TableMode="Detail">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="SOID" Caption="主对象标识" DataType="Long"/>
                    <Column Key="POID" Caption="父对象标识" DataType="Long"/>
                    <Column Key="VERID" Caption="对象版本" DataType="Integer"/>
                    <Column Key="DVERID" Caption="对象明细版本" DataType="Integer"/>
                    <Column Key="DispatchOrgId" Caption="调度组织" DataType="Long"/>
                    <Column Key="WarehouseCenterId" Caption="仓储中心" DataType="Long"/>
                    <Column Key="ComputeNo" Caption="计算号" DataType="Varchar" Length="40"/>
                    <Column Key="CarrierId" Caption="承运商" DataType="Long"/>
                    <Column Key="SettlementId" Caption="结算方" DataType="Long"/>
                    <Column Key="ExpenseId" Caption="费用名称" DataType="Long"/>
                    <Column Key="BizDate" Caption="业务日期" DataType="Date"/>
                    <Column Key="BizQty" Caption="业务量" DataType="Numeric" Precision="15" Scale="3"/>
                    <Column Key="CalculationAmount" Caption="计算金额" DataType="Numeric" Precision="15" Scale="3"/>
                    <Column Key="AdjustAmount" Caption="调整后金额" DataType="Numeric" Precision="15" Scale="3"/>
                    <Column Key="GenMethod" Caption="生成方式" DataType="Integer"/>
                    <Column Key="BillOID" Caption="单据ID" DataType="Long"/>
                    <Column Key="BillNo" Caption="单据号" DataType="Varchar" Length="100"/>
                    <Column Key="ExpenseContractTermId" Caption="条款ID" DataType="Long"/>
                    <Column Key="ExpenseContractTermName" Caption="条款名称" DataType="Varchar" Length="100"/>
                    <Column Key="TermLineId" Caption="条款明细ID" DataType="Long"/>
                    <Column Key="TermLineName" Caption="条款明细名称" DataType="Varchar" Length="100"/>
                    <Column Key="ExpenseContractId" Caption="合约ID" DataType="Long"/>
                    <Column Key="ExpenseContractName" Caption="合约名称" DataType="Varchar" Length="100"/>
                    <Column Key="SourceType" Caption="来源类型" DataType="Varchar" Length="10"/>
                    <Column Key="Status" Caption="状态" DataType="Integer" DefaultValue="100"/>
                    <TableFilter>
                        <![CDATA[DispatchOrgId = ? and BillOID=?]]>
                    </TableFilter>
                    <ParameterCollection>
                        <Parameter Formula="GetPara('dispatchorgOIDs_para');"/>
                        <Parameter Formula="GetPara('oid_para');"/>
                    </ParameterCollection>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <OperationCollection>
        <Operation Key="Edit" Caption="编辑" Visible="ReadOnly()" ShortCuts="Ctrl+E">
            <Action>
                <![CDATA[Edit()]]>
            </Action>
        </Operation>
		<Operation Key="Save" Caption="保存" Visible="!ReadOnly()" ShortCuts="Ctrl+S">
            <Action>
                <![CDATA[SaveData(); UpdateView();]]>
            </Action>
        </Operation>
        <Operation Key="Charge" Caption="计算" ShortCuts="Ctrl+S">
            <Action>
                <![CDATA[
	InvokeService('LRP_T_CalculateExpense',false,false,GetPara('No_para'),0,0,0,0,GetPara('pDateField'));
	LoadData();ShowData()
			]]>
            </Action>
        </Operation>
        <Operation Key="Cancel" Caption="取消" Visible="!ReadOnly()">
            <Action>
                <![CDATA[Cancel();	]]>
            </Action>
        </Operation>
        <Operation Key="BatchConfirm" Caption="确认" Visible="ReadOnly()">
            <Action>
                <![CDATA[
					var noselect = true;
					var i=0;
					var count = GetRowCount("Grid1",false); 
					while (i < count){		
						if(GetCellValue("Grid1", i, "Select") == true){ 	
						noselect = false;
							
							if (Status > 100){
								Confirm(LocaleString('CHshow','chkey41'));
								return 0;
							}			
						}	
						i=i+1;				
					}
					if (noselect) {
						Confirm(LocaleString('CHshow','chkey42'));
						return 0;
					}

					Confirm(LocaleString('CommonDef','key19'),'YES_NO',{YES:{
						loop "Grid1" (true){
							if(Select == true){ 
						  Status = 200;
							  Select = false;
						}					
						}
						SaveData(); 
						UpdateView();
					},NO:{}});
					]]>
            </Action>
        </Operation>
        <Operation Key="BatchConfirm-R" Caption="撤销确认" Visible="ReadOnly()">
            <Action>
                <![CDATA[
					var noselect = true;
					var i=0;
					var count = GetRowCount("Grid1",false); 
					while (i < count){		
						if(GetCellValue("Grid1", i, "Select") == true){ 	
						noselect = false;
							
							if (Status != 200){
								Confirm(LocaleString('CHshow','chkey43'));
								return 0;
							}			
						}	
						i=i+1;				
					}
					if (noselect) {
						Confirm(LocaleString('CHshow','chkey9'));
						return 0;
					}

					Confirm(LocaleString('CommonDef','key22'),'YES_NO',{YES:{
						loop "Grid1" (true){
							if(Select == true){ 
						  Status = 100;
							  Select = false;
						}					
						}
						SaveData(); 
						UpdateView();
					},NO:{}});]]>
            </Action>
        </Operation>
        <Operation Key="BatchDelete" Caption="删除">
            <Action>
                <![CDATA[
					//由于该数据对象只有明细，因此不能用batchdeletedata
					var noselect = true;
					var i=0;
					var count = GetRowCount("Grid1"); 
					while (i < count){		
						if(GetCellValue("Grid1", i, "Select") == true){ 	
						noselect = false;
							//若选择了状态大于100的明细则不允许删除
							if (Status > 100){
								Confirm(LocaleString('CHshow','chkey44'));
								return 0;
							}			
						}	
						i=i+1;				
					}
					if (noselect) {
						Confirm(LocaleString('CHshow','chkey11'));
						return 0;
					}
					//编辑状态和非编辑状态有两种删除方式
					if (ReadOnly()){
						//非编辑状态下，因为会直接删除，所以要进行判断
						Confirm(LocaleString('OwnerNull','key102'),'YES_NO',{YES:{
							var i=0;
							var count = GetRowCount("Grid1"); 
							while ( i < count ) {
								if(GetCellValue("Grid1", i, "Select") == true){ 
									DeleteRow("Grid1",i); 
									i=i-1; 
								count=count-1; 
								}
								i=i+1;
							}  
							//如果是非编辑情况下，直接保存
							SaveData(); 
							UpdateView();
						},NO:{return 0;}});

					}else {
						
						i=0;
						while ( i < count - 1 ) {
							if(GetCellValue("Grid1", i, "Select") == true){ 
								DeleteRow("Grid1",i); 
								i=i-1; 
							count=count-1; 
							}
							i=i+1;
						}    
					}
					]]>
            </Action>
        </Operation>
        <Operation Key="Close" Caption="关闭界面" RefKey="Close"/>
    </OperationCollection>
    <QueryCollection>
        <Query Key="queryKey1" Description="查询仓储中心">
            <Statement>
                <![CDATA[select  oid ,name from LRP_WarehouseCenter where OID=? ]]>
            </Statement>
        </Query>
        <Query Key="queryKey2" Description="查询调度组织">
            <Statement>
                <![CDATA[select  oid ,name from LRP_DispatchOrg where OID=? ]]>
            </Statement>
        </Query>
    </QueryCollection>
    <Body PopHeight="80%" PopWidth="80%">
        <Block>
            <GridLayoutPanel Key="GridLayoutPanel1" Caption="GridLayoutPanel1">
				<ToolBar Key="ToolBar1" Caption="ToolBar1" X="0" Y="0">
                    <ToolBarItemCollection/>
                </ToolBar>
                <TabPanel Caption="TabPanel1" Height="pref" Key="TabPanel1" X="0" Y="1">
                    <Grid Key="Grid1" Caption="费用明细" CanDelete="false" CanShift="false" Height="pref" PageLoadType="UI">
                        <GridColumnCollection>
                            <GridColumn Key="Select" Caption="选择" Width="55px"/>
                            <GridColumn Key="Status" Caption="状态" Width="55px" Sortable="true"/>
                            <GridColumn Key="WarehouseCenterId" Caption="仓储中心" Width="80px"/>
                            <GridColumn Key="DispatchOrgId" Caption="调度组织" Width="80px" Sortable="true"/>
                            <GridColumn Key="CarrierId" Caption="承运商" Width="80px" Sortable="true"/>
                            <GridColumn Key="SettlementId" Caption="结算方" Width="80px" Sortable="true"/>
                            <GridColumn Key="ExpenseId" Caption="费用名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="BizDate" Caption="业务日期" Width="80px" Sortable="true"/>
                            <GridColumn Key="BizQty" Caption="业务量" Width="59px" Sortable="true"/>
                            <GridColumn Key="CalculationAmount" Caption="计算金额" Width="65px" Sortable="true"/>
                            <GridColumn Key="AdjustAmount" Caption="调整后金额" Width="72px" Sortable="true"/>
                            <GridColumn Key="GenMethod" Caption="生成方式" Width="63px" Sortable="true"/>
                            <GridColumn Key="SourceType" Caption="来源类型" Visible="false" Width="67px"/>
                            <GridColumn Key="BillNo" Caption="单号" Width="131px" Sortable="true"/>
                            <GridColumn Key="BillOID" Caption="单据ID" Visible="false" Width="80px"/>
                            <GridColumn Key="ComputeNo" Caption="计算号" Width="95px" Visible="false" Sortable="true"/>
                            <GridColumn Key="ExpenseContractTermId" Caption="条款ID" Visible="false" Width="80px"/>
                            <GridColumn Key="ExpenseContractTermName" Caption="条款名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="TermLineId" Caption="条款明细ID" Visible="false" Width="80px"/>
                            <GridColumn Key="TermLineName" Caption="条款明细名称" Width="80px" Visible="false" Sortable="true"/>
                            <GridColumn Key="ExpenseContractId" Caption="合约ID" Visible="false" Width="80px"/>
                            <GridColumn Key="ExpenseContractName" Caption="合约名称" Width="80px" Sortable="true"/>
                            <GridColumn Key="OID" Caption="OID" Visible="false" Width="80px"/>
                        </GridColumnCollection>
                        <GridRowCollection>
                            <GridRow Key="row1" RowHeight="35" TableKey="LRP_ExpenseLine">
                                <GridCell Key="Select" Caption="选择" CellType="CheckBox" Enable="true" IsSelect="true"/>
                                <GridCell Key="Status" Caption="状态" CellType="ComboBox" Enable="false">
                                    <DataBinding ColumnKey="Status" DefaultValue="100"/>
                                    <Item Caption="已输入" Key="100" Value="100"/>
                                    <Item Caption="已确认" Key="200" Value="200"/>
                                    <Item Caption="已对账" Key="960" Value="960"/>
                                </GridCell>
                                <GridCell Key="WarehouseCenterId" Caption="仓储中心" CellType="ComboBox" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" SourceType="Formula">
                                    <DataBinding ColumnKey="WarehouseCenterId" CheckRule="WarehouseCenterId != '' || DispatchOrgId != ''" DefaultFormulaValue="getCurOrgID()" ErrorInfo="仓储中心和调度组织不可全为空"/>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery('queryKey1',getCurOrgID());]]>
                                    </FormulaItems>
                                </GridCell>
                                <GridCell Key="DispatchOrgId" Caption="调度组织" CellType="ComboBox" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" SourceType="Formula">
                                    <DataBinding ColumnKey="DispatchOrgId" DefaultFormulaValue="getCurDispatchOrgID()"/>
                                    <FormulaItems>
                                        <![CDATA[DBNamedQuery('queryKey2',getCurDispatchOrgID());]]>
                                    </FormulaItems>
                                </GridCell>
                                <GridCell Key="CarrierId" Caption="承运商" CellType="Dict" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" ItemKey="LRP_Carrier">
                                    <DataBinding ColumnKey="CarrierId" CheckRule="CarrierId &gt; 0 || SettlementId &gt; 0" ErrorInfo="承运商和结算方不可全为空" Required="true"/>
                                </GridCell>
                                <GridCell Key="SettlementId" Caption="结算方" CellType="Dict" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true)" ItemKey="Vendor">
                                    <DataBinding ColumnKey="SettlementId" DefaultFormulaValue="ToLong(GetDictValue('LRP_Carrier',CarrierId,'VendorId'));" Required="true"/>
                                </GridCell>
                                <GridCell Key="ExpenseId" Caption="费用名称" CellType="Dict" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" ItemKey="LRP_Expense">
                                    <DataBinding ColumnKey="ExpenseId" Required="true"/>
                                </GridCell>
                                <GridCell Key="BizDate" Caption="业务日期" CellType="DatePicker" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" Format="yyyy-MM-dd">
                                    <DataBinding ColumnKey="BizDate" Required="true"/>
                                </GridCell>
                                <GridCell Key="BizQty" Caption="业务量" CellType="NumberEditor" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" ShowZero="true">
                                    <DataBinding ColumnKey="BizQty" DefaultValue="0"/>
                                </GridCell>
                                <GridCell Key="CalculationAmount" Caption="计算金额" CellType="NumberEditor" Enable="false" ShowZero="true">
                                    <DataBinding ColumnKey="CalculationAmount" DefaultValue="0"/>
                                </GridCell>
                                <GridCell Key="AdjustAmount" Caption="调整后金额" CellType="NumberEditor" Enable="IIF(ReadOnly() || Status &gt; 100, false, true);" ShowZero="true">
                                    <DataBinding ColumnKey="AdjustAmount" DefaultValue="0"/>
                                </GridCell>
                                <GridCell Key="GenMethod" Caption="生成方式" CellType="ComboBox" Enable="false">
                                    <DataBinding ColumnKey="GenMethod" DefaultValue="2"/>
                                    <Item Caption="系统生成" Key="1" Value="1"/>
                                    <Item Caption="手工输入" Key="2" Value="2"/>
                                </GridCell>
                                <GridCell Key="SourceType" Caption="来源类型" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="SourceType" DefaultValue="O"/>
                                </GridCell>
                                <GridCell Key="BillNo" Caption="单号" CellType="TextEditor" Enable="IIF(ReadOnly() || GenMethod == 1 || Status &gt; 100, false, true);" MaxLength="40" Trim="true">
                                    <DataBinding ColumnKey="BillNo" Required="true"/>
                                </GridCell>
                                <GridCell Key="BillOID" Caption="单据ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="BillOID"/>
                                </GridCell>
                                <GridCell Key="ComputeNo" Caption="计算号" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="ComputeNo"/>
                                </GridCell>
                                <GridCell Key="ExpenseContractTermId" Caption="条款ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="ExpenseContractTermId"/>
                                </GridCell>
                                <GridCell Key="ExpenseContractTermName" Caption="条款名称" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="ExpenseContractTermName"/>
                                </GridCell>
                                <GridCell Key="TermLineId" Caption="条款明细ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="TermLineId"/>
                                </GridCell>
                                <GridCell Key="TermLineName" Caption="条款明细名称" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="TermLineName"/>
                                </GridCell>
                                <GridCell Key="ExpenseContractId" Caption="合约ID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="ExpenseContractId"/>
                                </GridCell>
                                <GridCell Key="ExpenseContractName" Caption="合约名称" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="ExpenseContractName"/>
                                </GridCell>
                                <GridCell Key="OID" Caption="OID" CellType="TextEditor" Enable="false">
                                    <DataBinding ColumnKey="OID"/>
                                </GridCell>
                            </GridRow>
                        </GridRowCollection>
                    </Grid>
                </TabPanel>
                <RowDefCollection RowGap="5">
                    <RowDef Height="40px"/>
                    <RowDef Height="100%"/>
                </RowDefCollection>
                <ColumnDefCollection ColumnGap="5">
                    <ColumnDef Width="100%"/>
                </ColumnDefCollection>
            </GridLayoutPanel>
        </Block>
    </Body>
</Form>
