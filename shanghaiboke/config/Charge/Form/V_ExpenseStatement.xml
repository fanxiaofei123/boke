<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Caption="费用对账单" FormType="Entity" Key="V_ExpenseStatement">
    <DataSource RefObjectKey="LRP_ExpenseStatement"/>
    <OperationCollection>
        <Operation Caption="新增" Key="New" Visible="ReadOnly()">
            <Action>
                <![CDATA[
				New('V_ExpenseStatement');
			]]>
            </Action>
        </Operation>
        <Operation Caption="复制新增" Key="CopyNew" RefKey="CopyNew" ShortCuts="Ctrl+E"/>
        <Operation Caption="保存" Key="Save" ShortCuts="Ctrl+S" Visible="!ReadOnly()&amp;&amp;Status==100">
            <Action>
                <![CDATA[
					if(CarrierId<=0 && SettlementId<=0){		
						Confirm(LocaleString('CHshow','chkey32'),'OK','OK:{}');
						return true;
					}
					if(GetRowCount('Grid0',false)<=0){
						Confirm(LocaleString('CommonDef','key1'),'OK','OK:{}');	
						return true;
					}
					//累加总金额
					var Amount = 0.0;
					loop"Grid0"(true){
						Amount = Amount + AdjustAmount;							
					}
					SetValue("TotalAmount",Amount);
					SaveData();
					UpdateView();
				]]>
            </Action>
        </Operation>
        <Operation Caption="编辑" Key="Edit" RefKey="Edit" ShortCuts="Ctrl+E"/>
        <Operation Caption="删除" Key="Delete" ShortCuts="Ctrl+D" Visible="ReadOnly()&amp;&amp;Status==StatusValue('prepared')">
            <Action>
                <![CDATA[
					var msg = InvokeService("LRP_ExpenseStatementDelete", true, false);
					UpdateView();Close();
				]]>
            </Action>
        </Operation>
        <Operation Caption="取消" Key="Cancel" RefKey="Cancel"/>
        <Operation Caption="确认" Key="Confirm" RefKey="Confirm"/>
        <Operation Caption="撤销确认" Key="Confirm-R" RefKey="Confirm-R"/>
        <Operation Caption="完成" Key="Finish" Visible="ReadOnly()&amp;&amp;Status==StatusValue('confirmed')">
            <Action>
                <![CDATA[				Confirm(LocaleString('CommonDef','key3'),'YES_NO',{YES:{FinishDate=ServerDate();Status=StatusValue('finished');SaveData();UpdateView();},NO:{}});
				]]>
            </Action>
            <ExceptionHandler>
                <![CDATA[				
				Status=StatusValue('confirmed');
				FinishDate = "";
			]]>
            </ExceptionHandler>
        </Operation>
        <Operation Caption="撤销完成" Key="Finish-R" Visible="ReadOnly()&amp;&amp;Status==StatusValue('finished')">
            <Action>
                <![CDATA[      var dt = DBNamedQuery('queryPayment', OID);
    if(dt.count > 0){
        Confirm(LocaleString('CHshow','chkey33'), 'OK',{OK:{}}); 
        return 0;
    }
				Confirm(LocaleString('CommonDef','key4'),'YES_NO',{YES:{FinishDate="";Status=StatusValue('confirmed');SaveData();UpdateView();},NO:{}});
				]]>
            </Action>
            <ExceptionHandler>
                <![CDATA[				
				Status=StatusValue('finished');
			]]>
            </ExceptionHandler>
        </Operation>
        <Operation Caption="添加收费明细" Enable="!ReadOnly()&amp;&amp;Status==100" Key="QuoteQuant">
            <Action>
                <![CDATA[                    
			            if(CarrierId>0 || SettlementId>0){
							ShowModal('V_QuoteExpenseLineView',{SettlementId_para:{SettlementId},
							CarrierId_para:{CarrierId}});
						}else{
                            Confirm(LocaleString('CHshow','chkey34'), 'OK',{OK:{}});
                        }]]>
            </Action>
        </Operation>
        <Operation Caption="关闭界面" Key="Close" RefKey="Close"/>
    </OperationCollection>
    <QueryCollection>
        <Query Description="读取费用明细引用" Key="GetExpenseStatement">
            <Statement>
                <![CDATA[
				
		select o.* from LRP_ExpenseLine o join LRP_ExpenseStatement_L l on o.oid =l.ExpenseLineId where l.soid=?
				
			]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
        <Query Key="queryPayment" Description="查询该单是否被付款单引用">
            <Statement>
                <![CDATA[select  count(*) as count from LRP_ExpenseStm_L_Show  where  SrcSOID = ?]]>
            </Statement>
        </Query>
    </QueryCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="main">
                <ToolBar Height="pref" Key="main_toolbar">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Height="100%" Key="main_split" Orientation="Vertical">
                    <TabPanel Caption="TabPanel0" Key="TabPanel0">
                        <GridLayoutPanel Caption="基本信息" Key="BasicTab" Padding="10px">
                            <TextEditor BuddyKey="Lab_OID" Caption="OID" Enable="false" Key="OID" Visible="false" X="1" Y="4">
                                <DataBinding ColumnKey="OID" TableKey="LRP_ExpenseStatement_H"/>
                            </TextEditor>
                            <Label Caption="OID" Key="Lab_OID" X="0" Y="4"/>
                            <TextEditor Caption="对账单号" Enable="false" Key="No" X="1" XSpan="2" Y="0">
                                <DataBinding ColumnKey="No" TableKey="LRP_ExpenseStatement_H"/>
                            </TextEditor>
                            <Label Caption="对账单号" Key="L_No" X="0" Y="0"/>
                            <TextEditor Caption="账单名称" Key="StatementName" Enable="!ReadOnly()" X="5" XSpan="2" Y="0">
                                <DataBinding ColumnKey="StatementName" TableKey="LRP_ExpenseStatement_H" Required="true"/>
                            </TextEditor>
                            <Label Caption="账单名称" Key="L_StatementName" X="4" Y="0"/>
                            <Dict Caption="公司代码" ItemKey="CompanyCode" Enable="!ReadOnly()" Key="CompanyCodeId" X="9" XSpan="2" Y="0">
                                <DataBinding ColumnKey="CompanyCodeId" TableKey="LRP_ExpenseStatement_H" Required="true"/>
                            </Dict>
                            <Label Caption="公司代码" Key="L_CompanyCodeId" X="8" Y="0"/>
                            <Dict Caption="承运商" ItemKey="LRP_Carrier" Key="CarrierId" X="1" XSpan="2" Y="1">
                                <DataBinding ColumnKey="CarrierId" TableKey="LRP_ExpenseStatement_H">
                                    <ValueChanging>
                                        <![CDATA[
											Confirm(LocaleString('CHshow','chkey35'),'YES_NO',
												{YES:{
													CommitValue('CarrierId');
													ClearAllRows('Grid0');
													},
												NO:{RollbackValue('CarrierId');}});
									  ]]>
                                    </ValueChanging>
                                    <ValueValidation>
                                        <![CDATA[GetRowCount('Grid0')<=1]]>
                                    </ValueValidation>
                                </DataBinding>
                            </Dict>
                            <Label Caption="承运商" Key="L_CarrierId" X="0" Y="1"/>
                            <Dict Caption="结算方" ItemKey="Vendor" Key="SettlementId" X="5" XSpan="2" Y="1">
                                <DataBinding ColumnKey="SettlementId" DefaultFormulaValue="GetDictValue('LRP_Carrier',CarrierId,'VendorId')" TableKey="LRP_ExpenseStatement_H">
                                    <ValueChanging>
                                        <![CDATA[
											Confirm(LocaleString('CHshow','chkey36'),'YES_NO',
												{YES:{
													CommitValue('SettlementId');
													ClearAllRows('Grid0');
													SetValue("CarrierId",-1,false); 
													},
												NO:{RollbackValue('SettlementId');}});
									  ]]>
                                    </ValueChanging>
                                    <ValueValidation>
                                        <![CDATA[GetRowCount('Grid0')<=1 && ToLong(CarrierId)<=0]]>
                                    </ValueValidation>
                                </DataBinding>
                            </Dict>
                            <Label Caption="结算方" Key="L_SettlementId" X="4" Y="1"/>
                            <NumberEditor BuddyKey="Lab_TotalAmount" Caption="总金额" Enable="false" Key="TotalAmount" X="9" XSpan="2" Y="1">
                                <DataBinding ColumnKey="TotalAmount" TableKey="LRP_ExpenseStatement_H"/>
                            </NumberEditor>
                            <Label Caption="总金额" Key="Lab_TotalAmount" X="8" Y="1"/>
                            <DatePicker Caption="账单日期" Enable="!ReadOnly()" Key="OrderDate" X="1" XSpan="2" Y="2" OnlyDate="true">
                                <DataBinding ColumnKey="OrderDate" TableKey="LRP_ExpenseStatement_H" Required="true"/>
                            </DatePicker>
                            <Label Caption="账单日期" Key="L_OrderDate" X="0" Y="2"/>
                            <DatePicker Caption="完成日期" Enable="false" Key="FinishDate" OnlyDate="true" X="5" XSpan="2" Y="2">
                                <DataBinding ColumnKey="FinishDate" TableKey="LRP_ExpenseStatement_H"/>
                            </DatePicker>
                            <Label Caption="完成日期" Key="L_FinishDate" X="4" Y="2"/>
                            <ComboBox Caption="状态" Enable="false" Key="Status" SourceType="Status" X="9" XSpan="2" Y="2">
                                <DataBinding ColumnKey="Status" TableKey="LRP_ExpenseStatement_H" DefaultValue="100"/>
                            </ComboBox>
                            <Label Caption="状态" Key="L_Status" X="8" Y="2"/>
                            <TextEditor BuddyKey="Lab_Remark" Caption="备注" Enable="!ReadOnly()" Key="Remark" X="1" XSpan="10" Y="3">
                                <DataBinding ColumnKey="Remark" TableKey="LRP_ExpenseStatement_H"/>
                            </TextEditor>
                            <Label Caption="备注" Key="Lab_Remark" X="0" Y="3"/>
                            <RowDefCollection RowGap="8">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="8">
                                <ColumnDef Width="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="50px" Width="33%"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="80px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="50px" Width="33%"/>
                                <ColumnDef Width="30px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="50px" Width="33%"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <TabPanel Caption="TabPanel1" Key="TabPanel1">
                        <Grid Caption="费用明细" Key="Grid0" CanInsert="false" NewEmptyRow="false">
                            <GridColumnCollection>
                                <GridColumn Caption="费用明细ID" Key="ExpenseLineId" Visible="false" Width="80px" Sortable="true"/>
                                <GridColumn Caption="费用名称" Key="ExpenseId" Width="80px" Sortable="true"/>
                                <GridColumn Caption="调度组织" Key="DispatchOrgId" Width="80px" Sortable="true"/>
                                <GridColumn Caption="承运商" Key="CarrierId_d" Width="80px" Sortable="true"/>
                                <GridColumn Caption="结算方" Key="SettlementId_d" Width="80px" Sortable="true"/>
                                <GridColumn Caption="业务日期" Key="BizDate" Width="80px" Sortable="true"/>
                                <GridColumn Caption="业务量" Key="BizQty" Width="80px" Sortable="true"/>
                                <GridColumn Caption="计算金额" Key="CalculationAmount" Width="80px" Sortable="true"/>
                                <GridColumn Caption="调整后金额" Key="AdjustAmount" Width="80px" Sortable="true"/>
                                <GridColumn Caption="生成方式" Key="GenMethod" Width="80px" Sortable="true"/>
                                <GridColumn Caption="来源类型" Key="SourceType" Width="80px" Sortable="true"/>
                                <GridColumn Caption="单号" Key="BillNo" Width="80px" Sortable="true"/>
                                <GridColumn Caption="条款名称" Key="ExpenseContractTermName" Width="80px" Sortable="true"/>
                                <GridColumn Caption="条款明细名称" Key="TermLineName" Width="80px" Sortable="true"/>
                                <GridColumn Caption="合约名称" Key="ExpenseContractName" Width="80px" Sortable="true"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="R3" TableKey="LRP_ExpenseStatement_L">
                                    <GridCell Caption="费用明细ID" CellType="TextEditor" Enable="false" Key="ExpenseLineId">
                                        <DataBinding ColumnKey="ExpenseLineId" Required="true"/>
                                    </GridCell>
                                    <GridCell Caption="费用名称" CellType="Dict" Enable="false" ItemKey="LRP_Expense" Key="ExpenseId"/>
                                    <GridCell Caption="调度组织" CellType="Dict" Enable="false" ItemKey="LRP_DispatchOrg" Key="DispatchOrgId"/>
                                    <GridCell Caption="承运商" CellType="Dict" Enable="false" ItemKey="LRP_Carrier" Key="CarrierId_d"/>
                                    <GridCell Caption="结算方" CellType="Dict" Enable="false" ItemKey="Vendor" Key="SettlementId_d"/>
                                    <GridCell Caption="业务日期" CellType="DatePicker" OnlyDate="true" Enable="false" Key="BizDate" Format="yyyy-MM-dd"/>
                                    <GridCell Caption="业务量" CellType="NumberEditor" Enable="false" Key="BizQty"/>
                                    <GridCell Caption="计算金额" CellType="NumberEditor" Enable="false" Key="CalculationAmount"/>
                                    <GridCell Caption="调整后金额" CellType="NumberEditor" Enable="!ReadOnly()" Key="AdjustAmount">
                                        <DataBinding ColumnKey="AdjustAmount" DefaultValue="0"/>
                                    </GridCell>
                                    <GridCell Caption="生成方式" CellType="ComboBox" Enable="false" Key="GenMethod">
                                        <Item Caption="系统生成" Key="1" Value="1"/>
                                        <Item Caption=" 手工输入" Key="2" Value="2"/>
                                    </GridCell>
                                    <GridCell Caption="来源类型" CellType="TextEditor" Enable="false" Key="SourceType"/>
                                    <GridCell Caption="单号" CellType="TextEditor" Enable="false" Key="BillNo"/>
                                    <GridCell Caption="条款名称" CellType="TextEditor" Enable="false" Key="ExpenseContractTermName"/>
                                    <GridCell Caption="条款明细名称" CellType="TextEditor" Enable="false" Key="TermLineName"/>
                                    <GridCell Caption="合约名称" CellType="TextEditor" Enable="false" Key="ExpenseContractName"/>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="200px"/>
                    <SplitSize Size="222px"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <OnPostShow>
        <![CDATA[
		if(!IsNew()){
			RefreshExpenseStatement();
		}
	]]>
    </OnPostShow>
    <MacroCollection>
        <Macro Key="RefreshExpenseStatement">
            <![CDATA[
			//读取出库订单引用并填入明细表			
			var rst = DBNamedQuery('GetExpenseStatement',OID);
			
			var i = 0;
			loop"Grid0"(true){
				rst.beforefirst();
				while(rst.next()){
					if(rst.OID == ExpenseLineId){
						SetCellValue('Grid0', i,'ExpenseId',rst.ExpenseId);
						SetCellValue('Grid0', i,'DispatchOrgId',rst.DispatchOrgId);
						SetCellValue('Grid0', i,'CarrierId_d',rst.CarrierId);
						SetCellValue('Grid0', i,'SettlementId_d',rst.SettlementId);
						SetCellValue('Grid0', i,'BizDate',rst.BizDate);
						SetCellValue('Grid0', i,'BizQty',rst.BizQty);
						SetCellValue('Grid0', i,'CalculationAmount',rst.CalculationAmount);
						SetCellValue('Grid0', i,'GenMethod',rst.GenMethod);
						SetCellValue('Grid0', i,'SourceType',rst.SourceType);
						SetCellValue('Grid0', i,'BillNo',rst.BillNo);
						SetCellValue('Grid0', i,'ExpenseContractTermName',rst.ExpenseContractTermName);
						SetCellValue('Grid0', i,'TermLineName',rst.TermLineName);
						SetCellValue('Grid0', i,'ExpenseContractName',rst.ExpenseContractName);
					}				
				}
				i = i+1;
			}
			]]>
        </Macro>
    </MacroCollection>
</Form>
