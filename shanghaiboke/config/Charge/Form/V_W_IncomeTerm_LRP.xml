<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="V_W_IncomeTerm_LRP" Caption="仓储收入条款" FormType="Entity" ViewKey="V_W_IncomeTerm_LRPView">
    <DataSource RefObjectKey="LRP_W_IncomeTerm"/>
    <OperationCollection>
        <Operation Key="New" Caption="新增" Visible="ReadOnly()">
            <Action>
                <![CDATA[New('V_W_IncomeTerm_LRP', 'self');]]>
            </Action>
        </Operation>
        <Operation Key="CopyNew" Caption="复制新增" Visible="ReadOnly()" RefKey="CopyNew" ShortCuts="Ctrl+E"/>
        <Operation Key="Save" Caption="保存" Visible="!ReadOnly()&amp;&amp;Status==100" ShortCuts="Ctrl+S">
            <Action>
                <![CDATA[
                         SaveData(); Parent.LoadData();]]>
            </Action>
        </Operation>
        <Operation Key="Edit" Caption="编辑" Visible="ReadOnly()" RefKey="Edit" ShortCuts="Ctrl+E"/>
        <Operation Key="Cancel" Caption="取消" Visible="!ReadOnly()" RefKey="Cancel"/>
        <Operation Key="Confirm" Caption="确认" Visible="ReadOnly()" RefKey="Confirm"/>
        <Operation Key="Confirm-R" Caption="撤销确认" Visible="ReadOnly();" RefKey="Confirm-R"/>
        <Operation Key="ToCancel" Caption="作废" Visible="ReadOnly()" RefKey="ToCancel"/>
        <Operation Key="ToCancel-R" Caption="撤销作废" Visible="ReadOnly()" RefKey="ToCancel-R"/>
        <Operation Key="Delete" Caption="删除" Visible="ReadOnly()" RefKey="Delete"/>
        <Operation Key="Close" Caption="关闭" Visible="ReadOnly()" RefKey="Close"/>
    </OperationCollection>
    <ScriptCollection>
        <Script Key="Load" Caption="载入" Range="Action" Verb="Load">
            <![CDATA[LoadData();]]>
        </Script>
    </ScriptCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="root" Caption="根面板">
                <ToolBar Key="main_toolbar" Height="pref">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Key="main" Orientation="Vertical" Height="100%" Caption="主面板">
                    <TabPanel Caption="TabPanel1" Key="TabPanel1">
                        <GridLayoutPanel Key="BasicTab" Padding="10px" Caption="基本信息" BottomPadding="5px">
                            <TextEditor Key="No" Caption="条款号" BuddyKey="Lab_No" X="1" Y="0" Enable="false">
                                <DataBinding ColumnKey="No" TableKey="LRP_W_IncomeTerm_H"/>
                            </TextEditor>
                            <Label Key="Lab_No" Caption="条款号" X="0" Y="0"/>
                            <TextEditor Key="Name" Caption="条款名称" BuddyKey="Lab_Name" X="4" Y="0">
                                <DataBinding ColumnKey="Name" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                            </TextEditor>
                            <Label Key="Lab_Name" Caption="条款名称" X="3" Y="0"/>
                            <Dict Key="IncomeId" Caption="收入名称" BuddyKey="Lab_IncomeId" X="7" Y="0" ItemKey="LRP_Income">
                                <DataBinding ColumnKey="IncomeId" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                            </Dict>
                            <Label Key="Lab_IncomeId" Caption="收入名称" X="6" Y="0"/>
                            <ComboBox Key="DataObjectKey" Caption="数据对象" BuddyKey="Lab_DataObjectKey" X="1" Y="1" SourceType="Formula">
                                <DataBinding ColumnKey="DataObjectKey" TableKey="LRP_W_IncomeTerm_H" Required="true">
                                    <ValueChanged>
                                        <![CDATA[                   								        								            
										 WarehouseIdField = '';
										 OwnerIdField = '';
										 NoField = '';
									     OrderDateField = '';
									     QtyField = '';	                 
				              ]]>
                                    </ValueChanged>
                                    <ValueChanging>
                                        <![CDATA[                   
								 Confirm(LocaleString('CHshow','chkey18'),'YES_NO',        
								 {YES: {             
								         CommitValue('DataObjectKey');             
								         ClearAllRows('Grid0'); 
										 WarehouseIdField = '';
										 OwnerIdField = '';
										 NoField = '';
									     OrderDateField = '';
									     QtyField = '';
										 },         
								   NO: {
								        RollbackValue('DataObjectKey');}});       
				              ]]>
                                    </ValueChanging>
                                    <ValueValidation>
                                        <![CDATA[GetRowCount('Grid0',false)<1]]>
                                    </ValueValidation>
                                </DataBinding>
                                <FormulaItems>
                                    <![CDATA[InvokeService("LRP_GetDataObjectKey", true, false);]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Key="Lab_DataObjectKey" Caption="数据对象" X="0" Y="1"/>
                            <ComboBox Key="WarehouseIdField" Caption="仓储中心字段" BuddyKey="Lab_WarehouseIdField" SourceType="Formula" X="4" Y="1" ItemsDependency="DataObjectKey">
                                <DataBinding ColumnKey="WarehouseIdField" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                                <FormulaItems>
                                    <![CDATA[InvokeService("LRP_GetFieldKey", false, false,GetValue("DataObjectKey"),"Long");]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Key="Lab_WarehouseIdField" Caption="仓储中心字段" X="3" Y="1"/>
                            <ComboBox Key="OwnerIdField" Caption="货主字段" BuddyKey="Lab_OwnerIdField" SourceType="Formula" X="7" Y="1" ItemsDependency="DataObjectKey">
                                <DataBinding ColumnKey="OwnerIdField" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                                <FormulaItems>
                                    <![CDATA[InvokeService("LRP_GetFieldKey", false, false,GetValue("DataObjectKey"),"Long");]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Key="Lab_OwnerIdField" Caption="货主字段" X="6" Y="1"/>
                            <ComboBox Key="OrderDateField" Caption="业务日期字段" BuddyKey="Lab_OrderDateField" SourceType="Formula" X="1" Y="2" ItemsDependency="DataObjectKey">
                                <DataBinding ColumnKey="OrderDateField" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                                <FormulaItems>
                                    <![CDATA[InvokeService("LRP_GetFieldKey", false, false,GetValue("DataObjectKey"),"Datetime");]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Key="Lab_OrderDateField" Caption="业务日期字段" X="0" Y="2"/>
                            <ComboBox Key="QtyField" Caption="业务量字段" BuddyKey="Lab_QtyField" SourceType="Formula" X="4" Y="2" ItemsDependency="DataObjectKey">
                                <DataBinding ColumnKey="QtyField" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                                <FormulaItems>
                                    <![CDATA[InvokeService("LRP_GetFieldKey", false, false,GetValue("DataObjectKey"),"Numeric");]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Key="Lab_QtyField" Caption="业务量字段" X="3" Y="2"/>
                            <ComboBox Key="NoField" Caption="单号字段" BuddyKey="Lab_NoField" SourceType="Formula" X="7" Y="2" ItemsDependency="DataObjectKey">
                                <DataBinding ColumnKey="NoField" TableKey="LRP_W_IncomeTerm_H" Required="true"/>
                                <FormulaItems>
                                    <![CDATA[InvokeService("LRP_GetFieldKey", false, false,GetValue("DataObjectKey"),"String");]]>
                                </FormulaItems>
                            </ComboBox>
                            <Label Key="Lab_NoField" Caption="单号字段" X="6" Y="2"/>
                            <TextEditor Key="Remark" Caption="备注" BuddyKey="Lab_Remark" X="1" Y="3" XSpan="4">
                                <DataBinding ColumnKey="Remark" TableKey="LRP_W_IncomeTerm_H"/>
                            </TextEditor>
                            <Label Key="Lab_Remark" Caption="备注" X="0" Y="3"/>
                            <ComboBox Key="Status" Caption="状态" BuddyKey="Lab_Status" X="7" Y="3" SourceType="Status" Enable="false">
                                <DataBinding ColumnKey="Status" TableKey="LRP_W_IncomeTerm_H" DefaultValue="100" Required="true"/>
                            </ComboBox>
                            <Label Key="Lab_Status" Caption="状态" X="6" Y="3"/>
                            <RowDefCollection RowGap="5">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="5">
                                <ColumnDef Width="77px"/>
                                <ColumnDef Width="33%" MinWidth="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="77px"/>
                                <ColumnDef Width="33%" MinWidth="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="33%" MinWidth="55px"/>
                                <ColumnDef Width="55px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <GridLayoutPanel Key="SystemInfo" Padding="10px" Caption="系统信息">
                            <Dict Key="CREATOR" Caption="创建人" BuddyKey="Lab_CREATOR" X="1" Y="0" Enable="false" ItemKey="Operator">
                                <DataBinding ColumnKey="CREATOR" DefaultFormulaValue="GetOperator()" TableKey="LRP_W_IncomeTerm_H"/>
                            </Dict>
                            <Label Key="Lab_CREATOR" Caption="创建人" X="0" Y="0"/>
                            <DatePicker Key="CREATETIME" Caption="创建时间" BuddyKey="Lab_CREATETIME" X="4" Y="0" Enable="false">
                                <DataBinding ColumnKey="CREATETIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_W_IncomeTerm_H"/>
                            </DatePicker>
                            <Label Key="Lab_CREATETIME" Caption="创建时间" X="3" Y="0"/>
                            <Dict Key="MODIFIER" Caption="修改人" BuddyKey="Lab_MODIFIER" X="1" Y="1" Enable="false" ItemKey="Operator">
                                <DataBinding ColumnKey="MODIFIER" DefaultFormulaValue="GetOperator()" TableKey="LRP_W_IncomeTerm_H"/>
                            </Dict>
                            <Label Key="Lab_MODIFIER" Caption="修改人" X="0" Y="1"/>
                            <DatePicker Key="MODIFYTIME" Caption="修改时间" BuddyKey="Lab_MODIFYTIME" X="4" Y="1" Enable="false">
                                <DataBinding ColumnKey="MODIFYTIME" DefaultFormulaValue="ServerDate()" TableKey="LRP_W_IncomeTerm_H"/>
                            </DatePicker>
                            <Label Key="Lab_MODIFYTIME" Caption="修改时间" X="3" Y="1"/>
                            <RowDefCollection RowGap="5">
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="5">
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="55px"/>
                                <ColumnDef Width="33%"/>
                                <ColumnDef Width="55px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <TabPanel Height="100%" Key="DetailTab" Padding="5px" TopPadding="5px">
                        <Grid Key="Grid0" Caption="计费明细" Enable="!ReadOnly()">
                            <GridColumnCollection>
                                <GridColumn Key="column1" Caption="选择" Width="80px" Sortable="true"/>
                                <GridColumn Key="LowerNumber" Caption="下限" Width="94px" Sortable="true"/>
                                <GridColumn Key="UpperNumber" Caption="上限" Width="88px" Sortable="true"/>
                                <GridColumn Key="PriceType" Caption="单价/总价" Width="80px" Sortable="true"/>
                                <GridColumn Key="Price" Caption="价格" Width="84px" Sortable="true"/>
                                <GridColumn Key="AddPrice" Caption="附加金额" Width="111px" Sortable="true"/>
                                <GridColumn Key="MinPrice" Caption="最低金额" Width="97px" Sortable="true"/>
                                <GridColumn Key="MaxPrice" Caption="最高金额" Width="96px" Sortable="true"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="SEQUENCE" RowHeight="35" TableKey="LRP_W_IncomeTerm_L">
                                    <GridCell Key="select" Caption="选择" CellType="CheckBox" IsSelect="true"/>
                                    <GridCell Key="LowerNumber" Caption="下限" CellType="NumberEditor" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="LowerNumber">
                                            <ValueChanged>
                                                <![CDATA[//修改下限后更新上一行的上限
																	var i = GetFocusRow('Grid0');
																	if(GetRowIndex('Grid0')==i){
																		if (i <= 0) {
																			//第一行不做考虑
																			return 1;
																		} else {
																			var qty = GetCellValue('Grid0', -1, 'LowerNumber');
																			SetCellValue('Grid0', i - 1, 'UpperNumber', qty);
																		}
																	}
																	]]>
                                            </ValueChanged>
                                        </DataBinding>
                                    </GridCell>
                                    <GridCell Key="UpperNumber" Caption="上限" CellType="NumberEditor" Precision="15" Scale="3">
                                        <DataBinding ColumnKey="UpperNumber">
                                            <ValueChanged>
                                                <![CDATA[//修改上限后更新下一行的上限
																var i = GetFocusRow('Grid0');
																var count = GetRowCount('Grid0', false);
																if(GetRowIndex('Grid0')==i){
																	if (i < count - 1) {   
																		var qty = GetCellValue('Grid0', -1, 'UpperNumber');  
																		SetCellValue('Grid0', i + 1, 'LowerNumber', qty);
																	}
																	if(i > 0){
																		if(GetCellValue('Grid0', -1, 'LowerNumber')<>GetCellValue('Grid0', i-1, 'UpperNumber')){
																			SetCellValue('Grid0', -1, 'LowerNumber', GetCellValue('Grid0', i-1, 'UpperNumber'));
																		}
																	}
																}
																]]>
                                            </ValueChanged>
                                        </DataBinding>
                                    </GridCell>
                                    <GridCell Key="PriceType" Caption="单价/总价" CellType="ComboBox">
                                        <DataBinding ColumnKey="PriceType" DefaultValue="1" Required="true"/>
                                        <Item Caption="单价" Key="1" Value="1"/>
                                        <Item Caption="总价" Key="2" Value="2"/>
                                        <Item Caption="单价（扣减下限）" Key="3" Value="3"/>
                                    </GridCell>
                                    <GridCell Key="Price" Caption="价格" CellType="NumberEditor" Precision="15" Scale="3" ShowZero="true">
                                        <DataBinding ColumnKey="Price"/>
                                    </GridCell>
                                    <GridCell Key="AddPrice" Caption="附加金额" CellType="NumberEditor" Precision="15" Scale="3">
                                        <DataBinding ColumnKey="AddPrice"/>
                                    </GridCell>
                                    <GridCell Key="MinPrice" Caption="最低金额" CellType="NumberEditor" Precision="15" Scale="3">
                                        <DataBinding ColumnKey="MinPrice"/>
                                    </GridCell>
                                    <GridCell Key="MaxPrice" Caption="最高金额" CellType="NumberEditor" Precision="15" Scale="3">
                                        <DataBinding ColumnKey="MaxPrice"/>
                                    </GridCell>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                    </TabPanel>
                    <SplitSize Size="180px"/>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
</Form>
