<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="LocationOutbound" Caption="整储位出库">
    <DataSource>
        <DataObject Key="LocationOutbound" Caption="整储位出库" PrimaryTableKey="LocationOutbound">
            <TableCollection>
                <Table Key="LocationOutbound" Caption="整储位出库">
                    <Column Key="OID" Caption="对象标识" DataType="Long"/>
                    <Column Key="SOID" Caption="主对象标识" DataType="Long"/>
                    <Column Key="POID" Caption="父对象标识" DataType="Long"/>
                    <Column Key="VERID" Caption="对象版本" DataType="Integer"/>
                    <Column Key="DVERID" Caption="对象明细版本" DataType="Integer"/>
                    <Column Key="LocationID" Caption="储位ID" DataType="Integer"/>
                </Table>
            </TableCollection>
        </DataObject>
    </DataSource>
    <QueryCollection>
        <Query Description="查询扫描得储位" Key="QueryLocation">
            <Statement>
                <![CDATA[select OID,StoreroomId,StoreareaId from LRP_Location where Code=?]]>
            </Statement>
            <ParameterCollection>
                <Parameter DataType="Varchar"/>
            </ParameterCollection>
        </Query>
		<Query Description="从库存表中查询扫入条码对应的库存记录" Key="QueryPackingMaterialQuant">
            <Statement>
                <![CDATA[select m.Name as MaterialName,m.PreCool,m.Discharging,m.DischargingOverTime,q.PackingMaterialId,q.MaterialBarCode,q.RecvDate,q.StoreroomId,q.StoreareaId,q.LocationId from LRP_PackingMaterialQuant q join LRP_PackingMaterial m on q.PackingMaterialID = m.oid where q.OnhandQty > 0 and q.LocationId=?]]>
            </Statement>
            <ParameterCollection>
				<Parameter DataType="Long"/>
            </ParameterCollection>
        </Query>
    </QueryCollection>
    <Body PopHeight="120px" PopWidth="600px">
        <Block>
            <FlexFlowLayoutPanel Key="main" Caption="根面板" Height="pref" Width="pref">
                <ToolBar Key="main_toolbar" Height="pref" Caption="main_toolbar">
                    <ToolBarItemCollection/>
                </ToolBar>
                <GridLayoutPanel Key="first_head" Padding="5px" Height="pref" Caption="基本信息">
                    <TextEditor BuddyKey="Lab_EnterLocationCode" Caption="扫描储位码" Enable="!ReadOnly()" Key="EnterLocationCode" X="2" Y="0">
						<KeyEnter>
							<![CDATA[								
								var dt=DBNamedQuery("QueryLocation",EnterLocationCode); 
								if(dt.size()>0)
								{
									dt.beforefirst();
									dt.next();
									SetValue('CurLocation',dt.OID);
								}
								else
								{
									Confirm("未能找到代码为"+EnterLocationCode+"的储位",'OK','OK:{}');
									SetFocus('EnterLocationCode',true);
								}
										
									  ]]>
						</KeyEnter>
					</TextEditor>
					<Label Caption="扫描储位码" Key="Lab_EnterLocationCode" X="1" Y="0"/>
					
					<Dict BuddyKey="Lab_CurLocation" Caption="选择储位" Enable="True" ItemKey="LRP_Location" Key="CurLocation" X="4" Y="0"/>
					<Label Caption="选择储位" Key="Lab_CurLocation" X="3" Y="0"/>
					
                    <Button Key="OK" Caption="确定" X="1" XSpan="2" Y="1">
                        <OnClick>
                            <![CDATA[
								//从库存中查询对应的条码
								var dt=DBNamedQuery("QueryPackingMaterialQuant",CurLocation); 
								if(dt.size()==0)
								{									
									Confirm("选择的储位上没有物料库存记录",'OK','OK:{}');							
									return true;
								}								
								
								dt.beforefirst();
								while(dt.next()){
									//如果有预冷时间需求，检查预冷时间是否符合
									if(dt.PreCool > 0){
										var PreCoolDate = DateAdd(dt.RecvDate,"h",dt.PreCool);
										if(ServerDate() < PreCoolDate){
											Confirm("储位上的物料记录"+dt.MaterialName+"的预冷时间不够，允许的出库时间为"+Format(PreCoolDate,'yyyy-MM-dd HH:mm:ss'),'OK','OK:{}');				
											return true;
										}
									}
								}
								
								dt.beforefirst();
								while(dt.next()){
									//检查并出库的物料是否是包装方案需要的物料
									var count = Parent.GetRowCount('Grid_Sum');
									var i = 0;
									var b = false;
									while ( i < count ) {
										if(Parent.GetCellValue('Grid_Sum',i,"MaterialId") == dt.PackingMaterialId){
											b = true;
											break;													
										}
										i = i + 1;
									}
									if(!b)
									{
										Confirm("储位上的物料记录"+dt.MaterialName+"不是包装方案中所需要的物料",'OK','OK:{}');
										return true;
									}
								}
								
								//将物料代码插入到入库列表中								
								dt.beforefirst();
								while(dt.next()){
									//检查扫入的条码是否已存在
									var b = false;
									var count = Parent.GetRowCount('Grid0');
									var i = 0;
									while ( i < count ) {
										if(Parent.GetCellValue('Grid0',i,"MaterialBarCode") == dt.MaterialBarCode){
											b = true;
											break;
										}
										i = i + 1;
									}
									if(!b){
										//检查并修改包装物料明细汇总的已出库数量
										var count = Parent.GetRowCount('Grid_Sum');
										var i = 0;
										var b = false;
										while ( i < count ) {
											if(Parent.GetCellValue('Grid_Sum',i,"MaterialId") == dt.PackingMaterialId){
												Parent.SetCellValue('Grid_Sum',i,'OutboundQty',Parent.GetCellValue('Grid_Sum',i,"OutboundQty") + 1);
												b = true;
												break;													
											}
											i = i + 1;
										}
								
										//在出库物料明细中插入一条记录
										var index = Parent.InsertRow('Grid0',-1);
										Parent.SetCellValue('Grid0', index,'MaterialId_Outbound',dt.PackingMaterialId);
										Parent.SetCellValue('Grid0', index,'MaterialBarCode',dt.MaterialBarCode);
										Parent.SetCellValue('Grid0', index,'Qty_Outbound',1);
										Parent.SetCellValue('Grid0', index,'Status_Outbound',10);
										Parent.SetCellValue('Grid0', index,'InboundDateTime',dt.RecvDate);
										Parent.SetCellValue('Grid0', index,'StoreroomId',dt.StoreroomId);
										Parent.SetCellValue('Grid0', index,'StoreareaId',dt.StoreareaId);
										Parent.SetCellValue('Grid0', index,'LocationId',dt.LocationId);
									}
								}
								Close();
							]]>
                        </OnClick>
                    </Button>
					<Button Key="Cancel" Caption="取消" X="3" XSpan="2" Y="1">
                        <OnClick>
                            <![CDATA[Close();]]>
                        </OnClick>
                    </Button>
                    <RowDefCollection RowHeight="30" RowGap="6">
                        <RowDef/>
                        <RowDef/>
                        <RowDef/>
                        <RowDef/>
                    </RowDefCollection>
                    <ColumnDefCollection ColumnGap="20">
                        <ColumnDef Width="30px"/>
                        <ColumnDef Width="60px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="60px"/>
                        <ColumnDef Width="50%"/>
                        <ColumnDef Width="30px"/>
                    </ColumnDefCollection>
                </GridLayoutPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
</Form>
